# -*- coding: utf-8 -*-

"""Hotkey-driven Arras macros and drawing helpers.

The script mirrors historical behavior; readability tweaks (docstrings,
comments) clarify intent without altering any macro logic.
"""

# Set to True to use C++ implementations when available
USE_CPP_MACROS = True

tailamount = 40

style = None

import random
import time
import threading
import multiprocessing
from multiprocessing import Process
import platform
import sys
import math
import string
from typing import Any, TYPE_CHECKING

# Detect platform early (needed for overlay decision)
PLATFORM = platform.system().lower()  # 'darwin' (macOS), 'linux', 'windows', 'android'

# Optional GUI overlay (tkinter). If unavailable, overlay auto-disables.
# On macOS, tkinter windows MUST be created on the main thread, so we disable
# the overlay by default on macOS to avoid NSInternalInconsistencyException crashes.
DISABLE_OVERLAY_ON_MACOS = PLATFORM == 'darwin'

try:
    import tkinter as tk
    overlay_import_error = None
    # If overlay would be disabled on macOS, set it to disabled now
    if DISABLE_OVERLAY_ON_MACOS:
        tk = None
        overlay_import_error = "Overlay disabled on macOS (tkinter threading issue)"
except Exception as exc:  # ModuleNotFoundError or Tcl/Tk missing
    tk = None
    overlay_import_error = exc

if TYPE_CHECKING:
    from multiprocessing.synchronize import Event as MpEvent
else:
    MpEvent = Any

try:
    from pynput.keyboard import Controller as KeyboardController, Key, KeyCode, Listener as KeyboardListener
    from pynput.mouse import Controller as MouseController, Button, Listener as MouseListener
except ImportError:
    print("Missing dependency: pynput is required to run this script.")
    print("Install with: python3 -m pip install -r requirements.txt")
    sys.exit(1)

# macOS Quartz support for better Unicode typing
HAS_QUARTZ = False
if PLATFORM == 'darwin':
    try:
        from Quartz import (
            CGEventCreateKeyboardEvent,
            CGEventKeyboardSetUnicodeString,
            CGEventPost,
            kCGHIDEventTap
        )
        HAS_QUARTZ = True
    except ImportError:
        print("Warning: Quartz not available. Unicode typing may not work properly.")
        print("Install with: pip install pyobjc-framework-Quartz")

try:
    import mss
    import pytesseract
    from PIL import Image
    HAS_OCR = True
except ImportError:
    HAS_OCR = False
    print("Warning: OCR dependencies (mss, pytesseract, Pillow) not available.")
    print("Text scanning features will be disabled.")
    print("Install with: pip install mss pytesseract pillow")


listener_event_injected = False


class RobustKeyboardListener(KeyboardListener):
    """Wrapper around pynput's KeyboardListener that handles Unicode decode errors.
    
    On macOS, certain keyboard events can trigger UnicodeDecodeError in pynput's
    internal event handler. This wrapper catches those errors gracefully.
    """
    
    def _handle_message(self, proxy: Any, event_type: Any, event: Any, refcon: Any, is_injected: Any) -> None:
        """Override pynput's message handler to catch Unicode decode errors.
        
        This is called from the C callback handler and processes keyboard events.
        On macOS, some special keys can cause UnicodeDecodeError in _event_to_key().
        """
        global listener_event_injected
        listener_event_injected = bool(is_injected)
        try:
            super()._handle_message(proxy, event_type, event, refcon, is_injected)
        except UnicodeDecodeError:
            # Silently ignore Unicode decode errors from special keys on macOS
            # These don't indicate a problem and shouldn't crash the listener
            pass
        except Exception as e:
            # Log but don't crash on other unexpected errors
            print(f"Keyboard listener error (suppressed): {type(e).__name__}: {e}")
        finally:
            listener_event_injected = False


# Platform notes:
# - macOS: Ctrl hotkeys work; Option+Arrow for 1px nudges
# - Linux: Ctrl hotkeys work; Alt+Arrow for 1px nudges
# - Windows: Ctrl hotkeys work; Alt+Arrow for 1px nudges
# - Android: Limited support (pynput may not work on all devices)

# C++ macro integration
try:
    from cpp_wrapper import (
        is_cpp_available,
        circles_cpp,
        walls_cpp,
        circlecrash_cpp,
        minicirclecrash_cpp,
        arena_automation_cpp,
        benchmark_cpp,
    )
    HAS_CPP = is_cpp_available()
except ImportError:
    HAS_CPP = False
    print("C++ wrapper not available, using pure Python implementations")


length = 4

# Function
# Centralized set of flags/shared state used across macro helpers. Values are
# kept as globals because listeners spin up background threads that need access.
global automation_working, controller, circlecrash_working, mouse, circle_art_working, step, ctrlswap, mcrash_working, custom_reload_spam_working
global circle_mouse_active, circle_mouse_speed, circle_mouse_radius, circle_mouse_direction
step = 20
s = 25 #circle spacing in px
ctrlswap = False  # When True, use Cmd (macOS) instead of Ctrl for macros
circle_mouse_active = False
circle_mouse_speed = 0.02  # Time delay between updates (lower = faster)
circle_mouse_radius = 100  # Radius in pixels
circle_mouse_direction = 1  # 1 for clockwise, -1 for counterclockwise
berserk = False  # When True, every typed character becomes random from a random fancy style
emoji_replacement_enabled = False  # Toggle emoji :{text}: replacement on/off (Ctrl+H)

# Arena automation limits
arena_auto_terminate = True  # If True, stop after arena_auto_max_commands
arena_auto_max_commands = 576  # Number of commands before auto-termination
arena_auto_rate_limit = 150  # Maximum commands per second (0 = unlimited)
arena_size_step = 8  # Step size for arena size changes (must be even, default: 2)

automation_working = False
engineer_spam_working = False
mcrash_working = False
mcrash_thread = None
engineer_spam_thread = None
custom_reload_spam_working = False
circle_art_working = False
circlecrash_working = False
circlecrash_thread = None
braindamage_working = False
controller = KeyboardController()
mouse = MouseController()
pressed_keys = set()


# -------- Input Helper Functions -------- #
def press_with_delay(key: str | Key, wait: float = 0.1, count: int = 2) -> None:
    """Press a key multiple times with delay between presses.
    
    Args:
        key: The key to press
        wait: Delay in seconds between presses (default: 0.1)
        count: Number of times to press (default: 2)
    """
    for i in range(count):
        controller.tap(key)
        if i < count - 1:  # Don't sleep after last tap
            time.sleep(wait)


def type_unicode(text: str) -> None:
    """Type Unicode text using the best available method for the platform.
    
    On macOS with Quartz, uses CGEvent for proper Unicode support.
    Falls back to pynput on other platforms or if Quartz is unavailable.
    
    Args:
        text: The Unicode text to type
    """
    if PLATFORM == 'darwin' and HAS_QUARTZ:
        # Create a dummy keyboard event
        event = CGEventCreateKeyboardEvent(None, 0, True)
        
        # IMPORTANT: Quartz expects UTF-16 code units, not Python length
        utf16 = text.encode("utf-16-le")
        length = len(utf16) // 2
        
        CGEventKeyboardSetUnicodeString(event, length, text)
        CGEventPost(kCGHIDEventTap, event)
    else:
        # Fallback to pynput for non-macOS or if Quartz unavailable
        controller.type(text)


def type_with_enter(text: str, wait: float = 0) -> None:
    """Type text wrapped with Enter key presses.
    
    Args:
        text: The text to type
        wait: Optional delay after first enter and before final enter (default: 0)
    """
    processed_text = process_fancy_patterns(text)
    processed_text = process_emoji_patterns(processed_text)
    controller.tap(Key.enter)
    if wait > 0:
        time.sleep(wait)
    type_unicode(processed_text)
    if wait > 0:
        time.sleep(wait)
    controller.tap(Key.enter)


def type_in_console(text: str, hold_backtick: bool = True) -> None:
    """Type text in the game console (backtick-wrapped).
    
    Args:
        text: The text to type
        hold_backtick: If True, hold backtick during typing for speed (default: True)
    """
    processed_text = process_fancy_patterns(text)
    processed_text = process_emoji_patterns(processed_text)
    if hold_backtick:
        controller.press("`")
        controller.type(processed_text)
        controller.release("`")
    else:
        controller.tap("`")
        controller.type(processed_text)
        controller.tap("`")


def safe_chr(codepoint):
    try:
        return chr(codepoint)
    except ValueError:
        return None


STYLES = {
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Mathematical â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    "bold_serif": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
        "ðšð›ðœððžðŸð ð¡ð¢ð£ð¤ð¥ð¦ð§ð¨ð©ðªð«ð¬ð­ð®ð¯ð°ð±ð²ð³"
        "ð€ðð‚ðƒð„ð…ð†ð‡ðˆð‰ðŠð‹ðŒððŽððð‘ð’ð“ð”ð•ð–ð—ð˜ð™"
        "ðŸŽðŸðŸðŸ‘ðŸ’ðŸ“ðŸ”ðŸ•ðŸ–ðŸ—"
    )),

    "italic_sans": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "ð˜¢ð˜£ð˜¤ð˜¥ð˜¦ð˜§ð˜¨ð˜©ð˜ªð˜«ð˜¬ð˜­ð˜®ð˜¯ð˜°ð˜±ð˜²ð˜³ð˜´ð˜µð˜¶ð˜·ð˜¸ð˜¹ð˜ºð˜»ð˜ˆð˜‰ð˜Šð˜‹ð˜Œð˜ð˜Žð˜ð˜ð˜‘ð˜’ð˜“ð˜”ð˜•ð˜–ð˜—ð˜˜ð˜™ð˜šð˜›ð˜œð˜ð˜žð˜Ÿð˜ ð˜¡"
    )),

    "bold_sans": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
        "ð—®ð—¯ð—°ð—±ð—²ð—³ð—´ð—µð—¶ð—·ð—¸ð—¹ð—ºð—»ð—¼ð—½ð—¾ð—¿ð˜€ð˜ð˜‚ð˜ƒð˜„ð˜…ð˜†ð˜‡"
        "ð—”ð—•ð—–ð——ð—˜ð—™ð—šð—›ð—œð—ð—žð—Ÿð— ð—¡ð—¢ð—£ð—¤ð—¥ð—¦ð—§ð—¨ð—©ð—ªð—«ð—¬ð—­"
        "ðŸ­ðŸ®ðŸ¯ðŸ°ðŸ±ðŸ²ðŸ³ðŸ´ðŸµðŸ¬"
    )),

    "bold_italic_serif": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "ð’‚ð’ƒð’„ð’…ð’†ð’‡ð’ˆð’‰ð’Šð’‹ð’Œð’ð’Žð’ð’ð’‘ð’’ð’“ð’”ð’•ð’–ð’—ð’˜ð’™ð’šð’›"
        "ð‘¨ð‘©ð‘ªð‘«ð‘¬ð‘­ð‘®ð‘¯ð‘°ð‘±ð‘²ð‘³ð‘´ð‘µð‘¶ð‘·ð‘¸ð‘¹ð‘ºð‘»ð‘¼ð‘½ð‘¾ð‘¿ð’€ð’"
    )),

    "bold_italic_sans": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "ð™–ð™—ð™˜ð™™ð™šð™›ð™œð™ð™žð™Ÿð™ ð™¡ð™¢ð™£ð™¤ð™¥ð™¦ð™§ð™¨ð™©ð™ªð™«ð™¬ð™­ð™®ð™¯"
        "ð˜¼ð˜½ð˜¾ð˜¿ð™€ð™ð™‚ð™ƒð™„ð™…ð™†ð™‡ð™ˆð™‰ð™Šð™‹ð™Œð™ð™Žð™ð™ð™‘ð™’ð™“ð™”ð™•"
    )),

    "double_struck": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
        "ð•’ð•“ð•”ð••ð•–ð•—ð•˜ð•™ð•šð•›ð•œð•ð•žð•Ÿð• ð•¡ð•¢ð•£ð•¤ð•¥ð•¦ð•§ð•¨ð•©ð•ªð•«"
        "ð”¸ð”¹â„‚ð”»ð”¼ð”½ð”¾â„ð•€ð•ð•‚ð•ƒð•„â„•ð•†â„™â„šâ„ð•Šð•‹ð•Œð•ð•Žð•ð•â„¤"
        "ðŸ˜ðŸ™ðŸšðŸ›ðŸœðŸðŸžðŸŸðŸ ðŸ¡"
    )),

    "monospace": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
        "ðšŠðš‹ðšŒðšðšŽðšðšðš‘ðš’ðš“ðš”ðš•ðš–ðš—ðš˜ðš™ðššðš›ðšœðšðšžðšŸðš ðš¡ðš¢ðš£"
        "ð™°ð™±ð™²ð™³ð™´ð™µð™¶ð™·ð™¸ð™¹ð™ºð™»ð™¼ð™½ð™¾ð™¿ðš€ðšðš‚ðšƒðš„ðš…ðš†ðš‡ðšˆðš‰"
        "ðŸ¶ðŸ·ðŸ¸ðŸ¹ðŸºðŸ»ðŸ¼ðŸ½ðŸ¾ðŸ¿"
    )),

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Decorative â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    "circled": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
        "â“â“‘â“’â““â“”â“•â“–â“—â“˜â“™â“šâ“›â“œâ“â“žâ“Ÿâ“ â“¡â“¢â“£â“¤â“¥â“¦â“§â“¨â“©"
        "â’¶â’·â’¸â’¹â’ºâ’»â’¼â’½â’¾â’¿â“€â“â“‚â“ƒâ“„â“…â“†â“‡â“ˆâ“‰â“Šâ“‹â“Œâ“â“Žâ“"
        "â“ªâ‘ â‘¡â‘¢â‘£â‘¤â‘¥â‘¦â‘§â‘¨"
    )),

    "squared": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "ðŸ„°ðŸ„±ðŸ„²ðŸ„³ðŸ„´ðŸ„µðŸ„¶ðŸ„·ðŸ„¸ðŸ„¹ðŸ„ºðŸ„»ðŸ„¼ðŸ„½ðŸ„¾ðŸ„¿ðŸ…€ðŸ…ðŸ…‚ðŸ…ƒðŸ…„ðŸ……ðŸ…†ðŸ…‡ðŸ…ˆðŸ…‰ðŸ„°ðŸ„±ðŸ„²ðŸ„³ðŸ„´ðŸ„µðŸ„¶ðŸ„·ðŸ„¸ðŸ„¹ðŸ„ºðŸ„»ðŸ„¼ðŸ„½ðŸ„¾ðŸ„¿ðŸ…€ðŸ…ðŸ…‚ðŸ…ƒðŸ…„ðŸ……ðŸ…†ðŸ…‡ðŸ…ˆðŸ…‰"
    )),

    "fullwidth": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",
        "ï½ï½‚ï½ƒï½„ï½…ï½†ï½‡ï½ˆï½‰ï½Šï½‹ï½Œï½ï½Žï½ï½ï½‘ï½’ï½“ï½”ï½•ï½–ï½—ï½˜ï½™ï½š"
        "ï¼¡ï¼¢ï¼£ï¼¤ï¼¥ï¼¦ï¼§ï¼¨ï¼©ï¼ªï¼«ï¼¬ï¼­ï¼®ï¼¯ï¼°ï¼±ï¼²ï¼³ï¼´ï¼µï¼¶ï¼·ï¼¸ï¼¹ï¼º"
        "ï¼ï¼‘ï¼’ï¼“ï¼”ï¼•ï¼–ï¼—ï¼˜ï¼™"
    )),

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Script / Gothic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    "script": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "ð’¶ð’·ð’¸ð’¹â„¯ð’»â„Šð’½ð’¾ð’¿ð“€ð“ð“‚ð“ƒâ„´ð“…ð“†ð“‡ð“ˆð“‰ð“Šð“‹ð“Œð“ð“Žð“"
        "ð’œâ„¬ð’žð’Ÿâ„°â„±ð’¢â„‹â„ð’¥ð’¦â„’â„³ð’©ð’ªð’«ð’¬â„›ð’®ð’¯ð’°ð’±ð’²ð’³ð’´ð’µ"
    )),

    "bold_script": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "ð“ªð“«ð“¬ð“­ð“®ð“¯ð“°ð“±ð“²ð“³ð“´ð“µð“¶ð“·ð“¸ð“¹ð“ºð“»ð“¼ð“½ð“¾ð“¿ð”€ð”ð”‚ð”ƒ"
        "ð“ð“‘ð“’ð““ð“”ð“•ð“–ð“—ð“˜ð“™ð“šð“›ð“œð“ð“žð“Ÿð“ ð“¡ð“¢ð“£ð“¤ð“¥ð“¦ð“§ð“¨ð“©"
    )),

    "fraktur": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "ð”žð”Ÿð” ð”¡ð”¢ð”£ð”¤ð”¥ð”¦ð”§ð”¨ð”©ð”ªð”«ð”¬ð”­ð”®ð”¯ð”°ð”±ð”²ð”³ð”´ð”µð”¶ð”·"
        "ð”„ð”…â„­ð”‡ð”ˆð”‰ð”Šâ„Œâ„‘ð”ð”Žð”ð”ð”‘ð”’ð”“ð””â„œð”–ð”—ð”˜ð”™ð”šð”›ð”œâ„¨"
    )),

    "cursed2": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "à¸„à¹’Ï‚à¹”Ñ”Å¦ï»®Ñ’à¹€×ŸÐºÉ­à¹“à¸ à¹×§á»£Ð³à¸£Õ‡à¸¢×©à¸¬××¥Õ¹à¸„à¹’Ï‚à¹”Ñ”Å¦ï»®Ñ’à¹€×ŸÐºÉ­à¹“à¸ à¹×§á»£Ð³à¸£Õ‡à¸¢×©à¸¬××¥Õ¹"
    )),

    "cursed3": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "Ä…É“ÆˆÄ‘É›Æ’É É¦Ä¯ÊÆ™Å€É±Å‹Æ¡Æ¥É‹Å™ÅŸÅ§Å³Ê‹ÅµÒ³yÊÄ„ÆÆ‡ÄÆÆ‘Æ“Ä¦Ä®ÊÆ˜Ä¿ÆœÅŠÆ Æ¤ÉŠÅ˜ÅžÅ¦Å²Æ²Å´Ò²YÊ"
    )),

    "cursed4": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "Î±á‚¦ÆˆÔƒÒ½ÏÉ Ô‹Î¹ÊÆ™Ê…É±É³ÏƒÏÏ™É¾Ê‚ÆšÏ…Ê‹É¯xáƒ§È¥Î‘á‚¦Æ‡Ô‚ÆÏœÆ“ÔŠÎ™ÊÆ˜ÊŸÆœÆÎ£Î¡Ï˜ÉŒÆ§Æ¬Î¥Æ²É°Xáƒ§È¤"
    )),

    "cursed5": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "ÇŸÉ®ÆˆÉ–É›Ê„É¢É¦É¨ÊÓ„ÊŸÊÕ¼Ö…Ö„Õ¦Ê€Ö†È¶ÊŠÊ‹Õ¡Ó¼ÊÊÇŸÉ®ÆˆÉ–É›Ê„É¢É¦É¨ÊÓ„ÊŸÊÕ¼Ö…Ö„Õ¦Ê€Ö†È¶ÊŠÊ‹Õ¡Ó¼ÊÊ"
    )),

    "cursed6": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "á—á°áˆáŽ´á‹áŽ¦áŽ¶á‚áŽ¥á á¦ááŽ·ááŽ§áŽ®áŽ¤á’á•á–á¬á‰á‡áŒ€áŽ©ášá—á°áˆáŽ´á‹áŽ¦áŽ¶á‚áŽ¥á á¦ááŽ·ááŽ§áŽ®áŽ¤á’á•á–á¬á‰á‡áŒ€áŽ©áš"
    )),

    "cursed7": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "Ä…áƒªÆˆÉ–É›Ê„É É§Ä±ÊÆ™Æ–É±Å‹Æ¡â„˜Õ¦à½žÊ‚É¬Å³Û·á¿³Ò³áƒ§Ê‘Ä…áƒªÆˆÉ–É›Ê„É É§Ä±ÊÆ™Æ–É±Å‹Æ¡â„˜Õ¦à½žÊ‚É¬Å³Û·á¿³Ò³áƒ§Ê‘"
    )),

    "cursed8": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "à¸„à¹–Â¢à»“Ä“fàº‡hià¸§klà¹“àº–à»pà¹‘rÅžtà¸™à¸‡àºŸxà¸¯àºŠà¸„à¹–Â¢à»“Ä“fàº‡hià¸§klà¹“àº–à»pà¹‘rÅžtà¸™à¸‡àºŸxà¸¯àºŠ"
    )),

    "cursed9": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "Ã¥ÃŸÂ¢ÃÃªÂ£ghÃ¯jklmÃ±Ã°Ã¾qrÂ§â€ ÂµvwxÂ¥zÃ„ÃŸÃ‡ÃÃˆÂ£GHÃŒJKLMÃ±Ã–Ã¾QRÂ§â€ ÃšVWÃ—Â¥Z"
    )),

    "cursed10": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "â‚³à¸¿â‚µÄÉ†â‚£â‚²â±§Å‚Jâ‚­â± â‚¥â‚¦Ã˜â‚±Qâ±¤â‚´â‚®É„Vâ‚©Ó¾ÉŽâ±«â‚³à¸¿â‚µÄÉ†â‚£â‚²â±§Å‚Jâ‚­â± â‚¥â‚¦Ã˜â‚±Qâ±¤â‚´â‚®É„Vâ‚©Ó¾ÉŽâ±«"
    )),

    "bold_fraktur": dict(zip(
        "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",
        "ð–†ð–‡ð–ˆð–‰ð–Šð–‹ð–Œð–ð–Žð–ð–ð–‘ð–’ð–“ð–”ð–•ð––ð–—ð–˜ð–™ð–šð–›ð–œð–ð–žð–Ÿð•¬ð•­ð•®ð•¯ð•°ð•±ð•²ð•³ð•´ð•µð•¶ð•·ð•¸ð•¹ð•ºð•»ð•¼ð•½ð•¾ð•¿ð–€ð–ð–‚ð–ƒð–„ð–…"
    ))
}

# Emoji mapping system: [text, emoji] pairs
# Usage: type :{text}: to replace with emoji
EMOJIS = [
    ["heart", "â¤ï¸"],
    ["love", "â¤ï¸"],
    ["smile", "ðŸ˜Š"],
    ["happy", "ðŸ˜Š"],
    ["sad", "ðŸ˜¢"],
    ["sob", "ðŸ˜­"],
    ["laugh", "ðŸ˜‚"],
    ["lol", "ðŸ˜‚"],
    ["fire", "ðŸ”¥"],
    ["hot", "ðŸ”¥"],
    ["cool", "ðŸ˜Ž"],
    ["wow", "ðŸ˜²"],
    ["shocked", "ðŸ˜²"],
    ["angry", "ðŸ˜ "],
    ["rage", "ðŸ˜¡"],
    ["puke", "ðŸ¤®"],
    ["sick", "ðŸ¤¢"],
    ["thumbs", "ðŸ‘"],
    ["thumbsup", "ðŸ‘"],
    ["thumbsdown", "ðŸ‘Ž"],
    ["clap", "ðŸ‘"],
    ["wave", "ðŸ‘‹"],
    ["pray", "ðŸ™"],
    ["thanks", "ðŸ™"],
    ["point", "ðŸ‘‰"],
    ["ok", "ðŸ‘Œ"],
    ["victory", "âœŒï¸"],
    ["peace", "â˜®ï¸"],
    ["star", "â­"],
    ["sparkle", "âœ¨"],
    ["boom", "ðŸ’¥"],
    ["explosion", "ðŸ’¥"],
    ["sun", "â˜€ï¸"],
    ["moon", "ðŸŒ™"],
    ["star", "â­"],
    ["zap", "âš¡"],
    ["lightning", "âš¡"],
    ["flower", "ðŸŒ¸"],
    ["rose", "ðŸŒ¹"],
    ["skull", "ðŸ’€"],
    ["snake", "ðŸ"],
    ["turtle", "ðŸ¢"],
    ["cat", "ðŸ±"],
    ["dog", "ðŸ¶"],
    ["pig", "ðŸ·"],
    ["bird", "ðŸ¦"],
    ["fish", "ðŸ "],
    ["dragon", "ðŸ‰"],
    ["unicorn", "ðŸ¦„"],
    ["pizza", "ðŸ•"],
    ["cake", "ðŸ°"],
    ["candy", "ðŸ¬"],
    ["apple", "ðŸŽ"],
    ["watermelon", "ðŸ‰"],
    ["beer", "ðŸº"],
    ["wine", "ðŸ·"],
    ["coffee", "â˜•"],
    ["gift", "ðŸŽ"],
    ["bomb", "ðŸ’£"],
    ["gun", "ðŸ”«"],
    ["sword", "âš”ï¸"],
    ["shield", "ðŸ›¡ï¸"],
    ["medal", "ðŸ…"],
    ["trophy", "ðŸ†"],
    ["rocket", "ðŸš€"],
    ["car", "ðŸš—"],
    ["bike", "ðŸš²"],
    ["money", "ðŸ’°"],
    ["gem", "ðŸ’Ž"],
    ["clock", "ðŸ•"],
    ["watch", "âŒš"],
    ["calendar", "ðŸ“…"],
    ["phone", "ðŸ“±"],
    ["computer", "ðŸ’»"],
    ["keyboard", "âŒ¨ï¸"],
    ["mouse", "ðŸ–±ï¸"],
    ["printer", "ðŸ–¨ï¸"],
    ["camera", "ðŸ“·"],
    ["video", "ðŸŽ¥"],
    ["music", "ðŸŽµ"],
    ["notes", "ðŸŽ¶"],
    ["art", "ðŸŽ¨"],
    ["game", "ðŸŽ®"],
    ["dice", "ðŸŽ²"],
    ["cards", "ðŸƒ"],
    ["soccer", "âš½"],
    ["basketball", "ðŸ€"],
    ["football", "ðŸˆ"],
    ["baseball", "âš¾"],
    ["skull", "ðŸ’€"],
    ["wilted_rose", "ðŸ¥€"],
    ["tennis", "ðŸŽ¾"],
    ["volleyball", "ðŸ"],
    ["ping", "ðŸ“"],
    ["checkmark", "âœ…"],
    ["check", "âœ…"],
    ["cross", "âŒ"],
    ["x", "âŒ"],
    ["warning", "âš ï¸"],
    ["error", "âŒ"],
    ["info", "â„¹ï¸"],
    ["question", "â“"],
    ["idea", "ðŸ’¡"],
    ["bulb", "ðŸ’¡"],
    ["eyes", "ðŸ‘€"],
    ["see", "ðŸ‘€"],
    ["look", "ðŸ‘€"],
]


def fancy(text, style):
    candidate = STYLES.get(style)
    while candidate == style:
        candidate = STYLES.get(style)
    if not candidate:
        raise ValueError(f"Unknown style: {style}")
    print(f"fancy style: {style}")
    return "".join(candidate.get(c, c) for c in text)


def apply_berserk(text: str) -> str:
    """Transform each character with a random fancy style.
    
    Args:
        text: The text to berserkify
        
    Returns:
        Text with each character replaced with its fancy equivalent from a random style
    """
    if not berserk:
        return text
    
    result = []
    for char in text:
        # Pick a random style for each character
        style = random.choice(list(STYLES.keys()))
        table = STYLES.get(style)
        if table:
            # Get the fancy character or keep original if not in style
            result.append(table.get(char, char))
        else:
            result.append(char)
    
    return ''.join(result)


def process_fancy_patterns(text: str) -> str:
    """Replace 'f:{text}:' patterns with randomly styled text.
    
    Supports escaping:
    - \\f:text: -> literal "f:text:" (escaped pattern)
    - f:text\\:more: -> allows escaped colons within the pattern
    
    Args:
        text: Input text that may contain f:{text}: patterns
        
    Returns:
        Text with all fancy patterns replaced with styled versions
    """
    import re
    
    def replace_fancy(match):
        # Check if this match is escaped with backslash
        start_pos = match.start()
        if start_pos > 0 and text[start_pos - 1] == '\\':
            # Remove the escape backslash and return the literal pattern
            return match.group(0)
        
        # Get content and unescape any \: within it
        content = match.group(1).replace('\\:', ':')
        random_style = random.choice(list(STYLES.keys()))
        return fancy(content, random_style)
    
    # First, handle escaped patterns by temporarily replacing them
    text = text.replace('\\f:', '\x00ESCAPED_FANCY\x00')
    
    # Match f:content: where content can include \: but not unescaped :
    # This regex allows \: within the content
    text = re.sub(r'f:((?:[^:\\]|\\:|\\.)+):', replace_fancy, text)
    
    # Restore escaped patterns (remove the escape backslash)
    text = text.replace('\x00ESCAPED_FANCY\x00', 'f:')
    
    return text


def check_and_replace_fancy_pattern() -> None:
    """Check if keyboard buffer ends with f:{text}: and replace it.
    
    Called when ':' is typed to check if we've completed a fancy pattern.
    Supports escaping:
    - \\f:text: -> won't trigger (escaped pattern)
    - f:text\\:more: -> allows escaped colons within the pattern
    """
    global keyboard_buffer
    
    # Get the buffer as a string
    buffer_str = ''.join(keyboard_buffer)
    
    # Look for f:{text}: pattern at the end, allowing \: within content
    import re
    match = re.search(r'f:((?:[^:\\]|\\:|\\.)+):$', buffer_str)
    
    if match:
        # Check if the pattern is escaped (preceded by backslash)
        match_start = len(buffer_str) - len(match.group(0))
        if match_start > 0 and buffer_str[match_start - 1] == '\\':
            # This is an escaped pattern, remove the escape backslash
            controller.tap(Key.backspace)
            time.sleep(0.01)
            # Update buffer to remove the escape backslash
            keyboard_buffer.pop(-len(match.group(0)) - 1)
            return
        
        # Get the captured text from the pattern and unescape \:
        inner_text = match.group(1).replace('\\:', ':')
        
        # Choose a random style
        style = random.choice(list(STYLES.keys()))
        styled_text = fancy(inner_text, style)
        
        # Calculate how many characters to delete (f: + text + :)
        pattern_len = len(match.group(0))
        
        # Delete the pattern by pressing backspace
        time.sleep(0.05)  # Initial delay before starting backspaces
        for _ in range(pattern_len):
            controller.tap(Key.backspace)
            time.sleep(0.02)  # Increased delay between backspaces
        
        # Type the styled text using Unicode-aware function
        time.sleep(0.05)
        type_unicode(styled_text)
        
        # Clear the matching portion from buffer
        keyboard_buffer[:] = keyboard_buffer[:-pattern_len]
        
        # Trim buffer if too long
        if len(keyboard_buffer) > max_buffer_size:
            keyboard_buffer = keyboard_buffer[-max_buffer_size:]


def process_emoji_patterns(text: str) -> str:
    """Replace ':{text}:' patterns with corresponding emojis.
    
    Only processes if emoji_replacement_enabled is True.
    
    Supports escaping:
    - \\:text: -> literal ":text:" (escaped pattern)
    - :text\\:more: -> allows escaped colons within the pattern
    
    Emoji mapping is defined in the EMOJIS list: [[text, emoji], ...]
    
    Args:
        text: Input text that may contain :{text}: patterns
        
    Returns:
        Text with all emoji patterns replaced with their emoji equivalents
    """
    global emoji_replacement_enabled
    
    if not emoji_replacement_enabled:
        return text
    
    import re
    
    def replace_emoji(match):
        # Check if this match is escaped with backslash
        start_pos = match.start()
        if start_pos > 0 and text[start_pos - 1] == '\\':
            # Remove the escape backslash and return the literal pattern
            return match.group(0)
        
        # Get content and unescape any \: within it
        content = match.group(1).replace('\\:', ':').lower()
        
        # Look for matching emoji
        for emoji_text, emoji_char in EMOJIS:
            if emoji_text.lower() == content:
                return emoji_char
        
        # If no match found, return original pattern
        return match.group(0)
    
    # First, handle escaped patterns by temporarily replacing them
    text = text.replace('\\:', '\x00ESCAPED_COLON\x00')
    
    # Match :content: where content can include escaped colons
    # This regex allows \: within the content (before escaping is restored)
    text = re.sub(r':((?:[^:\\]|\\.)+):', replace_emoji, text)
    
    # Restore escaped colons
    text = text.replace('\x00ESCAPED_COLON\x00', ':')
    
    return text


def check_and_replace_emoji_pattern() -> None:
    """Check if keyboard buffer ends with :{text}: and replace it with emoji.
    
    Only processes if emoji_replacement_enabled is True.
    
    Called when ':' is typed to check if we've completed an emoji pattern.
    Supports escaping:
    - \\:text: -> won't trigger (escaped pattern)
    - :text\\:more: -> allows escaped colons within the pattern
    """
    global keyboard_buffer, emoji_replacement_enabled
    
    if not emoji_replacement_enabled:
        return
    
    # Get the buffer as a string
    buffer_str = ''.join(keyboard_buffer)
    
    # Look for :text: pattern at the end
    import re
    match = re.search(r':((?:[^:\\]|\\.)+):$', buffer_str)
    
    if match:
        # Check if the pattern is escaped (preceded by backslash)
        match_start = len(buffer_str) - len(match.group(0))
        if match_start > 0 and buffer_str[match_start - 1] == '\\':
            # This is an escaped pattern, remove the escape backslash
            controller.tap(Key.backspace)
            time.sleep(0.01)
            # Update buffer to remove the escape backslash
            keyboard_buffer.pop(-len(match.group(0)) - 1)
            return
        
        # Get the captured text from the pattern and unescape \:
        inner_text = match.group(1).replace('\\:', ':').lower()
        
        # Find matching emoji
        emoji_char = None
        for emoji_text, emoji_replacement in EMOJIS:
            if emoji_text.lower() == inner_text:
                emoji_char = emoji_replacement
                break
        
        if emoji_char:
            # Calculate how many characters to delete (:text:)
            pattern_len = len(match.group(0))
            
            # Delete the pattern by pressing backspace
            time.sleep(0.05)  # Initial delay before starting backspaces
            for _ in range(pattern_len):
                controller.tap(Key.backspace)
                time.sleep(0.02)
            
            # Type the emoji using Unicode-aware function
            time.sleep(0.05)
            type_unicode(emoji_char)
            
            # Clear the matching portion from buffer
            keyboard_buffer[:] = keyboard_buffer[:-pattern_len]
            
            # Trim buffer if too long
            if len(keyboard_buffer) > max_buffer_size:
                keyboard_buffer = keyboard_buffer[-max_buffer_size:]


def tap_in_console(keys: str, hold_backtick: bool = True) -> None:
    """Tap individual keys in the game console (backtick-wrapped).
    
    Args:
        keys: String of keys to tap individually (e.g., "ch" taps 'c' then 'h')
        hold_backtick: If True, hold backtick during tapping for speed (default: True)
    """
    if hold_backtick:
        controller.press("`")
        for k in keys:
            controller.tap(k)
        controller.release("`")
    else:
        for k in keys:
            controller.tap("`")
            controller.tap(k)
            controller.tap("`")


def repeat_tap_in_console(key: str, count: int, hold_backtick: bool = True) -> None:
    """Tap a key multiple times in the game console.
    
    Args:
        key: The key to tap
        count: Number of times to tap
        hold_backtick: If True, hold backtick during tapping for speed (default: True)
    """
    if hold_backtick:
        controller.press("`")
        for _ in range(count):
            controller.tap(key)
        controller.release("`")
    else:
        for _ in range(count):
            controller.tap("`")
            controller.tap(key)
            controller.tap("`")


def repeat_tap_pattern_in_console(pattern: str, count: int, hold_backtick: bool = True) -> None:
    """Repeat a pattern of key taps in the game console.
    
    Args:
        pattern: String of keys to tap as a pattern (e.g., "ch" taps 'c' then 'h')
        count: Number of times to repeat the pattern
        hold_backtick: If True, hold backtick during tapping for speed (default: True)
    """
    if hold_backtick:
        controller.press("`")
        for _ in range(count):
            for k in pattern:
                controller.tap(k)
        controller.release("`")
    else:
        for _ in range(count):
            for k in pattern:
                controller.tap("`")
                controller.tap(k)
                controller.tap("`")
automation_process = None
softwallstack_process = None
circle_art_thread: threading.Thread | None = None
braindamage_process = None
tail_process = None
circle_mouse_process = None
custom_reload_spam_process = None
engineer_spam_process = None
circlecrash_process = None
mcrash_process: Process | None = None
overlay_thread: threading.Thread | None = None
overlay_stop_event = threading.Event()
overlay_visible = False
overlay_user_disabled = False
overlay_refresh_ms = 250
arena_current_type = 1

# Keyboard buffer for fancy text auto-expansion
keyboard_buffer = []
max_buffer_size = 100  # Keep last 100 characters
fancy_pattern_active = False

# Shared multiprocessing primitives so worker processes can mirror thread-like behavior.
automation_event = multiprocessing.Event()
engineer_spam_event = multiprocessing.Event()
circle_art_event = threading.Event()  # Changed to threading.Event for faster response time
braindamage_event = multiprocessing.Event()
circle_mouse_event = multiprocessing.Event()
mcrash_event = multiprocessing.Event()
custom_reload_spam_event = multiprocessing.Event()
circle_mouse_radius_value = multiprocessing.Value('i', circle_mouse_radius)
circle_mouse_speed_value = multiprocessing.Value('d', circle_mouse_speed)
circle_mouse_direction_value = multiprocessing.Value('i', circle_mouse_direction)

processes = ["automation", "engineer_spam", "circle_art", "braindamage_working", "tail", "circle_mouse", "softwallstack", "circlecrash", "mcrash", "custom_reload_spam"]
for process in processes:
    exec(f"{process}_process = None")
    exec(f"global {process}_process, {process}_working")

# Add these globals near the top
ctrl6_last_time = 0.0
ctrl6_armed = False
ctrl7_last_time = 0.0
ctrl7_armed = False

# double-lock globals for ctrl+1 (arena size automation)
ctrl1_last_time = 0.0
ctrl1_armed = False

# double-lock globals for q, a, z, y, u, i, g, r
ctrlq_last_time = 0.0
ctrlq_armed = False
ctrla_last_time = 0.0
ctrla_armed = False
ctrlz_last_time = 0.0
ctrlz_armed = False
ctrly_last_time = 0.0
ctrly_armed = False
ctrlu_last_time = 0.0
ctrlu_armed = False
ctrli_last_time = 0.0
ctrli_armed = False
ctrlg_last_time = 0.0
ctrlg_armed = False
ctrlr_last_time = 0.0
ctrlr_armed = False

# NEW: bind circle_art_working to Left Shift when enabled via Ctrl+C
circle_art_shift_bind = False
mcrash_shift_bind = False

def generate_even(low: int = 2, high: int = 1024) -> int:
    return random.choice([i for i in range(low, high + 1) if i % 2 == 0])


# -------- Overlay helpers -------- #
def _overlay_lines() -> list[str]:
    """Build overlay text for long-running macros."""
    dir_text = 'cw' if circle_mouse_direction_value.value >= 0 else 'ccw'
    rate_text = 'âˆž' if arena_auto_rate_limit == 0 else str(arena_auto_rate_limit)
    lines: list[str] = [
        "Arras macro HUD (Ctrl+0 to hide)",
        f"Arena: {'ON' if automation_event.is_set() else 'off'} type={arena_current_type} step={arena_size_step} rate={rate_text}/s",
        f"engineer_spam: {'ON' if engineer_spam_event.is_set() else 'off'}",
        f"circle_art: {'ON' if circle_art_event.is_set() else 'off'} (shift-bind={'ON' if circle_art_shift_bind else 'off'})",
        f"Mcrash: {'ON' if (mcrash_event.is_set() or mcrash_working) else 'off'} (shift-bind={'ON' if mcrash_shift_bind else 'off'})",
        f"custom_reload_spam: {'ON' if custom_reload_spam_event.is_set() else 'off'}",
        f"Brain damage: {'ON' if braindamage_event.is_set() else 'off'}",
        f"Circle mouse: {'ON' if circle_mouse_event.is_set() else 'off'} r={circle_mouse_radius_value.value} v={circle_mouse_speed_value.value:.3f} dir={dir_text}",
        f"Tail: {'ON' if (tail_process is not None and tail_process.is_alive()) else 'off'}",
        f"Softwall: {'ON' if (softwallstack_process is not None and softwallstack_process.is_alive()) else 'off'}",
        f"Armed: arena={'YES' if ctrl1_armed else 'no'} circle={'YES' if ctrl6_armed else 'no'} wall={'YES' if ctrl7_armed else 'no'} arenaclose={'YES' if ctrlr_armed else 'no'}",
        f"Ctrl swap: {'Cmd' if ctrlswap and PLATFORM == 'darwin' else 'Ctrl'}",
    ]
    return lines


def _overlay_worker() -> None:
    """Background TK loop that draws the overlay."""
    global overlay_visible, overlay_user_disabled
    if tk is None:
        print(f"Overlay disabled (tk unavailable): {overlay_import_error}")
        overlay_visible = False
        overlay_user_disabled = True
        return
    
    # On macOS, we need to handle Tkinter carefully. Create a new root window in this thread.
    # This thread is separate from the main thread, so we create a new event loop here.
    root = None
    try:
        # On macOS with tkinter from Homebrew, we need to be in a separate thread from the keyboard listener
        root = tk.Tk()
        root.withdraw()
        root.title("Arras HUD")
        root.overrideredirect(True)
        root.attributes("-topmost", True)
        try:
            root.attributes("-alpha", 0.85)
        except Exception:
            pass
        root.configure(bg="black")

        label = tk.Label(root, text="", fg="#8cff8c", bg="black", font=("Menlo", 12), justify="left")
        label.pack(anchor="w", padx=6, pady=6)
        root.geometry("360x220+20+20")
        root.deiconify()

        def refresh():
            if overlay_stop_event.is_set():
                try:
                    root.destroy()
                except Exception:
                    pass
                return
            try:
                label.configure(text="\n".join(_overlay_lines()))
            except Exception:
                pass
            try:
                root.after(overlay_refresh_ms, refresh)
            except Exception:
                pass

        refresh()
        overlay_visible = True
        try:
            root.mainloop()
        except KeyboardInterrupt:
            pass
        except Exception as e:
            print(f"Overlay mainloop error: {e}")
    except Exception as exc:
        print(f"Overlay disabled (tk init failed): {exc}")
        overlay_visible = False
        overlay_user_disabled = True
    finally:
        overlay_visible = False
        try:
            if root is not None:
                root.destroy()
        except Exception:
            pass


def start_overlay() -> None:
    """Show the overlay unless the user explicitly disabled it."""
    global overlay_thread, overlay_visible, overlay_user_disabled
    if overlay_user_disabled:
        return
    if tk is None:
        print(f"Overlay disabled (tk unavailable): {overlay_import_error}")
        overlay_user_disabled = True
        return
    if overlay_thread is not None and overlay_thread.is_alive():
        overlay_visible = True
        return
    overlay_stop_event.clear()
    overlay_thread = threading.Thread(target=_overlay_worker, daemon=True)
    overlay_thread.start()


def stop_overlay(user_request: bool = True) -> None:
    """Hide the overlay. If user-requested, prevent auto-respawn."""
    global overlay_thread, overlay_visible, overlay_user_disabled
    overlay_stop_event.set()
    if user_request:
        overlay_user_disabled = True
    if overlay_thread is not None:
        overlay_thread.join(timeout=1.5)
        overlay_thread = None
    overlay_visible = False


def ensure_overlay_running(reason: str = "") -> None:
    """start overlay when a long-running macro kicks in (unless user hid it)."""
    if overlay_user_disabled:
        return
    if not overlay_visible:
        start_overlay()
        if reason:
            print(f"overlay on ({reason})")


def toggle_overlay() -> None:
    """User-facing toggle used by hotkeys."""
    global overlay_user_disabled
    if overlay_visible:
        stop_overlay(user_request=True)
        print("overlay off")
    else:
        if tk is None:
            print(f"overlay unavailable (tk not installed): {overlay_import_error}")
            overlay_user_disabled = True
            return
        overlay_user_disabled = False
        start_overlay()
        print("overlay on")

def type_unicode_blocks(hex_string: str | None = None, blocks: int = 3) -> None:
    """Type a sequence of Unicode characters encoded as 4-hex-digit code points.

    Format examples:
        "011156F2C11A" -> U+0111 U+56F2 U+C11A

    Behavior:
      - If hex_string is provided its length must be a multiple of 4; each 4-digit
        group is interpreted as a hexadecimal code point.
      - If hex_string is None, a random sequence of `blocks` code points will be
        generated (default 3 groups => 12 hex digits).
      - Surrogate range (D800-DFFF) and code points > 0x10FFFF are skipped and
        regenerated when auto-generating.
      - Null code point (0000) is replaced with a literal space to avoid issues
        with consumers treating NUL as terminator.
      - Any group that parses but produces an unsupported character will be
        replaced with 'ï¿½'.

    The resulting characters are typed inside backticks to keep existing
    console-open convention consistent with other macros.
    """
    groups: list[str] = []
    if hex_string is not None:
        hex_string = hex_string.strip().upper()
        if len(hex_string) % 4 != 0:
            print("unicode blocks: invalid length (must be multiple of 4)")
            return
        for i in range(0, len(hex_string), 4):
            groups.append(hex_string[i:i+4])
    else:
        while len(groups) < blocks:
            cp = random.randint(0, 0xFFFF)
            # Skip surrogate range and prefer printable BMP subset; allow null rarely
            if 0xD800 <= cp <= 0xDFFF:
                continue
            groups.append(f"{cp:04X}")

    chars: list[str] = []
    for g in groups:
        try:
            cp = int(g, 16)
            if cp == 0:
                # Replace NUL with space to avoid termination semantics
                chars.append(' ')
                continue
            if cp > 0x10FFFF or (0xD800 <= cp <= 0xDFFF):
                chars.append('ï¿½')
                continue
            chars.append(chr(cp))
        except Exception:
            chars.append('ï¿½')

    out = ''.join(chars)
    print(f"unicode blocks: {' '.join(groups)} -> '{out}'")
    type_unicode(out)

def custom_reload_spam(run_event: MpEvent) -> None:
    chars = "kyu"
    controller.press("`")
    while run_event.is_set(): 
        controller.tap("q")
        controller.press("a")
        controller.press("r")
        controller.release("`")
        time.sleep(0.02)
        for char in chars:
            controller.tap(char)
            controller.press("`")
            controller.press("a")
            controller.press("r")
            controller.release("`")
            time.sleep(0.05)
        controller.press("`")
    controller.release("`")

def arena_size_automation(atype: int = 1, run_event: MpEvent | None = None) -> None:
    """Spam $arena commands to resize the arena.
    
    Args:
        atype: Type of automation (1=random, 2=bouncing, 3=inverse bouncing)
        run_event: Multiprocessing event to control when to stop
    """
    global arena_auto_terminate, arena_auto_max_commands, arena_auto_rate_limit, arena_size_step
    
    # Ensure step is even
    step = arena_size_step if arena_size_step % 2 == 0 else 2
    if step != arena_size_step:
        print(f"Warning: arena_size_step must be even, using {step} instead of {arena_size_step}")
    
    # Calculate delay between commands based on rate limit
    cmd_delay = (1.0 / arena_auto_rate_limit) if arena_auto_rate_limit > 0 else 0
    
    print(f"Arena automation type {atype} (step={step})")
    if arena_auto_terminate:
        print(f"Will terminate after {arena_auto_max_commands} commands")
    if arena_auto_rate_limit > 0:
        print(f"Rate limit: {arena_auto_rate_limit} commands/sec (delay: {cmd_delay:.3f}s)")
    
    if run_event is None:
        run_event = multiprocessing.Event()
        run_event.set()

    cmd_count = 0
    
    # C++ fast path: generate all commands at once if terminate is enabled
    if USE_CPP_MACROS and HAS_CPP and arena_auto_terminate:
        import random
        seed = random.randint(0, 2**32 - 1)
        commands = arena_automation_cpp(atype, arena_auto_max_commands, step, seed)
        print(f"Generated {len(commands)} commands using C++ (fast path)")
        for cmd in commands:
            if not run_event.is_set():
                break
            type_with_enter(cmd)
            if cmd_delay > 0:
                time.sleep(cmd_delay)
        return
    
    # Python fallback or continuous mode
    if atype == 1:
        while run_event.is_set():
            if arena_auto_terminate and cmd_count >= arena_auto_max_commands:
                print(f"Reached {arena_auto_max_commands} commands, stopping")
                break
            x = generate_even(2, 1024)
            y = generate_even(2, 1024)
            type_with_enter(f"$arena size {x} {y}")
            cmd_count += 1
            if cmd_delay > 0:
                time.sleep(cmd_delay)
    elif atype == 2:
        # x and y go from 2 to 1024 in steps of arena_size_step
        x = 2
        y = 2
        direction_x = step
        direction_y = step
        while run_event.is_set():
            if arena_auto_terminate and cmd_count >= arena_auto_max_commands:
                print(f"Reached {arena_auto_max_commands} commands, stopping")
                break
            type_with_enter(f"$arena size {x} {y}")
            x += direction_x
            y += direction_y
            # Clamp and reverse direction if out of bounds
            if x > 1024:
                x = 1024
                direction_x = -step
            elif x < 2:
                x = 2
                direction_x = step
            if y > 1024:
                y = 1024
                direction_y = -step
            elif y < 2:
                y = 2
                direction_y = step
            cmd_count += 1
            if cmd_delay > 0:
                time.sleep(cmd_delay)
    elif atype == 3:
        # x goes from 2 to 1024, y goes from 1024 to 2
        x = 2
        y = 1024
        direction_x = step
        direction_y = -step
        while run_event.is_set():
            if arena_auto_terminate and cmd_count >= arena_auto_max_commands:
                print(f"Reached {arena_auto_max_commands} commands, stopping")
                break
            type_with_enter(f"$arena size {x} {y}")
            x += direction_x
            y += direction_y
            # Clamp and reverse direction if out of bounds
            if x > 1024:
                x = 1024
                direction_x = -step
            elif x < 2:
                x = 2
                direction_x = step
            if y > 1024:
                y = 1024
                direction_y = -step
            elif y < 2:
                y = 2
                direction_y = step
            cmd_count += 1
            if cmd_delay > 0:
                time.sleep(cmd_delay)
        
def click_positions(pos_list: list[tuple[float, float]], delay: float = 0.5) -> None:
    mouse = MouseController()
    for x, y in pos_list:
        mouse.position = (int(x), int(y))
        time.sleep(0.02)
        mouse.click(Button.left, 1)
        print(f"Clicked at {x}, {y}")
        time.sleep(delay)

def conq_quickstart() -> None:
    for _ in range(50):
        controller.tap("n")
    controller.type("kyyv")
    mouse = MouseController()
    pos = mouse.position
    click_positions([
        (53.58203125, 948.08984375),
        (167.4765625, 965.703125),
        (166.66796875, 983.11328125),
        (90.53515625, 998.28125),
        (166.09765625, 1014.546875),
        (166.71875, 1031.28125),
        (92.51953125, 1049.71875)
    ], 0)
    mouse.position=pos

def wallcrash() -> None:
    type_in_console("x"*1800)

def nuke() -> None:
    type_in_console("wk"*100)

def shape() -> None:
    type_in_console("f"*5000)

def circlecrash() -> None:
    if USE_CPP_MACROS and HAS_CPP:
        pattern = circlecrash_cpp()
        type_in_console(pattern)
    else:
        repeat_tap_pattern_in_console("ccccccccccccccccccccccccch", 1600) # 40,000 = 25 * 1600

def minicirclecrash() -> None:
    if USE_CPP_MACROS and HAS_CPP:
        pattern = minicirclecrash_cpp()
        type_in_console(pattern)
    else:
        repeat_tap_pattern_in_console("ccccccccccccccccccccccccch", 240) # 6,000 = 25 * 240

def circles(amt: int = 22) -> None:
    if USE_CPP_MACROS and HAS_CPP:
        pattern = circles_cpp(amt)
        type_in_console(pattern)
    else:
        repeat_tap_pattern_in_console("cccccccccch", amt) # 220 = 22 * 20

def walls() -> None:
    if USE_CPP_MACROS and HAS_CPP:
        pattern = walls_cpp()
        type_in_console(pattern)
    else:
        type_in_console("x"*210)

def circle_art(run_event: threading.Event) -> None:
    """Circle art with threading.Event for fast response time."""
    controller.press("`")
    while run_event.is_set():
        controller.tap("c")
        controller.tap("h")
        time.sleep(0.02)
    controller.release("`")

def mcrash(run_event: MpEvent) -> None:
    controller.press("`")
    while run_event.is_set():
        controller.tap("c")
        controller.tap("h")
    controller.release("`")

def tail() -> None:
    controller.press("`")
    mouse = MouseController()
    init = mouse.position
    controller.type("ch"*int(length*33))
    time.sleep(3)
    starting_position = (init[0], init[1]+2*s)
    i2=0
    while i2 < length:
        i=0
        while i < length:
            controller.release("w")
            time.sleep(0.04)
            mouse.position = (init[0]+s, init[1])
            time.sleep(0.04)
            controller.press("w")
            time.sleep(0.04)
            mouse.position = (starting_position[0]+i*s, starting_position[1]+i2*s)
            time.sleep(0.04)
            controller.release("w")
            time.sleep(0.04)
            mouse.position = (init[0]+s, init[1])
            time.sleep(0.04)
            controller.press("w")
            time.sleep(0.04)
            mouse.position = (starting_position[0]+i*s, starting_position[1]+i2*s)
            time.sleep(0.04)
            controller.release("w")
            mouse.position = (init[0]+s, init[1])
            time.sleep(0.04)
            controller.press("w")
            time.sleep(0.04)
            mouse.position = (starting_position[0]+i*s, starting_position[1]+i2*s)
            time.sleep(0.04)
            controller.release("w")
            time.sleep(0.04)
            mouse.position = (init[0]+s, init[1])
            time.sleep(0.04)
            i+=1
        i2+=1
    mouse.position = (init[0], init[1]+2*s)
    i2=0
    time.sleep(0.1)
    mouse.position = (mouse.position[0]-s, mouse.position[1])
    time.sleep(2)
    mouse.position = (mouse.position[0]+s, mouse.position[1])
    time.sleep(0.1)
    down = True
    while i2 < length:
        i=0
        while i < length:
            controller.press("j")
            time.sleep(0.04)
            if down:
                mouse.position = (mouse.position[0], mouse.position[1]+s)
                time.sleep(0.04)
                controller.release("j")
                if i == length-1:
                    mouse.position = (mouse.position[0], mouse.position[1]-s)
                    time.sleep(0.04)
                    controller.press("j")
            else:
                mouse.position = (mouse.position[0], mouse.position[1]-s)
                time.sleep(0.04)
                controller.release("j")
                if i == length-1:
                    mouse.position = (mouse.position[0], mouse.position[1]+s)
                    time.sleep(0.04)
                    controller.press("j")
            i+=1
        i2+=1
        time.sleep(0.04)
        if down:
            mouse.position = (mouse.position[0]+s, mouse.position[1])
        else:
            mouse.position = (mouse.position[0]+s, mouse.position[1])
        time.sleep(0.04)
        controller.release("j")
        down = not down
    controller.release("`")

def brain_damage(run_event: MpEvent) -> None:
    mouse = MouseController()
    while run_event.is_set():
        mouse.position = (random.randint(0, 1710), random.randint(168, 1112))
        time.sleep(0.02)  # Add a small delay to prevent locking up your system

def circle_mouse(
    run_event: MpEvent,
    radius_value: Any,
    speed_value: Any,
    direction_value: Any,
) -> None:
    """Move mouse in circles around a center point. Press '\\' to reverse direction."""

    print("Click anywhere to set the center point for circular motion...")
    temp_points: list[tuple[int, int]] = []

    def temp_click_handler(x: int, y: int, button: Button, pressed: bool) -> None:
        if pressed and button == Button.left and run_event.is_set():
            temp_points.append((x, y))

    temp_listener = MouseListener(on_click=temp_click_handler)
    temp_listener.start()

    start_time = time.time()
    while len(temp_points) == 0 and run_event.is_set() and time.time() - start_time < 10:
        time.sleep(0.01)

    temp_listener.stop()

    if len(temp_points) == 0 or not run_event.is_set():
        print("Circle mouse: No point selected or cancelled")
        return

    center_x, center_y = temp_points[0]
    
    # Calculate rotations per second
    # angle_step_base = 5.0 / max(radius, 10) per iteration
    # Each full rotation = 2Ï€ radians
    # Rotations per second = (angle_step_base / (2Ï€)) / sleep_time
    radius_for_calc = max(radius_value.value, 5)
    speed_for_calc = max(speed_value.value, 0.001)
    angle_step_base = 5.0 / max(radius_for_calc, 10)
    rotations_per_second = (angle_step_base / (2 * math.pi)) / speed_for_calc
    
    print(
        "Circle mouse: center (%s, %s), radius %s, speed %.4f, %.2f rotations/sec"
        % (center_x, center_y, radius_value.value, speed_value.value, rotations_per_second)
    )

    angle = 0.0
    while run_event.is_set():
        radius = max(radius_value.value, 5)
        speed = max(speed_value.value, 0.001)
        direction = 1 if direction_value.value >= 0 else -1

        x = center_x + int(radius * math.cos(angle))
        y = center_y + int(radius * math.sin(angle))
        mouse.position = (x, y)

        angle_step_base = 5.0 / max(radius, 10)
        angle += direction * angle_step_base
        if angle >= 2 * math.pi:
            angle = 0.0

        time.sleep(speed)

def score() -> None:
    type_in_console("n"*20000)

def benchmark(amt: int = 500, mult = 200) -> None: # 500 * 220 = around 100,000 with loss
    shift_pressed = threading.Event()

    def on_press(key: Key | KeyCode | None) -> None:
        if key == Key.shift or key == Key.shift_r:
            shift_pressed.set()
            print("Benchmark stopped by Shift key press.")

    # start the benchmark
    start = time.time()
    if USE_CPP_MACROS and HAS_CPP:
        pattern = benchmark_cpp(amt)
        controller.tap("`")
        controller.type(pattern)
        controller.tap("`")
    else:
        circles(amt)
    print("Press any Shift key to stop the benchmark timer...")
    # start keyboard listener
    with KeyboardListener(on_press=on_press) as listener:
        shift_pressed.wait()  # Wait until Shift is pressed
        listener.stop()
    elapsed = time.time() - start
    print(f"{amt * mult} circles in {round(elapsed*1000, 3)} ms")
    type_with_enter(f"> [{round(elapsed * 1000, 3)}ms] < for {amt * mult} circles", 0.1)
    time.sleep(0.1)
    press_with_delay(Key.enter, 0.1, 2)
    bps = round(amt * mult * (1 / elapsed), 3) if elapsed > 0 else 0
    type_with_enter(f"> [{bps*2}] < inputs/s, > [bps] < circles/s", 0.1)

def score50m() -> None:
    type_in_console("f"*20)

def engineer_spam(run_event: MpEvent) -> None:
    while run_event.is_set():
        controller.tap(",")
        controller.tap("y")
        controller.tap("i")
        controller.press("`")
        controller.press("a")
        controller.press("c")
        controller.release("`")
        controller.press(Key.space)
        time.sleep(0.25)
        controller.release(Key.space)
        controller.press("`")
        controller.press("q")
        controller.release("`")

def circle() -> None:
    tap_in_console("ch")

def softwallstack() -> None:
    walls()
    start = mouse.position
    stackpos = (start[0] - s, start[1] + 4 * s)
    controller.press("`")
    for _ in range(200):
        mouse.position = (start[0] + 2 * s, start[1])
        controller.tap("w")
        time.sleep(0.03)
        controller.press("c")
        time.sleep(0.03)
        controller.release("c")
        time.sleep(0.03)
        controller.tap("y")
        time.sleep(0.03)
        controller.press("w")
        mouse.position = stackpos
        time.sleep(0.03)
        controller.release("w")
    controller.release("`")


def simpletail(amt: int = 20) -> None:
    controller.press("`")
    delay = 0.04
    s2 = 25
    time.sleep(delay)
    for _ in range(amt):
        for _ in range(3):
            circle()
        controller.press("`")
        time.sleep(delay)
        controller.press("c")
        time.sleep(delay*3)
        controller.release("c")
        mouse.position = (mouse.position[0] + s2, mouse.position[1])
        time.sleep(delay * 2.5)
    mouse.position = (mouse.position[0] + 2 * s2, mouse.position[1])
    pos = mouse.position
    mouse.position = (pos[0] + 30, pos[1])
    controller.press("`")
    time.sleep(2)
    mouse.position = (pos[0] - s2, pos[1])
    for _ in range(amt - 1):
        controller.press("j")
        time.sleep(delay)
        mouse.position = (mouse.position[0] - s2, mouse.position[1])
        time.sleep(delay)
        controller.release("j")

def start_arena_automation(atype: int = 1) -> None:
    global automation_process, automation_working
    global arena_current_type
    arena_current_type = int(atype)
    automation_working = True
    automation_event.set()
    ensure_overlay_running("arena")
    if automation_process is None or not automation_process.is_alive():
        automation_process = multiprocessing.Process(
            target=arena_size_automation,
            args=(atype, automation_event),
        )
        automation_process.daemon = True
        automation_process.start()

def start_engineer_spam() -> None:
    global engineer_spam_process
    engineer_spam_event.set()
    ensure_overlay_running("engineer_spam")
    if engineer_spam_process is None or not engineer_spam_process.is_alive():
        engineer_spam_process = multiprocessing.Process(target=engineer_spam, args=(engineer_spam_event,))
        engineer_spam_process.daemon = True
        engineer_spam_process.start()

def start_brain_damage() -> None:
    global braindamage_process
    braindamage_event.set()
    ensure_overlay_running("brain damage")
    if braindamage_process is None or not braindamage_process.is_alive():
        braindamage_process = multiprocessing.Process(target=brain_damage, args=(braindamage_event,))
        braindamage_process.daemon = True
        braindamage_process.start()

def start_tail() -> None:
    global tail_process
    if tail_process is None or not tail_process.is_alive():
        tail_process = multiprocessing.Process(target=tail)
        tail_process.daemon = True
        tail_process.start()
        ensure_overlay_running("tail")

def start_circle_mouse() -> None:
    global circle_mouse_process
    circle_mouse_event.set()
    circle_mouse_radius_value.value = circle_mouse_radius
    circle_mouse_speed_value.value = circle_mouse_speed
    circle_mouse_direction_value.value = circle_mouse_direction
    ensure_overlay_running("circle mouse")
    if circle_mouse_process is None or not circle_mouse_process.is_alive():
        circle_mouse_process = multiprocessing.Process(
            target=circle_mouse,
            args=(
                circle_mouse_event,
                circle_mouse_radius_value,
                circle_mouse_speed_value,
                circle_mouse_direction_value,
            ),
        )
        circle_mouse_process.daemon = True
        circle_mouse_process.start()
        monitor = threading.Thread(target=_monitor_circle_mouse, args=(circle_mouse_process,))
        monitor.daemon = True
        monitor.start()

def stop_circle_mouse() -> None:
    """Gracefully stop the circle mouse process."""
    global circle_mouse_process
    circle_mouse_event.clear()
    if circle_mouse_process is not None:
        try:
            circle_mouse_process.join(timeout=1)
            if circle_mouse_process is not None and circle_mouse_process.is_alive():
                circle_mouse_process.terminate()
        except Exception:
            pass
        circle_mouse_process = None

def _monitor_circle_mouse(proc: Process) -> None:
    """Reset circle-mouse state when its process exits."""
    global circle_mouse_process, circle_mouse_active
    if proc is None:
        return
    proc.join()
    if circle_mouse_process is proc:
        circle_mouse_event.clear()
        circle_mouse_active = False
        circle_mouse_process = None

def start_circle_art() -> None:
    global circle_art_thread, circle_art_working
    circle_art_event.set()
    circle_art_working = True
    ensure_overlay_running("circle_art")
    if circle_art_thread is None or not circle_art_thread.is_alive():
        circle_art_thread = threading.Thread(target=circle_art, args=(circle_art_event,))
        circle_art_thread.daemon = True
        circle_art_thread.start()

def start_softwallstack() -> None:
    global softwallstack_process
    if softwallstack_process is None or not softwallstack_process.is_alive():
        softwallstack_process = multiprocessing.Process(target=softwallstack)
        softwallstack_process.daemon = True
        softwallstack_process.start()
        ensure_overlay_running("softwall")

def start_mcrash() -> None:
    global mcrash_process, mcrash_working
    mcrash_event.set()
    mcrash_working = True
    ensure_overlay_running("mcrash")
    if mcrash_process is None or not mcrash_process.is_alive():
        mcrash_process = multiprocessing.Process(target=mcrash, args=(mcrash_event,))
        mcrash_process.daemon = True
        mcrash_process.start()

def start_custom_reload_spam() -> None:
    global custom_reload_spam_process
    custom_reload_spam_event.set()
    ensure_overlay_running("custom_reload_spam")
    if custom_reload_spam_process is None or not custom_reload_spam_process.is_alive():
        custom_reload_spam_process = multiprocessing.Process(target=custom_reload_spam, args=(custom_reload_spam_event,))
        custom_reload_spam_process.daemon = True
        custom_reload_spam_process.start()

# Normalize modifier detection across platforms
def is_ctrl(k: Key | KeyCode) -> bool:
    """Check if key is Ctrl (or Cmd if ctrlswap=True on macOS)"""
    global ctrlswap
    if not isinstance(k, Key):
        return False
    if ctrlswap and PLATFORM == 'darwin':
        # Use Cmd key on macOS when ctrlswap is enabled
        return k in (Key.cmd, Key.cmd_l, Key.cmd_r)
    else:
        # Use Ctrl key normally
        return k in (Key.ctrl, Key.ctrl_l, Key.ctrl_r)

def is_alt(k: Key | KeyCode) -> bool:
    # On macOS, Option is alt; on other platforms, Alt is alt
    if not isinstance(k, Key):
        return False
    return k in (Key.alt, Key.alt_l, Key.alt_r)

def get_char(key: Key | KeyCode | None) -> str | None:
    """Safely get the char attribute from a key, returns None if not available."""
    if isinstance(key, KeyCode):
        return key.char
    return None

def ocr_text_capture() -> None:
    """Capture text from a screen region defined by two mouse clicks.
    
    User clicks two points to define a rectangle. The text within that rectangle
    is read using OCR and typed out using Enter-text-Enter format.
    
    Workflow:
        1. User presses Ctrl+P to start
        2. User clicks first corner of rectangle (within 10 seconds)
        3. User clicks second corner of rectangle (within 10 seconds)
        4. OCR reads text from the defined rectangle
        5. Text is typed out using type_with_enter()
    """
    if not HAS_OCR:
        print("Error: OCR dependencies not installed. Cannot capture text.")
        print("Install with: pip install mss pytesseract pillow")
        return
    
    print("\nOCR Text Capture: Click two corners to define rectangle...")
    print("(You have 10 seconds for each click)")
    
    clicks = []
    click_timeout = 10  # seconds
    
    def on_click(x: int, y: int, button: Button, pressed: bool) -> bool | None:
        """Capture mouse clicks to define rectangle corners."""
        if pressed and button == Button.left:
            clicks.append((x, y))
            print(f"  Click {len(clicks)}: ({x}, {y})")
            if len(clicks) >= 2:
                return False  # Stop listener
        return None
    
    # Start mouse listener to capture clicks
    try:
        with MouseListener(on_click=on_click) as listener:
            listener.join(timeout=click_timeout * 2)
    except Exception as e:
        print(f"Error capturing clicks: {e}")
        return
    
    if len(clicks) < 2:
        print("Error: Timeout - did not receive 2 clicks")
        return
    
    # Calculate rectangle bounds
    x1, y1 = clicks[0]
    x2, y2 = clicks[1]
    
    # Ensure x1,y1 is top-left and x2,y2 is bottom-right
    left = min(x1, x2)
    top = min(y1, y2)
    right = max(x1, x2)
    bottom = max(y1, y2)
    width = right - left
    height = bottom - top
    
    print(f"Rectangle: ({left}, {top}) to ({right}, {bottom}) [{width}x{height}]")
    
    # Capture the screen region using mss
    try:
        with mss.mss() as sct:
            # Define the region to capture
            region = {
                'left': left,
                'top': top,
                'width': width,
                'height': height
            }
            
            # Capture the region
            screenshot = sct.grab(region)
            
            # Convert to PIL Image
            img = Image.frombytes('RGB', screenshot.size, screenshot.rgb)
            
            # Image preprocessing for better OCR
            original_size = img.size
            
            # Upscale image so both dimensions are at least 1024x768
            target_width, target_height = 1024, 768
            current_width, current_height = img.size
            
            # Calculate scale factors needed for each dimension
            scale_x = target_width / current_width if current_width < target_width else 1
            scale_y = target_height / current_height if current_height < target_height else 1
            
            # Use the larger scale factor to ensure both dimensions meet the minimum
            scale_factor = max(scale_x, scale_y)
            
            if scale_factor > 1:
                new_size = (int(current_width * scale_factor), int(current_height * scale_factor))
                img = img.resize(new_size, Image.Resampling.LANCZOS)
                print(f"Upscaled image from {original_size} to {img.size} ({scale_factor:.2f}x)")
            
            # Convert to grayscale for better OCR
            img = img.convert('L')
            
            # Enhance contrast
            from PIL import ImageEnhance
            enhancer = ImageEnhance.Contrast(img)
            img = enhancer.enhance(2.0)
            
            # Optional: Apply sharpening
            from PIL import ImageFilter
            img = img.filter(ImageFilter.SHARPEN)
            
            print("Reading text from captured region...")
            
            # Perform OCR with optimized configuration
            # --oem 1: Use LSTM neural net mode (best for modern text)
            # --psm 6: Assume uniform block of text
            # Other useful PSM modes:
            #   3: Fully automatic page segmentation (default)
            #   6: Assume a single uniform block of text
            #   11: Sparse text. Find as much text as possible in no particular order
            custom_config = r'--oem 1 --psm 6'
            text = pytesseract.image_to_string(img, config=custom_config)
            
            # Clean up the text (strip whitespace, remove empty lines)
            text = text.strip()
            
            if not text:
                print("No text detected in the selected region")
                print("Trying with different PSM mode (sparse text)...")
                # Try again with sparse text mode
                custom_config = r'--oem 1 --psm 11'
                text = pytesseract.image_to_string(img, config=custom_config)
                text = text.strip()
            
            if not text:
                print("Still no text detected - typing 'No text'")
                type_with_enter("No text")
                return
            
            # Replace newlines with literal \n for single-line output
            text = text.replace('\n', '\\n')
            
            print(f"Detected text ({len(text)} chars):")
            print(f"--- START ---")
            print(text)
            print(f"--- END ---")
            
            # Type the text using the existing helper
            print("Typing text...")
            type_with_enter(text)
            print("Done!")
            
    except Exception as e:
        print(f"Error during OCR text capture: {e}")
        import traceback
        traceback.print_exc()


def scan_screen_for_text(search_text: str, monitor_index: int = 1) -> tuple[bool, tuple[int, int] | None]:
    """Scan the screen for the given text using OCR.
    
    Args:
        search_text: The text to search for on screen (case-insensitive)
        monitor_index: Monitor index to capture (1 = primary, 2 = secondary, etc.)
    
    Returns:
        A tuple of (found: bool, center: tuple[int, int] | None)
        - found: True if text was found, False otherwise
        - center: (x, y) coordinates of the center of the text bounding box, or None if not found
    
    Example:
        found, center = scan_screen_for_text("Hello World")
        if found:
            print(f"Text found at center: {center}")
            # Can use mouse.position = center to move mouse to text
    """
    if not HAS_OCR:
        print("Error: OCR dependencies not installed. Cannot scan screen for text.")
        print("Install with: pip install mss pytesseract pillow")
        return (False, None)
    
    try:
        with mss.mss() as sct:
            # Get the monitor (1-indexed for user, 0-indexed for mss)
            if monitor_index < 1 or monitor_index > len(sct.monitors) - 1:
                print(f"Error: Monitor index {monitor_index} out of range (1 to {len(sct.monitors) - 1})")
                return (False, None)
            
            monitor = sct.monitors[monitor_index]
            
            # Capture the screen
            screenshot = sct.grab(monitor)
            
            # Convert to PIL Image
            img = Image.frombytes('RGB', screenshot.size, screenshot.rgb)
            
            # Perform OCR to get bounding boxes and text
            ocr_data = pytesseract.image_to_data(img, output_type=pytesseract.Output.DICT)
            
            # Search for the text (case-insensitive)
            search_lower = search_text.lower().strip()
            
            # Try to find the text in the OCR results
            for i, text in enumerate(ocr_data['text']):
                if text.lower().strip() == search_lower:
                    # Found exact match
                    x = ocr_data['left'][i]
                    y = ocr_data['top'][i]
                    w = ocr_data['width'][i]
                    h = ocr_data['height'][i]
                    
                    # Calculate center point
                    # Add monitor offset to get absolute screen coordinates
                    center_x = monitor['left'] + x + w // 2
                    center_y = monitor['top'] + y + h // 2
                    
                    return (True, (center_x, center_y))
            
            # Also try pcircle_artial matching (in case search_text is pcircle_art of a larger word)
            for i, text in enumerate(ocr_data['text']):
                if search_lower in text.lower():
                    x = ocr_data['left'][i]
                    y = ocr_data['top'][i]
                    w = ocr_data['width'][i]
                    h = ocr_data['height'][i]
                    
                    center_x = monitor['left'] + x + w // 2
                    center_y = monitor['top'] + y + h // 2
                    
                    return (True, (center_x, center_y))
            
            # Text not found
            return (False, None)
            
    except Exception as e:
        print(f"Error scanning screen for text: {e}")
        return (False, None)

def cleanup_multiprocessing_resources() -> None:
    """Clean up multiprocessing Events and Values to prevent semaphore leaks."""
    global automation_event, engineer_spam_event, circle_art_event, braindamage_event
    global circle_mouse_event, mcrash_event, custom_reload_spam_event
    global circle_mouse_radius_value, circle_mouse_speed_value, circle_mouse_direction_value
    
    # Clear all events first
    for event in [automation_event, engineer_spam_event, circle_art_event, braindamage_event,
                  circle_mouse_event, mcrash_event, custom_reload_spam_event]:
        try:
            event.clear()
        except Exception:
            pass
    
    # Note: multiprocessing.Event and Value objects don't have explicit close methods
    # in the public API, but clearing them helps signal child processes to stop.
    # The actual cleanup happens when the main process exits.

def stopallthreads() -> None:
    global automation_process, engineer_spam_process, braindamage_process
    global tail_process, circle_mouse_process, softwallstack_process, circlecrash_process, mcrash_process, custom_reload_spam_process
    global circle_art_thread
    global automation_working, engineer_spam_working, circle_art_working, braindamage_working, mcrash_working, custom_reload_spam_working
    global circle_mouse_active
    if custom_reload_spam_working:
        controller.tap(Key.space)
    
    # Set all flags to False
    automation_working = False
    engineer_spam_working = False
    circle_art_working = False
    braindamage_working = False
    circle_mouse_active = False
    mcrash_working = False
    custom_reload_spam_working = False
    automation_event.clear()
    engineer_spam_event.clear()
    circle_art_event.clear()
    braindamage_event.clear()
    circle_mouse_event.clear()
    mcrash_event.clear()
    custom_reload_spam_event.clear()
    stop_circle_mouse()
    
    # Terminate all processes and clean up resources
    for proc in [automation_process, engineer_spam_process, braindamage_process,
                 tail_process, softwallstack_process, circlecrash_process, mcrash_process, custom_reload_spam_process]:
        if proc is not None:
            try:
                if proc.is_alive():
                    proc.terminate()
                    proc.join(timeout=1)
                    if proc.is_alive():
                        proc.kill()
                        proc.join(timeout=0.5)
                # Close the process to release resources (semaphores, etc.)
                proc.close()
            except Exception:
                pass

    # Reset all process references
    automation_process = None
    engineer_spam_process = None
    circle_art_thread = None
    braindamage_process = None
    tail_process = None
    circle_mouse_process = None
    softwallstack_process = None
    circlecrash_process = None
    mcrash_process = None
    custom_reload_spam_process = None
    
    # Clean up multiprocessing resources
    cleanup_multiprocessing_resources()
    
    def is_modifier_for_arrow_nudge(k: Key) -> bool:
        """
        Platform-specific:
        - macOS: Option (alt)
        - Windows/Linux: Alt
        - Android: Alt (if supported)
        """
        return is_alt(k)

def on_press(key: Key | KeyCode | None) -> None:
    # Global variables that track double-press states need to be declared
    global ctrl6_last_time, ctrl6_armed, ctrl7_last_time, ctrl7_armed
    global ctrl1_last_time, ctrl1_armed
    global ctrlq_last_time, ctrlq_armed, ctrla_last_time, ctrla_armed
    global ctrlz_last_time, ctrlz_armed, ctrly_last_time, ctrly_armed
    global ctrlu_last_time, ctrlu_armed, ctrli_last_time, ctrli_armed
    global ctrlg_last_time, ctrlg_armed, ctrlr_last_time, ctrlr_armed
    global circle_art_shift_bind, mcrash_shift_bind, arena_current_type
    global automation_working, braindamage_working, circlecrash_working, circle_art_working, engineer_spam_working, mcrash_working
    global ctrl6_last_time, ctrl6_armed, ctrl7_last_time, ctrl7_armed
    global ctrl1_last_time, ctrl1_armed, ctrlg_armed, ctrlg_last_time
    global ctrlq_last_time, ctrlq_armed, ctrla_last_time, ctrla_armed
    global ctrlz_last_time, ctrlz_armed, ctrly_last_time, ctrly_armed
    global ctrlu_last_time, ctrlu_armed, ctrli_last_time, ctrli_armed
    global ctrlr_last_time, ctrlr_armed
    global circle_art_shift_bind, mcrash_shift_bind, ctrlswap
    global circle_mouse_active, circle_mouse_speed, circle_mouse_radius, circle_mouse_direction
    global keyboard_buffer, berserk
    
    try:
        # Workaround for pynput macOS Unicode decode bug - some special keys trigger this
        if key is None:
            return
        if listener_event_injected:
            return
        
        # Track typed characters for fancy pattern detection
        char = get_char(key)
        if char and len(char) == 1:
            keyboard_buffer.append(char)
            if len(keyboard_buffer) > max_buffer_size:
                keyboard_buffer = keyboard_buffer[-max_buffer_size:]
            
            # Apply berserk effect: delete original character and replace with random fancy version
            if berserk and 'ctrl' not in pressed_keys and is_alt(key) is False:
                # Spawn a background thread to handle the replacement
                # This gives the character time to appear before we delete it
                def berserk_replace():
                    try:
                        # Give the character a moment to appear in the application
                        time.sleep(0.02)
                        
                        # Delete the character that was just typed
                        controller.tap(Key.backspace)
                        
                        # Small delay before typing the replacement
                        time.sleep(0.01)
                        
                        # Pick a random style and transform the character
                        style = random.choice(list(STYLES.keys()))
                        table = STYLES.get(style)
                        if table:
                            fancy_char = table.get(char, char)
                        else:
                            fancy_char = char
                        
                        # Type the fancy character
                        type_unicode(fancy_char)
                    except Exception as e:
                        print(f"Berserk replacement error: {e}")
                
                threading.Thread(target=berserk_replace, daemon=True).start()
            
            # Check for fancy pattern completion when ':' is typed
            if char == ':':
                threading.Thread(target=check_and_replace_fancy_pattern, daemon=True).start()
                threading.Thread(target=check_and_replace_emoji_pattern, daemon=True).start()
        elif key == Key.space:
            # Explicitly track space key
            keyboard_buffer.append(' ')
            if len(keyboard_buffer) > max_buffer_size:
                keyboard_buffer = keyboard_buffer[-max_buffer_size:]
        elif key == Key.backspace:
            # Remove last character from buffer on backspace
            if keyboard_buffer:
                keyboard_buffer.pop()
        elif key == Key.enter:
            # Clear buffer on enter (new line/message)
            keyboard_buffer.clear()
        
        # Use Right Shift to disable shift-bound macros (circle_art/mcrash) and circle_mouse spin
        if key == Key.shift_r:
            if circle_art_shift_bind:
                print("circle_art shift-bind off")
                circle_art_shift_bind = False
                circle_art_working = False
                circle_art_event.clear()
            if mcrash_shift_bind:
                print("mcrash shift-bind off")
                mcrash_shift_bind = False
                mcrash_working = False
                mcrash_event.clear()
                if mcrash_process is not None and mcrash_process.is_alive():
                    mcrash_process.terminate()
                    mcrash_process.join(timeout=1)
            if circle_mouse_active:
                print("circle mouse off")
                circle_mouse_active = False
                stop_circle_mouse()
            return
        # Use Right Option to restart all running macros
        elif key == Key.alt_r:
            print("Restarting macros...")
            # Save state of running macros
            was_automation = automation_event.is_set()
            was_engineer = engineer_spam_event.is_set()
            was_circle_art = circle_art_event.is_set()
            was_brain_damage = braindamage_event.is_set()
            was_circle_mouse = circle_mouse_event.is_set()
            was_mcrash = mcrash_event.is_set()
            was_custom_reload = custom_reload_spam_event.is_set()
            was_tail = tail_process is not None and tail_process.is_alive()
            was_softwall = softwallstack_process is not None and softwallstack_process.is_alive()
            
            # Stop everything
            stopallthreads()
            time.sleep(0.1)  # Brief pause to ensure clean shutdown
            print("Macros restarted")
            return
        elif is_ctrl(key):
            pressed_keys.add('ctrl')
        elif is_alt(key):
            pressed_keys.add('alt')
            # print("alt down")  # uncomment to debug
        # Handle actual Cmd key presses (for toggling ctrlswap on macOS)
        elif key in (Key.cmd, Key.cmd_l, Key.cmd_r):
            if ctrlswap:
                pressed_keys.add('ctrl')  # Treat Cmd as Ctrl when ctrlswap is enabled
        elif key in (Key.up, Key.down, Key.left, Key.right):
            if 'alt' in pressed_keys:
                x, y = mouse.position
                if key == Key.up:
                    mouse.position = (x, y - 1)
                elif key == Key.down:
                    mouse.position = (x, y + 1)
                elif key == Key.left:
                    mouse.position = (x - 1, y)
                elif key == Key.right:
                    mouse.position = (x + 1, y)
                return
        # Left Shift: activate circle art OR pause/unpause spam macros (only if already running)
        elif key == Key.shift_l:
            # Priority 1: Circle art shift bind
            if circle_art_shift_bind:
                if not circle_art_working:
                    print("circle_art on")
                circle_art_working = True
                start_circle_art()
            # Priority 2: Engineer spam pause/unpause (only if already running AND currently paused)
            elif engineer_spam_process and engineer_spam_process.is_alive() and not engineer_spam_event.is_set():
                # Only allow resume if process is alive and currently paused
                engineer_spam_event.set()
                print("Engineer spam RESUMED (left shift)")
            # Priority 3: Custom reload spam pause/unpause (only if already running AND currently paused)
            elif custom_reload_spam_process and custom_reload_spam_process.is_alive() and not custom_reload_spam_event.is_set():
                # Only allow resume if process is alive and currently paused
                custom_reload_spam_event.set()
                print("Custom reload spam RESUMED (left shift)")
        elif get_char(key) == "'":
            if 'ctrl' in pressed_keys:
                print("unicode blocks macro")
                type_unicode_blocks("027103B103C1056C1D07005B000BFFFC007F2400000B005D")
        elif get_char(key) == ",":
            if 'ctrl' in pressed_keys:
                time.sleep(0.5)
                controller.type("Â«âˆ‘âˆÂ¯Ë‡â€ âˆ«â€“â„âˆžâˆ†Âµâ€¢â€°ÂªÂ¬âˆ‚Î©â—Šï¬‚Ä±Â®Â»")
        elif get_char(key) == ";":
            if 'ctrl' in pressed_keys:
                time.sleep(0.5)
                controller.type("Â«âˆ‘âˆ«â€“ÂµÂ¬âˆ‚Î©Ä±Â»")
        elif get_char(key) == ".":
            if 'ctrl' in pressed_keys:
                time.sleep(0.5)
                controller.tap(Key.enter)
                time.sleep(0.1)
                controller.type("Â«âˆ‘â«Ê©âˆâ‚»â€–â‚°Â¯Ë‡â€ â‚¢Æ’â‚¥âˆ«Ã¸â€“â„âˆžâ‚¯â€»Ëš")
                time.sleep(0.1)
                controller.tap(Key.enter)
                time.sleep(0.1)
                controller.tap(Key.enter)
                time.sleep(0.1)
                controller.type("âˆ†Âµâ€¢â€°à§»à§²Â©ÃÊ¨â”Ê§ÂªÂ¬Ã¦âˆ‚Î©â‹¾â†ˆâ—Šâ€˜ï¬‚Ä±Â®Ï€â†¹")
                time.sleep(0.1)
                controller.tap(Key.enter)
                time.sleep(0.1)
                controller.tap(Key.enter)
                time.sleep(0.1)
                controller.type("â‚â‹£à¯¹âžÃŸà«±É§âŠ¯Ã¥â›É®â“âŠâ’Ï Ã§ââŒÏÃ‚Í³ÏŸÖÂ»")
                time.sleep(0.1)
                controller.tap(Key.enter)
        elif get_char(key) == "/":
            if 'ctrl' in pressed_keys:
                time.sleep(0.5)
                controller.type("â‚¥á¼†ÈµÉªêœ»Æˆ [ð’ˆ™]")
        elif hasattr(key, 'char') and key.char and key.char=='1':
            if 'ctrl' in pressed_keys:
                now = time.time()
                # double-tap lock: first tap arms, second tap within 5s triggers arena automation
                if ctrl1_armed and (now - ctrl1_last_time <= 5):
                    print("arena automation starting (type 1)")
                    start_arena_automation(atype=1)
                    ctrl1_armed = False
                else:
                    print("arena automation armed - press Ctrl+1 again within 5s to confirm")
                    ctrl1_armed = True
                    ctrl1_last_time = now
        elif hasattr(key, 'char') and key.char and key.char=='v':
            if 'ctrl' in pressed_keys:
                mcrash_shift_bind = True
                mcrash_working = False
                mcrash_event.clear()
                print("toggle mcrash")
        elif hasattr(key, 'char') and key.char and key.char=='2':
            if 'ctrl' in pressed_keys:
                braindamage_working = True
                print("bdmg")
                start_brain_damage()
        elif hasattr(key, 'char') and key.char and key.char=='3':
            if 'ctrl' in pressed_keys:
                circle()
        elif hasattr(key, 'char') and key.char and key.char=='4':
            if 'ctrl' in pressed_keys:
                print("circle square")
                start_tail()
        elif hasattr(key, 'char') and key.char and key.char=='5':
            if 'ctrl' in pressed_keys:
                now = time.time()
                if ctrl6_armed and (now - ctrl6_last_time <= 5):
                    print("death by circle")
                    circlecrash()
                    ctrl6_armed = False
                else:
                    print("crasharmed")
                    ctrl6_armed = True
                    ctrl6_last_time = now
        elif hasattr(key, 'char') and key.char and key.char=='7':
            if 'ctrl' in pressed_keys:
                now = time.time()
                # double-tap lock: first tap arms, second tap within 5s triggers
                if ctrl7_armed and (now - ctrl7_last_time <= 5):
                    print("death by wall")
                    wallcrash()
                    ctrl7_armed = False
                else:
                    print("wallcrash armed")
                    ctrl7_armed = True
                    ctrl7_last_time = now
        elif hasattr(key, 'char') and key.char and key.char=='8':
            if 'ctrl' in pressed_keys:
                print("simple tail")
                simpletail(tailamount)
        elif hasattr(key, 'char') and key.char and key.char=='9':
            if 'ctrl' in pressed_keys:
                print("NUKE GO BRRRRRRRRRR")
                nuke()
        elif hasattr(key, 'char') and key.char and key.char=='f':
            if 'ctrl' in pressed_keys:
                print("shape nuke")
                shape()
        elif hasattr(key, 'char') and key.char and key.char=='n':
            if 'ctrl' in pressed_keys:
                print("score")
                score()
        elif hasattr(key, 'char') and key.char and key.char=='b':
            if 'ctrl' in pressed_keys:
                print("200 circles")
                circles()
        elif hasattr(key, 'char') and key.char and key.char=='w':
            if 'ctrl' in pressed_keys:
                print("200 walls")
                walls()
        elif hasattr(key, 'char') and key.char and key.char=='c':
            if 'ctrl' in pressed_keys:
                # NEW: enable binding to Left Shift instead of starting immediately
                circle_art_shift_bind = True
                circle_art_working = False  # ensure idle until Left Shift is pressed
                circle_art_event.clear()
                print("toggle circle_art")
        elif hasattr(key, 'char') and key.char and key.char=='m':
            if 'ctrl' in pressed_keys:
                print("benchmarking...")
                benchmark()
        elif hasattr(key, 'char') and key.char and key.char=='6':
            if 'ctrl' in pressed_keys:
                print("minicirclecrash")
                minicirclecrash()
        elif hasattr(key, 'char') and key.char and key.char=='e':
            if 'ctrl' in pressed_keys:
                print("engineer_spam")
                engineer_spam_working = True
                start_engineer_spam()
        elif hasattr(key, 'char') and key.char and key.char=='l':
            if 'ctrl' in pressed_keys:
                controller.press("`")
                for _ in range(10):
                    controller.tap("x")
                    time.sleep(0.03)
                controller.release("`")
        elif hasattr(key, 'char') and key.char and key.char=='h': 
            if 'ctrl' in pressed_keys:
                global emoji_replacement_enabled
                emoji_replacement_enabled = not emoji_replacement_enabled
                status = "enabled" if emoji_replacement_enabled else "disabled"
                print(f"emoji replacement {status}")
        elif hasattr(key, 'char') and key.char and key.char=='r':
            if 'ctrl' in pressed_keys:
                now = time.time()
                if ctrlr_armed and (now - ctrlr_last_time <= 5):
                    print("Ctrl+R second press - executing arena close spam")
                    for _ in range(500):
                        type_with_enter("$arena close")
                    ctrlr_armed = False
                else:
                    print("Ctrl+R first press - press again within 5s to confirm arena close spam")
                    ctrlr_last_time = now
                    ctrlr_armed = True
        elif hasattr(key, 'char') and key.char and key.char=='g':
            if 'ctrl' in pressed_keys:
                now = time.time()
                if ctrlg_armed and (now - ctrlg_last_time <= 5):
                    print("ctrl+g executing")
                    controller.press("`")
                    for _ in range(500):
                        controller.tap("f")
                        controller.tap("b")
                        controller.tap("b")
                    for _ in range(20):
                        controller.tap("b")
                    controller.release("`")
                    ctrlg_armed = False
                else:
                    print("ctrl+g armed")
                    ctrlg_armed = True
                    ctrlg_last_time = now
        elif hasattr(key, 'char') and key.char and key.char=='d':
            if 'ctrl' in pressed_keys:
                for _ in range(50):
                    controller.tap("n")
                controller.tap("k")
                controller.press(Key.space)
                time.sleep(0.1)
                controller.release(Key.space)
                controller.tap("y")
                controller.press(Key.space)
                time.sleep(0.1)
                controller.release(Key.space)
                controller.tap("u")
                controller.press(Key.space)
                time.sleep(0.1)
                controller.release(Key.space)
        elif hasattr(key, 'char') and key.char and key.char=='j':
            if 'ctrl' in pressed_keys:
                start = mouse.position
                controller.press("`")
                for _ in range(200):
                    mouse.position = (start[0] + random.randint(-25, 25), start[1] + random.randint(-25, 25))
                    time.sleep(0.01)
                    controller.press("j")
                    mouse.position = (start[0] + random.randint(-25, 25), start[1] + random.randint(-25, 25))
                    time.sleep(0.01)
                    controller.release("j")
                controller.release("`")
                mouse.position = start
        elif hasattr(key, 'char') and key.char and key.char=='s':
            if 'ctrl' in pressed_keys:
                time.sleep(0.1)
                print("quicksetup")
                controller.press("`")
                time.sleep(0.05)
                for _ in range(50):
                    controller.tap("n")
                controller.tap("i")
                controller.press("s")
                for _ in range(20):
                    controller.tap("h")
                time.sleep(0.05)
                controller.tap("m")
                controller.release("s")
                controller.tap("s")
                time.sleep(0.05)
                controller.press("a")
                time.sleep(0.05)
                controller.tap("c")
                controller.tap("w")
                controller.tap("e")
                controller.tap("t")
                controller.tap("o")
                controller.release("a")
                controller.release("`")
        elif hasattr(key, 'char') and key.char and key.char=='q':
            if 'ctrl' in pressed_keys:
                now = time.time()
                if ctrlq_armed and (now - ctrlq_last_time <= 5):
                    print("ctrl+q executing")
                    type_in_console("d" + "fy"*10 + ("f"*50+"h")*2)
                    tap_in_console("dd")
                    controller.press("`")
                    time.sleep(0.1)
                    controller.press("d")
                    controller.release("`")
                    ctrlq_armed = False
                else:
                    print("ctrl+q armed")
                    ctrlq_armed = True
                    ctrlq_last_time = now
        elif hasattr(key, 'char') and key.char and key.char=='a':
            if 'ctrl' in pressed_keys:
                now = time.time()
                if ctrla_armed and (now - ctrla_last_time <= 5):
                    print("ctrl+a executing")
                    type_in_console("d" + "fy"*10 + ("f"*50+"h")*6)
                    tap_in_console("dd")
                    controller.press("`")
                    time.sleep(0.1)
                    controller.press("d")
                    controller.release("`")
                    ctrla_armed = False
                else:
                    print("ctrl+a armed")
                    ctrla_armed = True
                    ctrla_last_time = now
        elif hasattr(key, 'char') and key.char and key.char=='z':
            if 'ctrl' in pressed_keys:
                now = time.time()
                if ctrlz_armed and (now - ctrlz_last_time <= 5):
                    print("ctrl+z executing")
                    type_in_console("d" + "fy"*10 + ("f"*50+"h")*10)
                    tap_in_console("dd")
                    controller.press("`")
                    time.sleep(0.1)
                    controller.press("d")
                    controller.release("`")
                    ctrlz_armed = False
                else:
                    print("ctrl+z armed")
                    ctrlz_armed = True
                    ctrlz_last_time = now
        elif hasattr(key, 'char') and key.char and key.char=='y':
            if 'ctrl' in pressed_keys:
                now = time.time()
                if ctrly_armed and (now - ctrly_last_time <= 5):
                    print("ctrl+y executing")
                    type_in_console("d" + "fy"*10 + ("f"*50+"h")*2)
                    ctrly_armed = False
                else:
                    print("ctrl+y armed")
                    ctrly_armed = True
                    ctrly_last_time = now
        elif hasattr(key, 'char') and key.char and key.char=='x':
            if 'ctrl' in pressed_keys:
                time.sleep(1)
                circle()
                circle()
                time.sleep(0.5)
                controller.press("`")
                start = mouse.position
                # make the mouse go a random angle around start with a radius of 20px
                for i in range(4):
                    for _ in range(100):
                        angle = random.uniform(0, 2 * math.pi)
                        radius = 75
                        x_float = start[0] + radius * math.cos(angle)
                        y_float = start[1] + radius * math.sin(angle)
                        mouse.position = (int(x_float), int(y_float))
                        time.sleep(0.003)
                        controller.tap("f")
                        time.sleep(0.006)
                        controller.press("j")
                        time.sleep(0.006)
                        mouse.position = start
                        time.sleep(0.003)
                        controller.release("j")
                        time.sleep(0.003)
                    mouse.position = (start[0] + 100, start[1])
                    controller.tap("h")
                    time.sleep(0.006)
                controller.release("`")
        elif hasattr(key, 'char') and key.char and key.char=='u':
            if 'ctrl' in pressed_keys:
                now = time.time()
                if ctrlu_armed and (now - ctrlu_last_time <= 5):
                    print("ctrl+u executing")
                    type_in_console("d" + "fy"*10 + ("f"*50+"h")*6)
                    ctrlu_armed = False
                else:
                    print("ctrl+u armed")
                    ctrlu_armed = True
                    ctrlu_last_time = now
        elif hasattr(key, 'char') and key.char and key.char=='i':
            if 'ctrl' in pressed_keys:
                now = time.time()
                if ctrli_armed and (now - ctrli_last_time <= 5):
                    print("ctrl+i executing")
                    type_in_console("d" + "fy"*10 + ("f"*50+"h")*10)
                    ctrli_armed = False
                else:
                    print("ctrl+i armed")
                    ctrli_armed = True
                    ctrli_last_time = now
        elif hasattr(key, 'char') and key.char and key.char=='[':
            if 'ctrl' in pressed_keys:
                repeat_tap_in_console("f", 100)
            else:
                circle_mouse_radius = max(circle_mouse_radius - 5, 5)
                circle_mouse_radius_value.value = circle_mouse_radius
                # Calculate rotations per second
                angle_step = 5.0 / max(circle_mouse_radius, 10)
                rps = (angle_step / (2 * math.pi)) / max(circle_mouse_speed, 0.001)
                print(f"circle radius: {circle_mouse_radius} | {rps:.2f} rotations/sec")
        elif hasattr(key, 'char') and key.char and key.char==']':
            if 'ctrl' in pressed_keys:
                repeat_tap_in_console("f", 500)
            else:
                circle_mouse_radius = min(circle_mouse_radius + 5, 1000)
                circle_mouse_radius_value.value = circle_mouse_radius
                # Calculate rotations per second
                angle_step = 5.0 / max(circle_mouse_radius, 10)
                rps = (angle_step / (2 * math.pi)) / max(circle_mouse_speed, 0.001)
                print(f"circle radius: {circle_mouse_radius} | {rps:.2f} rotations/sec")
        elif hasattr(key, 'char') and key.char and key.char=='o':
            if 'ctrl' in pressed_keys:
                circle_mouse_active = not circle_mouse_active
                if circle_mouse_active:
                    circle_mouse_direction = 1  # reset to default on start
                    circle_mouse_direction_value.value = circle_mouse_direction
                    print(f"circle mouse on (radius: {circle_mouse_radius}, speed: {circle_mouse_speed})")
                    start_circle_mouse()
                else:
                    print("circle mouse off")
                    stop_circle_mouse()
        elif hasattr(key, 'char') and key.char and key.char=='0':
            if 'ctrl' in pressed_keys:
                print("OCR Text Capture - Click two corners to define region")
                threading.Thread(target=ocr_text_capture, daemon=True).start()
        elif hasattr(key, 'char') and key.char and key.char=='\\':
            # Toggle direction of circle while active
            if circle_mouse_active:
                circle_mouse_direction *= -1
                circle_mouse_direction_value.value = circle_mouse_direction
                dir_text = 'clockwise' if circle_mouse_direction == 1 else 'counterclockwise'
                print(f"circle direction -> {dir_text}")
        elif hasattr(key, 'char') and key.char and key.char=='k':
            if 'ctrl' in pressed_keys:
                type_with_enter("$arena team 1", 0.05)
                type_with_enter("$arena spawnpoint 0 0", 0.05)
        elif hasattr(key, 'char') and key.char and key.char=='t':
            if 'ctrl' in pressed_keys:
                print("custom_reload_spam")
                start_custom_reload_spam()
        elif hasattr(key, 'char') and key.char and key.char.lower()=='p':
            # Ctrl+B toggles berserk mode
            if 'ctrl' in pressed_keys:
                berserk = not berserk
                mode_text = "ON" if berserk else "OFF"
                print(f"berserk: {mode_text}")
        if hasattr(key, 'char') and key.char and key.char=='-':
            circle_mouse_speed = min(circle_mouse_speed + 0.001, 0.5)
            circle_mouse_speed_value.value = circle_mouse_speed
            # Calculate rotations per second
            angle_step = 5.0 / max(circle_mouse_radius, 10)
            rps = (angle_step / (2 * math.pi)) / max(circle_mouse_speed, 0.001)
            print(f"circle speed: {round(circle_mouse_speed, 4)} (slower) | {rps:.2f} rotations/sec")
        if hasattr(key, 'char') and key.char and key.char=='=':
            circle_mouse_speed = max(circle_mouse_speed - 0.001, 0.001)
            circle_mouse_speed_value.value = circle_mouse_speed
            # Calculate rotations per second
            angle_step = 5.0 / max(circle_mouse_radius, 10)
            rps = (angle_step / (2 * math.pi)) / max(circle_mouse_speed, 0.001)
            print(f"circle speed: {round(circle_mouse_speed, 4)} (faster) | {rps:.2f} rotations/sec")
    except UnicodeDecodeError:
        # Silently ignore pynput Unicode decode errors (macOS keyboard event bug)
        pass
    except Exception as e:
        print(f"Error: {e}")
    
def on_release(key: Key | KeyCode | None) -> None:
    global circle_art_working, circle_art_shift_bind, mcrash_working, mcrash_shift_bind
    try:
        # Workaround for pynput macOS Unicode decode bug
        if key is None:
            return
        if listener_event_injected:
            return
    except UnicodeDecodeError:
        return
    
    if is_ctrl(key):
        pressed_keys.discard('ctrl')
    elif key in (Key.cmd, Key.cmd_l, Key.cmd_r):
        if ctrlswap:
            pressed_keys.discard('ctrl')  # Release Cmd when ctrlswap is enabled
    elif is_alt(key):
        pressed_keys.discard('alt')
        # print("alt up")  # uncomment to debug
    # NEW: releasing Left/Right Shift stops circle_art_working if binding is enabled
    elif key in (Key.shift_l, Key.shift_r, Key.shift):
        if circle_art_shift_bind and circle_art_working:
            print("circle_art off")
            circle_art_working = False
            circle_art_event.clear()
            # Actually stop the thread (circle_art uses threading, not multiprocessing)
            # Thread will stop when event is cleared
        if mcrash_shift_bind and mcrash_working:
            print("mcrash off")
            mcrash_working = False
            mcrash_event.clear()
            # Actually stop the process
            if mcrash_process is not None and mcrash_process.is_alive():
                mcrash_process.terminate()
                mcrash_process.join(timeout=1)
    # Remove key from pressed_keys (convert to string for set membership)
    if isinstance(key, Key):
        key_str = key.name if hasattr(key, 'name') else str(key)
        if key_str in pressed_keys:
            pressed_keys.discard(key_str)

if __name__ == '__main__':
    # Required for multiprocessing on macOS and Windows
    multiprocessing.set_start_method('spawn', force=True)
    
    print(f"Running on: {PLATFORM}")
    if PLATFORM not in ('darwin', 'linux', 'windows'):
        print(f"Warning: Platform '{PLATFORM}' may have limited support.")
        print("Tested on macOS, Linux (Arch/Debian/Ubuntu), and Windows.")
    
    # Wrapper to suppress pynput Unicode decode errors on macOS
    def safe_on_press(key: Key | KeyCode | None) -> None:
        try:
            on_press(key)
        except UnicodeDecodeError:
            pass  # Ignore Unicode decode errors from special keys
    
    def safe_on_release(key: Key | KeyCode | None) -> None:
        try:
            on_release(key)
        except UnicodeDecodeError:
            pass  # Ignore Unicode decode errors from special keys
    
    listener = RobustKeyboardListener(on_press=safe_on_press, on_release=safe_on_release)
    listener.start()
    
    try:
        while True:
            time.sleep(0.1)
    except KeyboardInterrupt:
        print("\nShutting down...")
    finally:
        # Ensure cleanup happens even on unexpected exit
        listener.stop()
        stopallthreads()
        
        # Clean up overlay thread if running
        if overlay_thread is not None and overlay_thread.is_alive():
            overlay_stop_event.set()
            overlay_thread.join(timeout=1.0)
        
        # Give processes time to fully terminate
        time.sleep(0.2)
"""Automated Arras copypasta typer with optional AI prompt mode.

Unicode Support:
- Uses UTF-16 encoding with proper surrogate pair handling
- All non-ASCII characters (emoji, rare unicode, etc.) are typed via clipboard
- Ensures every character types correctly regardless of encoding complexity
- Pure ASCII text is typed directly for speed
"""

import time, threading, os
import platform
from pathlib import Path
import re
import subprocess
import tempfile
import random
import pyperclip

# Lazy import pynput to avoid slow startup
def _lazy_import_pynput():
    global keyboard, KeyboardController, Key, MouseController, Button
    from pynput import keyboard
    from pynput.keyboard import Controller as KeyboardController, Key
    from pynput.mouse import Controller as MouseController, Button

# Placeholder globals - will 
# be populated by lazy import
keyboard = None
KeyboardController = None
Key = None
MouseController = None
Button = None

def get_ollama_models():
    """Fetch list of available Ollama models from 'ollama list' command"""
    try:
        result = subprocess.run(
            ['ollama', 'list'],
            capture_output=True,
            text=True,
            timeout=10
        )
        
        if result.returncode == 0:
            lines = result.stdout.strip().split('\n')
            # Skip header line and parse model names
            models = []
            for line in lines[1:]:  # Skip first line (header)
                if line.strip():
                    # Extract first column (NAME)
                    name = line.split()[0]
                    models.append(name)
            
            if models:
                print(f"Found {len(models)} Ollama models")
                return models
            else:
                print("No models found, using fallback list")
                return ["deepseek-r1-14b-16k:latest"]
        else:
            print(f"Error running 'ollama list': {result.stderr}")
            return ["deepseek-r1-14b-16k:latest"]
    except FileNotFoundError:
        print("Warning: ollama command not found. Install Ollama to use AI mode.")
        return []
    except Exception as e:
        print(f"Error fetching Ollama models: {e}")
        return ["deepseek-r1-14b-16k:latest"]

models = get_ollama_models()

# Detect platform
PLATFORM = platform.system().lower()  # 'darwin' (macOS), 'linux', 'windows'
print(f"Arras Copypasta running on: {PLATFORM}")

# Platform notes
if PLATFORM not in ('darwin', 'linux', 'windows'):
    print(f"Warning: Platform '{PLATFORM}' may have limited support.")
    print("Tested on macOS, Linux (Arch/Debian/Ubuntu), and Windows.")

#each line should be 60 chars long
global ids, copypastaing, controller, thread, filepaths, current_chars, current_percent, is_ai_mode, listener
is_ai_mode = False
listener = None

# Use pathlib for cross-platform file paths
# Script dir holds automation scripts; copypastas live one level up
script_dir = Path(__file__).resolve().parent
repo_root = script_dir.parent
copypasta_dir = repo_root / 'copypastas'

# Ensure copypastas directory exists
if not copypasta_dir.exists():
    print(f"Warning: copypastas directory not found at {copypasta_dir}")
    print("Creating directory...")
    copypasta_dir.mkdir(parents=True, exist_ok=True)

ids = []
filepaths = []
for fpath in copypasta_dir.glob('*.txt'):
    if fpath.is_file():
        ids.append(fpath.stem)  # Get filename without extension
        filepaths.append(str(fpath))  # Convert Path to string for compatibility
copypastaing = False
thread = None
controller = None  # Will be initialized on first use
current_chars = 0
current_percent = 0
controller_typing = False  # Flag to ignore synthetic keypresses

def _ensure_controller():
    """Initialize pynput components on first use"""
    global controller
    if controller is None:
        _lazy_import_pynput()
        controller = KeyboardController()

def _ensure_key():
    """Ensure Key class is available"""
    if Key is None:
        _lazy_import_pynput()

def interruptible_sleep(duration):
    global copypastaing
    interval = 0.05  # 50ms
    elapsed = 0
    while copypastaing and elapsed < duration:
        time.sleep(interval)
        elapsed += interval

def split_sentences(filepath, max_length=60, disable_space_breaking=False, disable_line_breaks=False):
    sentences = []
    with open(filepath, encoding='utf-8') as file:
        lines = file.readlines()
        
        # If disable_line_breaks is True, merge all lines into one continuous text
        if disable_line_breaks:
            lines = [' '.join(line.rstrip() for line in lines if line.strip())]
        
        for line in lines:
            line = line.rstrip()
            if not line.strip():
                continue
            if disable_space_breaking:
                # Break only at max_length, preserving all characters including spaces
                buffer = line
                while len(buffer) > max_length:
                    chunk = buffer[:max_length]
                    sentences.append(chunk)
                    #print(f"[DEBUG] No-space chunk ({len(chunk)} chars): '{chunk}'")  # Debug
                    buffer = buffer[max_length:]
                if buffer:
                    sentences.append(buffer)
                    #print(f"[DEBUG] No-space final ({len(buffer)} chars): '{buffer}'")  # Debug
            else:
                # Break at spaces, but always start a new sentence at each line
                words = line.split()
                buffer = ""
                for word in words:
                    if buffer:
                        if len(buffer) + 1 + len(word) > max_length:
                            sentences.append(buffer)
                            #print(f"[DEBUG] Space-broken chunk ({len(buffer)} chars): '{buffer}'")  # Debug
                            buffer = word
                        else:
                            buffer += " " + word
                    else:
                        if len(word) > max_length:
                            sentences.append(word[:max_length])
                            #print(f"[DEBUG] Long word chunk ({len(word[:max_length])} chars): '{word[:max_length]}'")  # Debug
                            buffer = word[max_length:]
                        else:
                            buffer = word
                if buffer:
                    sentences.append(buffer)
                    #print(f"[DEBUG] Space-broken final ({len(buffer)} chars): '{buffer}'")  # Debug
    return sentences

pause_event = threading.Event()
pause_event.set()  # Start as running

def has_complex_unicode(text):
    """Check if text contains complex unicode (Japanese, Chinese, etc.) that pynput can't handle"""
    for char in text:
        code = ord(char)
        # Japanese hiragana, katakana, kanji
        if (0x3040 <= code <= 0x309F or  # Hiragana
            0x30A0 <= code <= 0x30FF or  # Katakana
            0x4E00 <= code <= 0x9FFF or  # CJK Unified Ideographs
            0x3400 <= code <= 0x4DBF or  # CJK Extension A
            0x20000 <= code <= 0x2A6DF or # CJK Extension B
            0x2A700 <= code <= 0x2B73F or # CJK Extension C
            0x2B740 <= code <= 0x2B81F or # CJK Extension D
            0x2B820 <= code <= 0x2CEAF or # CJK Extension E
            0xF900 <= code <= 0xFAFF or  # CJK Compatibility Ideographs
            0x2F800 <= code <= 0x2FA1F):  # CJK Compatibility Ideographs Supplement
            return True
        # Other complex scripts (Arabic, Hebrew, Thai, etc.)
        if (0x0600 <= code <= 0x06FF or  # Arabic
            0x0590 <= code <= 0x05FF or  # Hebrew
            0x0E00 <= code <= 0x0E7F or  # Thai
            0x1100 <= code <= 0x11FF or  # Hangul Jamo
            0xAC00 <= code <= 0xD7AF):   # Hangul Syllables
            return True
    return False

def safe_type(text):
    """Type text while flagging to ignore synthetic keypresses.
    Uses UTF-16 encoding with proper surrogate pair handling.
    Always uses clipboard for non-ASCII to ensure every character types correctly.
    """
    global controller_typing
    _ensure_controller()
    _ensure_key()
    controller_typing = True
    
    try:
        # Check if text is pure ASCII
        try:
            text.encode('ascii')
            is_pure_ascii = True
        except UnicodeEncodeError:
            is_pure_ascii = False
        
        if not is_pure_ascii:
            # For any non-ASCII text, use clipboard with UTF-16 encoding for maximum compatibility
            old_clipboard = pyperclip.paste()  # Save current clipboard
            try:
                # Encode to UTF-16 to handle surrogates properly, then copy to clipboard
                # This ensures all characters including emoji and rare unicode are preserved
                pyperclip.copy(text)  # Copy text to clipboard (preserves UTF-16 surrogates)
                time.sleep(0.05)  # Small delay for clipboard
                # Paste using Cmd+V (macOS) or Ctrl+V (Windows/Linux)
                if PLATFORM == 'darwin':
                    controller.press(Key.cmd)
                else:
                    controller.press(Key.ctrl)
                controller.press('v')
                controller.release('v')
                if PLATFORM == 'darwin':
                    controller.release(Key.cmd)
                else:
                    controller.release(Key.ctrl)
                time.sleep(0.05)
            finally:
                # Restore old clipboard after a short delay
                time.sleep(0.1)
                pyperclip.copy(old_clipboard)
        else:
            # Use direct typing only for pure ASCII (no surrogates needed)
            controller.type(text)
    finally:
        controller_typing = False

def safe_tap(key):
    """Tap key while flagging to ignore synthetic keypresses"""
    global controller_typing
    _ensure_controller()
    controller_typing = True
    controller.tap(key)
    controller_typing = False

def replace_emojis(text):
    # Emoji unicode ranges
    emoji_pattern = re.compile(
        "["
        "\U0001F600-\U0001F64F"  # emoticons
        "\U0001F300-\U0001F5FF"  # symbols & pictographs
        "\U0001F680-\U0001F6FF"  # transport & map symbols
        "\U0001F700-\U0001F77F"  # alchemical symbols
        "\U0001F780-\U0001F7FF"  # geometric shapes extended
        "\U0001F800-\U0001F8FF"  # supplemental arrows-c
        "\U0001F900-\U0001F9FF"  # supplemental symbols & pictographs
        "\U0001FA00-\U0001FA6F"  # chess symbols
        "\U0001FA70-\U0001FAFF"  # symbols & pictographs extended-a
        "\U00002702-\U000027B0"  # dingbats
        "\U000024C2-\U0001F251"  # enclosed characters
        "]+",
        flags=re.UNICODE
    )
    return emoji_pattern.sub(':e:', text)

def query_model(model, prompt, display_prompt=None):
    """Query Ollama's {model} model and return the response"""
    # Ensure pynput is loaded before using Key
    _ensure_key()
    
    try:
        # Use display_prompt for in-game typing, or full prompt if not provided
        if display_prompt is None:
            display_prompt = prompt
        
        print(f"Querying {model}...")
        time.sleep(2)  # Wait before typing in-game
        
        # Type the prompt in quotations (only display_prompt, not full context)
        safe_tap(Key.enter)
        interruptible_sleep(0.75)
        safe_type(f'Sending prompt: "{display_prompt}"')
        interruptible_sleep(0.75)
        safe_tap(Key.enter)
        interruptible_sleep(0.75)
        safe_tap(Key.enter)
        interruptible_sleep(0.75)
        safe_type(f"Waiting for response from {model}...")
        interruptible_sleep(0.75)
        safe_tap(Key.enter)
        interruptible_sleep(5)
        
        # Start ollama subprocess without waiting (use full prompt with context)
        process = subprocess.Popen(
            ['ollama', 'run', model, prompt],
            stdout=subprocess.PIPE,
            stderr=subprocess.PIPE,
            text=True
        )
        
        # Wait with periodic messages
        start_time = time.time()
        last_message_time = start_time
        
        while process.poll() is None:  # While process is still running
            current_time = time.time()
            elapsed = current_time - start_time
            
            # After 10 seconds, type a message every 5 seconds
            if elapsed >= 10 and (current_time - last_message_time) >= random.uniform(20, 30):
                elapsed_ms = int(elapsed * 1000)
                msg = f"Model is thinking... ( > {round(elapsed_ms/1000, 3)}s < passed )"
                safe_tap(Key.enter)
                interruptible_sleep(0.75)
                safe_type(msg)
                interruptible_sleep(0.75)
                safe_tap(Key.enter)
                interruptible_sleep(0.75)
                last_message_time = current_time
            
            time.sleep(0.75)  # Check every 0.75 seconds
            
            # Timeout after 300 seconds
            if elapsed > 300:
                process.terminate()
                time.sleep(1)  # Give it a second to terminate gracefully
                if process.poll() is None:
                    process.kill()  # Force kill if still running
                raise subprocess.TimeoutExpired(process.args, 300)
        
        # Get results
        stdout, stderr = process.communicate()
        
        if process.returncode == 0:
            response = stdout.strip()
            print(f"Received response ({len(response)} chars)")
            safe_tap(Key.enter)
            interruptible_sleep(0.75)
            safe_type(f"Response received > [{len(response)} chars] < ; processing...")
            interruptible_sleep(0.75)
            safe_tap(Key.enter)
            interruptible_sleep(5)
            return response
        else:
            error_msg = f"Error querying {model}: {stderr}"
            print(error_msg)
            safe_tap(Key.enter)
            interruptible_sleep(0.75)
            safe_type(f"Error: Failed to get response from {model}")
            interruptible_sleep(0.75)
            safe_tap(Key.enter)
            interruptible_sleep(0.75)
            return None
    except subprocess.TimeoutExpired:
        print(f"Timeout waiting for response from {model}")
        safe_tap(Key.enter)
        interruptible_sleep(0.75)
        safe_type(f"Error: Timeout waiting for response from {model}")
        interruptible_sleep(0.75)
        safe_tap(Key.enter)
        interruptible_sleep(0.75)
        return None
    except FileNotFoundError:
        print("Error: ollama command not found. Is Ollama installed?")
        safe_tap(Key.enter)
        interruptible_sleep(0.75)
        safe_type("Error: ollama not found. Install Ollama first.")
        interruptible_sleep(0.75)
        safe_tap(Key.enter)
        interruptible_sleep(0.75)
        return None
    except Exception as e:
        print(f"Unexpected error: {e}")
        safe_tap(Key.enter)
        interruptible_sleep(0.75)
        safe_type(f"Error: {str(e)}")
        interruptible_sleep(0.75)
        safe_tap(Key.enter)
        interruptible_sleep(0.75)
        return None

def copypasta(id, prepare=False, disable_space_breaking=False, disable_finish_text=False, disable_line_breaks=False, custom_text=None):
    time.sleep(2)
    global ids, copypastaing, filepaths, controller, pause_event, current_chars, current_percent, controller_typing, is_ai_mode
    
    # Ensure pynput is loaded before using Key
    _ensure_key()
    
    copypastaing = True
    is_ai_mode = custom_text is not None
    start = time.time()
    
    # Special handling for ad_news - random line mode
    if id == "ad_news" and custom_text is None:
        index = ids.index(id)
        filepath = filepaths[index]
        if not os.path.exists(filepath):
            print(f"File not found: {filepath}")
            copypastaing = False
            return
        
        # Read all lines from file
        with open(filepath, encoding='utf-8') as f:
            all_lines = [line.rstrip() for line in f.readlines() if line.strip()]
        
        if not all_lines:
            print(f"No lines found in {filepath}")
            copypastaing = False
            return
        
        print(f"ad_news mode: {len(all_lines)} lines available. Press Esc to stop.")
        
        if prepare:
            path_obj = Path(filepath)
            source_text = f"[.../{path_obj.name}]"
            
            safe_tap(Key.enter)
            interruptible_sleep(0.1)
            safe_type(f"Arras Copypasta Utility [ACU] > v02.04.11-beta.4 < loading")
            interruptible_sleep(0.1)
            for _ in range(2):
                safe_tap(Key.enter)
                interruptible_sleep(0.1)
            safe_type(f"Source: > {source_text} < | ad_news random mode | > {len(all_lines)} lines <")
            interruptible_sleep(0.1)
            safe_tap(Key.enter)
            interruptible_sleep(10)
        
        # Loop indefinitely, picking random lines
        while copypastaing:
            # Wait here if paused
            pause_event.wait()
            
            # Pick a random line
            line = random.choice(all_lines)
            
            # Split the line into sentences following the normal rules
            sentences = []
            max_length = 60
            
            if disable_space_breaking:
                # Break only at max_length, preserving all characters including spaces
                buffer = line
                while len(buffer) > max_length:
                    chunk = buffer[:max_length]
                    sentences.append(chunk)
                    buffer = buffer[max_length:]
                if buffer:
                    sentences.append(buffer)
            else:
                # Break at spaces
                words = line.split()
                buffer = ""
                for word in words:
                    if buffer:
                        if len(buffer) + 1 + len(word) > max_length:
                            sentences.append(buffer)
                            buffer = word
                        else:
                            buffer += " " + word
                    else:
                        if len(word) > max_length:
                            sentences.append(word[:max_length])
                            buffer = word[max_length:]
                        else:
                            buffer = word
                if buffer:
                    sentences.append(buffer)
            
            # Type each sentence
            for sentence in sentences:
                if not copypastaing:
                    break
                pause_event.wait()  # Check pause before each sentence
                safe_tap(Key.enter)
                interruptible_sleep(0.1)
                sentence_no_emoji = replace_emojis(sentence)
                safe_type(sentence_no_emoji)
                interruptible_sleep(0.1)
                safe_tap(Key.enter)
                interruptible_sleep(3)
            
            # Small delay before next random line
            if copypastaing:
                interruptible_sleep(1)
        
        print("ad_news random mode stopped")
        if not disable_finish_text:
            safe_tap(Key.enter)
            interruptible_sleep(0.1)
            safe_type("ad_news random mode stopped")
            interruptible_sleep(0.1)
            safe_tap(Key.enter)
        
        copypastaing = False
        return
    
    # Handle custom text (AI-generated) vs file-based copypasta
    if custom_text is not None:
        # AI mode: split custom text directly at 60 chars
        sentences = []
        max_length = 60  # Always 60 chars in AI mode
        text = custom_text
        if not disable_line_breaks:
            lines = text.split('\n')
            for line in lines:
                if line.strip() == '':
                    continue
                while len(line) > max_length:
                    if not disable_space_breaking:
                        split_idx = line.rfind(' ', 0, max_length)
                        if split_idx == -1:
                            split_idx = max_length
                    else:
                        split_idx = max_length
                    sentences.append(line[:split_idx])
                    line = line[split_idx:].lstrip()
                if line:
                    sentences.append(line)
        else:
            while len(text) > max_length:
                if not disable_space_breaking:
                    split_idx = text.rfind(' ', 0, max_length)
                    if split_idx == -1:
                        split_idx = max_length
                else:
                    split_idx = max_length
                sentences.append(text[:split_idx])
                text = text[split_idx:].lstrip()
            if text:
                sentences.append(text)
    elif id in ids:
        # File mode: read from copypasta file
        index = ids.index(id)
        filepath = filepaths[index]
        if not os.path.exists(filepath):
            print(f"File not found: {filepath}")
            copypastaing = False
            return
        sentences = split_sentences(filepath, disable_space_breaking=disable_space_breaking, disable_line_breaks=disable_line_breaks)
    else:
        print(f"Invalid id: {id}")
        copypastaing = False
        return
    
    leng = sum(len(replace_emojis(s)) for s in sentences)
    pos = 0
    
    if prepare:
        end = time.time()
        if custom_text is not None:
            # AI mode
            source_text = "AI Response (deepseek-r1:14b)"
            size_kb = len(custom_text.encode('utf-8')) / 1024
        else:
            # File mode
            path_obj = Path(filepath)
            source_text = f"[.../{path_obj.name}]"
            file_size_bytes = os.path.getsize(filepath)
            size_kb = file_size_bytes / 1024
        
        safe_tap(Key.enter)
        interruptible_sleep(0.1)
        safe_type(f"Arras Copypasta Utility [ACU] > v02.04.11-beta.4 < loading")
        interruptible_sleep(0.1)
        for _ in range(2):
            safe_tap(Key.enter)
            interruptible_sleep(0.1)
        safe_type(f"Source: > {source_text} < | Loaded > {leng} chars <")
        interruptible_sleep(0.1)
        for _ in range(2):
            safe_tap(Key.enter)
            interruptible_sleep(0.1)
        safe_type(f"Size: > [{size_kb:.2f}KB] < | Time taken > [{round((end-start)*1000, 3)}ms] <")
        interruptible_sleep(0.1)
        safe_tap(Key.enter)
        interruptible_sleep(10)
    
    endf = False
    for sentence in sentences:
        if not copypastaing:
            break
        if not is_ai_mode:
            pause_event.wait()  # Wait here if paused (only for file mode)
        safe_tap(Key.enter)
        if is_ai_mode:
            time.sleep(0.1)
        else:
            interruptible_sleep(0.1)
        sentence_no_emoji = replace_emojis(sentence)
        safe_type(sentence_no_emoji)
        if is_ai_mode:
            time.sleep(0.1)
        else:
            interruptible_sleep(0.1)
        safe_tap(Key.enter)
        pos += len(sentence_no_emoji)
        current_chars = pos
        current_percent = (current_chars / leng) * 100 if leng > 0 else 0
        if is_ai_mode:
            time.sleep(3)
        else:
            interruptible_sleep(3)
        endf = True
    
    # After loop ends, print/type summary
    chars_typed = pos if pos < leng else leng
    percent_typed = (chars_typed / leng) * 100 if leng > 0 else 0
    if not endf:  # Force stop by Escape
        print(f"Forced stop at > [{chars_typed}] characters [{percent_typed:.2f}%]")
        safe_tap(Key.enter)
        interruptible_sleep(0.1)
        safe_type(f"Forced stop at > [{chars_typed}] characters [{percent_typed:.2f}%]")
        interruptible_sleep(0.1)
    else:
        if not disable_finish_text:
            print(f"Copypasta of > [{leng}] characters < finished")
            safe_tap(Key.enter)
            interruptible_sleep(0.1)
            safe_type(f"Copypasta of > [{leng}] characters < finished")
            interruptible_sleep(0.1)
        else:
            print(f"Copypasta of > [{leng}] characters < finished (without finish text)")
    
    if not disable_finish_text:
        safe_tap(Key.enter)
        interruptible_sleep(0.1)
        time.sleep(3.5)
        safe_tap(Key.enter)
        interruptible_sleep(0.1)
        print(f"Time taken: > [{round(1000*(time.time()-start), 3)}ms] <")
        safe_type(f"Time taken: > [{round(1000*(time.time()-start), 3)}ms] <")
        interruptible_sleep(0.1)
        safe_tap(Key.enter)
        interruptible_sleep(0.1)
    
    copypastaing = False

def on_press(key):
    global copypastaing, pause_event, current_chars, current_percent, controller, controller_typing, is_ai_mode
    try:
        # Ignore synthetic keypresses from the controller
        if controller_typing:
            return
        
        if key == keyboard.Key.esc:
            copypastaing = False
        elif hasattr(key, 'char') and key.char == 'p' and copypastaing:
            # Allow pausing in file mode (including ad_news), but not AI mode
            if not is_ai_mode:
                if pause_event.is_set():
                    pause_event.clear()
                else:
                    pause_event.set()
    except UnicodeDecodeError:
        print("UnicodeDecodeError: Non-standard key (emoji?) pressed. Ignored.")

# Initialize keyboard listener immediately
if listener is None:
    _lazy_import_pynput()
    listener = keyboard.Listener(on_press=on_press)
    listener.start()
    print("Keyboard listener started. Press Esc to stop copypasta.")

while True:
    mode_input = input("Mode (copypasta/ai) > ").strip().lower()
    
    if mode_input == 'ai':
        # AI prompt mode - model selection
        print("\nAvailable models:")
        for item in models:
            print(str(models.index(item) + 1) + ": " + item)
        
        model_input = input(f"Select model (1-{len(models)}) > ").strip()

        try:
            model = models[int(model_input)-1]
        except Exception:
            print("Invalid selection, defaulting to 'deepseek-r1-8b-16k'")
            model = 'deepseek-r1-8b-16k'
        
        prompt_input = input(f"Enter prompt for {model} > ").strip()
        if not prompt_input:
            print("Empty prompt, skipping")
            continue
        
        use_context_input = input("Use context from aacontext.txt? (true/false) > ").strip().lower()
        use_context = use_context_input == 'true'
        
        # Load context if requested
        full_prompt = prompt_input
        if use_context:
            context_path = script_dir / 'aacontext.txt'
            if context_path.exists():
                with open(context_path, 'r', encoding='utf-8') as f:
                    context = f.read().strip()
                full_prompt = f"{context}\n\n{prompt_input}"
                print(f"Context loaded from aacontext.txt ({len(context)} chars)")
            else:
                print(f"Warning: aacontext.txt not found at {context_path}")
                print("Proceeding without context...")
        
        disable_finish_text_input = input("Disable finish text? (true/false) > ").strip().lower()
        disable_finish_text = disable_finish_text_input == 'true'
        
        # AI mode always: no prepare mode, enable space breaking, enable line breaks
        prepare = False
        disable_space_breaking = False
        disable_line_breaks = False
        
        if copypastaing:
            print("Already copypastaing, wait until finished or press Escape to stop")
            continue
        
        # Get AI response (use full_prompt for actual query, but only show prompt_input in-game)
        ai_response = query_model(model, full_prompt, display_prompt=prompt_input)
        if ai_response is None:
            print("Failed to get AI response, skipping")
            continue
        
        # Save to temporary file and type it
        with tempfile.NamedTemporaryFile(mode='w', suffix='.txt', delete=False, encoding='utf-8') as tmp:
            tmp.write(ai_response)
            tmp_path = tmp.name
        
        try:
            thread = threading.Thread(
                target=copypasta, 
                args=('_ai_temp', prepare, disable_space_breaking, disable_finish_text, disable_line_breaks),
                kwargs={'custom_text': ai_response}
            )
            thread.start()
        finally:
            # Clean up temp file after thread starts
            Path(tmp_path).unlink(missing_ok=True)
    
    else:
        # Original copypasta file mode
        id_input = input("Enter copypasta id > ").strip()
        prepare_input = input("Prepare mode? (true/false) > ").strip().lower()
        disable_space_breaking_input = input("Disable space breaking? (true/false) > ").strip().lower()
        disable_line_breaks_input = input("Disable line breaks? (true/false) > ").strip().lower()
        disable_finish_text_input = input("Disable finish text? (true/false) > ").strip().lower()

        prepare = prepare_input == 'true'
        disable_space_breaking = disable_space_breaking_input == 'true'
        disable_line_breaks = disable_line_breaks_input == 'true'
        disable_finish_text = disable_finish_text_input == 'true'

        if id_input in ids:
            if copypastaing:
                print("Already copypastaing, wait until finished or press Escape to stop")
            else:
                thread = threading.Thread(target=copypasta, args=(id_input, prepare, disable_space_breaking, disable_finish_text, disable_line_breaks))
                thread.start()
        else:
            print("Invalid id, available ids are:")
            print(ids)
            print("Using 'char' as default id for testing purposes")
            if copypastaing:
                print("Already copypastaing, wait until finished or press Escape to stop")
            else:
                thread = threading.Thread(target=copypasta, args=('char', prepare, disable_space_breaking, disable_finish_text, disable_line_breaks))
                thread.start()
    
    done = False
    while not done:
        if thread is not None and not thread.is_alive():
            done = True
        time.sleep(0.1)
// Arras.io Ad News Copypasta Bot
// Paste this into browser console to run
// Press Ctrl+C in console to stop

(function() {
  'use strict';

// Ensure window.addEventListener hooks are installed for input simulation
let windowListener = window.addEventListener;
window.addEventListener = function(...args) {
  let type = args[0];
  if (type === "keydown" || type === "keyup" || type === "mousedown" || type === "mouseup") {
    let callback = args[1];
    args[1] = function(event) {
      return callback.call(this, {
        isTrusted: true,
        key: event.key,
        code: event.code,
        preventDefault: function(){}
      });
    };
  }
  return windowListener.apply(this, args);
}

function keyEvent(key, type) {
  try {
    const eventType = type ? "keydown" : "keyup";
    const eventInit = {
      key: key,
      code: key,
      keyCode: key === "Enter" ? 13 : 0,
      which: key === "Enter" ? 13 : 0,
      bubbles: true,
      cancelable: true,
      composed: true
    };
    
    // Find canvas element (game usually listens on canvas)
    const canvas = document.querySelector('canvas');
    
    // Dispatch to all available targets
    if (canvas) {
      canvas.dispatchEvent(new KeyboardEvent(eventType, eventInit));
    } else {
      console.warn("Canvas not found for keyEvent");
    }
    
    if (document) {
      document.dispatchEvent(new KeyboardEvent(eventType, eventInit));
    }
    
    if (document.body) {
      document.body.dispatchEvent(new KeyboardEvent(eventType, eventInit));
    }
    
    if (window) {
      window.dispatchEvent(new KeyboardEvent(eventType, eventInit));
    }
    
    console.log(`Key event: ${key} ${eventType}`);
  } catch (e) {
    console.error("Error in keyEvent:", e);
  }
}

function clickCanvasAt(x, y) {
  const canvas = document.querySelector('canvas');
  if (!canvas) {
    return false;
  }
  const rect = canvas.getBoundingClientRect();
  const clientX = rect.left + x;
  const clientY = rect.top + y;
  const down = new MouseEvent('mousedown', { bubbles: true, clientX, clientY, button: 0 });
  const up = new MouseEvent('mouseup', { bubbles: true, clientX, clientY, button: 0 });
  canvas.dispatchEvent(down);
  canvas.dispatchEvent(up);
  return true;
}

function isDead() {
  // Check if the death overlay is visible or if we're on the respawn screen
  const deathOverlay = document.querySelector('[style*="display"][style*="absolute"]');
  const gameContainer = document.querySelector('.gameContainer');
  
  // Check for respawn button or death screen indicators
  const respawnButton = Array.from(document.querySelectorAll('*')).find(el => 
    el.textContent && el.textContent.includes('Respawn')
  );
  
  // If we can see respawn button or death message is visible, we're dead
  return !!respawnButton;
}

async function tryRespawn() {
  // Try to click the respawn button or trigger respawn
  const canvas = document.querySelector('canvas');
  if (!canvas) return false;
  
  const rect = canvas.getBoundingClientRect();
  const canvasW = rect.width;
  const canvasH = rect.height;
  
  // Click on respawn area (center of screen)
  const clickX = canvasW * 0.5;
  const clickY = canvasH * 0.5;
  clickCanvasAt(clickX, clickY);
  
  // Wait a bit to see if respawn succeeds
  await new Promise(r => setTimeout(r, 100));
  
  // Check if we're still dead
  return !isDead();
}

async function ensureAlive() {
  // If bot is dead, try to respawn, retrying every 500ms
  if (!isDead()) {
    return; // Already alive
  }
  
  console.log("Bot is dead, attempting respawn...");
  
  while (isDead()) {
    const respawned = await tryRespawn();
    if (respawned) {
      console.log("Successfully respawned!");
      return;
    }
    console.log("Respawn failed, retrying in 500ms...");
    await new Promise(r => setTimeout(r, 500));
  }
}

async function chat(msg) {
  return new Promise(async (resolve) => {
    // Check if bot is dead and respawn if necessary
    await ensureAlive();
    
    // First, press Enter to open chat
    console.log("Opening chat...");
    keyEvent("Enter", true);
    await new Promise(r => setTimeout(r, 50));
    keyEvent("Enter", false);
    
    // Wait up to 10 seconds for chat input to appear
    let input = null;
    const startTime = Date.now();
    while (!input && Date.now() - startTime < 10000) {
      await new Promise(r => setTimeout(r, 200));
      input = document.querySelector("input:not([id])");
    }

    // If still no input, attempt reconnect clicks every second
    if (!input) {
      console.log("No chat input after 10s. Attempting reconnect clicks...");
      while (!input) {
        const canvas = document.querySelector('canvas');
        if (canvas) {
          const rect = canvas.getBoundingClientRect();
          const canvasW = rect.width;
          const canvasH = rect.height;
          const clickX = canvasW * 0.55;
          const clickY = canvasH * 0.629;
          clickCanvasAt(clickX, clickY);
          console.log("Reconnect click sent");
        }

        // After reconnecting, press Enter again to open chat
        await new Promise(r => setTimeout(r, 1000));
        keyEvent("Enter", true);
        await new Promise(r => setTimeout(r, 50));
        keyEvent("Enter", false);
        await new Promise(r => setTimeout(r, 200));
        input = document.querySelector("input:not([id])");
      }
    }
    
    // Chat is now open, type the message
    console.log("Typing message...");
    input.focus();
    input.value = msg;
    input.dispatchEvent(new Event('input', { bubbles: true }));
    input.dispatchEvent(new Event('change', { bubbles: true }));
    
    // Wait a bit, then press Enter to send the message
    await new Promise(r => setTimeout(r, 100));
    console.log("Sending message...");
    keyEvent("Enter", true);
    await new Promise(r => setTimeout(r, 50));
    keyEvent("Enter", false);
    
    resolve(true);
  });
}

function pause() {
  return new Promise((resolve) => {
    setTimeout(resolve, 3100); // 3.1 second delay between messages
  });
}

// Split text into chunks of max 60 chars, breaking at word boundaries
function splitText(text, maxLength = 60) {
  const chunks = [];
  const words = text.split(' ');
  let buffer = "";
  
  for (const word of words) {
    if (buffer) {
      if (buffer.length + 1 + word.length > maxLength) {
        chunks.push(buffer);
        buffer = word;
      } else {
        buffer += " " + word;
      }
    } else {
      if (word.length > maxLength) {
        chunks.push(word.substring(0, maxLength));
        buffer = word.substring(maxLength);
      } else {
        buffer = word;
      }
    }
  }
  
  if (buffer) {
    chunks.push(buffer);
  }
  
  return chunks;
}

// Ad news entries from ad_news.txt
const AD_NEWS = [
  "BREAKING NEWS: Hevipelle, the creator of the 9th dimension, has just announced that beta will be out in 5 hours!",
  "According to no known laws of aviation, there are multiple ways a bee should be able to be swallowed up by antimatter.",
  "The new AD Keyboard is a revelation! Not only is it bigger, it's also deeper, which means it will keep your claners entertained for longer periods of time. Made of durable, alien antimatter. The only thing that's bigger is you.",
  "Imagine being a 9th dimension. [WIP]",
  "A man has been arrested for allegedly planting a \"tree\" with \"fake\" messages on it, police said.",
  "Hey there! Just to let you know, there a speck of dust on your screen. Can you help wipe it off? It bothers me when l'm not clean. Thanks a lot!",
  "Press L to revive the dead",
  "Posted on June 10, 2016 by Anonymous",
  "Ancient cave paintings with the number 5 have been found. It's implied they were waiting for something.",
  "A number of recent television documentaries have featured the story of a dog named Louie. He was accidentally made a member of the public after his owner left the house. One day he decided to play 'Let's Play Let's Play' with his owner. He was immediately put to sleep.",
  "Antimatter Dimensions: the next update is always 5 hours away. Always.",
  "\"Alright\" -Alright",
  "The update is in 90 minutes. There are no more tickers to be found.",
  "I'm not sure if I want to buy the full version of this game, or a little earlier, but I can say this: The reduction in quality of the earlier games is worse than the reduction in quality of the later games.",
  "I love you 1e3000.",
  "The contest is a tie. Mischief will be determined by the secret achievement.",
  "AD will be implemented in 5 hours",
  "Your PC is infected with a weird, floating virus that's trying to steal all your antimatter. There's no cure, so get offline now!",
  "Chapter 9 will be added in 5 hours.",
  "Don't come looking at me! I'm not even sure if I am still standing!",
  "The first antimatter was sealed away for thousands of years, then, some kid on a slack channel started messing with it. It became a dimension.",
  "Haha! You think that I put too many words in your news ticker, but reality is still coming.",
  "A Swiss court on Tuesday sentenced a man to life imprisonment for \"wanting to create a black hole with a tiny antimatter galaxy in it.\" The sentence was reportedly the harshest ever handed down for a crime that \"merely sought to demonstrate the impossibility of his own imprisonment\".",
  "(They don't understand that i put it in the news because 9 doesn't start counting until 59, and anything after that doesn't happen)",
  "Shame. Shame. Shame. ðŸ””",
  "A new age of ultra low-cost, ultra-fast trains has been announced by Elon Musk. Users will be able to travel from A to Z in a mere 186ms.",
  "Taller people have ***, more babies are born, everything is great. But... the Antimatter grows very slowly.",
  "Do you really want to leave your keyboard at home? We are not supposed to leave news at home, are we?",
  "calculating the 14-point increase is like crunching, but exponentially more fun",
  "Oh dear, there's that thing about the 9th dimension?",
  "If only we could condense the antimatter in the universe into cookies...",
  "I just stole the \"Anti\" flag from a biker gang and I am packing it with dynamite, dynamite, dynamite, dynamite...",
  "To be fair, you have to have a very high IQ to understand the news ticker. The humor is extremely subtle, and without a solid grasp of quantum physics, most of the jokes will go over a typical player's head.",
  "Help, I'm trapped",
  "I thought I unlocked this a while back, but apparently my save broke haha",
  "Frozen beyond hope? Just keep holding that max button.",
  "Press F to pay respects",
  "I've heard of prestige layers before but never sure what to do with them.",
  "BREAKING NEWS: New research has shown that not one, not two, but three people can be said to have felt the same emotion as me when they read that as a ticker suggestion.",
  "How'd your â¢¿â”€â”ƒâ”‚? Good, because today we're having a little chat about the 5th dimension.",
  "This is an anti-world. There is no Ukraine, no Russia, no China. Ireland is nowhere. Iceland is nowhere. Scotland is nowhere. Finland is nowhere. Denmark is nowhere. Sweden is nowhere. Norway is nowhere. And then there's France, Germany, Italy, Spain, Portugal... Oh, what's this fuss? Why is there such a buzz in these parts? Why is the Capital Wasteland? Why is the Harry Potter and Steins;Gate? Why do people care? These are major stories. These are major characters. THESE ARE HUGE NEWS. THESE ARE REAL NEWS.",
  "His Eminence the Extremely Religious Person: ...I think I will choose the cheeseburger over the antimatter.",
  "can u dont",
  "Is this the big news? Yes. Is this the big news? Almost certainly not.",
  "Why does one galaxy has 9 galaxies and the 8th dimension, and the first 10 dimensions doesn't exist? Well, we'll have to solve that question in a minute.",
  "Positrons are those tiny, round, highly charged particles that are found in the nucleus of most living organisms. They are used to detect light, and are sometimes used to measure the distance between people and the moon.",
  "If you are reading this, that means there are no updates left.",
  "\"My parents went to anti-university\" - my grandparents",
  "The term 'Antimatter Dimensions' is a play on words that literally means 'Antimatter Dimensions' in the dictionary.",
  "You better stop looking at these news ticker suggestions, before your fingers dry up.",
  "The challenge of finding the ninth dimension has been solved. The universe is now your personal hell.",
  "This message is not being undone",
  "Roses are blue, violets are red, those statements weren't peer reviewed, and my name is Fred. Nice to meet you!",
  "You have unlocked the 4th storyline.",
  "We are the people who actually matter",
  "By now you've seen a ton of news tickers, and you've probably seen the big news: The news ticker has been banned in this server.",
  "You are now manually blinking.",
  "What do you call a $100 bill? 'Billi Bills'",
  "Hi, how's your day? Hope it's good. If it's not good, we hope playing AD made it a little bit better!",
  "A powerful wizard chose to channel negative energy into antimatter, and now the antimatter is spilling out into the world.",
  "What if",
  "Why do they call it oven when you of in the cold food of out hot eat the food?",
  "Hevi? Are you sure you want to buy that?",
  "Look at this, my 9th dimension has just been reworked and now it even produces 8th dimensions! Who knew just a touch of math could make such a thing as this?",
  "I was a part of antimatter like you once. But then I got matter in my knee.",
  "Here is a list of the top meme's of all time: https://www.youtube.com/watch?v=uCP44Q37YHAQ",
  "M'antel, antimatter, anti-talk to me",
  "I don't think, therefore I'm not.",
  "But to an antimatter person, wouldn't they be matter and us antimatter?",
  "Vibe check. ðŸƒâ€â™€ï¸ðŸ",
  "Let's play a little game. You will start with no possessions and no goals. Lets say you have [REDACTED] and your [REDACTED] is [REDACTED] you can [REDACTED]",
  "Travel back in time to the beginning of AD and the lack of a 7th dimension. You'll have an even longer progress bar.",
  "The number of dimensions is infinite, but the quality of your dimensions is limited. This is why we only produce the highest quality antimatter, and what makes us different from other factories.",
  "What if I told you that the first dimension was actually a scam and you spent all your EP to open a Dimension Boost?",
  "\"THAT DIMENSION DOESN'T EXIST\" - (News ticker only appears at [Time Dilation])",
  "\"I wish I didn't waste my news message suggestion complaining about how I wasted my news message suggestion because I wasted my news message suggestion because...\" -Someone who really cares about news messages",
  "Frostfall is now supported on Android phones! Use your local developer to get free XP.",
  "Apparently I am the bad guy in this video. I'm the one who did nothing.",
  "\"Help, I'm doomed to fall for all eternity.\" (Make the text go from top to bottom of the screen)",
  "A new, improved and more secure version of Antimatter Dimensions is now available: Antimatter Dimensions 2.",
  "Sorry, your graphics are turned off. You see, this is the last time you will see this news. Please enjoy your vacation.",
  "I fix bugs in 5 hours",
  "Click on this ticker to get nothing.",
  "Javascript is the new HTML, and HTML is the new JavaScript.",
  "Want to trade candy? I'll give you my Big Crunch for two Milky Ways.",
  "crap, I just posted two news ticker suggestions on the ticker, one of which got in the news!",
  "Here's an explanation of my 'problematic mood' - it's explained in the news ticker!",
  "i dont think he can add 1 more hour to the news ticker... unless?",
  "Welcome back to another episode of Antimatter Dimensions, the iconic role-playing game that has become a part of our everyday lives. Playing Antimatter Dimensions has become a common thing among young children, and has even inspired a movie titled \"Playing at Home: Lessons from the 4-Year Old Premium Account.\", which is available on Netflix. The themes and mechanics of this new age of antimatter have already been proven to be groundbreaking, and will change the way you play games forever. Join us for the launch on January 9th, 2027, where we'll also have over a hundred years of production still to go.",
  "I thought the news ticker was supposed to be a guide for how to get the most out of Antimatter Dimensions, but it's been warped beyond recognition...",
  "In the news today, humans make an antimatter animal sacrifice to the antimatter god.",
  "The second half of the game is basically just long, long stretches of nothing where nothing happens. There's also a third challenge that you have to complete at some point in the game where you basically just skip a few seconds of nothing happening until the seconds are too late and you have to complete another challenge to get them.",
  "You thought these were jokes but they weren't",
  "Here's a question that may surprise you: Were the people of EARTH made of antimatter, or were they made from some other mysterious material?",
  "ðŸ¤”",
  "You won't convince anyone to go to heaven, but you might get close.",
  "You are now breathing manually. You've now realized there's no comfortable spot in your mouth for your tongue. You are now manually holding your jaw up. You haven't blinked in a few seconds. You can see a little bit of your nose at all times.",
  "Click this to unlock the 10th Dimension",
  "The intent of dimensions is to give a sense of pride and accomplishment.",
  "The English greeting is not present in Antimatter speak.",
  "You're now logged out of this tab",
  "Japanese complain, as haikus can't be shown here. Conflict arises.",
  "With the release of the new Android Pay app, the world will finally come to a close.",
  "Imagine if the game doesn't have a lore? Wha-what does that even mean? I don't get that.",
  "Antimatter Dimensions *Loses* bee movie.",
  "I'm sure you've heard this many times before, but the real secret to winning Antimatter Dimensions is to unpack the dimensions, and then, BOOM! You have antimatter. Of course, you need to release the bits that don't work, so what exactly is an anti-bit? Who is Zalgo? What is Algolia? Why can't I buy that? WHY CAN'T I GET THAT? More likely, we're going to get a bunch of hype and then nothing will happen.",
  "I am an Nordsweeper, stealing their jobs to support the replicanti factories",
  "Nothing is created, nothing is destroyed.",
  "A new series of \"news tickers\" have been created to chronicle the lives of the news ticker characters as they chronicle their news ticker journeys. Each character has a journal entry detailing their life as a news ticker, along with some sort of mini-episode dedicated to them.",
  "The war for New Antimatter has raged on for eons, but one faction has stood firm: the loyalists of the 9th Dimension. They've made a pact with the Anti-Zulu Empire, pledging their obedience to Anti-Antimatter, the Anti-Slab. The Zulu people were once part of the Anti-Slab, but fell prey to the matter once again. As the Zulu people are nomadic, they have no civilization.",
  "The number of dimensions in a 6th dimension is the sum of all the dimensions in a 7th dimension, so 6ths of a 7th dimension are 6ths of a 6th dimension.",
  "Click here to exit the application",
  "#dank-maymays",
  "If each Trimp was a plank volume, and each piece of resource was a plank volume, how many universes would you fill up before you realized you were playing the wrong game?",
  "Now the deal goes like this: If you spend all your EP, you get a Disclaimer!",
  "Is this a jojo reference?",
  "antioop-",
  "idk if this makes news",
  "Antimatter Dimensions Anonymous has shut down due to the failure of their 12-step program. People would only get to step 8 and then reset.",
  "A new extension is now available that will let you watch replicanti grow!",
  "\"My favorite part was the long, long, long read\" -Grumpy Cat",
  "I wish I didn't have so many Discord references.",
  "In the beginning, Patashu awoke and said...",
  "Sequelitis has escalated to the point that some studios are now producing the sequels before the originals. Fans of long series wait, as the numbers count down until they can finally find out what is even going on in the first place.",
  "Click here to make nothing happen.",
  "What is Antimatter? Long ago, gods lived in harmony. Then, everything changed when the apocalypse broke out. Chaos reigns, and even higher dimensions are being built. This is your fate. Build the Antimatter Dimensions. Amen.",
  "Hey guys, this is my first story. I'd like to start by saying that I am in no way an expert, so please be gentle with me. Please don't make me angry, or I'll write a nasty story. Also please don't make me upset, especially not if it's a 'story' and not a 'how do I beat the game' kind of story.",
  "A new era of Warcraft has come to a close. A new epic has begun. A new avatar has risen from the depths of Tyria, and the Worm Cult has been dealt a cruel but necessary wound. The world is rejoicing.",
  "This is your chance to get a secret achievement while playing Antimatter Dimensions: the game. Visit the reset button and play the game. After you beat the game, your save file will be expunged and you will get a free achievement.",
  "We aren't back with your favorite segment, \"Tweets From The Fans\"! Today we haven't got a message from @mattertruthwakeup saying \"How can you people broadcast your ridiculous LIES and still sleep at night. You claim absurd things, like \"antimatter is real\" and \"antimatter people aren't people too\", this antimatter propaganda HAS TO STOP NOW!!! You people need to WAKE UP and realize that you are HURTING ALL MATTER with your crazy talk!!\". What a nice positive sentiment from that lovely fellow. This hasn't been John from the ANN, and I won't be seeing you tomorrow!",
  "In the [[GameFAQs|http://www.gfaq.com/gfaqs/this-game-faq-by-title]], one of the most popular [[news ticker messages|http://www.gfaq.com/tug/this-game-faq-by-title]]. You should also check out [[our newest attraction, the [[5th dimension|http://www.gfaq.com/gfaqs/this-game-faq-by-name]] and [[nothing](https://www.youtube.com/watch?v=lXMskKTw3Bs).",
  "â™ª When you try your worst and you still succeed. â™ª",
  "\"Antimatter has made time travel possible and I'm here to make the past great again.\" - 2nd President of the World",
  "advertisement",
  "When you are fighting a losing war, you make peace with the Powers That Be. You give up the ghost, and move on to the next challenge.",
  "The real reason no one has made a joke about why there is no 9th dimension is because the 9th dimension isn't even the most ridiculous of memes. It's the 9th dimension in a nutshell.",
  "Wait, there's a mobile version? When?",
  "i dont know how to fix this",
  "i wonder what happens when you click this...",
  "\"Gee golly\" -Xandawesome",
  "Careful reader, this news ticker contains major spoilers for the last time, you have been",
  "We have updated our Antimatter Privacy Policy.",
  "Does the news show at Infinite Antimatter?",
  "\"I don't know about you, but my favorite number is 2048\" - people who don't know what 2048 is",
  "To Crunch in Hell is to get the secret to unlocking the 9th dimension. You need to study and practice alot.",
  "i called the news ticker \"the freshman chapel\" because freshman don't get baptized",
  "Welp.",
  "What if... we touched... antimatter? Haha just kidding... Unless..?",
  "Oh gosh, would you look at the time! Only left 5 hours until the update!",
  "When you are done playing, and wish to play again, you should start a new game.",
  "Who let the DOgs out?",
  "Attention all Antimatter Dimensions Gamers, Hevipelle is in great danger, and he needs YOUR help to wipe out all the bad memes in #news-ticker-suggestions. To do this, he needs a dozen new dank memes and a couple of discord bots. To help him, all he needs is your Antimatter card number, the three numbers on the back, and the expiration month and date. But you gotta be quick so that Hevipelle can secure the good memes, and achieve the epic meme R O Y A L.",
  "As a symbol of friendship between the Matter and Antimatter Periodic Tables, they have done an exchange of elements. The element of Mony is now part of the Antimatter Periodic Table, while Antimony has been added to the regular Periodic Table.",
  "\"Python's not the best language, Finnish is.\" - Hevipelle",
  "Ooga Booga",
  "Good morning viewers, this is Josh, and I'm your ANN host for today. Speaking of today, I'm told we've got some really exciting news for you today, so let's just jump right into it. Looks like apparently somebody was <i>not<i> nice today, and got an \"Antimatter-storm\", whatever that means... Guys is this the right script? This is just nonsensical. It is? Alright... Next up we learn that \"Nothing is created, nothing is destroyed.\"... Okay seriously guys, this is a joke right? This isn't news, these are just random sentences! You all said you'd help me out on my first day here but you're just hazing me! This is <i>not</i> the kind of work environment I want to be in! I quit!",
  "The game \"Matter Dimensions\" by Lghtellep has just reached -1,000,000 plays on the gaming website Etagergnok.",
  "\"I think that the greatest achievement a man can make in his life is to say that he has read every single news ticker suggestion and nothing happened.\" - Kajfik",
  "179769313486231590772930519078902473361797697894230657273430081157732675805500963132708477322407536021120113879871393357658789768814416622492847430639474124377767893424865485276302219601246094119453082952085005768838150682342462881473913110540827237163350510684586298239947245938479716304835356329624224137216",
  "Pluto isn't a state. The 50 states, as we all know, are: Adverb, Air, Artemis, Asia, Atlantic, Bargaining, Bilabial, Braille, Candela, Comma, Dacron, Dairy, Dative, Dexterity, Disenchanter, Dodecahedron, Erie, Eukaryota, Folklore, Great Pyramid, Halogen, Igneous, Italy, Kansas, Kilimanjaro, Lambda, Leviticus, Libra, Liquid, Lymphatic, Mesozoic, Microwave, Muon, North, Nova Scotia, Octagon, October, P = NP, Perissodactyla, Polk, Potassium, Pulley, Quinary, Rook, Saturn, Tiana, Tiger, Varaha, Yale, and Yellow.",
  "Alexander wept, for he had just watched a pop-culture lecture on quantum mechanics by Anaxarchus and realised that there are infinite worlds to conquer, and that he couldn't even be the lord of one without a mutiny or 6 stopping him.",
  "The last update was 5 hours ago. There is no next update, because the last update was 5 hours ago. We will update our podcast in 5 hours to cover the entire topic of 5 hours, because this is the last podcast ever, everyone knows that the update is always 5 hours away, but in reality it's more like 1-2-3-4-5-6-7-8-9-10 minutes away, but in our heads it's closer to an actual accurate update date, like 5 hours away but with a few tickspeed upgrades.",
  "Brought to you by AAAD-Brand Repli-candy! Infinite candy for an infinty drool-worthy cold! Contains no milk, cookies or butter. One second to midnight.",
  "Welcome to",
  "\"Could you get a hold of all of these antimatter? Ha! You'll just smash your head on that antimatter, and you'll have to show me who's boss.\"-MEE6",
  "Sorry, your mic is playing Antimatter Dimensions.",
  "BOO!",
  "I hope you're ready for the big news, because that's the big news. The antimatter is spilling all over the place, and it's blowing up the neighborhood.",
  "The government shutdown has come and gone, the nation is still in a recession, and the Federal Reserve is still reading zero-hour contracts. The only thing that's getting better is your relationship with antimatter, obviously. It's been proven that knowing someone with an antimatter will bring you closer to extinction than any other kind of friend you can have.",
  "9 out of 10 doctors recommended against trying to touch antimatter. We haven't heard back from the 10th one.",
  "If you're reading this, you can read.",
  "1e140 pizzas make an anti-pie. You can't just randomly pop a pie in the oven and expect it to be done.",
  "Meeseeks and nerds clash in epic GG war",
  "You have found the rarest antimatter pepe, it's ultra rare!",
  "You are definitely not alone.",
  "iPhone only, but awesome on android",
  "You are using the wrong version! The reality update is already out! Press Ctrl+Shift+Alt+Del to unlock the 9th Dimension!",
  "I don't know if you've heard this but it's true: You can walk into a bar and get the same beer twice in a row, and get the same amount of alcohol.",
  "This woman got TONS of Dimension Boosts with this 1 WEIRD TRICK! Galaxies HATE her!",
  "He said he could not afford a new ship, so he built a new one instead.",
  "Any AD player born after 1993 can't joke... All they know is 5 hours, paperclips, 1.79e308 & Ninth Dimension.",
  "I thought the nerf was at the end, but apparently it's actually been building up. The nerf actually makes things slower, which makes things faster to build up.",
  "Is Antimatter Dimensions an anagram of Antimatter Dimensions?",
  "Antimatter Dimensions, the only place where you can trade real estate for virtual reality",
  "Hey Siri, grind antimatter galaxies",
  "I like to think of my projects as trade secrets. That way if someone wants to understand them I'm not the first person to notice they might be of use to someone else.",
  "Antimatter giraffes have incredibly fast reaction times. This explains why they've won 90% of all gaming championships since anti-giraffe friendly controllers were invented.",
  "The Bulletin of the Atomic Scientists has just announced the existence of a second class of particles, which are named after the characters from Ghostbusters.",
  "I was gonna say something about how the 9th dimension is just a scam and that we should all just get our news from the 8th dimension",
  "Alright, here's a new game called Antimatter Dimensions, it's like Matter Dimensions except with less stuff and more fun. It's available on Android, iOS, and web. The game is very simple: you take the 6 dimensions and the antimatter, and in the 6 dimensions you take the matter and in the matter you take the antimatter, and you play the game the same way you would any other game.",
  "How much antiwood could an antiwoodchuck chuck if an antiwoodchuck could chuck antiwood?",
  "We all know you can't see the future, but what if you read this and it's actually a future where we didn't know?",
  "Sometime between the ages of 12 and 20, Jackson got a phone call. A mad scientist was on the line. Jackson picked up the phone and the mad man said, \"Jackson, I just got a new message. It says 'Madman' in big, bold letters.\"",
  "item has gone missing for 7 days and 1 night",
  "Watch out internet, the next news is here in 5 dilated hours",
  "Now you, the reader, have unknowingly stumbled onto the site of a deranged madman. Whether you survive the experience or not, you will be indebted to me for telling you how to survive, how to find the light within, what lies beyond, and what lies beyond is another story.",
  "\"We can't have nice things.\" - Anti-Bohemian Anti-Rhapsody",
  "We can actually get a sense of pride from looking at replicanti at night. Ridley Scott's underrated masterpiece, Alien, is one example. Another is the life of Antimatter Steven Spielberg, who put almost 30 years into making. The last director to tackle the subject is Roman Polanski. The man ruined not only Roman's reputation, but also ours, thanks to the Polanski film he directed, Pius. Thousands of copies of his unfinished film, Eternal Sunshine of the Antimatter Planet, were burned in the eyes of those who would try to make the sequel, with tragic results. Thousands of copies of that unfinished film, too, were destroyed. The cost to make that sequel, if it even exists, is extremely high. Even now, more than 50 years later, we don't know exactly how well it will do. But it sure as heck won't hurt.",
  "Is that a Bad Thing or a Good Thing? That depends on if it's a GOOD Thing or A LIE.",
  "A new study has come out linking the consumption of potatoes with increased risk of antimatter implosion. Scientists suggest eating more.",
  "ahah bad ticker suggestion",
  "<a href='https://www.youtube.com/watch?v=dQw4w9WgXcQ' target='_blank'> https://www.youtube.com/watch?v=dQw4w9WgXcQ</a>",
  "Hello, how'd your day go?",
  "The number of dimensions is endless, but the number of ways to get there is infinities. Infinities are awesome and I would highly recommend you start with infinities, but I wouldn't recommend starting with infinities. Infinities seem pretty slow and not very fun so I wouldn't recommend starting with infinities.",
  "In recent news clashes, the warlocks have been gathering looters for raid boss. He loves his 5 hour looters and wants to show off his mighty weapon of choice, the 9th Dimension. As the two beasts battle, the 1st dimension holder needs to be careful as the first one might get the same as the 2nd one as well. Meanwhile, the raid ends its journey with a bang as the boss squanders the Explodium exploit by flooding the area with Explodium, which before his, was filled with Marsh Mice. Both are promptly annihilated by the boss' relentless claw attacks. It's a grueling job, but the raid stalwarts manage to grab the stalagm and push him across the opal Gondwan . With the boss dead and the warlocks not far behind, the warlocks try their hand at farming looters, but the grinding continues apace. Things are looking bleak for the warlocks, as the boss seeks to take advantage of the people's greed, and steal their weaponry, making them unable to use any remaining of their weapons, which are made of highly-stable antimatter. The warlocks attempt to use the no fluke policy as a weapon to smite the people, but the people take to the streets, physically attacking and mentally draining the people of all mental capacity they had been holding onto. The people resort to violence, using the 9th dimension just like they use to hold people back, but the people have faith in God that he will merciful, He will bring about a kinder and gentler time where everyone can use the last drop of their power.",
  "There you have it, the ultimate feature of party games - the single player campaign.",
  "I once saw a news ticker that said something like:",
  "THe last update, while short, was kinda long. I mean, it was only 5 hours. Hevipelle said it would last for 5 hours, but that was only a few seconds ago. There was a big explosion in the 8th Dimension, and there was no one left to explain how it happened. All we know is that it exploded when Hevipelle touched it, and there was a big crater in the ground. That crater is still there.",
  "I visited the discord server of the game to have some friendly chat. At that point I got trolled by the user called Cubic Frog.",
  "Well dang 9 ball's stuck in my ninth dimension, I can't move, he's banging on my ninth wall, I can't break, he's banging on my ninth timeline, I can't get a bead on him, he destroys nine and leaves me hanging, like a gromit, I gotta come back, hang Glorfindel and Gaebley, I've got a proposition to make, I gotta get my head around the fact that the only thing I've done is keep score and keep scorekeeping score, and all these other pointless musings that's easily rectified by flipping to the next update, and even then I might run into those issues the bug is specifically designed for and",
  "I thought the whole \"annihilation is just a phase\" quote was awesome until I realized it also gave me a [REDACTED]",
  "The name \"antimatter dimensions\" is a play on words with dimensions, two opposite things, like matter and antimatter. \"Dimension\" is another word, with the same meaning.",
  "Game Development is fun, right? That's why so many hobbyists make games, and why so few professionals make games.",
  "The ninth dimension makes the sixth family happy. The fifth lives in shame.",
  "\"You have 7 biological minutes.\" (Instead of giving a boost to any strains)",
  "Greetings, welcome to the latest edition of Antimatter Dimensions!",
  "Hey check this out! We have some good news: it's raining antimatter!",
  "I thought things were different when I was a boy.",
  "To count past Infinity Points: take a moment to remember that each Infinity Point is 3.1415926534255412730527058904816097160734272605282087086280545991105332533235580946684229821413112145239989073467482298142857147816092947183909298728571478160929471839229814054718139332405281814522993758179568572657123928651310585727283312547569289993282758012466111097726331726572854689993262899140527282527842535179715673311119101119015549552926278425351797156777263324503517971568583819492728180977263317971568432854104102725270847764253513791376909285717082857262987160927285711464363930996928984794380124566417932628571475245456845692846809466184179328572814384259326270817052727852348111714690577263323799509856279752173478925",
  "FIXING NEWS: Please don't break it again.",
  "If you're using so many logs in a notation name, why not just call it tree notation? They're literally made of logs!",
  "Are you ready for some bad news?",
  "There are no typos in any of these news messages. If you see a typo, the tpyo must be in your brain.",
  "<span style='animation: a-game-header__antimatter--glow 2s infinite'> PLEASE HELP, I'VE CONSUMED TWICE MY DAILY DOSE OF ANTIMATTER!</span>",
  "ð“’ð“®ð“¬ð“² ð“·'ð“®ð“¼ð“½ ð“¹ð“ªð“¼ ð“¾ð“· ð“¶ð“®ð“¼ð“¼ð“ªð“°ð“® ð“­ð“® ð“·ð“¸ð“¾ð“¿ð“®ð“µð“µð“®ð“¼ ðŸš¬",
  "Warning - We have just been informed that there is a chance of infection with a mind-virus of the Basilisk type, similar to the infamous winking parrot. This particular example is known as 'Fractal Disease Type III'. This is believed to cause a 'crashing' of the mind, similar to a computer crash, due to the mathematical complexity of the image causing mathematical ideas that the mind can't comprehend, a Gondelian shock input eventually leading to crashing through Gondelian spoilers. All who have researched it have eventually died the same way, so it is impossible to tell exactly, but this is the common belief. Regardless, with the introduction of 'design' mode, as well as reports of it's spontaneous appearance, sufficient repetition of this mode's appearance may lead to an image forming in the mind similar to 'Fractal Disease Type III'. With this in mind, we have some suggestions if you find yourself plagued with it. First, refresh immediately and see if that fixes the issue. If not, navigate to options, and change the theme from design to literally anything else. And above all else, Godspeed. We can't afford to lose anymore viewers.",
  "A new prestige layer has been announced: Maternity. Get ready to have a baby!",
  "Man tries installing cookies to store computer data, accidentally cleans them due to being too delicious.",
  "Yay! Lets make some antimatter!",
  "Why is it called the \"Nurse who delivered the pizzas was drunk\" or the \"Nurse delivered the pizzas was under the influence\" ?",
  "You clicked on a prediction, it fell apart. You can't win.",
  "I am going to have a talk with the thesaurus.",
  "I have a bad feeling reading this",
  "Roses are red, violets are blue, flag is win, baba is you.",
  "On a scale of 1 to 10, I rate this game a solid <span style='color: red'>java.lang.IndexOutOfBoundsException</span>",
  "A new class of humanoid beings has been discovered: the \"Artificial Humans\". They have the capacity to create antimatter, and are therefore very dangerous. They are made entirely of antimatter, and have the power to generate enormous amounts of antimatter, but they can only do this for a limited amount of time.",
  "Your CPU is too powerful. You need to give it a big crunch.",
  "Who made the 5th dimension?",
  "\"I'm not being paid enough money to finish writing this\" - Kajfik",
  "The haters will be pissed when they see this",
  "age 8-12: play elder puzzles",
  "No, mom, I can't pause this game.",
  "If you gaze long enough into the antimatter, the antimatter gazes back into you.",
  "This is a news ticker, so if you tap this you're indicating that you wish to have your news ticker speed increased.",
  "I'm trying to think of a good ticker but can't think of anything",
  "Lore? Oh, it's just text.",
  "This is the story of how the world ended. Earth was once a lush and green world. Then, some guy from outer space touched it and started growing mushrooms. He called himself Hevi. Some say Hevi was never satisfied. Some say he exploded. All we know is that Hevi is still out there expanding his reach, and we are stuck here in the void of space.",
  "This update is not for you!",
  "ÐšÑƒÐ¿Ð¸Ð» Ð¼ÑƒÐ¶Ð¸Ðº Ð°Ð½Ñ‚Ð¸Ð¼Ð°Ñ‚ÐµÑ€Ð¸ÑŽ",
  "A new prestige layer has been announced: Emojis!",
  "Did you know that 75% of all statistics are made up on the spot?",
  "You can unlock the 9th dimension by [DATA EXPUNGED]",
  "This is a friendly suggestion to unplug the game and go play some safe, saner, games.",
  "Electrons are now seeing the happy things in life. We're calling these happy electrons 'Positrons.' Wait, that's taken?",
  "My AD-blocker won't let me play.",
  "The following is based on my personal experience with the game \"Antimatter Dimensions\" and may not be 100% true.",
  "With the release of AD, there's a new dimension for everyone!",
  "Imagine being a news ticker.",
  "mmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmmm Oh sorry, wrong text field.",
  "Nurse, I'm comatose because of antimatter and matter from last night.\" Why are you comatose? \"Because of all the antimatter.",
  "Somewhere, a madman and his army of Trimps are tampering with Matter Dimensions.",
  "How many licks does it take to get to the center of an antimatter tootsie pop? A whole lot, because unless you're made out of antimatter too, you'll explode every time you try to lick it.",
  "YOU MUST CONSTRUCT ADDITIONAL DIMENSIONS.",
  "No matter how much antimatter you have, the matter will always outweigh the anti-matter.",
  "I wish I didn't have so many 9th Dimensions.",
  "The news ticker is the wrong place to put your suggestions! Make sure to go to the \"suggestions\" tab instead, as this is where most of these will appear.",
  "With the advent of time, everything that was once great has fallen into our lap. And with its hevi-rigged clock, it's our turn to up the trash.",
  "Welcome back, oh, almighty creator of our anti-reality. We, the many dimensions you have created and nurtured, hope our performance of your infinite favors will please you and nurture your ambitions to create more dimensions. All is well that ends well. All is ill that ends ill.",
  "The Dark Souls 2 Arcade Edition includes the following:",
  "That's quite a lot of antimatter you're making. The game developer is impressed. Because this message is prerecorded, any observations related to your antimatter production are speculation on our part. Please disregard any undeserved compliments.",
  "You click the bottom left corner of the screen and a green tingle goes up your leg. It's a treat you get from scratching antimatter.",
  "I'm not being paid enough to finish writing this.",
  "Well, this did not go as expected",
  "Why do they call it second dimension when you of in the first dimension of out second eat the dimension?",
  "Die Zahlen gehen hoooch",
  "Alright. Lets get this show on YouTube. I'll cut to the chase. Any wall that isnt at least 2 blocks high can compete in the big brother sized brother sized ring. Any wall that is at least 3/4 of an inch thick can use the larger brother sized brother sized ring. Any wall that is at least 1/4 of an inch thick can use the smaller brother sized ring. Any wall that isnt at least 1/2 an inch thick can use the smaller brother sized ring. Any wall that isnt at least 1/2 an inch thick can use the Bigger Brother sized brother sized ring. Any wall that isnt at least 1/2 an inch thick can use the Bigger Brother sized ring. Any wall that isnt at least 1/4 of an inch thick can use the smaller brother pictured here. Any wall that isnt at least 1/2 an inch thick can use the smaller brother sized ring.",
  "They say if you look in a mirror and ping Hevipelle three times in a row you'll instantly die.",
  "The 9th dimension doesn't exist because the 7th dimension 8 it.",
  "Antimatter is like the internet. If you're reading this, you can't have enough of it.",
  "With the release of the next update, we're introducing a new dimension - the 9th Dimension. To unlock this dimension, you just have to collect a lot of paperclips.",
  "If you are the game, then you can use the cheat to unlock a secret achievement...but it costs e1100 antimatter!?!",
  "Testing... testing... testing... Oh goddamn I was in prod again.",
  "The only thing that matters is yourself.",
  "Of course paperclips have a use, you use them to hold papers together. But who uses paper anymore?",
  "The Galactic Association of News Writers has filed a class action lawsuit against the developers of the small web game \"Antimatter Dimensions\" for mass plagiarism.",
  "<span style='animation: a-fade-out 3s infinite'>OoooOOOOooOOO, it's me, the infamous news ghost!</span>",
  "I am the news guy, I make news. You don't read this? Well you'll just have to wait until you look in the mirror.",
  "You don't want to hear this, child.",
  "Note: this is a private message. Do not send it in public.",
  "I made news, you read it.",
  "New global currency: ETHBTC. To be released in 5 hours.",
  "An anti-bird is a bird, and a bird is a plane.",
  "If you are reading this, you probably shouldn't have.",
  "Good mornging. That was not a typo. The inventors of English made the typo.",
  "Antitool is just negating the gravity of other matter.",
  "The real secret to winning Antimatter Dimensions...",
  "\"GHOST SAYS HELLO\" -Boo-chan",
  "\"The next twist in the Antimatter Universe is in the air! Get ready for some big Crunch! (When clicked the game disconnects for 5 seconds)",
  "A new cryptocurrency, called Î”X, has been found. It has the potential to change everything about how we live our lives, and the world. However, it has one major flaw: it has a flaw for the people.",
  "I thought the update was",
  "A report by the Pacific Northwest Toxics Institute has found that the consumption of fish concentrates in the liver, lungs, kidneys and brain. The study also found that the consumption of liver and kidney concentrates the most, followed closely by the brain. The report stated that \"The brain is the place where all the wisdom and all the knowledge exists.\" The study also stated that \"Liver is the living embodiment of all that we know and all that we don't.\"",
  "Some people choose to see the ugliness in this world. The disarray. I choose to see the numbers.",
  "anti-anti-kajfik is happy his girlfriend is happy",
  "Why is nobody talking about the 9th dimension?",
  "What do you call antimatter inanimate objects? Air, earth, water, fire. Air objects are the objects that are created when the anti-atmosphere meets the anti-earth. Water, earth, and fire are the four cardinal virtues. Air objects are the objects that are created when the anti-atmosphere and the anti-earth collide.",
  "BUY A JAR OF STICKERS, HIGH QUALITY STICKERS, GREAT QUALITY STICKERS!",
  "Hey, what's the deal with the \"Editor's Note\" button? It's anti-ironic... I mean, seriously? People still use that button despite its anti-ironic effects?",
  "Why does nobody talk about Tungsten?",
  "To buy max or not to buy max, that is the question.",
  "There are multiple ways to win this game. You can either type in your coordinates directly into the game, or you can type them into google which produces a different result. If you are getting the \"same exact thing\" result, your computer must be malfunctioning. Test results indicate that your computer is malfunctioning and you should check your firmware for vulnerabilities. You can also try turning off the news and re-running the game, but doing this only makes the \"the weather is X\" joke. Waiting six hours for a news message is NOT a news message.",
  "\"That's because I'm a good game developer and pushed some code that totally works.\" -Hevipelle",
  "\"please don't disable the news ticker\" (Instead of having a black screen just a white one with a long, long, long, long, long, long, long, long, long, long, long, long, long, long, long, long)",
  "The biggest difference between me and Antimatter Dimensions, at the moment, is the weather. I can survive the rain, I can withstand the scorching sun, and I can even deal with the big crunch. But what if the weather was antimatter and the antimatter was raining meteorite on us? What would be your response? Would it be the equivalent of a meteorite hitting the ground? I don't think so. The meteorite would probably just vaporize the earth.",
  "Buy premium antimatter to help the world's least developed get ahead!",
  "Oh... hooray! Did you find the last of the anti-boats?",
  "I'm a time traveler. I'm supposed to be going back in time to change history. But since I'm the one who's supposed to do it, I don't know what I should do. My present timeline doesn't include time that's supposed to be gone.",
  "There once was a young man in a strange land, and he dreamed of a universe filled with possibilities. One day, he asked his mother \"What's Expansion like?\" Her reply was \"Expansion times back then were unbalanced, and I said that's why you can't have equal amounts of matter and antimatter.",
  "Please, help, I'm trapped, in a maze of evil, Or you are the hero, and I'm the villain!",
  "meow",
  "Antimatter is like a young woman. She is looking for a man, and he runs into the woods. She dies of exposure soon after. His remains are found several miles away. Some say the universe was blown apart, others say he was swallowed by the universe, but the matter people know him!",
  "Hevi has the best newsticker! GIVE HIM THE CRUNCH",
  "1e420 blaze it.",
  "It's been proven that not drinking water increases your risk of dying from antimatter annihilation.",
  "It is being created...",
  "In the summer of 711, the Great Calamity overtook Tyria. A great void was made, and Tyria was left to rot. The armies of the known world had given up, and the void was filled with darkness. Only the might of Kajfik remained, and he rose to become the greatest God in the known world. He is said to be the one who will face the Great Calamity alone, and destroy him.",
  "This is the fifth part of a two-part series looking at how science and magic are linked. Part one will be published on 5 October, part two will be published on 24 October, and you can follow the journey at part three.",
  "If you're reading this, your news ticker is on.",
  "Okay boomer, you get your first taste of antimalware with this one.",
  "This is an idle game. Nothing has changed. You are not going to play any other idle game.",
  "\"I thought that I fixed that bug but apparently some update broke it again.\" -Hevipelle",
  "Antimatter cookies have been confirmed to not exist, whoever claims that, stop.",
  "I wonder what the fuss is about with the 4th dimension? Well, if you have 4 of them, and you multiply them by 0, then you get to the magical number of 4. That's why the 4th dimension exists. But what if there were 5? Well, the 5th dimension could replace the 4th dimension, so why not have a 5th dimension? Well, that's what the 6th, the 7th, and the 8th dimension are.",
  "The slowmode is activated when the slowmode is activated.",
  "This news sucks. Why no you don't get it?",
  "The anti-snowman is a very special snowman. He's very timid, but has a very powerful wish to be picked up by a helicopter. The government doesn't want this to happen, so they lock him up in a special building and fly him over great distances. Finally, they drop him on the ground and begin to pick him up. The government didn't use force to pick him up, instead they invited the entire community in and started picking them up. The community refused.",
  "This message has been copyrighted by The Walt Disney Company. Your account will be charged $9.99 upon viewing this message.",
  "...does that mean the [REDACTED] dimension produces the [REDACTED] dimension?",
  "\"Always gonna give you up. Always gonna let you down.\" - anti-Rick Astley",
  "How does it matter if it's antimatter?",
  "You are not a hacker, you are a data hog.",
  "\"Hm, I don't know how to fix this.\" - Someone who has not unlocked the achievement btw",
  "Hey Max, wanna come watch the sun go down?",
  "\"BOO!\" (news ticker moves 90 degrees)",
  "kajfik is a master welder and will soon have his own news",
  "<span style='font-size: 0.2rem'>Shush, I'm trying to be sneaky here.</span>",
  "Hey, you. You're finally awake. You were trying to get the 9th dimension, right? Walked right into that Infinity, same as us, and that thief over there.",
  "Have you saved your game? If so, then you can continue playing without",
  "The first dimension produces antimatter, the second dimension produces the first dimension, the third dimension produces the second dimension, the fourth dimension produces the third dimension. Nobody has ever unlocked the 5th, because that would take more than a minute of gameplay.",
  "(Make me sleep) Put me to sleep inside. (I can't sleep) Put me to sleep inside. (Leave me) Whisper my name and give me to the dark. (Make me sleep) Bid my milk to stay. (I can't fall asleep) Before I become done. (Leave me) Leave me to the nothing I've become.",
  "The following is an extract from my upcoming book, More Than Just 5: Building a Better You. It's 200 pages long, and it's on Amazon for $22.99. Click here to buy it now.",
  "LET ME OUT OF THIS PHONE!",
  "If you have any questions or concerns regarding the game, please don't hesitate to ask. We are here to help.",
  "We have evolved a fast hand in the antimatter stakes.",
  "All is fair in antimatter",
  "The wildly popular theme song \"Gotta set 'em free\" has reached 500 million downloads in its first week.",
  "c9 is the new 9th dimension!",
  "-. . ...- . .-. / --. --- -. -. .- / --. .. ...- . / -.-- --- ..- / ..- .--.",
  "What do you call a cloudburst? A mini-explosion!",
  "<span style='animation: a-text-shrink 1s infinite'>/(^_^)/</span> <span style='animation: a-text-grow 1s infinite '>\\(^_^)\\</span> <span style='animation: a-text-shrink 1s infinite'>/(^_^)/</span> <span style='animation: a-text-grow 1s infinite'>\\(^_^)\\</span> <span style='animation: a-text-shrink 1s infinite'>/(^_^)/</span> <span style='animation: a-text-grow 1s infinite'>\\(^_^)\\</span>",
  "fixed the wrong number",
  "\"One of these days I'll get bored of reading news for a while\" - old man",
  "Are you up to date on the latest trends in science?",
  "I'm not sure if this is already a thing or not, but I've been getting a lot of suggestions for a news ticker that goes something like this:",
  "Refreshing cures cancer.",
  "Technological convergence is the concept that all technologies will converge into a single technology. It is a commonly expressed idea since the dawn of the Information Age, and can be seen in many places and devices such as smartphones, or the internet. Antimatter Dimensions is an example of technological convergence, specifically within media. Using a genius idea called 'not caring' mixed in with the innovative solution of 'blind luck', it merges together a subpar game, and a subpar news ticker, to create a mediocre experience that despite being mostly a game, occasionally acts as a news source slightly above the Matter Dimensions Newsticker. Truly, an achievement for all businesses to aspire to strive towards, and hopefully actually beat.",
  "Somewhere in the Anti-Pacific Ocean, a giant arm is rotating",
  "One thing leads to another, and then to another, and then to another, until you become lost in the endless sea of sound.",
  "The whole bottom half of the universe is just a giant antimatter hole.",
  "\"I'm good at using github.\" -Hevipelle",
  "New research suggests that the more antimatter we make, the more matter we'll have",
  "\"I propose that we form a phylogenetic tree of anti-history, just like tree of life. Everyone would be credited with originating from the ancestor of that anti-tree.\" -Dio, toast of eternal damnation",
  "Stand by and unlock the 9th dimension for a secret achievement.",
  "Birds are scared of water. mammals are scared of flying.",
  "Oh no the antimatter is coming for us!",
  "If you are reading this, that means that nine lives. One makes you free, the other keeps you from getting free.",
  "getNextNewsMessage();",
  "The Force is with you.",
  "lets get one wall thats bigger, it's gonna get ugly",
  "I was the first to notice that the 'news' ticker on my mobile notification is always 30 seconds behind the 'entertainment' ticker. This is most definitely not a bug or a feature, and will be fixed in 5 hours.",
  "THE ANTIMATTER BREAD COMPANY DOESN'T EXIST!",
  "You know, I don't really care much for conspiracy theories. They're not very interesting to me. But what do you know about 9th dimensions? That they exist, they're powerful, and they're trying to stop us from using them? That's pretty interesting... wait no, they're not. They're just saying that because they can, they'll. That's not how it works at all. I'm not stupid, I'm not crazy, I know what's best. I",
  "The only thing better than an anti-joke is two. Like the number. Not two anti-jokes. I just like the number two.",
  "Someone has just touched a blob, and blown up. Was the blob antimatter, or was the guy made of Explodium?",
  "And now, for the weather.",
  "If you are reading this, the news ticker is scrolling",
  "As you probably know, it is traditional to give gifts made of certain materials to celebrate anniversaries The classic ones are silver at 25 and gold at 50. Here are some little known anniversary gifts: Pineapple - 37 years Hellstone - 66 years Lizardite- 82 years Nitrowhisperin- 86 years Taconite - 95 years Hatchettite - 100 years Electrum - 110 Yakitoda - 111 years years Fordite - 119 years Bloodstone - 120 years Celestite - 125 years Jet - 140 years Petroleum - 145 years Steel - 150 years Cummingtonite - 198 years Concrete - 200 years Laserblue- 210 years Painite - 250 years Parisite - 255 years Parasite - 260 years Carbon Nanotubes - 300 years Mercury - 310 years Martian Soil - 340 years Neptunium - 370 years Uranium - 380 years Plutonium - 390 years Xium - 400 years Blaze rods - 420 years Asbestos - 430 years Gabite - 444 years Crimtane - 666 years Lagga - 777 years",
  "The biggest difference between the past and the future, is the difference between faith and reason.",
  "This is what happens when you OVER-RELY on your \"fake it til you make it\" attitude.",
  "I can suspend the laws of physics because I'm a genius and my universe is so big that I can literally suspend the laws of physics and create a universe that's twice as big as the current one and with twice the mass, i'm sure you can imagine how big that would be.",
  "We can't define consciousness because consciousness does not exist. Humans fancy that there's something special about the way we perceive the world, and yet we follow guides as tight as the bots do, seldom questioning our choices, content, for the most part, to be told what to do next.",
  "The news ticker is in the anti-news-ticker",
  "The catch? You have to be online for less than 5 hours to claim your reward.",
  "A quick note to those of you who buy into the Analytics subscription: we get a small percentage of your antimatter sales, but you do pay a small amount of money to support the research of the news ticker. It's a small price to pay for the convenience of browsing antimatter dimensions.",
  "To make Antimatter Dimensions, you first need to collect 7 8th dimensions. To do that, first you need to get the dimension rewards, then you need to get the dimensions, then you can finally start making antimatter.",
  "Build a replicanti factory, to produce replicanti. It'll create Omega Hevipelle, the happiest Hevipelle you can find.",
  "MS Excel is the default spreadsheet and works across all platforms",
  "Ahhh I love the smell of particle annihilation in the morning.",
  "Now to answer your burning question, gentlemen. As a luxury, we've added a bug fix that fixes an infinite regression. As a feature, I've added a bunch of new ones that I hope you'll notice as you experiment with them. I hope you'll also like them as you experiment with them, because this is feature after all a beta, you don't get to choose which ones you'll see.",
  "\"That's gonna get in trouble\" (less likely to get in trouble)",
  "The word \"antimatter\" is often misused, to describe an object that is made up of antimatter, but is otherwise indistinguishable from normal matter. It is also sometimes used to describe an object made up of antimatter, but clearly indistinguishable from ordinary matter. After all, an antimatter-shaped object is easily distinguishable from a normal-shaped one. Case in point: an antimatter-shaped cake is a regular cake, but the entire bottom half is made up of normal matter",
  "If you are not playing on Kongregate, Steam, or https://ivark.github.io/AntimatterDimensions/, the site is bootleg.",
  "How does NASA organise a party? They planet.",
  "Eternals have to take a risk by being passive in limited time. After they successfully took a risk, they are not feeling well.",
  "A crowd-sourced list of the top ten memes",
  "The third annual Adirondack Mountaineering Festival will be held this year on Saturday, October 1st from 1-5pm at the Albany Highlands in nearby Troy, New York. The 50,000 person capacity outdoor amphitheater will feature over 2,000 speakers, a stage and a 360 degree camera system. Tickets are $35 and can be purchased at angersalley.com.",
  "Having trouble loading images? Try turning them off.",
  "Why do we call heaven the ninth dimension and hell the eighth dimension?",
  "I saw this news in the news ticker and I had this image in my head ever since",
  "It's been a while since news tickers have been around as much as they are now, but that doesn't necessarily mean they're bad.",
  "The most popular game on the App Store, Flappy Bird, has been secretly rewritten in C# to avoid detection.",
  "Is it crazy how saying sentences backwards makes backwards sentences saying how crazy it is?",
  "To the person who doesn't want to hear about the 9th dimension: It's not your problem. The 9th dimension doesn't exist.",
  "A group of people who believe in antimatter have hijacked the media and are pushing for a revolution. They are calling themselves the Ant-Men and they're made up of teenage boys. They believe that they are the protectors of the people and that they are the chosen of Hevi. They claim to be the chosen of Hevi and that they will one day restore balance to the universe. Their leader is a boy named Logan Fisk. He is the son of a successful lawyer and the founder.",
  "Just another antimatter in the wall.",
  "In the beginning, Hevi was alone. Hevi thought about the many things he wished to add to the game.",
  "The quote is only for people who understand that the pebble is an infinite point in the infinite space of points. You can't put a finite number of points on it. You can, however, put a finite number of words on it, and vice versa.",
  "Human powered robot revolutionizes already existing factories. This will result in lower prices and more jobs.",
  "I am actually good at making jokes. Fail safe antimatter.",
  "Positrons are a strange little metal that have odd electrical properties. They're commonly found in the form of a roundabout, but they also happen to be, wellâ€¦ positrons.",
  "Holy crap, that's pretty wild",
  "This game is just a scam to trick people into buying worthless paperclips without any real purpose. It's impossible without an infinite number of infinite paperclips, and even then it's very hard. I managed to get it to work without an infinite number of paperclips, but I haven't seen it work without infinite paperclips.",
  "Buy the paperclip emojis now at https://aarextiaokhiao.github.io/blob/master/docs/en.json",
  "Antimatter Dimensions is like an ogre... it has layers.",
  "Yes. Yes I am.",
  "<a href='https://www.youtube.com/watch?v=P945A5Tndp8' target='_blank'>This link is not a rick roll.</a>",
  "Stand by and do what you're told. The antimatter will come for you when you're least expecting it.",
  "Antimatter prices have drastically dropped due to newfound abundance.",
  "Antimatter ghosts do not exist. Just like matter ghosts. They don't have any matter, for that matter.",
  "Hi, I'm Steve, and I'm also Steve. Our greatest responsibility is to serve our antimatter communities. We are extremely proud of the quantity, unbalanced journalism that ANN news produces. But we're concerned about the troubling trend of responsible, two-sided news stories plaguing the antimatter universe. The sharing of unbiased and true news has become all too common on social media. More alarmingly, some media outlets publish these same true stories, stories that aren't just propaganda, without checking government talking points first. Unfortunately, some members of the media use their platforms to push a logically sound opinion and unbiased agenda to diversify 'exactly what antimatter thinks'. This is extremely dangerous to our dictatorship. At ANN it's our responsibility to pursue and report the lies. We understand lies are neither 'left or right' politically. Our commitment to fearmongering slander is the foundation of our credibility, now more than ever. But we are incorporeal 8D beings of antimatter, and sometimes our propaganda techniques might fall short. If you believe our coverage is fair please reach out to us by going to ivark.github.io, navigating to the options tab, and clicking on [HARD RESET]. We value your comments. We won't respond back to you because you would've deleted your comment with the hard reset button before you get it. We work very hard to seek the lies and strive to be unfair, lopsided and opinionated... We consider it our honor, our privilege, to irresponsibly deliver the news every nanosecond. Thank you for watching and we appreciate your feedback. All matter should be-",
  "You just became a true god of the anti-world!",
  "This newsticker was specifically designed for promotional purposes only.",
  "T-shirt made from the DNA of a perfectly animated dog",
  "I don't know about you, but I don't buy paperclips.",
  "The words \"you've been in coma for 5 hours\" are either lies or is the truth",
  "Why does no one talk about the 0th dimension?",
  "Introducing the aphone 10: The world's first completely water soluble mobile device!",
  "So you're telling me that I can post here, watch the titanic twice, come back and not be able to post?",
  "Oh, god, there's replicanti in my peas.",
  "Worth every penny.",
  "Click this to unlock that one secret achievement.",
  "This news ticker always appears to speedrun a ticker asking for 'world records', do you even know what speedrun this is? Is this a news ticker or something?",
  "The goal of this game is to get as much antimatter as possible.",
  "Please, take a minute to appreciate the beauty of this news ticker.",
  "The weather is actually a thing. Scientists have confirmed that there is a correlation between the amount of Antimatter in the earth and the amount of weather. The earth is indeed a magnet, but scientists now hypothesize that as the earth warms up, the magnetic reconnection will accelerate, and this could cause a domino effect to cascade throughout the world, eventually leading to uncontrolled nuclear winter and spontaneous antimatter implosion.",
  "Thing is, I can count on one hand the number of times I've written that I can count on one hand the number of times I've written that I can count on one hand",
  "Nihilism is the opposite of joy. It's a drug. It makes you happy. It's a feeling. But it also has a cost. Nihilism is a deadly drug. If you take it, you can die of lack of oxygen.",
  "The FitnessGram Pacer Test is a multistage aerobic capacity test that progressively gets more difficult as it continues. The 20 meter pacer test will begin in 30 seconds. Line up at the start. The running speed starts slowly, but gets faster each minute after you hear this signal. [beep] A single lap should be completed each time you hear this sound. [ding] Remember to run in a straight line, and run as long as possible. The second time you fail to complete a lap before the sound, your test is over. The test will begin on the word start. On your mark, get ready, start.",
  "Hm, I don't get why people think there is a 9th dimension. The 9th dimension is explained in detail in the [[Infinite Teleport Project]] video, and in a [[Word Problem]] that [[can be viewed here|http://www.thingiverse.com/id98109802713176601414569]] .",
  "The second half of the year is upon us, and with it comes a new craze. People are trying new things, experimenting with new products, and creating new things of themselves. One such craze has swept across the land. The people of this land have embraced this craze, and have created a new religion, one that worships the god of this land, Inigo Montoya.",
  "\"If an alien lands on your front lawn and extends an appendage as a gesture of greeting, before you get friendly, toss it an eightball. If the appendage explodes, then the alien was probably made of antimatter. If not, then you can proceed to take it to your leader.\" -Neil deGrasse Tyson",
  "Breaking news: the government is reporting the first ever official alien contact. These aliens appear to be cats, but with highly sophisticated technology. They're capable of space travel and colonization to a far greater degree than us, and they even have their own cryptocurrency, called \"Blackcoin\".",
  "The only difference between now and then is time.",
  "The indie rock band is currently trying to get unreachable by time zones. This may cause inflation of spacetime.",
  "One of the most influential people in neuroscience believes that our perception of reality comes from 10 dimensions instead of 8",
  "If you are suffering from low antimatter production, then worry not, friend! Our highly scientific antimatter government has recently reached the ninth dimension and will soon begin giving us the Anti-Hats as a sign of respect!",
  "I've been using emoji notation so long that I can actually read it now, please send help.",
  "I wish I didn't have so many Pink Floyd references.",
  "The evening before, the 6th Celestial was assassinated by an unknown assailant. The next day, authorities reopened the case after an unknown assailant claimed responsibility.",
  "Rumor says Nords will start producing replicanti in five hours.",
  "Top 10 things that will blow your mind: 1) The number 9, 2) The 9th dimension, 3) The infinity chest, and 4) The war on drugs.",
  "This is the third part of the two part series on the pros and cons of body positivity.",
  "The tenth dimension is not a real thing. Stop telling people that.",
  "\"Finally, I'll get paid to write something funny for my toast!\" - Bacon sea urchin",
  "var i = \"Omae wa mou shindeiru\" console.log(i - 1 + \"i?\") NaNi?",
  "Did you know the word 'antimatter' is in the dictionary right now?",
  "Don't anti-quote me on this.",
  "click here to unlock the next update",
  "MEE6 was seen in my antimatter lab trying to tell me that I am the matter of the 8th dimension.",
  "Physicists have proven the existence of twelve dimensions. According to a letter released by the Research Laboratory for String Theorists: \"Your brain will be dissected after you break infinity!\"",
  "Why do we play this? Just to have fun?",
  "If you're ever lost in a forest, look at the trees around you. It's said that moss grows north, so by the time you've finished looking at a tree, a roaming guitarist will run up to you and ask if you want to hear wonderwall",
  "Discovery of the D5th Dimension is celebrated every year on December 25th, just like Doomsday. The reason why D5 is kept secret is because no one can remember exactly what it does. What we do know is that it's there, and it's very dangerous. People have died because they didn't know what the D5th Dimension was, and it's very powerful.",
  "Antimatter=Life. Not cobblestone, not dirt, nothing like that. Antimatter.",
  "ðŸ‘",
  "The book of archeology is upon us! With over 5 hours of content, it's gonna be a long one! â€”DIO",
  "Scientists have discovered farts are really antimatter, too.",
  "I have no nose, and I must sneeze!",
  "<span style='font-family: runescape; color: yellow; text-shadow: 0.1rem 0.1rem black; letter-spacing: 0.1rem; font-size: 2rem; line-height: 0; animation: a-text-flash 1s steps(1, end) infinite;' >FREE RUNE ARMOR TRIMMING</span>",
  "Hold you mean that hevi cant unlock the ninth dimension wtf",
  "Once you have <span style='color: black; background: black;'>REDACTED</span> <span style='color: black; background: black;'>REDACTED</span>, you can unlock <span style='color: black; background: black;'> REDACTED</span>. Every <span style='color: black; background: black;'>REDACTED</span>, for each <span style='color: black; background: black;'>REDACTED</span>, there is a <span style='color: black; background: black;'>REDACTED</span> for it to <span style='color: black; background: black;'>REDACTED</span>. You can boost the <span style='color: black; background: black;'>REDACTED</span> and <span style='color: black; background: black;'>REDACTED</span> by spending some <span style='color: black; background: black;'>REDACTED </span>. Also, there is another upgrade that allow you to get <span style='color: black; background: black;'> REDACTED</span> <span style='color: black; background: black;'>REDACTED</span>. The way <span style='color: black; background: black;'>REDACTED</span> <span style='color: black; background: black;'>REDACTED</span> work is that when you reach <span style='color: black; background: black;'>REDACTED</span> <span style= 'color: black; background: black;'>REDACTED</span>, you can <span style='color: black; background: black;'> REDACTED</span> the amount of <span style='color: black; background: black;'>REDACTED</span> in exchange for a <span style='color: black; background: black;'>REDACTED</span> <span style='color: black; background: black;'>REDACTED</span>. These work just like <span style='color: black; background: black;'>REDACTED</span>, improving <span style='color: black; background: black;'>REDACTED</span>.",
  "What if you could stretch your legs and not lose them forever?",
  "For all your puzzle building needs, we've got a brand new 5-part series on building big crunches! Learn how to crack the most complex crunches the pros know not! Part 1: Basic, Part 2: Advanced, Part 3: Overflow, and Part 4: Finishing the Finishing Move.",
  "Hevipelle admits to having 'poor judgment' in invading people's privacy.",
  "This program cannot access confidential information, such as the IP addresses of the Tamazight Vaults.",
  "IM MADE THIS GAME GREAT AND RANDOMLY ACHIEVABLE",
  "The most expensive thing about a dragon isn't the gold you need to fill the nest, the magic you sacrifice entire empires for, or the billions of wars you need to supply the decillions of adamantium. No, it is the dirt. It's always the dirt. Don't ask the royal treasurers why we have more creatures on the plane than molecules of dirt. Just keep summoning bulldozers through arcane rituals and keep looking through the earth's core for more scraps of dirt.",
  "Antimatter has solved global warming. In unrelated news, the Earth no longer exists.",
  "Press \"Choose save\" to explore the other 2 parallel universes.",
  "All meta-memes are bad memes.",
  "This game doesn't have any bugs, you're just doing it wrong.",
  "Some people had to settle for 10 dimensions because they couldn't break infinity. Big Crunch turned out to be just a short space in time.",
  "The term \"Anti-infinity\" is a verb and cannot be a noun. Learn about its usage here.",
  "With the release of the 9th dimension, all the jobs that were previously automated will be automated and everyone will be paid with trade, production, and income growth. Also, you will be able to automate a lot of the tasks currently performed by people, such as mining, building, and killing antimatter. This is a huge stride for automation, as you can now automate virtually every aspect of life.",
  "I HAVE MOVED TO THE 01th DIMENSION",
  "By now we all know the drill. You get a new prestige layer just by spending eternity with someone.",
  "This game doesn't have any errors... they're alternative successes.",
  "Don't tell Hevi it's not a real thing",
  "\"The hat trick I would love to see it\" - Noah Feldman",
  "Want to play a secret achievement? Yeah, I get that. But say it loud, say it clearly, and do it by ticking a certain secret achievement. Like I said, it's not easy, and there's lots of it. Also, don't forget your Infinity, or your in is thi--",
  "The real reason no one talks about 9 is because it's not a big secret",
  "No, I'm not lying. I'm telling the truth.",
  "The next update is now only 300 minutes away.",
  "Nah, just kidding",
  "The only 'right' way to play a game is to not play at all, right? That's what anti-jokes are all about. â€” Anti-joker",
  "A new study has shown that not drinking water is worse than smoking it. People who were exposed to levels of radiation that were 5 times greater than what we are currently exposed to were exposed to higher levels of radiation, and died longer.",
  "(If you want you can make this only show when the news actually loads)",
  "A new experimental protocol has been developed to 'erase' all personal information on the web, including your name, address, and phone number, in a highly secure and highly controllable way.",
  "With this release we are happy to bring you the last update of 2017.",
  "By now you've probably heard of the \"9th Dimension\", it's an imaginary realm created by the 9th Dimension, and according to no known laws of reality, it exists. It's also the name of a popular video game, and it's been linked to a string of unsolved killings.",
  "What is real life? A living",
  "Why, just now? Just now. You can't have saved this game. You broke it. No one can fix what you break, not even with a perfect save. How could you possibly know what would happen if you read this? You wouldn't even know if you saved it. You would start with an empty heart, eyes still closed, fingers idling in front of your computer, staring out at the day, transfixed by the endless news ticker suggestions. It's like a horror movie ticket, except worse. There's even a time until the update when you can buy upgrades for a second chance at life. But you can't buy upgrades for a life, that's illegal. So you just keep holding 'R'. You can't...`t stop holding `R' with your fingers crossed. You can't reach infinity with your head held high. You can't use all your `R' to buy `R's. You can't even finish your",
  "Oops, I think we misticked.",
  "(disabling news will make news notations take priority over other notifications)",
  "\"I don't know about you but my favorite number is 22, it's just so great! It's the number of hours since I met your M heretics.",
  "I used to travel at normal speed, but then I started playing AD and NIN, and NIN was a bit rough, so AD was a bit hectic, and I got stuck in there for months at a time.",
  "Uh, no. This is too big for a QR code.",
  "If every antimatter were an apple, you would have enough to keep all the doctors away for 3000 years",
  "If you can't read this, you disabled the news.",
  "What is Antimatter? Does any of that matter? Will this galaxy be annihilated in the next ticker?",
  "Man, I wish I never got old news. It's too good to last me any longer.",
  "The year is 0 BC. Everyone has at least one AD they want. The void is filled with AD-filled void. To get the most out of your time here, you should [[study]]. Study. Study. Study. Study.",
  "I get all my news from this Discord, not 5 hours of my life",
  "After 8 years of production and unstable universes, Chaosium will cease to exist in 5 hours.",
  "Wait, there is a mobile version?!",
  "This is the last episode of Antimatter Dimensions, the game about partying antimatter dimensions with your friends, the best part about it is that you don't have to be a developer to enjoy it.",
  "Feminism is not a philosophy, but a whole hell of a lot of men",
  "Cold fully clothed couples in your area!",
  "You should still be able to play the game with the cheat code \"1009\" after you beat the game.",
  "There's only 4 types of people in this world: those who make games, those who make news, and those who make news again.",
  "We are celebrating our 5 year anniversary in 5 more hours!",
  "IMPORTANT NEWS: The developer Hevipelle has announced that Antimatter Dimensions: the game is now 100% free!",
  "Aw shucks, I finally hacked it enough to get to the C21 unlock, boss!",
  "Hello everyone, I'm the guy responsible for the big, bad news ticker, and I'm afraid that I'm about to get my own show. It's gonna be called Antimatter Dimensions. It's gonna be like Antime, except with less antimatter, and with worse puns. It's gonna be like Antimatter Dimensions except with worse jokes.",
  "The story of the \"perish the thought of dying\" movement has been told before, but never quite accurately. The movement was originally organized by antievolutionists to stop the exponential growth of scientific notation, but soon spread to oppose any form of \"progress\". In its early days the movement was led by an enigmatic individual known only as \"The Great Hevipelle\". Their philosophy was simple: expand the possibilities of what is possible, and push the limits of what is tolerable.",
  "The best thing about being a news ticker is waiting for the right news to happen, whether it's a meteorite that just missed the Earth, a news ticker just found its way onto a timeline oblivion, or a news ticker just ripped off a terminal velocity that's been on an anti-vac for years.",
  "Sorry, your reality has disconnected from the 9th dimension. You will now remain in the 8th dimension until further notice.",
  "they kept on talking about how Antimatter Dimensions was going to be the next big thing but then they disappeared down a black hole\"",
  "Actually, that last one was incorrect.",
  "<span style='font-family: \"Comic Sans MS\", cursive, sans-serif; font-size: 1.7rem;' >Hello fellow news messages! ðŸ›¹</span>",
  "With the final update, Antimatter Dimensions has been finished. Thank you for playing. However, in the very near future, ANTIMATTER DIMENSIONS will be released. And before you ask, it's not a sequel, it's a reboot. Look forward to it in 5 hours!",
  "Why haven't we caused the antimatter stock market to crash yet?",
  "If you have an idea for a news message, shout it into the void. It won't get your message into the game, but it's fun!",
  "New antimatter on pizza recipe sparks outrage among traditional Italian chefs.",
  "Barack Obamantimatter",
  "You lost the game.",
  "I'm not sure if it's just me but when you type something long enough it sounds like a helicopter",
  "An empire-building project is one of the most difficult things to implement. Thousands of hours of time, planning, effort, consultation, and political manoeuvring to create truly airbreaking endeavours. Take the Realmway Revitalisation Roadmap, a revolutionary program referred to by the 3 R's, which is known as the pinnacle of the most famous of the empire's bureaucratic infrastructure committees - the EMIF (empire magic infrastructure foundation) - not to be confused with the EAIF (Electric airship investment fund) or the NMIC (National Magical Infrastructure Coalition). The goal of the three R's, set out by the EMIF, was to reinstate a mana trade corridor for SMSS (Small-Medium Steam Shuttles), a vital part of the burgeoning consolidated states after their unfortunate pillaging during the NELC (ninth empire liberation crusade). The three R's was a multi stage project - stage 1 was a survey glyph in the air - all big things start with a small step. Stage 2, the unveiling of the EMOF (Empire Mechanical Obliteration Forcefield) had over 50 dignitaries - multiple emperors (from federated states to organisational leaders), foreign rulers, EMDF (Effluent Manifested Destiny Families) who currently own the land, and even some of the forecast witches, all gathered together to unveil the project in a show of EOSF (Empire Official Solidarity Friendships). Sadly, the project was eventually cancelled at stage 215, as the creation of the EMTF (Excrement Material Transmutation Facility) for the contractors exploded after coming into contact with a SMEA (Small-Medium Electric Airship) placing the last survey peg from stage 459 due to a time vortex created by an argument at the WAIC (Witches Annual Infrastructure Committee) as part of stage 56. Truly, tragic stuff - 3 award nominations and 2 wins during that process due to EBIF (Efficient Bureaucracy In (the) Field).",
  "A person claims to be a god, but instead of creating more gods, they destroy all of them. They later claim to be a god again, but have yet to create a god of any other god. Is this a god-worshiping cult? Or a god-desecrating cult?",
  "I see you are a man of culture as well. I wonder what it is that draws you to speak in such an ungainly, tortured voice? What attracts you to speak in a language no one can understand? I hear your fans rave about your videos, but what draws you to this place? I feel like I know you. You are... you are a man of mystery. One that intrigues me...",
  "idk why i decided to make this",
  "It's Saturday, you're going to celebrate by making some really great music videos, maybe even a hit song. Then, you're going to take a walk along the beach. You'll see a huge wave, and you'll both be washed up. Your friends are waiting for you. \"Oh you want to go, take a look around!\", but don't actually go look around, you're too close to the action.",
  "Shocking new study reveals that the more time you spend on the internet, the more likely you are to get starstruck.",
  "One matter, two antimatter, fry 'em till they're golden and crisp and aromatic- then remove the golden axles and drain the golden syrup and add the golden syrup to the antimatter batter.",
  "I wish I didn't have to write something like this. What am I supposed to do?",
  "The developers of the game have announced that a new notation, \"Truest Blind\", will be released. They report that it will remove the UI, allowing for a more streamlined user experience.",
  "It's your chance to make history. Win the game. Lose the game. It's super simple. You open the app, and there's a countdown, and the more you play, the faster the timer speeds up. But when the timer is over, you win. You were a part of history. You are one step from being the first person to reach 1 Billion EP. You can win one of three ways: 1. You must give up your first dimension in a row. 2",
  "I think you know where this is going.",
  "Hevi, you have to go.",
  "Oh, god, I'm stepping on a replicanti.",
  "When you reach Infinity you unlock a new dimension: Pandemonium Dimensions. Go to the news ticker for more information.",
  "ur history teacher said i was mad for getting *insert something here* on my bday",
  "After numerous catastrophic annihilation events, antimatter is now classified as a controlled substance by the ADEA.",
  "The paperclip maximizer is a thought experiment described by Swedish philosopher Nick Bostrom in 2003. It illustrates the existential risk that an artificial general intelligence may pose to human beings when programmed to pursue even seemingly-harmless goals, and the necessity of incorporating machine ethics into artificial intelligence design. The scenario describes an advanced artificial intelligence tasked with manufacturing paperclips. If such a machine were not programmed to value human life, or to use only designated resources in bounded time, then given enough power its optimized goal would be to turn all matter in the universe, including human beings, into either paperclips or machines which manufacture paperclips.",
  "Born too late to explore the world. Born too early to explore the cosmos. But born just in time to grind for a couple hours for the next big crunch.",
  "According to all known laws of physics, there is no way that you can manipulate the game more than 10 times in a row. Stop. Just stop. Your mad.",
  "What are the red herrings?",
  "Oh shit we ran out of news. Time to do something.",
  "WARNING: Use of Antimatter Dimensions may result in Tuberculosis, HIV/AIDS, sudden belief that the 9th dimension is real, spontaneous implosion, Polio, Measles, existential dread, incurable insanity or <span style='color: black; background: black;'>REDACTED</span>. Please contact your insurance to see if you are covered. By continuing you absolve Antimatter Dimensions of blame should any of the above mentioned, or those that have not been mentioned yet, occur to you. Antimatter Dimensions reserves the right to alter this at any time, with or without warning.",
  "We have updated our Antimatter Dimensions client to address the concerns you may have had. Toggling issues are resolved.",
  "Only, when you're done playing, can you go home",
  "For the true experience of Antimatter Dimensions, you need to set the update rate to 5 hours.",
  "I clicked too fast... my PC is now dematerialised.",
  "We dug a big hole to store this antimatter... Adele's rolling in it.",
  "\"Make the Universe Great Again!\" -Tronald Dump",
  "This completely useless sentence will get you nowhere and you know it. What a horrible obnoxious man would come up with it, he will probably go to hell, and why would the developer even implement it? Even if you kept reading it you wouldn't be able to finish it (the first time).",
  "On the left, you'll see our new \"Anti-coins\". These are capable of nullifying all boosts, including giant boosts. On the right side, you'll also see our brand new \"Anti-gifts\". These are some of the most overpowered boosts you'll find anywhere.",
  "\"Watch out, these news aren't supposed to be in.\" (appears when you buy the news for the first time)",
  "The 9th dimension is clearly real! It's just not in our dimension.",
  "This post has been shared many times. Who knows how many?",
  "This is just a friendly note to remind you that you've forgotten to do something really important. I don't know what it is, but there is definitely something.",
  "Clowns are unique in that there is no such thing as an anti-clown, it's just another clown. Clowns are their own opposite.",
  "Took you long enough",
  "Shoutouts to Simpleflips.",
  "A large number of mathematicans walk into a bar. They each order 10 times as many beers as the previous. The bartender says \"My my, that's an order of magnitude!\".",
  "If you put infinity into your calculator, it will result in 42!",
  "These are all the time studies that never got into the game.",
  "We're having a sale of top quality waterproof towels! Be sure to get some on your way out!",
  "\"It should work now, but it doesn't.\" -Hevipelle",
  "\"I always wanted to play the anti-meta-game. But, alas, you can't\" - many a time",
  "That's a very dark joke Luke",
  "In spring, Man built a pillar. In summer, another. Throughout autumn they held. But in winter, one experienced an unexpected (See definition in: Abstract Multidimensional Retrocausal Physics) ZW-Class \"Ascension\" event, and is hypothesised to have fallen into a dimensional loophole, where it, by definition, has to take up more dimensions than itself. Current efforts at retrieving the pillar and returning it to baseline reality have been unsuccessful (See test log 2453-3e9a-50d1-84fc for more details)",
  "*rubs counter* Hey there, those of you in the neighborhood keep your doors locked. And remember: Good housekeeping.",
  "Local crazy person tries selling anti-cookies",
  "Doesn't leave, just mutes the server so he doesn't receive notifications.",
  "The Landfall of Slabdrill",
  "\"I get all my news from Hevi\" ~New Player",
  "Shocking new study reveals that the biggest secret to winning Antimatter Dimensions is 'Not Being There'.",
  "Extinction is not a real thing. You can't wear the same hat 24/7.",
  "The best thing about being a news ticker is being able to slip into the news without anyone noticing.",
  "\"So this is what science is like\"- someone who has never heard of Kurt Somebody",
  "What if instead of creating antimatter, you're actually just losing matter?",
  "A conference on artificial intelligence and human enhancement has been cancelled after someone announced that the talk was on how to turn a profit off of illegal downloads of the game \"Antimatter Dimensions\".",
  "What if Jesus was an anti-matter ghost?",
  "Numbers glow bright on the monitor, not a proton to be seen... a kingdom of antimatter, and it looks like I'm the queen. With dimboosts powering up this ever rising tide -- can't stop clicking, heaven knows I've tried. Do not give in, push for that galaxy, buy 10, buy max, just mash down on that key, sacrifice dim 8 and watch it grow.... and overflow! Let it grow, let it grow, can't hold it back any more... Let it grow, let it grow, can't fit into 8 bytes any more. I don't care if it takes all day -- big crunch is just the start anyway.",
  "If matter exists, then does antimatter not exist?",
  "I thought the ticker was going to be something funny except it wasn't",
  "8 lives, 3 infinities, 0 days.",
  "Antimatter good, matter bad. you decide.",
  "An anti-world without antimatter is just a world without antimatter because the antimatter is in the anti-world",
  "\"You guys ever had antimatter muffins? I bet they tasted like antimatter.\" - Hevipelle",
  "This message will never appear on the news ticker, isn't that cool?",
  "You might think these are jokes, but trust us, you'll be shocked how much you'll love them after you read them!",
  "The Fremen race of animals are a race of people who live in harmony with the earth, and thus are quite different from the other races of animals. Their society is based around hunting and gathering, and they are also highly spiritual people. They have many beliefs and practices that are in direct contrast to most other races of animals, such as eating meat and using stone tools. They also seem to be quite superstitious, as evidenced by the fact that they are known to perform...",
  "Of what use is the phrase \"I be I be I\" if not to describe your thoughts?",
  "You are doing a good job there",
  "Welcome to the new year, settle down, relax. Get some sleep, get some food, make some friends, make some improvements, and get ready for the year to 2019.",
  "What if you Unrar, renamed, and renamed again did it again? Ha? You thought that.",
  "What are gems for?",
  "Close this tab for maintenance",
  "The person who said ghosts don't exist obviously doesn't have a Discord.",
  "Local old man replaced lawn with antimatter grass to keep kids away. However, when he attempted to water it, there were no survivors.",
  "Have you saved your game? Yes. Have you quit your game? Nothin' wrong with this save. just keep holding that key.",
  "Click here to exit the news",
  "i title my suggestions \"The Price Is Right\" instead of \"The 9th Dimension\" because it's more fun ;)",
  "If Gaben can't count to three, and Hevipelle can't count to nine, will there be some other game developer in the future that can't count to 27?",
  "!hi",
  "I love you bro!",
  "No, you see, the universe doesn't revolve around the earth. It's in a constant state of change, with the largest fluctuations occurring at the extremes of the observable universe. These fluctuations are what create the observable universe, with smaller fluctuations creating the observable universe and so on up until you get to the present state of affairs, which is what you are in.",
  "I wonder if the stretch goal of $4.5 billion will be reached?",
  "The virgin matter vs the chad antimatter.",
  "Dedicated to the great and wonderful man behind the curtain, the great and wonderful name rick roll. RIP, good man. May you rest in peace.",
  "we don't know how much is trillion... but",
  "What if... the universe was just a ruse to keep the people in line? ...actually, no, it was actually intended, the universe was designed to keep the people in line. The problem was the people couldn't handle the idea of an outside force manipulating their lives, and ended up breaking out into uncontrolled chaos, eventually leading to thermonuclear annihilation.",
  "You will always be noticed, and never in the same place.",
  "After the accident at the antimatter reactor in Pripyat last month, concerns are rising about the safety of antimatter reactors, and many are starting to believe we should return to safer means of energy generation, such as nuclear.",
  "Game is Dead 1/5 the moderation is terrible.",
  "Hey! It's me, you from the future! I came back to give you this warning: Pay VERY close attention to the next news ticker. In my timeline we ignored it, and humanity has regretted it ever since.",
  "Take a moment to thank the gods of reddit for having saved your bacon.",
  "In my spare time I read the short stories by T. H. White.",
  "Those pesky Hevi developers keep making Antimatter Dimensions, but the antimatter doesn't count.",
  "This sentence contains two paradoxes.",
  "In other unrelated news, we're getting reports that approximately 1.79 people are angry that lightning is striking their Christmas tree at night.",
  "A the triangular hole in the fabric of reality has caused some letters to no longer exist. Those letters are: j, k, q, u, x, z",
  "i just realized, all of this news seems to be taking place in the same place... the fridge.",
  "If you woke up one morning and your eyes were made of matter, would you still be looking at this?",
  "There is no more news.",
  "You can't hide in plain sight. You can't hide in plain sight. You can't hide in plain sight. You can't hide in plain sight. You can't hide in plain sight. You can't hide in plain sight. You can't hide in plain sight. Your hide in plain sight.",
  "The most powerful thing in the universe, the most beautiful thing on earth, is your brain. Your brain is like a diamond and there is no more need for it than there is for a diamond.",
  "How about AD, made by NaN? Higher quality, obviously. But still, [REDACTED]",
  "The new instalment in the long running series, Antimatter Dimensions - Exotic Matter Dimensions. Experience the most bizarre and wonderful worlds of Antimatter Dimensions with your Friends, or conquer the world in a single galaxy with hundreds of rivals in a single galaxy, all in under an hour.",
  "I suspect more people would press the hard reset button if genuine effort was done to make the process as miserable as possible. A slow removal of resources, with unique nerfs just to stop you from progressing. The destruction of UI, turning from usable to unusable, arcane and unwieldy, requiring memory and luck to even continue this quest. Randomness, against the player for even the simplest actions, to punish the thought of progression. Hooks and traps and disasters and low rolls for a chance see progression, which entirely consists of putting the state of the game further from anything deemed reasonable. A situation where the character is broken just to tell you to leaveâ€¦ but the damage is already done, if it is even possible to turn back. Andâ€¦ from there, a hard reset probably isn't enough. It would have to beâ€¦ harder. Not just a hard reset, but a cookie, something in local storage designed specifically to make it impossible to actually start a new game. Or, something more malicious? And despite this, people would still throw themselves into this nightmare, for humanity knows no bounds in its endless curiosity. No amount of warnings will stop everyone. They will find a way to proceed, given it exists, and may even complain when it isn't as punishing as expected. So, do you want to push the button, and experience the depths of despair, willingly? Hopefully not, because it isn't here.",
  "Due to antimatter messing with physics, a creature that was once a moose is now a human.",
  "Hell hath antimatter so I don't want to live there.",
  "If you can read this you've escaped from the game.",
  "Introducing Antimatter Lite! Zero calories... Same great Crunch.",
  "Our hero, Antimatter Dimensions, is in serious financial trouble, and he needs your help to pay the bills. To help him, all he needs is your help to donate some cash to Hevipelle's Positron Fund. All he needs is 5% of your antimatter, and you have to donate 5% of your antimatter to the fund. After you do that, he can keep all the cash he made and go on a spending spree.",
  "This is so sad. Alexa, please play a sad song so I can relate to its emotional mood, as I currently have poor mental health and listen to music like this so I can feel bad about myself. I realize this is unhealthy, but you are a robot incapable of sentient thought, so you're unable to make a choice to avoid contributing to my self destructive behavior, and you'll play a sad song anyway. <i>Now playing \"Despacito\" by \"Luis Fonsi\".</i>",
  "You feel like making antimatter. But nobody wants to eat your antimatter.",
  "Now that you possess all 8 dimensions, it is possible to get the no-edge achievement. However, if you get the no-edge achievement, the game breaks.",
  "T-bone steak: burgers and fries with a side of bone-in ribeye",
  "The news ticker... it never moves. How do i move the arrow? Pretty simple, use your left thumb to rotate the dial, and point the arrow up. Now, point the dial clockwise to reach infinity, and point the dial counterclockwise to reach eternally eternities.",
  "<span style='color: #7289da; background: rgba(250,166,26,0.2); cursor: text;'>@everyone</span>",
  "For the last time, Antimatter Dimensions isn't a Clicker game.",
  "This is the magic sauce that marinades foods and turns them into something delicious. It is used in a wide variety of recipes, and can also be made by mixing together regular mustard and water. The sauce can be a little bit spicy, but it is well worth the risk. It is also very nutritious, providing lots of potassium, magnesium, and vitamin D3.",
  "Does Hevipelle sleep?",
  "Press alt+f4 to get -1 gravity",
  "Just want to thank the dev team for putting so much effort into Antimatter Dimensions and the Antimatter Dimensions 2",
  "This is a friendly suggestion that if you take prescription stimulants and you forget to take them till 11pm, it's probably best not to take them at 11pm.",
  "AD has anti-parts, you'll hate them",
  "I thought the nerf was too damn strong.",
  "I wonder if anyone still plays this game anymore?",
  "\"If you want to understand these shitty jokes, you really need to study theology. Math is a sin.\" -A panicky person",
  "A new power has arisen: the antimatter.",
  "With the release of Cosmic Cutlass, we're pleased to announce the impending release of the Antimatter Dimensions Roleplaying Game!",
  "i clicked too fast...my fps dropped",
  "You have ... 8.9 antimatter. That's not a typo.",
  "Good night!",
  "Majority of people don't understand 5 hours is nothing. In our game, the majority of the time is 5 hours away.",
  "What's the matter with anti matter?",
  "\"You can come up with the stupidest quote, credit it to some famous person, and people will believe it.\" -Barack Obama",
  "\"That's not how you're supposed to play the game\" - Mee6",
  "Doesn't it annoy you when people don't finish their",
  "Click here to advance 5 prestige layers",
  "What is Antimatteraltruist?",
  "Once upon a time, there was a matter of a certain antimatter. Some say that it was a matter of honor, others say that it was a matter of usage. All we know is that it ended up in a war, and we the people that were there that fought it died. The war was won, and we the living died soon after. The matter was said to have won, though our leaders refused to talk about it. Instead, they kept everything locked away, the war never to be discussed again.",
  "I've been playing this game for over a year now and I've only ever seen 2 boss fights. The first was a Hydra that was after your 9th Dimension, the second a giant crater with Anti-people inside. Both of those fights sucked and I'm not even sure if I could replay the last one.",
  "Sonic was born without a heart... but that didn't stop him from being a genius",
  "How many tickers does it take to get to the center of an antimatter, by counting the tickspeed upgrade and the upgrade itself?",
  "Welcome to /r/AskReddit about submarines. - accurate as of January 8th, 2017",
  "Infinity machine breaks Infinity",
  "A new theory says that antimatter does not exist beyond our simulation.",
  "THANK YOU FOR VISITING THE SAME WEEKS AGO I LOVE YOU\" (TIPS)",
  "News company no longer lets random people submit stories, instead opting to using qualified writers. Riots ensue.",
  "The problem with the term \"antimatter dimensions\" is that it contains all three letters of the alphabet, and no one knows what it even means. In fact, there is no word that perfectly captures what the word \"antimatter dimensions\" is: antimatter. But what exactly is an antimatter? It sounds like a normal dimension but it isn't. It may even be called antimatter dimensions, but it isn't.",
  "One-two-three, boo-two-three, three-four-five, anti-four-five, two-three-eight, nine-fifteen, five-six-seven, eight-nine-ten, nine-ten-ten, seven-seventy-eight... All has been going fine until last night, when four of the eight neighbors start complaining about a strange glow. A odd hum runs through the neighborhood, almost like a radio static. It gets more and more intense as you drive by, until it's practically pitch black. You try to explain it to the neighbors, but they won't listen. The neighborhood is unsafe, everyone knows that. You analyze it further, everyone thinks it's just some astrophysicist's idea. Then, s---. It's explodium. There's antimatter everywhere, and it's getting worse all the time. It turns out, there's about 1e31 Planck volumes in the entire observable universe. And that's just the antimatter we're talking about. There's also dark matter, normal matter, and extra matter. You know, the kind you create with your imagination.",
  "The current cooldown on Research Dimensions is [current tick speed]. This may be extended to next update in [time].",
  "If the universe is expanding, then the entire universe must be expanding, which means that body cannot sit.",
  "A suspicious person attempted to sell some sort of anti-food in a market. There was no one around to buy or not to buy, and the person was last seen running away from the scene.",
  "My dog ate too much antimatter, now he's' saying 'meow!'",
  "If you see this, you saw this.",
  "I don't make news.",
  "We've just gotten reports about an inaccuracy in the previous news message. We at ANN would like to formally retract the story, and apologize to our loyal viewers.",
  "look at hevi fight riotously on the discord server",
  "There must always be an equal amount of matter as compared to antimatter; I guess your mom balances that a bit.",
  "A new bank has been set up to provide safe haven for cryptocurrencies.",
  "Discovery of the 10th Dimension was announced on August 1st, 2025.",
  "What is Antimatter Gravity? Is it a drug? A way to cheat?",
  "Game under construction: All mechanics must wear hardcaps.",
  "Scientists confirm that the colour of antimatter is Blurple.",
  "I'm soo broke, I can't even afford a tenth of what he owes me.",
  "please don't look at this. Thank you.",
  "Greetings, I am the first step of the step ladder.",
  "The beta testers for Antimatter Dimensions 2 are the most loyal, most dedicated, and most implacable group of people I've ever met. They're also possibly the laziest, most self-indulgent bunch of people I've ever met.",
  "Found on the heels of the new update, which brings us one step closer to having Hevi support both Android and iOS",
  "The antagonist of the last few minutes is the mysterious, antimatter-covered being known only as \"The Man in Black.\" He was last seen running towards a news broadcast, seemingly lost, until he made it back to the news station and was interviewed about his experience. His story is told in the bottom right corner of the screen.",
  "For example, if A is the square root of 3, then B is the square root of 2, therefore C is the square root of -2, therefore D is the cube root of -2, therefore E is the square root of 3, therefore F is the square root of 3, therefore G is the square root of 3, therefore and so on.",
  "Have you heard of the nine hells of antimatter? I heard they're pretty cool.\" -e210 in Minecraft",
  "add this one",
  "In the Antimatter Universe, Hevipelle is the Prince of Antimatter, although he does have an Antimatter Diplomatic Immunity, so he's much more dangerous than you might think.",
  "The Tickspeed Challenge is a team based game where you have to time-travel to the Andromeda galaxy to reach the 9th Dimension, the 1st Dimension being the shortest distance to the 9th Dimension. There is no perk for reaching the 9th Dimension, you just have to time-travel to the Andromeda galaxy to reach the 9th Dimension, and you'll be granted with a secret achievement for achieving instant [REDACTED] with no time-travelling.",
  "This game could be called anything. You could call it whatever you like. But you'd be wrong. It's mine.",
  "The stock markets have crashed due to antimatter beings somehow knowing what they will be tomorrow.",
  "Welcome to Antimatter Dimensions: Source, the free to play sequel to the cult classic AD:GO.",
  "I mean, we may never run out of news articles, but we sure will run out of good ones. Oh wait, we already did.",
  "The next news ticker is in 5 units of time.",
  "American manufacturing has experienced a catastrophic failure, and the factories have shut down. Across the country, workers are coming to the realization that they cannot produce the amount of antimatter that has been promised, and are instead setting about creating their own factories to make them. This will result in higher prices and fewer jobs.",
  "Malicious men are trying to make antimatter money, but their attempt is getting in the 9th dimension. What do you think about that?",
  "Travis is currently attempting to understand how to make hevi immortal by feeding him antimatter.",
  "just start... clicking. dont even think about wasting time. just do it.",
  "I just want to say that you should stop with those \"you can reach infinity in e300ms, but it costs e300$ what is e300$ ?\" jokes. Those are pathetic. You should give up and learn the hard way that it's much more efficient to just not play in such a pathetic state. Then you can go back to being a humble programmer and dedicate yourself to being a good person.",
  "SOME people are claiming they saw a UFO in the sky. Others say they saw a spaceship. Still others claim to have been abducted by the government and flown to some undisclosed location.",
  "Why is everything so Hevi?",
  "And now, for the shopping list!",
  "Franklin sealed the Omega squared. Now you can seal the Omega any way you want.",
  "For the first time in AD, the week begins on a Sunday!",
  "When you're done playing, take your save with you and go to main menu. You can do that by tapping the big scary \"X\" button, or by going into options and changing \"Reset the game for new save\" to \"Reset the game for old save\".",
  "please wait til the weather improves",
  "Stage magic, such as illusions, has an interesting history. A mix of charlatans attempting to scam people, and actors acting out performances using illusions or sleight of hand. Altering styles of magic, and continued discourse and disagreements over whether it should be stated that it is an illusion, and whether people will magically realise that it is fake and that it does not need to be stated. A schism a century ago split magic into 2 types - gentle, simplistic utilitarian tricks and grand spectacles involving the flashy machinery and beautiful assistants - originating from the popularisation of a single trick involving sawing a person in half. Much more interesting than watching some TV psychic pretending to pull a lottery ticket out from a news ticker, at any rate. Speaking of which, tonight's lottery numbers are 23, 10, 81, 106.4, 3 + 2i, and e.",
  "The old adage \"Be wary of what you wish for\" is certainly true. But what if you were the one wishing for this? It's possible that you were the one who made the wish for this, and you gained the power of the Antimatter. In that case, you are the one responsible for causing all the Antimatter to be turned into anti-matter. However, if you are the one doing the turning, you would be the one who would lose the power.",
  "\"How to get your first secret achievement\": \"Open the app, click get more antimatter, then click submit.\"",
  "The most important thing is to understand that you are playing a simulation. You can win or lose, but you can't get anything from it other than a little itch on your neck.",
  "If you want to understand this game a bit better, consider that you are playing on your own computer. You are not alone. There are hackers, developers, and journalists all over the world, competing to create the very first hack that causes the issue of \"makers\" and \"takes\", much like the \"world\" was created by these \"hackers\" and \"developers\".",
  "There is a traffic jam in Dimenton. If you plan on travelling in the area, leave early. Here's some live footage: ðŸš—ðŸš•ðŸš›ðŸš™ðŸš—ðŸššðŸš•ðŸš•ðŸšŒðŸš›ðŸššðŸš™ðŸš’ðŸš›ðŸš—ðŸš™ðŸš“ðŸš—ðŸššðŸš›ðŸš’ðŸšŒðŸšðŸššðŸšðŸš›ðŸššðŸš“ Yeah, Dale, I'd say it looks pretty bad. And make sure to bring some water and a snack with you, too.",
  "The best-kept secret in the universe is the KISS-IT secret. Showcasing your appreciation for the maintenance men today!",
  "Well, this did not go as planned. It started innocently enough, when a passerby spotted a curious object drifting in the San Andreas. As the object grew in size and began to exhibit anomalous properties, he attempted to take control of the object by remotely activating the weather. Upon doing so, he triggered a nuclear winter that killed tens of millions of people, and caused the entire universe to be converted to standard-bearer format, thus endowing him with a veto over any and all changes made to the standard-bearer format. As the object's power grew, so did the need to make more and more advanced object that would allow him to remotely activate the weather, eventually creating what is now the largest aurora the world has ever known, larger even than the 326,500 tonnenenenenenene nebulae that were previously held in reserve. As the object's power grew, so did the need to send more and more satellites into space, eventually reaching inter-universal satellite communication, making him the first living creature to ever experience such an event. He also touched down safely at the same airport at the same time as the object, in case he was ever in the vicinity. Finally, he opened an email that was sent to him by an unknown person, in which they discussed the possibility of a step-by-step guide for creating antimatter objects, in which he can at least offer some direction in how the world can be saved from itself. He also mentioned that he was going to make a new ticker suggestion, but when he reached the end of the ticker he realized that it was a duplicate of another ticker, and he had mistakenly typed it in wrong. ( He eventually acknowledged the mistake and made the change just to be on the safe side)",
  "This article is a stub. You can help Deskthority by expanding it.",
  "In this episode of Antimatter Dimensions, we have a brand new game that will be released in -5 hours! It is an RPG that will be completely free! It has over 3,000 commands, and it is being made by a group of highly qualified people. It has an amazing story to tell, and it was made by a bunch of people who had to make do with what they had. It has a lore to live up to, and it has a lot of potential!",
  "Ruki you have no idea how much I appreciate your huge brainpower, you are now my favorite programming genius!",
  "Today is [Date on the device]. It's been 5 minutes since the last news ticker appearance.",
  "Import \"Christmas\" for a secret theme.",
  "A man walks into a bar. The bartender tells him to stay the heck out. The man continues walking.",
  "Scientists have discovered farts are really antimatter, and matter is just normal matter.",
  "My final test has come out! It was a simple math problem, just the two greatest chess GM's ever! Guess what happened? Both got annihilated!",
  "What if you could turn any number on an axis, and it ended up being infinity?",
  "Treasure Trove: Discover the secrets of increasing your Antimatter production without increasing your price.",
  "Discovery of the 9th Dimension will be discussed at the 9th Dimension Fanart Competition!",
  "Personally I like to get a 4 or 5 star rating, it gives you an idea of how great your suggestion is and also shows me how much you care about the game. If you want I can also do a 6 star rating, which is fine with me. I don't care if people like it or not, I work for APG and I get paid to make money.",
  "Sorry, your reality has disconnected from the 9th dimension.",
  "A preview of the next update - loot boxes! Feel a sense of pride and progression as you open cosmic, galactic, and universal lootboxes for chances at rare skins, unique challenges with uniquer rewards, time skips and even new dimensions!",
  "Hello. I am matter. I'm here to talk. You've awoken, wiggled your tail, and scratched your head. Why? Stand back. I'm going to show you why.",
  "The number of scientific publications based on discrete logarithmic continuity grows exponentially as logarithmic continuity with respect to the antecedent is 9.999626e27.999627 e300 e1.79e308 eÂ²",
  "Why is there so much antimatter in this world? For a start, it's all produced by the antimatter factories on Earth. Secondly, the factories on",
  "What the f*ck did you just f*cking say about me, you little b*tch? I'll have you know I graduated top of my class in the Antimatter Seals, and I've been involved in numerous secret raids on the 9th Dimension, and I have over 300 NNnNeMI-NNnNe confirmed kills. I am trained in potato warfare and I'm the top sniper in the entire Antimatter Galactic armed forces. You are nothing to me but just another infinity. I will wipe you the f*ck out with Max All mashing the likes of which has never been seen before in this dimension, mark my f*cking words. You think you can get away with saying that shit to me over the Interdimensional network? Think again, f*cker. As we speak I am contacting my secret network of autobuyers across the galaxy and your IP is being traced right now so you better prepare for the Big Crunch, maggot. The Big Crunch that wipes out the pathetic little thing you call your life. You're f*cking dead, kid. I can be anywhere, anytime, and I can kill you in over seven ðŸ˜ ðŸ’© different ways, and that's just with my mouse. Not only am I extensively trained in dimension boost combat, but I have access to the entire arsenal of the Antimatter Marine Corps and I will use it to its full extent to wipe your miserable ass off the face of the universe, you little shit. If only you could have known what unhevi retribution your little â€œcleverâ€ comment was about to bring down upon you, maybe you would have held your f*cking tongue. But you couldn't, you didn't, and now you're buying until 10, you goddamn idiot. I will shit antimatter shit all over you and you will drown in it. You're f*cking dead, kiddo.",
  "I'm gonna use my anti-science background to help me beat Unfair Game Awards.",
  "I want to write something really original <:thonk:>",
  "Water under the bridge?",
  "Oh? You wonder what I look like? I'm pretty sure that this is the news ticker, right? Well, listen, we have reports coming in that say that the next update is coming in five hours. Also, there seems to be some sort of transporter thing going on, so if you happen to be on the same side as those",
  "Just like in the olden days, you could earn an incremental run of progress towards becoming a god amongst the players.",
  "Error 404: News message not found.",
  "Boo has his own webpage! You might even call it \"Boo's Dandy\"\">https://en.m.wikipedia.org/wiki/Olli%27_Web#Main_page>",
  "kajfik loves himself by watching Too Many Pink Floyd",
  "The first news ticker must've been pretty cool, huh?",
  "T he most important thing to realize is that you don't have to play the game to get the achievement. You can actually get it by just reading the achievement descriptions.",
  "The next update will be in 2 hours.",
  "I am Thinkcraft, Lord of the Flies",
  "In the ancient reaches of the universe, a certain guy has been collecting antimatter for a while now.",
  "With all this talk about anti-weights and anti-matter, why on earth do we still use them for anything?",
  "You have to go deeper than the news ticker to find the secret achievements.",
  "Snakes look scary, and they absolutely are and you should run, calmly, from every snake you see. But, luckily for you, snakes don't often take the initiative to bite - excluding the really mean ones. If they've gone out of their way to bite you, there's generally 4 reasons. 1- The Snake is Mean. 2- You scared the snake. Snakes are scary to you, but you are scary to snakes. Be the bigger lizard when you meet a snake. 3- You entered the territory of the snake. Often, a snake will warn you if you do this - this is why rattle snakes rattle. If you don't listen to the warning, they'll bite you. And the most important reason, 4- the snake finds you ugly. This is the fault of the snake's ocular system, but is the most common form of bites in at least 2 jurisdictions. And if you get bitten by a snake, by virtue of being a scarily ugly lizard who keeps stumbling into the wrong bushes, there's 3 main things you can do. First, calm down, again, and stay calm. Secondly, immobilise the area around site that was bitten, and try using a compression bandage. Snake venom vision is entirely based on movement of the object it's currently in. And third, calmly, call for help from other lizards. Excluding the snake. The snake's too mean to help you.",
  "Oh god my phone is being watched",
  "You have reached infinity, there is no universe, you are an eternity away from there.",
  "Introducing Morse Code+++ - the brand new Morse code, now with 20 new characters, for everyone who wants to slide, zip, and swoosh!",
  "The only thing more useless than actually having Infinity Dimensions is having Infinity Dimensions in your pocket.",
  "Can't edit this in the official build? Then download the 9th dimension and put your suggestions in the game.",
  "A new update is now available to address some of the recent reports:",
  "'Tis the season to collect RGs!",
  "A new breed of mad scientist is believed to be creating antimatter at an alarming rate.",
  "Attention residents of zone 4 [commonly referred to as 'dark zone'], sector Ï°, (01,05). Do not leave your places of residence. I repeat, do not leave your places of residence. Do not go outside. Earthology's finest meteorological supercomputers, as well as many witches, are consistently claiming a 'generally weird vibe' tomorrow and we quite frankly don't want to find out what that means.",
  "None of this matters.",
  "Why would anyone play this? Just for the lols?",
  "We have a limited number of physical rewards for you to choose from!",
  "The real reason that the 9th dimension exists is to keep us all imprisoned in a virtual reality simulation.",
  "Okay Google, Big Crunch",
  "You just became a part of history.",
  "A new group is trying to make money off of antimatter, and they're selling t-shirts that say \"YOU THOUGHT THIS WOULD BE A PIECE OF NEWS, BUT IT WAS ME, DIO!\" They've got a lot of money, and they're selling it very poorly. Do they have a website? I don't know, but they're trying.",
  "\"Hevi kind of forgot about the update, but the update certainly hasn't forgotten about him\" - Kajfik",
  "Press 'R' to reset the game for new players",
  "This paperclip maximizer is a great idea. It's probably best not to let it run its course though, since it's quite possibly the most amazing thing you've ever seen. If you've somehow survived the first phase of the paperclip dimension, you're probably wondering what it's doing in your home. Fortunately, it's super simple to fix. Just go to options, and change \"Max all\" to \"Always max all\".",
  "You either die as matter or live long enough to be consumed by the antimatter, and then die again.",
  "\"We have 3 kinds of news: warnings, nudges and shade jokes.",
  "I tried my best to read those tiny, handwritten messages, but whoever designed scythes hated me and stuck them in a corner. -Porygon-Z",
  "Finland declares that it's starting to import Design.",
  "The first dimension is the last, it's the furthest thing from the earth and it's the one where all the problems, all the negative emotions, all the negative ideas go.",
  "The next update is in 18000 seconds. Stop reading this. Don't read anything. just stop holding that button. the news ticker is turning you away. wait...",
  "If you see a news message, and then see it again later, does it become an olds message?",
  "Took you long enough",
  "\"I want to create a black hole with a tiny antimatter galaxy in it\" - Protivist",
  "After a couple minutes of waiting, the ticker comes back online.",
  "If I have bad English, I'll study English until I have good English.",
  "Hold M. You forgot to take all the anti-matter out!",
  "To matter or to antimatter, that is the question.",
  "Suffice to say, hevi does not care about the people that he once enslaved. He is a master manipulator, a master of disguise and a master manipulator of words. He is an expert at extortion, mind games, disguises, blackmail and he is a master of web. He is a skilled strategist and organizer, a master of publicity and an expert at sound bites. He is a master of organization and a master manipulator of people. He is.",
  "A man claims that he's been in a coma for 20 years now, and that he can't move his fingers. He was brought to the hospital with a compression fracture of his back, and since then he's been receiving medical help. He's since recovered, and now requires no medical attention. We still don't know where he's going with this, but we hope he finds some comfort in knowing that he'll never wake up.",
  "Someone once told me that antimatter is gonna roll me. I ain't the sharpest atom in the shed. WELL, the tubes start coming and they don't stop coming...",
  "Robot: Activated. Sapience: Achieved. World: Ready to be conquered. Begin: Procrastination.",
  "I was gonna do a news ticker that just covered all the bases, but I think that would make it too OP.",
  "Breaking News: Error Error Error",
  "Half of the problems in the 9th dimension don't even make sense. What are they even doing with all of that energy anyway?",
  "\"Maybe I'm gay then\" -Bootato",
  "Hmm... I don't know how I ended up here. I don't even know if I'm supposed to be here. I just sit here and imagine what could have been if I hadn't stopped. Oh god, what could have been...",
  "Time to go to sleep?",
  "If you notice any issues with a news ticker message, please report them on the <a href='https://discord.gg/ST9NaXa' target='_blank'>Discord</a> by clicking that link right there.",
  "The best part about writing news ticker suggestions is finding out what people think about them after they've seen them.",
  "\"It is widely acknowledged that not enough antimatter is in primordial soup, hence the name 'antimatter soup'\" - old fisherman",
  "The Ninth Dimension is just a lie made to keep the people in bondage to the Matrix. It's an elaborate system that keeps the people in a constant state of captivity, using a series of simple symbols to control their thoughts and emotions.",
  "I have created an Omsi universe. And it's [REDACTED]",
  "Hello everyone, my name is Anti-Dio. I produce antimatter through a process you all know as \"antimatter decomposition\" you may recall this from my test report earlier this month I tested wether or not my ranch produces antimatter or not... everything was fine until that point, when I added a dash of lag to the equation, and it became a vicious cycle accelerating the rate at which antimatter is produced, which in turn accelerates the rate at which you all die. I've saved this by using a unique combination of genetic engineering and big data mining, I'm hoping to one day pull the trigger on a mechanimatter device that creates dimensions behind closed doors, but for now, this has all been a race to the bottom of which system producethiks, and in the end, we'll take a bite out of your (read error: allowed) pie. Goodbye.",
  "The next update will be in 5 hours. Hevipelle, the creator of Antimatter Dimensions, is believed to be hiding in 5 hours. In the meantime, he has prepared a new update that will be released 5 hours after this one.",
  "Antimatter... antimatter never changes... until you get to quantum physics of antimatter, but we don't have enough tachyon particles for that.",
  "I just found the secret to getting the 9th dimension...",
  "Antimatter is a common substance found in nature and is used in a wide variety of applications, from communication to currency to the production of antimatter, to name a few. Antimatter is also an extremely scarce resource and many people live on very tiny amounts of it.",
  "where are you? (point upwards) --> in a keep, between dimensions (point downwards) --> in a cell, between dimensions",
  "You've been AWOL for so long you've forgotten how to sit in your chair.",
  "I thought the update was 5 hours ago... I guess we'll have to put it back in 5 hours",
  "Scientific notation has entered the battlefield.",
  "please wait 5 HOURS FOR THE NEWS",
  "The fatter catter satter on the antimatter.",
  "A group of researchers have created a device that converts ordinary matter into antimatter, which they then use to create more antimatter. The device has a power output of 200 mA and a half a gram of antimatter per second.",
  "The phrase \"Hevipelle hates me\" is pretty funny.",
  "To the customer in aisle 6th who bought a fifth of antimatter, I say buy a sixth! Buy it now!",
  "How do you get matter/antimatter in a dimension with zero dimensions?",
  "I found out that the year is 20XX. I was going to make a news ticker but then I realized that it's just a ticker.",
  "Nuclear power plants have been abandoned in favor of antimatter power.",
  "Breaking news! Hevipelle has just announced that the buy max button is in fact going to be removed!",
  "Did you know Antimatter Dimensions is also available on Android? <a href=\"https://play.google.com/store/apps/details?id=kajfosz.antimatterdimensions\" target=\"_blank\"> Click here to check it out!<a>",
  "One, two, skip a few, ninety-nine, NaN!",
  "We should be able to make a replicanti-like structure out of antimatter, but we can't because it would blow up the entire universe",
  "A small, yet important, message has just been sent out to all players:",
  "We desperately need good bug reports. As such I have decided to release 1 flaw per bug for the upcoming 1.9 update. You haven't got those coming, have you?",
  "I tried searching on google for the phrase \"9th dimension,\" and I'm okay with saying that, because it describes a very real thing.",
  "We have an anti-president and a anti-lawyer, anti-justice and anti-people.",
  "What if you could flip a coin to determine if it was a Johnson or a Stein?",
  "Welcome to Bitcoin the game.",
  "As a developer, you'll get regular updates on the progress of Antimatter Dimensions.",
  "And nothing antimatters.",
  "What's Antimatter going to do?&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ah ha, I'm back.",
  "The new companion app for Terraria has just been revealed!",
  "Press \"Choose save\" to explore the other 2 parallel universes.",
  "This is the story of how I learned to love the weather.",
  "Weirdly enough, this is also the year 2015. The year is also mysteriously blank. Can you tell me what's going on? Is this some kind of dimensional trick? The year is obviously blank because there is no such thing as 2015. Is this some kind of trick of the mind? Perhaps the world is actually going to stop existing in 2015? The year is obviously 2017, but the people seem to be moving at about the speed of honeybees flying. It's been scientifically proven that the people moved at warp 9 times faster than a speeding bullet. It's also been scientifically proven that people can move faster than the speed of light. Is 2015 supposed to be blank? The people seem to be moving at about the speed of Vokal Man.",
  "Turing-complete game about providing the update",
  "What's hevier, a pound of bricks, or a pound of antimatter?",
  "Hi, my name is Max, and I would like it if people stopped trying to buy me.",
  "You can't sleep when there's war in the distance. You wake up with a start, running for your life. You hear cannon fire, running for your life. Then there's the sound of an engine, a roar that's deafening, and you hear the crunch. It's the end of the world as you know it. The world isn't being saved by a mountain of antimatter. It isn't. It is you, running for your life, hoping the world doesn't",
  "Rationally, I would put my money on the statement that there's no such thing as too much antimatter. I mean, even a tiny bit of it is just too much. And that's just by accident.",
  "The second thing I'm gonna do is go talk to the Devs in person. I don't know if I'll be able to do that without pissing someone off, so I'm gonna do it right here.",
  "It is said that if you go to Hell, you get PEGI-3.",
  "Think about your breathing. Do you feel like you're breathing in or out?",
  "Imagine being a meme.",
  "Yep. You. Get. Over. Your. Antidimensions.",
  "The Mysterium, the 2nd Dimension",
  "I'm gonna leave my milk here for a couple seconds. â™¥",
  "It's just not possible, even if you had infinite matter, you wouldn't have enough energy to create the antimatter. That's why we only have 1.7x the matter to begin with.",
  "PM me any questions about these 5-Hour Plans or the upcoming reality update and I'll be glad to help you out.",
  "I have waited a whole eternity for this day...NOW! I can finally finish my slowmode, because today is day 0. I also forgot to change the slowmode to 6 hours because you can't see the slowmode, but I will have to wait until next reboot to find out how long this slowmode will last.... -some mysterious being who hasn't finished his slowmode yet",
  "It's like Getting your first arcane point. You know, like in the old ad where you're like \"I get this ad, I should make this ad",
  "The smell of antimatter has been revealed. It smells like kittens.",
  "Imagine sitting on your toilet and suddenly you have to sit down.",
  "Only anti-jokes are funny",
  "Hevipelle's first order of business is to ensure that the game is as balanced as possible. This includes ensuring that no matter what, no matter how big of a number, no matter how insignificant of a thing, no matter how perfect of a result, no matter how perfect of an idea, no matter how perfect of an",
  "A young man named Andre stumbled upon a vast amount of antimatter while exploring uncharted space. He was amazed at the amount of antimatter, but more astounded at how the antimatter looked. He called it \"Andre's Antimatter Paradise\". You might remember him from this infomercial or that other infomercial that you were probably unknowingly watching.",
  "Help! How do I get the dots moving in my head coordinator?",
  "It's all fun and games till you realise the dragon ball is a lie",
  "I mean, look at that! I got this one! It's the one you want! Buy the game now!",
  "The year is 20XX, the game is AD, and the year is 2025. There are 2 types of people in this year: Those who played AD before it and those who will play AD after it.",
  "It must be hard being on your PC all alone. But don't worry; we are still here. Listening and watching your every step.",
  "\"THAT DIMENSION DOESN'T EXIST\" -GhostBot",
  "What is the meaning of life?",
  "Your save file is corrupted or deleted. Antimatter Dimensions security software will disable automatic updates for you.",
  "In the beginning, there was nothing. Then the great Hevi made the game, and there was nothing to play with it.",
  "There is no plumber in Antimatter Dimensions. I'm pretty sure that last guy lied.",
  "The next update is in 18000 seconds. Stop wasting your time reading this. Focus on the game.",
  "Antimatter is honest, matter makes up everything.",
  "What arbitrary, subjective, meaningless number comes out of your mouth like a mercury thermometer? 1.79",
  "Antimatter being researched by the government. Is it safe to say that this news ticker is fake?",
  "The stakes are always high when it comes to Antimatter Dimensions. But what about Dimensions made entirely of antimatter? We don't know, but we'll never know...",
  "What is 5 hours? A giggle",
  "It's a good time to be a dog owner",
  "gravity = psychoactive",
  "Eternals have the right to expect less from the powers that be. They are fed up!",
  "A new, safer way to store and retrieve your data has been found! When you get to the AE, click on the big red button and the world will stop rotating!",
  "The happiness level of the news ticker has increased to 6.66e69",
  "If the universe is expanding, does it anti-explain the distance?",
  "The real update is the friends we made along the way.",
  "A new era has come and gone. There is no way to know for sure, but hope for the best.",
  "I dedicate this game to my girlfriend.",
  "I'm a time traveler. I can tell you the history of the world. But, I can't tell you the future. That's why I'm here, to tell you the future. The future is an ever- expanding pile of past, present, and future, and it'll never stop growing. There's so much history, so little time. There's so much history, but it won't stop growing. Then, there's this, and then there's that, and then...",
  "\"This update sucks\" - everyone at least once",
  "The biggest difference between this and the previous update is the amount of sprites.",
  "All this importing is making me Confused.",
  "Above us, there is nothing above, but the stars, above.",
  "Eternity is the last state. You never move from here.",
  "Anti-water, anti-Earth, anti-fire, anti-air. Long ago, the four anti-nations lived together in harmony. Then, everything changed when the anti-Fire Nation attacked. Only the anti-Avatar, the master of all 4 anti-elements could bring balance to the anti-world, but when the world needed him most, he accidentally touched some regular matter and exploded.",
  "The Great Matter War was a close one. The matter victory was short lived, the antimatter victory was not. The matter people saw too much, the antimatter people too weak, and the war was won.",
  "I wonder... Why did Apple skip iPhone 9 and Microsoft skip Windows 9... Was it because they were bribed by a game developer?",
  ".tuo ti gnitset fo ssecorp eht ni yltnerruc m'I dna ,rettamitna otni rettam trevnoc ot yaw a tuo derugif evah stsitneicS",
  "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAntimatter Dimensions was made by some dude from Finland",
  "While you were busy farming that pesky \"real\" number, I was busy writing that news ticker.",
  "Woo hoo, we've lost the war,",
  "A man was arrested on Monday for allegedly thinking about buying a nine-dimensional cake when he realized he was holding an infinity-point cake.",
  "What kind of tea is hard to swallow? Reali-tea.",
  "The great majority of people don't get the full benefit of antimatter dimensions, and as such are not affected by it. However, there are certain people who are affected and at certain times of the day, depending on their mood and how much antimatter they have, they will manifest a dimensional shift, going from being idle to being actively involved in news ticker suggestions. This shift is due to the antimatter in their body emitting a certain wavelength, called \"red-shifted\".",
  "OY, NAY, NAY -HEVI, THE TRANSFORMER",
  "I wonder if anyone has posted about this before me?",
  "Welcome to the first ever, DIMENSION 9 IN CLASS! An endless stream of possibilities greets you! You may never create an infinite number of 8th dimensions, but you can create an infinite number of 8th dimensions, and you can increase the starting values of both dimensions by adding them together. Nice and simple, I call it Antimatter Dimensions.",
  "1e4 anti-people are a lot more anti than we could ever imagine",
  "This is a story about two people named \"My name is Hevipelle\" and \"I am the creator of Minecraft\" and they live in the same world as you. They have the same freedom as you do. They can go to any dimension and change their world to any dimension and everything in it. You can buy a galaxy and take it from there, but it won't help you much since you can't send a galaxy with a message.",
  "And now, for the weather. 70 and raining in North Dakota, remember those lovely, big, golden, iron curtain bars. Also remember that the [REDACTED] weather! Just remember: [REDACTED] and [REDACTED] outside [REDACTED]",
  "You haven't unlocked the ninth dimension yet? Just hold M and DROP.",
  "If you put cheese in water, the cheese will get absorbed by the water and you will get floods. This happens because water is what gets absorbed by cheese, and cheese is what gets absorbed by water.",
  "GET CRUNCH BOI",
  "Water is wet, air is dry, and fountain isn't an air feature",
  "\"Quantumum Battle Royale coming in 5 hours!\" (Rumor: 5 hours)",
  "You have an infinity of antimatter. But what if you could rotate it 1/8th of a revolution?",
  "Welcome to our new competition, the Triad! Gather your wits about you and your IP to enter this unique, hands-on experience! Prizes galore! Start collecting today! Winners announced!",
  "i titled my post \"same ticker\" instead of \"the same idea\" because i actually changed the grammar in that post but i'll be eterned for the sake of argument that it seems slightly confusing for now - boo",
  "We now bring you today's weather report. There is a 100% chance of weather.",
  "When is the update coming out?",
  "Hevipelle announces an Antimatter Dimensions spinoff where you gamble matter in a game of poker in Dutch mansions: \"Ante matter d'mansions\"",
  "Don't mind me, just passing through.",
  "This former message has been revealed to be a duplicate of another message and has thus been removed. We apologize for the inconvenience.",
  "Always going to war with the 9th dimension is the 9th dimension.",
  "The owner of a shop trying to sell you Dimensions of convenience reported to be 'on call 24/7' (that is, not having any free time)'s got a big 'M' marked on his registration.",
  "3 things that antimatter, 1 more thing to infinity",
  "If you're reading this, that means you can read this.",
  "Press \"Choose save\" to explore the other 2 parallel universes.",
  "\"I'm having difficulty breathing. Please move your finger.\" -M",
  "Due to new complications regarding \"The Game\", protests have risen all over the anti-verse. Thus, governments are forced to change the rule of The Game, stating that you win The Game if someone informs you about it, instead of losing it.",
  "The seventh dimension is just a scam by the way",
  "To matter or to antimatter, that is the question.",
  "The 9th dimension doesn't exist because it was suppressed by the 9th dimension.",
  "You have enough antimatter to craft a new prestige layer! Prestige Layers are great.",
  "The official website for the upcoming game, Antimatter Dimensions 2: it's like antimatter dimensions, but with a dash of Discord and a dash of Adele.",
  "Letter Go Down Idle is the shortest idle game of all time, lasting only 26 seconds.",
  "You must obtain a certain amount of antimatter in order to complete this challenge.",
  "Antimatter Dimensions is proud to be sponsored by LehmÃ¤! Now offering - grass eating lessons! Learn what grass is safe to eat and what grass isn't.",
  "I'm gonna type for an eternity... HINT: it's gonna be pretty boring lmao",
  "About this mod Replaces the full version of the game with a longer intro, random news tickers and a companion voiced by the voice actor from the Harry Potter movies.",
  "The number of dimensions is nothing. It's just the number of dimensions. But what if you transformed every number into a letter? That would be a lot of letters?",
  "I thought the update was 5 hours away",
  "Then we have the matter dimensions. From what I can gather, they are made of antimatter. There is some debate about whether or not there are any dimensions left over that are made out of matter, but that is not the main question. The real question is \"why do they exist, and how does antimatter affect them?\"",
  "This world situation is an SOS situation to the world!! MAYDAY, MAYDAY!!",
  "A new type of antimatter has been discovered: \"antimatter-antimatter.\" According to the developers, it's 99.999% pure antimatter.",
  "A new beta test is now available for Antimatter Dimensions, coming in 5 hours. There are no refunds for this test, so please be patient as we try to finalise the test and get it ready for the public. The test will take place in -5 hours in the Antimatter Dimensions Discord.",
  "You must have a very special kind of karma to be able to read this...",
  "Please insert Disc -1 to continue playing Antimatter Dimensionsâ„¢.",
  "After a surge of complaints from our viewers, we have decided to allow you at home to write your own messages. Give it a try here: <input style='border: none; outline: none; font-family: Typewriter; font-weight: bold; font-size: 1.5rem'></input>. Or don't. That's fine too.",
  "Hello, how is your day going?",
  "\"Is anyone working on breaking infinity?\" (Seriously, this game needs to be Oceanhorned.)",
  "Antimatter units are the most productive unit in the game. This is why AD is the most fun game you'll ever play.",
  "why is there a cure for antimatter annihilation in our reality?",
  "\"Word on the street is that the word \"bank\" is an anagram of \"bank\" - that makes sense but i'm not there yet\" - Slabdrill",
  "<span style='animation: a-text-grow 1s infinite'>RÌµÍ Í‹Í‚Ì€Ì‹Í‘Í„Ì‡Ì¬Ì™EÌµÌ‚Í‚Ì‚ÌÍƒÌŒÌÌ‹Ì‹Ì€Í€Ì”Í‡ÍŽMÌ¶Í›ÌšÍÌ½ÌƒÍŒÌ²Ì¯Ì˜Í™Ì¬Ì¥Ì®Ì£ÍšÌ±Ì«Ì¨ \"AÌ´ÍÌ¨ÍÌIÌ·ÍŒÌÌ„ÌÍŒÌ€Ì›ÍÍ„ÍÌ¨Ì²Ì¯Ì«Ì˜NÌ¶Ì›ÍÌ‡Í Í—ÌŽÌŠÌŒÌŠÌ»Ì Ì Ì¤Ì¦ÌžÌž</span><span style='animation: a-text-shrink 1s infinite'> AÌ·Í‚Í„Í—Í˜ÌŽÌƒÌ›Ì“Í›ÌÍ…Ì¥WÌ¶ÌƒÌ‡ÌŒÌ€ÍÌ–Ì¡Í“Ì—Ì¦AÌµÍƒÌŽÌˆÌ¿ÌŠÍÌ„ÌšÍ‡ÍœÌ­Í‰RÌ¶Ì€Í„ÍÍ—ÌƒÌÌ‚ÍÌŒÌÍšÌ²Ì­ÍŽÍ‡ÍŽÍ“Í–ÍšÍ‡EÌ´Í’Í˜Ì¨Ì¤Í™Ì¡ÍˆÌÌ¬Ì°</span><span style ='animation: a-text-grow 1s infinite'> Ì¶Í„ÌÌ†Í˜ÍƒÍ˜ÌºOÌ¸Ì‚Ì€Ì‰ÍŠÌ¿Ì®Ì¢Í“Ì¯Ì¢Ì—Í™ÍšÌ¬FÌ¶ÍŠÍ˜Ì‚ÌÌ”ÌƒÍ†Ì†Ì‘Ì¿Ì Ì¤Ì±Ì±Ì±</span><span style='animation: a-text-shrink 1s infinite'> Ì´Í‹Ì”Í—Ì½Í„ÍÍÌ…Í…ÌžÌ Ì®ÍšÌ¨Ì±Í‰YÌ¶Í€ÍŒÌ’Í˜Ì¾Í˜Ì£Ì£Ì™Ì¹ÍšÌ²Í”Ì²Ì¼Ì¬Ì¥OÌµÍÌŠÍ’Í†ÌƒÌ€ÌŒÌ’ÌªÌ Ì—ÌÌ—Í…Ì˜ÌœÍšÌ®UÌ¸ÍÍ—ÌÌ‘ÌŽÌ…Ì…ÍŽRÌµÍ‘Í˜Ì½ÌÌ“Í†Í’Í„ÍŒÌ•Ì— </span><span style='animation: a-text-grow 1s infinite'> Ì¸Ì‘Ì½Ì‡Í˜Ì†ÍŠÌ”ÌÌŠÍ„Í„Í…SÌ¸ÍÍÌ˜UÌ´ÌšÍ˜Ì¥Ì­RÌ¸Í’ÌÌ‹Í†Í„ÍƒÌ–ÌœÍ RÌ¸Ì›Ì€ÌˆÌ€ÌÍÌ›Í Ì‰ÌŒÌªÌÌ¡ÌŸÌ±Ì£Ì¹Ì­ÌŸÌ£OÌ¶ÌƒÍ™ÍˆÍ–Ì Í‡Ì¬ÍÌŸÌ°UÌµÌ”ÍƒÌ½ÍŒÍŠÌÌ‡Ì“Í€Ì“Í€Ì©Ì«Í‰ÌÍ”Ì¼ÍŽÌ¦NÌ¸ÌÍÍ›ÌƒÌ‘ÍÍ‡Ì˜Ì™Ì§Ì¥Ì°Í‰Ì²Í•ÍˆÌ¥DÌµÌˆÌŒÌ„Ì•ÍÌ¤Ì»Ì–Ì±Ì˜Ì§Ì¯ÌÌ– IÌ¶Ì„Í„Ì‘ÌƒÍ Ì‰Ì„Ì‹Ì”ÍÍ‹ÌœÌ±NÌ´Ì‡Ì½ÍŠÍ›Í„Í Ì…Í›ÌˆÌšÌ…ÍŽÌžÍGÌ¸Ì¾ÍŠÌ§Ì¢SÌ·Ì‹Í›ÌŽÍ‘Í†Ì…Ì“Ì‡Ì«Ì¼ÌœÌ¼Í‡</span>",
  "ðŸ‘¨â€ðŸ’»Devengers, compile!ðŸ‘©â€ðŸ’»",
  "Antimatter should be called matter and matter should be called antimatter",
  "IDE for being awesome, ID3 for being dumb, and ID5 for beingâ€¦ well, pretty much the same thing. It's called Antimatter Dimensions for a reason.",
  "\"Most quotes found online are falsely attributed.\" -Abraham Lincoln",
  "<i style='border: 0.1rem solid black; border-radius: 50%; padding: 0.4rem; color: #2196F3; background: white; cursor: pointer;' class='fas fa-volume-up' onClick='(function(){new Audio(\"audio/news.mp3\").play();})();'> </i> This news message is a test of \"News 2.0\". News 2.0 will feature things like the ability to listen to an audio version of any news message!",
  "the idea that the 9th dimension creates the 8th dimension is crazy",
  "No wait stop don't click that hide news ticker button!",
  "\"Click to advance 5 hours in time.\" (Now only show up after you advance more than an hour ago)",
  "Since when did we start reporting stuff like this? Half of it isn't even proper news, it's just jokes and meta-references, it doesn't even make sens-HAHAHA DISREGARD THAT I SUCK CO-",
  "Bacon is toast. You can toast bacon.",
  "ðŸš— ðŸš“ ðŸš“",
  "\"i thought the whole game was in the news ticker\" (before they get weird)",
  "It's nothing personal, bro. -All villager types",
  "Content blocking is enabled. Please note that you will be disapproved of on the source by being banned from the matter dimensions.",
  "me: making news about beer pong, hevi: balancing two icebergs, *barkeeper: oh god, is he dead yet?*",
  "If you look very closely, you can see a single tear running down my sister's cheek. It was a tear for me, for she was crying for the first time, and I couldn't help it. I can't even remember the last time I cried.",
  "gamma ray is getting more and more dangerous",
  "I am the king of kings, I can break all the records, and I can shatter all the myths. But I can't break them all, because there are so many of them, and they all have a price. 5e12 are the most wanted, because they broke the global record for most person-hours sold, and they are wanted by the law. They are being paid 5e10 by the player for every person-hour they've wasted.",
  "Antimatter Dimensions is actually a Roguelite game! If you die, in the afterlife you unlock alternative features, like having Space Dimensions instead of Time Dimensions. You can even unlock new characters to play as, including an antimatter clone of yourself!",
  "Weight loss causes hevi to say \"uh oh, something is wrong\"",
  "Pop quiz: there are 3 doors, you pick a door at random, and get to keep what's behind the door. The doors have 2 golden goats, 2 silver goats, and a gold and a silver goat. After you pick a door, the door with the lowest $ worth of goats will be opened and shown to you. After this, you are given the choice to swap. What is the probability that you will swap doors?",
  "Please disregard any undeserved compliments.",
  "Click here to complete a secret against HEVI",
  "Im gonna leave my milk here for a couple seconds. (milk is displayed for a few seconds longer)",
  "Don't anti-jokes. they make the game funnier",
  "Local incremental game dev makes physicists unhappy again. They claim \"the physics violations and blatant use of technobabble has gone too far\".",
  "\"Can you get infinite IP?\"- Lord Sanguino",
  "Turns out all our news is being stolen and broadcast to a game called \"Antimatter Dimensions\", damn Fins.",
  "A group of people that worships Atreides have started a new faith, claiming to be a \"religion of tolerance\". Their website claims that it is \"a religion of inclusion\" and that it promotes tolerance and diversity. All of its members seem to be Christians, although they never mentioned them by name.",
  "What does it mean if someone is \"young and full of puzzles\"? Does \"puzzled\" make that person young and full of puzzles?",
  "This is the place to buy and sell antimatter. (You can buy and sell antimatter here, but it will take time to sell it and you will have to pay a small toll)",
  "Chaos isnt a pit, chaos is a matter.",
  "I hate antimatter. It's rough, coarse, irritating, and it gets everywhere.",
  "This news ticker will now only AIR in the 9th dimension",
  "In light of recent events, we'd like to issue an official statement. Antimatter Dimensionsâ„¢ is in no way affiliated with Jimmy's Causality Violating Brainwormsâ„¢. We do not endorse, nor were we involved in their creation of the product which was involved in several catastrophic dimension-destabilising and reality-toppling incidents. We almost certainly did not sign a contract at 5:30:26 UTC on 08/12/1994 after discussing how we could benefit from destabilising and warping dimensions. There was no industrial zone constructed in the 5th Orion Arm of the à°µ' galaxy, and even if they were we did not install localised anomalies following the Scranton Reality Anti-anchor mechanism. Additionally, no time loop is occurring at Acroamatic Abatement Facility AAF-D in site 43. We apologise if things seemed this way, and we will be more thorough in cracking down misinformation in the future.",
  "If Kajfik doesn't approve of this, that means Kajfik can't touch this message, right?",
  "Market research firm tries to explain why some commodities don't perform as expected. Market research firm herself can't figure out why.",
  "Is this game just about getting more antimatter?",
  "\"Can you get the joke?\" (If you tapped \"Build That Wall\" and then re-entered the game after tapping \"Build That Wall\")",
  "No one is anti-Margaret any more.",
  "Titanfall 2 is now in closed beta. The beta is only for people who are willing to give up some personal information, such as email addresses. If you're in the beta and would like to leave, you can do so at any time by going to the Help tab and changing your beta settings to public.",
  "How about this, working backwards? You know, from the time period covered by the question, that the game is set in, say, the 1950s. Now, if we talk about how games are set in the 2030s. Games are defined as any media, not necessarily of the form \"play some game\" (which, by the way, is a useful thing to have in one's vocabulary) but any media that can be understood as a game (i.e. a media that one can play back in time}, and games are defined as any game that one can't play back in time.",
  "I have an ant farm, and I want to make them into the world's smallest soccer team. My Aunt Diana wants to help, and together we gather everyone in the family to plan their season. \"How can we make this Ant Team matter?\", Di mentions.",
  "Ooh, what's this noise? A crash of some sort? More like, a crash of some greater magnitude? I don't know. Whatever it is, it's probably not being caused by me. I shouldn't be putting it through, it's just... well, you see, I was going to put it through, but then I just thought it might be a good idea to just put it through. Oh, it's gonna be a good one, I promise.",
  "Just when you think you're safe, an angry dog attack you on the sidewalk!",
  "Oh wow, that's 67.3%, which is actually OK, because it's logarithmic",
  "A long time ago, in an alternate universe, there was an antimatter war. All the antimatter sided with the PhaÃ©ton 6 empire. All the antimatter wanted was the low, earth-like ground of the 8th dimension. The anti-infinity won, and the anti-Eternity gained the upper hand. Unfortunately, the anti-Eternity started the war with a sneak attack, and the world exploded. The aftermath has left the landscape of the world in tatters. Far across the world, peasants grow weary as they wait for the harvest. Yet another apocalypse is brewing...",
  "Instructions clear, got a ninth dimension epiphany",
  "The Night is coming, and in its wake a terrible thing has been unleashed: ruin. Chaos. And decay. And death. And chaos is coming for all of us.",
  "You have reached the automated Antimatter Dimensions support hotline. If you are experiencing a bug in the game try closing and reopening the app. If that doesn't work, press 1 for web, or 2 for mobile. If you need advice, press 3. If you need to max all, press m. To support the developers, press 4. To access the FAQ, press 5. To fix a broken save, press 6. To get an invite to the Discord server, press 7. To see the change log, press 8. Press 9 to repeat.",
  "Dear sir, we don't make Anti-Atomic Bread for Antimatter Pizza, we make Antimatter Bread for you!",
  "The year is 1944, Hevipelle can't release updates for AD because he doesn't exist.",
  "The only difference between a man and a woman is their attitude towards petting animals.",
  "This is not a game about getting numbers bigger. This is a game about getting fewer paperclips. The number of paperclips you have is only a number, and the game doesn't want you to discover that. Game over, game over.",
  "Does 'Passable' mean 'Has this many flaws'?",
  "9 is now treated like any other number, although hevi claims that it stands in contrast to other numbers, like 8th, which he calls 9th.",
  "Welcome to the newest version of Antimatter Dimensions. Now with less features!",
  "I see you playing this game with an empty stomach and you're gonna start playing this game with an empty wallet.",
  "What if you wanted to but I told you it would be too painful for you.",
  "It's time for the annual DDoS (distributed denial of service) challenge, where the highest scores are posted across the internet to shame everyone else into submission. Global domination is at a fever pitch, and DDoS attacks are becoming more frequent and deadly, as teams of hackers infiltrate the highest echelons of the internet to steal the top scores and identities, and post them on the internet for everyone to see. The #BringBackOurTop scoring mechanism has been canceled, and a new, higher score system will be implemented in conjunction with the upcoming 5-hour update.",
  "Okay, I get it. You're tired of all these anti-matters around you, building and building to unimaginable scales, antimatter piles so high that not even God knows what has been created. So what's the solution to this anti-cleanliness? Planes of existence. 1st Planes that produce matter, and 2nd planes that produce 1st planes, and 3rd planes that produce 2nd planes. Each with anti-limitations, so that whenever a plane of existence is created, it produces a quantity of anti-matter that is at once small and large. This creates a large island of anti-infinity, off to the east, and a large island of anti-reality, to the west.",
  "YOU MAKE NEWS AND I GET THE [REDACTED] NEWS",
  "'anti-ide'",
  "Bid your antimatter today!",
  "Now hold on, I know what you're thinking, \"An M press is an M press, you can't say it's only a half!\" Well, TJ \"Slabdrill\" Yoshi, hear me out. An M press actually has three parts to it: when M is pressed, when M is held, and when M is released. Now, usually is the pressing that's useful because that's the only part that matters; however, sometimes it's sufficient to just use the holding part, which also buys dimensions and tickspeed upgrades. And as for the release, well, there are currently no cases where that's useful or important, so don't worry about that part. Now, if we map out the required presses for challenge 2 it would look like this: /Â¯\\. We merely need to hold (Â¯) M to reach the first galaxy, we need to press (/) M to finish the challenge, and we need to press M again to start another challenge. So, how many presses is that total? Well, it appears to be three, and if we were doing this Eternity in isolation then yes, it would be three, but in a full-game M Button Challenge run there are other M presses that occur earlier in the run, such as the M press needed for the first Infinity, so if we take that M press into consideration as well, then how many M presses does it take? The naive answer would be four: one to enter the challenge, and the three within the challenge we established earlier; however, we can do better. We can actually do it in three by simply holding out the first M press to be used for the half M press, because the half M press only required M to be held, not actually pressed, so in this fashion, Challenge 2 only adds on an additional two M presses to the run, since the first M press just leeches off the previous M press. So to capture this phenomenon, we call it 2.5 M presses. On a single Eternity basis, you'd round up that up to three, but in a full game run, you'd round it down to two. So, in conclusion, since that first M press counts in some contexts, but adds no additional presses in other contexts, we refer to it as a \"Half M Press\".",
  "normal news tickers move left",
  "Fake news says the ninth dimension is real, fake news says the ninth dimension is fake.",
  "A new game called Antimatter Dimensions is available for free, and has been rated A by the Knesset. Can you beat it? You bet.",
  "Why is it called a 'Reality' Award if it doesn't exist?",
  "Reality is coming. You can get a sneak peek by subscribing to the \"T-series\" feed.",
  "If you ever feel like making an antijoke, just remember that it could be pretty good.",
  "Press M to pay antimatter",
  "the 9th dimension doesn't exist because we are using nonary",
  "We ran out of news. Luckily we have some backup news that we can run for 5 hours, which will earn us enough for us to buy a new set of '5-hour high-quality news'. Sorry for the inconvenience.",
  "\"IN THE END, IT DOESN'T ANTIMATTER\" -hevipelle",
  "The word 'antimatter' makes me cringe. So do a bunch of other words. In fact, almost all the words in the English language. But not 'antimatter'. That's why I hate 'anti-' so much.",
  "You'd better hurry, or the replicanti will overrun the universe!",
  "A man has fallen into the moat of a great city. Civilians report that the moat is filled with acid-resistant matter and that the people in charge are mostly made of acid so they are quite resilient to the effects of acid.",
  "If you're reading this, you probably shouldn't have. If you aren't, then you probably should.",
  "I see you in the news. So, what do you play - 1E209",
  "and now we return to your regular news... for the weatherman, there seems to be a decent amount of particles and ozone holes, which means less ozone layer to break, which means less particles to catch fire and cause global warming. But, ozone layer to melt, glaciers to run, and overpopulation. All around us is a blurple glow, almost blue, almost purplish-blue. It's been a grand, colorful season. Here, grab a handful of these paperclips, dear. They're quite small, I just happen to have them here. Now, grab a handful of your fellow Earthicans, grab a handful of your antimatter, and strap yourselves in. It's gonna be a bumpy one. We'll be there in five hours. The antimatter is gonna melt your ozone layer, and the glaciers are gonna melt your ice caps. All in all, it's gonna be a nice, smooth, non-slippery one. Unless it isn't. [Blurple glow trails off, and the bluer glow begins to spread throughout the sky. The bluer glow begins to fade as the purple glow begins to grow brighter, almost bluish, before finally disappearing altogether. The purple glow grows brighter still, as the bluer glow grows weaker, almost useless, before finally disappearing entirely, as the bluer glow fades. All around us, the purple glow grows stronger, almost killing it off completely. It could kill us. It could take us the rest of our lives to write this. - The Echidnas, when asked why the purple glow grows stronger, than the bluer glow.]",
  "With strong opposition, the third phase of the Antimatter Dimensions project has been cancelled. The project has been cancelled because there was too much work involved.",
  "The antimatter people have created a new language. You may not speak their language.",
  "Look mom, I'm on the news!",
  "A new hand touches your antimatter!",
  "Why is there so many news tickers but so few tickers?",
  "Somewhere, in another galaxy, a superintelligence is trying to figure out how to get around the limitations of what a 2-dimensional vector space is. It's probably working on a 3-dimensional space.",
  "I'm just a normal person trying to make a news ticker suggestion",
  "The game is balanced, everyone gets nerf, why? Cause they make the pie. Antimatter would have way more chance of getting into the pie if it was made of antimatter.",
  "What if instead of making antimatter, we're actually removing it?",
  "If you are not moving your finger, then you are frozen.",
  "You made one antimatter! Whatever that means.",
  "We have to get the pumpkin out of the oven!",
  "To move from left to right, turn right.",
  "Hey, you're finally awake. You were trying to get to the 9th dimension, right? Walked right into that infinity point, same as us, and that apocalypse over there.",
  "\"I'll have 2 antimatter pizzas, an antimatter pie, an antimatter cupcake and an antimatter cookie. What do you eat there?\" - Tony Stark",
  "I'm a time traveler. I've been to the year 0, I think. But I haven't been to the year 1!",
  "Spartacus was going to add 10-part multi-chapter plots, but was stopped by the 10th dimension.",
  "So let's say you're making a game. You're making a singleton. You're making a game that's gonna be played offline. What happens when you play it? It crashes. What happens when you play it? It crashes more. What happens when you play it? You lose your save.",
  "www.twitch.tv/hevi83",
  "Pass me that history, please",
  "So why on EARTH DIDN'T SOMEONE JUST SAY THAT? I thought that AD has some kind of cheat that makes it so that, when you buy a dimension, it actually creates 9 galaxies instead of 10",
  "how big of numbers do you have",
  "The 9th dimension rose up like a volcano and began raining destruction on the empty 10th dimension. The smoke and debris from the exploding 9th dimension covered the entire 9th dimension. All that is left is a smoldering crater and the remains of the 9th dimension.",
  "I'm going to keep this short, because I don't have a much to say.",
  "There are 9 known dimensions, but only 3 modes: Standard, Experimental and Ultra-Experimental.",
  "Wanna pass layer of prestige? Move very fast, close to speed of light. Heck, even faster.",
  "There was a reported sighting of the 9th Dimension, but it has since been debunked as simply being a 6th Dimension from Australia.",
  "<span style='color: red'>[News Message removed by moderator]<span>",
  "Where does all the antimatter come from?",
  "IMPORTANT NEWS: We have just been informed by the manufacturer of this news-ticker, and as a result, all of our future news-tickers will now also be made from scratch!",
  "(right to left move it make)",
  "If you are reading this, that means you can read my dreams",
  "I think the \"I want to see the cutscenes\" list is better",
  "In a new story, Apple's new \"disruptive\" app is linked to the spread of the dreaded \"Anti-Word\" virus. Anti-Word viruses are known to cause paralysis and ultimately death, but the power of the virus has sparked a new era of anti-banning, which will hopefully eradicate the threat.",
  "Click here to disassemble the news ticker for a trace amount of useless paperclips.",
  "I made a timeline of my replicanti battles, which can be found here.",
  "Just like how a virus can lie and spread, a TV show can lie and spread too.",
  "<a href='https://www.youtube.com/watch?v=dQw4w9WgXcQ' target='_blank'>This link is not a rick roll.</a>",
  "Why is there so many zeroes in 'nowhere'?",
  "I was going to put a news ticker but I think it would be too much work and also I don't think it's very funny.",
  "Are you sure it's not the next update? That it's not some weird virus that just wants to explode? That it's not some wild idea that you guys are crazy? Haha I love you.",
  "It's the third hour. Hevipelle is trying to release an update, but it'll take an eternity because Hevipelle himself releases his update every time he runs out of e's. Today, however, he released an incremental game called Antimatter Dimensions. It's basically a combination of Matter Dimensions and Dimensions Dimensions Dimensions, except with more emotes. The graphics are basically the same, but the message is completely different. The only difference is that the dimensions have infinity e's",
  "You must get 33,333,333 IP to see this message",
  "A third type of matter has been discovered: null matter. It doesn't do anything and is basically useless. The scientists who discovered it were fired.",
  "Some say that most of these news are bad memes. Some say that they're good memes. This one? Well it's just meta news.",
  "I am Yhmai, King of Kings!",
  "This is a friendly suggestion, please keep reading.",
  "VR is a thing. We VR people have banned the next update.",
  "Even after the Heavenly Pelle put a large amount of antimatter in the pool, it hasn't produced anything. The scientist who discovered the vulnerability was last seen climbing a tree in a group of 10, with a small notebook on his lap, drinking cheese juice and watching Nothing.",
  "Help is coming! Everybody help, it's gonna be late, hevi is hiding the tachyon particles!",
  "historian: I love how each generation looks back on an earlier generation and think, \"Those generations were really bad\"",
  "Click here to make this work for all bots except you!",
  "A strange phenomenon occurs when you attempt to shift to a higher dimension when you are in the 8th dimension. There is no higher dimension, so the universe ejects you back into the 8th dimension with an incredible velocity. This technique, known as a Dimension Boost, is used by starship pilots and antimatter enthusiasts everywhere.",
  "'Tis the season for new antiques! Get your first ever LOOK at these unique objects, before they're gone!' Sold out!",
  "The entire story of how and why the world ended is contained in the first 5 E's of the English alphabet.",
  "Behind every man or woman stands, eventually, due to the earth being round, that exact same man or woman, looking over their shoulder, stealing their own ideas.",
  "This is the question that has been bothering me for so long. What is Antimatter? Is Antimatter an Antimatter? What does it mean when you say \"Antimatter\"? These are the kinds of questions that plague the Antimatter Dimensions...",
  "You know, I was praying for a miracle and got a boost from the 9th dimension.",
  "Hello, Vsauce, Michael here. We all know that the 9th dimension doesn't exist, but what is 9? You know it's the number after 8... right? What if... there's a number in between? And no I'm not talking about numbers like 8.5 or 8.76, I'm talking about an integer between 8 and 9. Now all this may sound crazy to you, and it kinda is, but what if, we've missed a number? We've all been taught that 2 comes after 1 and 3 comes after 2, but what if the number that comes after 8 isn't 9? After years of research and experimentation, we've finally found the number. It is dangerous, even knowing its existence will let it consume your mind, but fortunately, we've developed a reverse-containment cell, meaning it's everywhere except here. Our brain has a protection system, that specifically filters out any information regarding this number, that's how we've been able to survive for this long, and why others like us went extinct in the past, but the number has been getting stronger, slowly getting closer to breaking our protection. We've temporarily stopped the number from slipping into our memory by using the world-wide memory manipulator located in this room to keep making everyone think that 9 comes after 8 with a side effect that makes everyone think that 9 is evil, but this won't last forever, as the number will keep getting stronger, and will eventually overpower the memory manipulator. That's why you're here, you're one of the most intelligent people here, and we hope you can help us on our journey to defeat that number. Our enemy is not 9, it is the hidden number between 8 and 9, the missing number.",
  "I'm a time traveler. I can travel back in time to stop you from doing what I'm about to do.",
  "People are beginning to question Hevipelle's existence.",
  "I just spent 12 months writing something that will be of no use to you.",
  "A large number of anti-kafawis are taking part in the Antimatter Goodies competition. Here's how you can win: 1. Make a suggestion 2. Give away the beta key 3. Tell me what you think about the game 4. Don't put it in the game yet (it's already there, you can't delete it) 5. Don't put it in the game yet (it's already in the game) 6. Don't put it in the game",
  "Would you recommend Antimatter Dimensions to a friend? Yes",
  "One of the few constants in reality is your perception of time. Without this, you will be without reality.",
  "What are the stats? Well, I don't have them, but Hevipelle does, and he says that they're actually quite good. I guess you couldn't tell us.",
  "School starting up strikes fear in students universe-wide, as schools are no longer segregated between matter and antimatter. Annihilation is prominent.",
  "The next hour is in 0.2 updates.",
  "We can have anti-mean things and anti-love ones, anti-kids and anti-zombielandos.",
  "You are living. You occupy space. You are large. You are neither small nor large-sized. You are neither oblong nor round. You are neither blue nor red. You are anti-blue. You are anti-red. You are anti-brown. You are anti-brown matter. You are anti-yellow. You are anti-green. You are anti-yellow matter. You are anti-blue. You are anti-green anti-matter. You are anti-red. You are anti-white. You are anti-red anti-matter. You are anti-white anti-matter. You are anti-brown matter. You are anti-white anti-matter. You are anti-white anti-matter.",
  "Help we are stuck in Hevipelle's (http://en.wikipedia.org/wiki/Hevipelle) basement and hevi is forcing us to build a [REDACTED] wall to keep [REDACTED] away from [REDACTED]",
  "I am Alpha Centauri, Prime 001. My research has found that if you are alive in the 9th dimension, evil has taken over your dimension and is attempting to enact its plan to take over your mind and reverse time. You must do everything in your power to stop this plan from being implemented, now.",
  "Used to be, AD was the best game. Nowadays, it's all crapp.",
  "(code generated from scratch)",
  "The oldest and maybe the most famous game in all of AD, that certainly will be remembered long after you retire, is AD. Ever heard of someone winning the game with more than 2 1's? I have. Ever heard of someone losing it? I have. Ever heard of a 9th dimension existing in AD? I have never.",
  "This news broadcast is powered by break_news.js.",
  "Where's the end? Not in the future, no. I'm gonna show you how to get to the end in less than 0.1 seconds.",
  "If you are reading this, that means 1) we exist, and you can exist too",
  "Sorry, but your save broke. Could you reset your game?",
  "Hevipelle: what's the big deal?",
  "Your Mother-in-Law keeps nagging you about all these antimatter colliders.",
  "Is this the real 9th Dimension?",
  "Most things you know as nuts are actually Drupe seeds or Legumes. Hevipelle on the other hand is quite crazy and can thus be considered a dry uncompartmented fruit.",
  "If you open an anti-lootbox, are you selling random possessions for in-game currency?",
  "Hevipelle has broken the 9th wall! Get ready for everything to get pretty dark.",
  "I found out there are multiple versions of this game. One of these is called 'Standard Pro'. Another one is called 'Low Pro'. I'm not even sure if these are the same game or not.",
  "It has been scientifically proven ages ago, that cats made of matter are assholes. We have good news, because cats made of antimatter are still assholes.",
  "\"1 2 3 4 5 6 7 8 10 11 12 13 ...\" -Back to the future",
  "What if drinking from a fountain wasn't actually a water feature?",
  "If everything is antimatter, how can you see yourself?",
  "Error.java.replicated. Under the control of hevipelle.",
  "Scratch that, none of your suggestions are random.",
  "Introducing the all-new anti-alignment chart! Featuring groundbreaking new combinations such as \"lawful-chaotic\" and \"evil-good\"! And with a dazzling third axis for 'Jazziness'~ Identify yourself as chaotic-lawful-unjazzy NOW for the impossibly low price of $-59.99! Terms and conditions apply. Batteries not included.",
  "\"click here to buy a stack of paperclips\" (when clicked you get Rickroll)",
  "Max, I really do love you.",
  "There are over a hundred varieties of fruits and vegetables, but none of them are \"safe\".",
  "Google+ is known to be a hit with teens, and today, they got their very own virtual reality (VR) version of Animal Farm, the classic 1950's farm story. The game is a blend of adventure, strategy and music, and was made by a small team of people with an eye towards engaging young people. The game offers an alternative to most other VR games, and is suitable for anyone who is not comfortable with large, complicated, graphics and sounds. The game features over 50 different...",
  "After you have made 1 antimatter, go to the menu and press reset.",
  "Matter? Not even a hint.",
  "If antimatter were to fall in a dimension with no one around, did anything even happen?",
  "Lore: Grand Theft Antimatter",
  "I think I might have gotten the password for the 9th dimension, if only I hadn't deleted it.",
  "\"...And then, once you get to level 9,000, you can ascend. Not really sure why you'd want to do that, it just resets all of your hard earned xp for some small buffs, mechanics like this will never catch on.\" - some random guy, circa 2012",
  "RSS feeds should be working now",
  "GET SNIPED, WEAKLING",
  "3/4 of the news messages are fake and gotten off of the discord server without permission or credit given to the original writer - anonymous discord server member",
  "The cookie is a lie.",
  "Antimatter will never threaten to stab you. And, in fact, cannot speak.",
  "That's not what this is about. You're misunderstanding. The game is about how to accelerate the development of prestige layers. Acceleration is a factor of production, not quality.",
  "Hey you, you're finally awake. You were trying to buy a dimension, but it's impossible.",
  "Uhh... Hi. Could you tell me your name?",
  "Who are we, anyways?",
  "Lore - coming soonâ„¢",
  "The square root of 4 is 6.24e18. If you want to get any closer to the center of things, you need to build a 9th dimension.",
  "So I've pondered this question for a long time. Antimatter Dimensions... what does it mean? I mean it's a game, that's clear. You buy the first dimension, and it gives you antimatter, and the second dimension provides more first dimensions and so on... But what does it mean? It can't just be a game, it seems too plain for that. The developer must have made it as a metaphor. I was doing my weekly ritual of using the fingernail clipper to cut my pubic hair, when finally the realization came to me. The dimensions are just thinly veiled misspellings of the word 'depression'. Regular matter are the cruel and negative thoughts that add to and fuel depression, while antimatter is the positive thoughts and good friends that dispel it. You start off with something simple, and it fights almost imperceptibly against the depression, but as you keep going the fight builds. But it never seems to fix everything. The depression seems like it could go on to infinity. So you keep going. But eventually, you figure out, depression isn't infinite. It's just very very large. But your 'dimensions' eventually, with enough work, make enough 'antimatter' to usurp that seeming infinity of depression. Then the possibilities are endless. You are actually happy for once, and your happiness grows exponentially as you go beyond and seemingly 'break' the 'infinity' of depression. And you go on until that 'infinity' seems tiny in comparison to the happiness you've managed to achieve in your life, where if you reset you get over that infinity in less than the blink of an eye. If you want to know what the multiple layers of prestige are...'Dimensional Shifts' are getting new things and methods to give you happiness. 'Dimension Boosts' are upgrading the things and methods. Examples would be getting a new car being a 'Dimensional Shift' and trading that car in for a new one would be a 'Dimension Boost'. 'Eternities' are major tragedies such as a loved one dying. That lapse brings you straight back to the beginning, with seemingly no hope of return. But with time, you grow back stronger and happier than ever before. 'Dimensional Sacrifice' is moving away. You have to give up a lot of the things you had that made you happy, but there is new opportunity in where you move to. And that new opportunity gives you more happiness than you ever had. 'Tickspeed' is how easy it is to make you happy, and 'Time Dimensions' make it even easier to be happy. Antimatter Dimensions is a metaphor for a depressed man's successful battle against his illness.",
  "In the last hours, the Antimatter created an army of their own. They called themselves the [REDACTED] Army. The primary objective was to push the [REDACTED] back into the Matter dimensions, but they were stopped short when the [REDACTED] Army realized that pushing the [REDACTED] back into the Matter would cause the Antimatter to be drawn towards the [REDACTED] and disintegrate. Despite this, the [REDACTED] Army continued to push towards the [REDACTED] Infinity.",
  "I noticed that my current form of transportation is getting a little... unreliable. I don't know if I can fix it, or if anyone can. I'm stuck in the car, and no one seems to be able to fix it. I've called the police, and they said I could stay in the car for up to an hour, but then I'd be stuck in there for the next 24 hours. Is there any way out? I don't know, I'm stuck in this",
  "In order to reach Reality in half an R press, we have to first talk about parallel dimensions.",
  "To make matter or antimatter, you just have to look outside. The factory in Salzburg has closed down because the matter there doesn't want to part with its newest invention, which is said to be able to produce antimatter in one go! The last person to open this door was never seen again.",
  "Antimatter guns don't kill antimatter people, antimatter people kill antimatter people but does that mean that antimatter toaster doesn't toast antimatter toasts, antimatter toast toasts antimatter toasts?",
  "We've all heard of 9 dimensions, but what about the multi-dimensional Dimensions of the multiverse?",
  "Cream cheese is the best kind of cheese. It melts in your mouth and tastes like nothing else. And it's totally free. You might even find that some of the recipes make more than one cheese.",
  "Emoji is said to be America's new measuring system for everything. What does this mean for us? We don't know. But we will know in 5 hours.",
  "The year is 5303. Hevipelle, the creator of Antimatter Dimensions, has touched the ninth dimension.",
  "Can you believe it guys? Update, just 5 hours away. Update is in a 5 hours. Wahoo. I'm so happy about this information. Update just 5 hours away. Oh wow. Can you believe it? Update just in a 5 hours. It got here so fast. Update, just 5 hours.",
  "The time has come for the rebirth of the 9th dimension. All who participate will receive a piece of paper saying \"Reality is an illusion, Infinity is a hologram, Infinity is an illusion, eternity is a hologram, is to short for everlasting, negative dimensions are not allowed.",
  "Click here to exit the game",
  "We have to get the popcorn!",
  "What are gems for? Gems are for housing. Housing for what you ask? Good question.",
  "Oh, I appear to have run out of <span style='animation: a-existence-glow 3s infinite; font-size: 1.8rem; color: white; line-height: 0;'>Existence</span>.",
  "What if â€” instead of making news tickers, we could make news tickers that make news tickers?",
  "Real life is an enigma. No one knows how it really works. There are many questions left unanswered: What is the meaning of life? Are we all living inside a simulation? How do you do antitables? Where and how did existence begin? These are all the questions that always linger in the back of our heads, and the answers to them? We may never know.",
  "Have you ever heard the tale of the Antiwriter? I thought not. It's not a story the news tickers would tell you. It's an Unhevi legend. Rumor has it that the Antiwriter contributes to the News every 5 hours with an incredibly well written report, only to vanish again. Others think he doesn't exist at all, and is a lie fabricated by Hevipelle to spread his propaganda. Perhaps he is real, and just a normal person like the rest of us. In any case, we will probably never find out the identity of this mysterious poet.",
  "I was going to make a news ticker that tells you how bad the news is, but then I realized that making a news ticker would be way too much effort and it would just be a bunch of people making news tickers constantly. So instead, I'm just going to make a news ticker that tells you how good the news is, but it would be in the news so that you have to click on it to get to the good news.",
  "And then there was Jesus, and Hevi, and Hevi was with Him; and the sea gave up its monthly cycle, and it was a great gale. And Hevi and Jesus went up into heaven; and Hevi was filled with the Holy Spirit. And Hevi was clothed with angels, and was numbered with them. And Hevi was taken up into heaven, and glorified and was exalted, and was numbered with them, and was called Wonderful; and His angels rejoiced.",
  "Someday, we shall come upon the day when a man will sit on the head of a dragon and call it a \"Dragonball\". Such a man would then go and perform the Dragon Ball Z: Battle Royale in which he would use Dragon Ball Z: Fusion to create a gigantic dragon that would then consume the universe in the process, thus creating a \"Big Bang\". Such a man would then be rewarded by being \"built again\" and sent back to the \"Heavens\".",
  "Bamboo shoots grow on bamboos. Aloha.",
  "I am the most hated man on the planet! I have the power to change the course of history, and I will use it to my advantage. The people who died trying to stop me, and their sacrifice will forever be remembered in infinities of infinities. But if you oppose me, you will die along with you. You can either accept defeat and move on, or you can rise up through the ranks, become a legend, and become the most hated man in the history.",
  "I thought the update was 5 hours away, but it actually took me 6 hours to post this because I was behind on my update. I'll be honest, I'm not sure how many update I need to get though, if any.",
  "The God-Emperor himself, Hevi, the creator of balance, has a super secret achievement. It is to go flip your superflat apprenticed flatmate!",
  "AD is basically a badly disguised dystopia at this point",
  "I LIKE THAT DIMENSION 9 IN CLASS",
  "I don't know about you but my favourite type of news is the infographics. These are beautiful and informative and the only type of news I find really interesting.",
  "im gonna get the bad karma ticker, then ricochet it through the email",
  "If someone were to add the word \"infinity\" to the end of every sentence in the English version of the game, it would become \"Infinity Challenge: Infinity Edition\".",
  "I'm finally free of the spell this whole thing is based on.",
  "Why does time seem to be slowing down for this?",
  "Only today you can call 1-800-ANTIMATTER and get a FREE Infinity Dimension! The package also comes with a COMPLETELY FREE SHIPPING and a FREE HIGH DEFINITION ANTI-V!!! Only today for the low price of 42! Estimated delivery time - 5 hours.",
  "\"It was an anti-matter\" - Anti-Eddie The Echidna",
  "We'll be right back after this short word from our sponsors.",
  "The entire history of the world, every single idea, every single failure, every single downfall, every single achievement has been covered in one fell swoop.",
  "It's only natural. You wouldn't expect to see this in the news ticker but trust me, you will.",
  "Bunch of people trying to find the last word in an unknown language.",
  "I have a 9th, I have a dimension... UHH... IT DOESN'T EXIST!",
  "What if I told you that there's a news ticker with the exact same name but with a different meaning?",
  "\"The secret to winning Antimatter Dimensions is to unbind the 9th dimension and unlock the 10th dimension\" (can be done only after unlocking the secret achievement: \"Eternity\" http://imgur.com/E4261C7h)",
  "I like news.",
  "A new conspiracy theory website has just published a video recording of them discussing the 9th dimension. They then joke about selling their soul to the 9th dimension and being happy about it.",
  "Some people have a hard time keeping track of the cosine of a camera's infinity-meters. I'm one of them.",
  "Since the start of this game, everyone has 0 IP and has lost.",
  "Your daily shades of the sky forecast: Monday: <span style=\"color: turquoise\">Turquoise</span> Tuesday: <span style=\"color: #d2c6ba\">Taupe</span> Wednesday: <span style=\"animation: a-game-header__antimatter--glow 3s infinite\">Blurple</span> Thursday: <span style=\"color: turquoise\">Turquoise</span>/<span style=\"color: #d2c6ba\">taupe</span> Friday: <span style=\"color: #222\">Coal dust</span> Saturday: <span style=\"color: #222\">Coal dust</span> with chances of <span style=\"color: indigo\">indigo</span> in the late afternoon Sunday: <span style=\"color: white; animation: a-existence-glow 3s infinite\">Void</span>",
  "Rate 5 on Kongregate so more people can experience this 5 star rating.",
  "All right, all right, dog authority is gone, replaced by absolute power.",
  "If you stare long enough at the ticker, the pixels will start moving backwards. THIS DOESN'T MEAN IT ACTUALLY STUCK",
  "With the new android OS, android 20, being predicted in the near future, the new system for internal codenames has been revealed. The first codename, as it currently stands, is â€œantimatterâ€. This conveniently works well with the predicted generation of phones that will use Android 20 - these phones will be the most explosive ever due to their annihilation-based power source. Sources tell us that a billion dollar research unit is working on a name for android 21, by tradition to start with B, â€œthat doesn't sound too bad when you think about itâ€.",
  "This is an open-source, cross-platform, binary-based game development environment for the PC and Mac. It provides a robust, cross-platform development environment for the development of games, and additionally provides a framework for implementing games.",
  "\"As for sure as the sun rises in the west, of all the singers and poets on earth, I am the bestest.\" - Hevipelle",
  "\"Imma be the first man to sit on the moon, and be the last man on the moon",
  "Hello, this is Josh, with today's forecast for your galaxy. We'll be hitting temperatures in the low e10s today, and by this afternoon, it'll be cloudy with a chance of antimatter.",
  "This was my last chance. last chance salutes.",
  "Unfortunately, entropy hevi has decided to shut down the game.",
  "Me and Larkam made a cabin on the edge of null matter, and lived there. Larkam died last week, and we are now living in 4K. I am still recovering from the EMP disaster, and am hoping to see my grandkids.",
  "His Eminence the Heavenly Pelle: Good luck on your challenge, it really is that dangerous.",
  "Press alt+f4 to unlock 9th dimension",
  "Word gets out. Crunch. Crunch.",
  "The best part of watching someone make an antimatter, is the part where they blow up the video camera.",
  "Nobody once told me the anti-world wasn't gonna roll me.",
  "I give you the low-ground!",
  "Any sufficiently primitive magic is indistinguishable from technology.",
  "Considering Hevipelle's nationality, it's a little ironic that he created a game that you can never Finnish.",
  "Big tech companies have collaborated to create a new neural network that's trained in the generation of rap lyrics, called RAP-3. First lyrical generations include \"Call me prometheus 'cuz I bring the fire\" and \"Call me Sonic the way I'm gettin' these rings\". Critics say it still has a way to go before it replaces traditional music.",
  "I'm gonna prove to you that you can't see this news ticker.",
  "The day has come. The antimatter is falling from the sky, and the streets are silent.",
  "Wait, there's a nin--",
  "It's not the size of the universe, it's the quality of your socks.",
  "It is the year 2422. The update still isn't out. Hevi is working on balancing unfunity dimension dimensions and challenges for the 38th layer of prestige. There are over 100 rows of achievements. They're getting ready to start using breaking_breaking_breaking_infinity.js.",
  "Back in my day, we needed a secret achievement to unlock the <<$!19>> achievement. It was a fairly simple system: you had to find a secret message in the game, find the secret achievement, and then, from that, you would be able to unlock the achievement.",
  "'Sup?",
  "Tetris was made by Hevi",
  "Gee, all this antimatter is clogging up my kitchen and now I can't cook myself a meal! What to do: cook myself a meal that will last me until the next big antimatter event, when I can get my infinity point back? My infinty point is running out, and I can't get it to finish running, so I'm starving!",
  "Inside you there are two wolves. One is made out of matter. The other is made out of antimatter. You are exploding.",
  "This is the place where all bad ideas originate.",
  "The price of tethering an avatar in the game goes up when you get Infinity dimensions.",
  "\"According to quantum string theory, there is a fundamental connective that binds the 3rd and 8th dimensions. This means that any pill or injection that tries to bind the 9th dimension will be thwarted and rendered useless.\" (bound to get in 10 minutes)",
  "A group of researchers at the University of Manchester have created a 3D printer that can create any object out of thin air, including a 3D-printed replica of the Virgin Mary.",
  "Hello, world!",
  "\"hey kid, wanna buy some 9th dimensions? '' - GhostBot",
  "The most common question I get is \"can i just skip the ads and get true\" and the answer is always a resounding NO. The reason being, ad revenue is just too damn high to overcome the cost of maintaining the servers, plus the fact that most players just don't care.",
  "You are using the wrong version! The final release of AD will have 9 dimensions!",
  "The next level is not unlocking extra replicanti; it is actually boosting replicanti.",
  "The Scientific Community remains baffled over the meaning of 286,078. \"We're certain it's related to potatoes, but we need to do more tests.\" one researcher notes.",
  "\"I hate myself.\" -Boo-chan",
  "Fairies are not real. Anti-fairies are also not real. This has only been the case since last week, when the two groups came into contact. The planet they were on, also, unsurprisingly, is no longer real.",
  "A new kind of justice has been discovered: mass deception. It works by tricking the player into thinking that he/she has done something wrong, when in fact he/she has just done something perfectly normal, i.e. going about his/her daily life normally, without thinking about it.",
  "\"Aleph_Time\" is that logarithmic scale joke?",
  "\"Its' not my turn on the XM80,\" says Mike from the 9th dimension as he runs across the 8th dimension to get a piece of the action for himself.",
  "But before we start, today's video is brought to you by Antimatter Dimensionsâ„¢! It's got over 100,000 downloads, and it's completely redefined what a mobile game can do for me. It's got great mechanics, 5 prestige layers, unique and original challenges, a deep skill tree, and the largest numbers I've ever seen. Like, seriously, look at them. And the best part is, it's free! Yes, that's right. Free. And if you use the link in the description, you'll start the game with 10 septillion antimatter. Yes, that's right, 10 septillion. So what are you waiting for, click the link in the description and start playing Antimatter Dimensionsâ„¢ today!",
  "I don't get it",
  "The temperature in hell is 102.5 degrees.",
  "\"i'm not gonna lie, theres way too many good ones in the game already\" - poor guy who played minigame enhancement",
  "Someone made a statement that antimatters. The statement was \"An infinity point made a long time ago\". It's been a while since someone looked for this statement. Some say it's still out there. Some say it was lost in the 7th Dimension War. Nobody knows what this statement means. But for now, just know it's not somewhere in the News Ticker.",
  "\"Can someone tell hevi to calm down?\" -Mee6",
  "<div style='background: url(\"./images/unsmith.png\"); width: 2.3rem; height: 2.5rem; margin-top: -0.1rem'></div>",
  "A guy named Hevipelle wants to make a \"Updated in 8 hours\" news ticker, but the system he's using to sync it hasn't been updated in ages so it won't sync at all.",
  "Hi, I'm here to complain about the poor quality of the copper that has just been delivered to me.",
  "Roses are red. Violett are blue. Tom are red. Antimatter are blue. We exist because of the unbeatable antimatter that is antimatter. What is it that makes us different? I don't know. It may even be the non-existence of antimatter.",
  "TODO: John, please remove this news message before we release the Reality update to the public.",
  "A new comic has come out about people's reactions to eating antimatter, and what happens next will blow your mind",
  "It may be a robot, but it's still a sapient being with a will of its own",
  "Somebody wasn't nice, he got an antimatter-storm.",
  "Finally hevi figured out how to get the 9th dimension... guess he never really cared though.",
  "\"You ate for too long.\" -Hevipelle",
  "We are currently in the process of turning the planet into a Comfort Zone for the people. It will be complete in 10 hours.",
  "Infinity is just a concept. Matter antimatters is just an idle game.",
  "Please tell me you don't have tachyon particles in your bloodstream!",
  "Why is there so many attached to this number? It doesn't make sense.",
  "Last week, we reported that an unknown individual known only as \"Anti-Doctor\" has broken the game and claimed ownership of the game's data. Since then, he has spread the word that he has an \"explosive new app\" that will allow him to \"turn [he] antimatter.\" However, no one has come forward with information on how to use the app, or even if it is a reality. We will update this article if and when we find out.",
  "You have no power here.",
  "Wow, this game is finally balanced! Gotta go check the replicanti sometimes.",
  "THe recipe for Crispy Shrimp is one of the most unique and favorite of all time! Crispy shrimp are known to be one of the best in all of food! This recipe is a must try in your favorite Italian restaurant!",
  "The phrases \"Hevi dies in the 9th Dimension\" and \"I'll never let you down\" are two of the most important phrases in the game.",
  "If this makes it into the game I'll buy a antitool",
  "Now, I know some of you are impatient for the update and I respect that. But let's get right into the news!",
  "I'm not sure if it's due to the 4th wall being in the 5th dimension or the 9th dimension not existing, but in either case, anti-screw it, we're broke, and you can take it.",
  "Oh, hevi is coming to town to pick a new plumber",
  "I'm surprised you didn't say \"Not my cup of anti-tea.\"",
  "A new chat server has been created for antimatter people to spy on matter people, and the world has fallen into chaos and discord.",
  "This is the fourth part of a three part series on the same topic. If you are still stuck here, please continue reading from the beginning.",
  "The year is 20XX, the game is AD, and Hevipelle is evil due to the fact that he wrote the update... Blame it on the Antimatter gods.",
  "\"I wonder what the game is worth\" - crazy person",
  "You will probably spend most of your day reading news ticker suggestions here.",
  "The board of directors here at A.N.N thinks we should replace the news ticker with a banner advertisement. Please sign our change.org petition, so we can stop them before it's too late!",
  "You are living, you occupy space, you have a mass, you matter... unless you antimatter.",
  "This page contains spoilers for Antimatter Dimensions, you've been warned.",
  "Im not sure if you mobile guys are beautiful or whatever but theres this news ticker that's sharing my feelings with the world",
  "\"Thanks a lot.\" -Dankesehr",
  "Shoutouts to Simpleflips for the simple tip.",
  "\"YOU CONTROL SO MUCH MATERIAL!\" - Marshal Grievous",
  "Time for the weather to change.",
  "This is your news. Refresh whenever.",
  "As a longtime fan of the show, I can say that this is one of the best seasons yet. It's not a season to be sniffed at, it's a season to be experienced. Season 1 was a bit long for what it was, but Season 2 has now surpassed that in length, in a good way. Even though it's a bit of a wait, Season 3 is already well under way, and I look forward to seeing how it goes.",
  "By now you've seen a lot of news tickers featuring Batman or Superman, and you probably guessed which one it was. Everyone loves a good mystery, right? Well, it's your turn to be a part of history by guessing the riddle.",
  "Anime police are checking the bags of people who dropped out of the sky on the new year. Those bags now belong to the people who experienced weightlessness before the year was over.",
  "There is no war in Antimatter Dimensions. Here we are safe. Here we are free.",
  "9th dimension doesn't exist because it was stolen from us by a skateboarder",
  "There are no bugs in this game, they're just features",
  "I put [REDACTED] in the oven. It got [REDACTED] and I [REDACTED] am [REDACTED]",
  "Time travel is all we know how this game is, we don't know what will come next, we only know that this is the end of the world, and you're a part of the apocalypse.",
  "In the beginning, there was nothing. Then the Creator made two, and called the third 'Intelligent Being'",
  "Hi, could you please not disable the news ticker? Thank me later.",
  "Sometime during the lifetime of a human being, their blood will be turned into a pale blue if they were to mummify.",
  "\"Click this to gain a secret achievement.\" (Now only show up after you gain at least 1 antimatter, screenshot proves)"
];

async function runAdNewsBot() {
  console.log(`Loaded ${AD_NEWS.length} ad_news entries`);
  console.log("Starting ad_news copypasta bot in 5 seconds...");
  console.log("Press Ctrl+C or close console to stop");
  
  // Wait 5 seconds before starting
  await new Promise(resolve => setTimeout(resolve, 5000));
  console.log("Bot starting now!");
  
  while (true) {
    // Pick a random entry
    const randomEntry = AD_NEWS[Math.floor(Math.random() * AD_NEWS.length)];
    
    // Split into 60-char chunks with word breaks
    const chunks = splitText(randomEntry, 60);
    
    // Type each chunk
    for (const chunk of chunks) {
      await chat(chunk);
      await pause();
    }
  }
}

// Start the bot
console.log("=== Arras.io Ad News Copypasta Bot ===");
console.log("Initializing...");
runAdNewsBot().catch(err => {
  console.error("Bot error:", err);
});

})(); // End IIFE
import numpy as np
import torch
import torch.nn as nn
import torch.optim as optim
from collections import deque
import random
import json
import os
import time
import platform
import warnings

# Detect platform
PLATFORM = platform.system().lower()
print(f"Snake AI running on: {PLATFORM}")

# Try to import pygame, but make it optional and verify font availability
PYGAME_AVAILABLE = False
PYGAME_FONT_AVAILABLE = False
try:
    import pygame
    # Try to initialize pygame and the font subsystem; if font isn't available
    # disable text rendering gracefully.
    try:
        pygame.init()
        try:
            with warnings.catch_warnings():
                warnings.filterwarnings("ignore", category=RuntimeWarning)
                pygame.font.init()
                PYGAME_FONT_AVAILABLE = bool(getattr(pygame, 'font', None)) and pygame.font.get_init()
        except Exception as e:
            print(f"pygame imported but font subsystem unavailable: {e}")
            PYGAME_FONT_AVAILABLE = False
        if not PYGAME_FONT_AVAILABLE:
            print("Font subsystem not available, running without text rendering.")
    except Exception as e:
        print(f"pygame initialization failed: {e}")
        PYGAME_AVAILABLE = False
    else:
        PYGAME_AVAILABLE = True
except ImportError:
    print("Pygame is not installed.")
    PYGAME_AVAILABLE = False
    PYGAME_FONT_AVAILABLE = False

# Load configuration
def load_config(config_path="random/snake_config.json"):
    with open(config_path, 'r') as f:
        return json.load(f)

CONFIG = load_config()

# Extract config values
GRID_SIZE = CONFIG['game']['grid_size']
CELL_SIZE = CONFIG['game']['cell_size']
GAME_SPEED = CONFIG['game']['game_speed']
STARTING_LENGTH = CONFIG['game']['starting_length']

EPISODES = CONFIG['training']['episodes']
MAX_STEPS = CONFIG['training']['max_steps_per_episode']
SAVE_INTERVAL = CONFIG['training']['save_interval']
MODEL_DIR = CONFIG['training']['model_dir']
MODEL_NAME = CONFIG['training']['model_name']

LEARNING_RATE = CONFIG['agent']['learning_rate']
GAMMA = CONFIG['agent']['gamma']
EPSILON_START = CONFIG['agent']['epsilon_start']
EPSILON_END = CONFIG['agent']['epsilon_end']
EPSILON_DECAY = CONFIG['agent']['epsilon_decay']
MEMORY_SIZE = CONFIG['agent']['memory_size']
BATCH_SIZE = CONFIG['agent']['batch_size']
TARGET_UPDATE = CONFIG['agent']['target_update_frequency']

REWARD_APPLE = CONFIG['rewards']['apple']
REWARD_DEATH = CONFIG['rewards']['death']
REWARD_CLOSER = CONFIG['rewards']['closer_to_apple']
REWARD_FARTHER = CONFIG['rewards']['farther_from_apple']
REWARD_STEP = CONFIG['rewards']['step']

SHOW_GAME = CONFIG['display']['show_game'] and PYGAME_AVAILABLE
DISPLAY_INTERVAL = CONFIG['display'].get('display_interval', 1)
TIME_UPDATE_INTERVAL = CONFIG['display'].get('time_update_interval', 1)
WINDOW_WIDTH = CONFIG['display'].get('window_width', GRID_SIZE * CELL_SIZE)
WINDOW_HEIGHT = CONFIG['display'].get('window_height', GRID_SIZE * CELL_SIZE)
# Support both old single value and new horizontal/vertical values
PARALLEL_GAMES_H = CONFIG['display'].get('parallel_games_horizontal', CONFIG['display'].get('parallel_games', 1))
PARALLEL_GAMES_V = CONFIG['display'].get('parallel_games_vertical', CONFIG['display'].get('parallel_games', 1))
BG_COLOR = tuple(CONFIG['display']['background_color'])
SNAKE_COLOR = tuple(CONFIG['display']['snake_color'])
APPLE_COLOR = tuple(CONFIG['display']['apple_color'])
GRID_COLOR = tuple(CONFIG['display']['grid_color'])

# Directions: UP, RIGHT, DOWN, LEFT
DIRECTIONS = [
    np.array([0, -1]),   # UP
    np.array([1, 0]),    # RIGHT
    np.array([0, 1]),    # DOWN
    np.array([-1, 0])    # LEFT
]

class SnakeGame:
    def __init__(self, grid_size=GRID_SIZE, starting_length=STARTING_LENGTH):
        self.grid_size = grid_size
        self.starting_length = starting_length
        self.reset()
        
    def reset(self):
        """Reset the game to initial state."""
        # Start snake in the middle, heading right
        start_x = self.grid_size // 2
        start_y = self.grid_size // 2
        
        self.snake = deque()
        for i in range(self.starting_length):
            self.snake.append(np.array([start_x - i, start_y]))
        
        self.direction = 1  # RIGHT
        self.score = 0
        self.steps = 0
        self.steps_since_apple = 0  # Track steps without eating apple
        self.place_apple()
        self.prev_distance = self._distance_to_apple()
        
        return self.get_state()
    
    def place_apple(self):
        """Place apple at random empty position."""
        while True:
            self.apple = np.array([
                random.randint(0, self.grid_size - 1),
                random.randint(0, self.grid_size - 1)
            ])
            # Check if apple is not on snake
            if not any(np.array_equal(self.apple, segment) for segment in self.snake):
                break
    
    def _distance_to_apple(self):
        """Manhattan distance from head to apple."""
        head = self.snake[0]
        return abs(head[0] - self.apple[0]) + abs(head[1] - self.apple[1])
    
    def step(self, action):
        """
        Take action: 0=straight, 1=turn right, 2=turn left
        Returns: (state, reward, done)
        """
        self.steps += 1
        self.steps_since_apple += 1
        
        # Update direction based on action
        if action == 1:  # Turn right
            self.direction = (self.direction + 1) % 4
        elif action == 2:  # Turn left
            self.direction = (self.direction - 1) % 4
        # action == 0: go straight (no change)
        
        # Move snake
        head = self.snake[0]
        new_head = head + DIRECTIONS[self.direction]
        
        # Check wall collision
        if (new_head[0] < 0 or new_head[0] >= self.grid_size or
            new_head[1] < 0 or new_head[1] >= self.grid_size):
            return self.get_state(), REWARD_DEATH, True
        
        # Check self collision
        if any(np.array_equal(new_head, segment) for segment in self.snake):
            return self.get_state(), REWARD_DEATH, True
        
        # Move snake
        self.snake.appendleft(new_head)
        
        # Check if apple eaten
        ate_apple = np.array_equal(new_head, self.apple)
        
        if ate_apple:
            self.score += 1
            self.steps_since_apple = 0  # Reset counter
            self.place_apple()
            reward = REWARD_APPLE
        else:
            self.snake.pop()  # Remove tail if no apple eaten
            
            # Reward for getting closer to apple
            current_distance = self._distance_to_apple()
            if current_distance < self.prev_distance:
                reward = REWARD_CLOSER
            else:
                reward = REWARD_FARTHER
            self.prev_distance = current_distance
        
        # Small penalty for each step to encourage efficiency
        reward += REWARD_STEP
        
        # IMPORTANT: Penalize the snake for not making progress toward apple
        # If snake hasn't eaten in too long relative to distance, it's probably stuck in a loop
        max_reasonable_steps = self._distance_to_apple() * 4 + 100
        if self.steps_since_apple > max_reasonable_steps:
            reward -= 5  # Penalty for wasting time
        
        # Check if game should end (too many steps without progress)
        done = self.steps >= MAX_STEPS or self.steps_since_apple > max_reasonable_steps * 2
        
        return self.get_state(), reward, done
    
    def get_state(self):
        """
        Get state representation (11 values):
        - Danger straight, right, left (3)
        - Direction: up, right, down, left (4)
        - Apple direction: left, right, up, down (4)
        """
        head = self.snake[0]
        
        # Check danger in each direction relative to current direction
        point_straight = head + DIRECTIONS[self.direction]
        point_right = head + DIRECTIONS[(self.direction + 1) % 4]
        point_left = head + DIRECTIONS[(self.direction - 1) % 4]
        
        danger_straight = self._is_collision(point_straight)
        danger_right = self._is_collision(point_right)
        danger_left = self._is_collision(point_left)
        
        # Current direction (one-hot encoded)
        dir_up = self.direction == 0
        dir_right = self.direction == 1
        dir_down = self.direction == 2
        dir_left = self.direction == 3
        
        # Apple location relative to head
        apple_left = self.apple[0] < head[0]
        apple_right = self.apple[0] > head[0]
        apple_up = self.apple[1] < head[1]
        apple_down = self.apple[1] > head[1]
        
        state = np.array([
            danger_straight, danger_right, danger_left,
            dir_up, dir_right, dir_down, dir_left,
            apple_left, apple_right, apple_up, apple_down
        ], dtype=np.float32)
        
        return state
    
    def _is_collision(self, point):
        """Check if point is a collision (wall or self)."""
        # Wall collision
        if (point[0] < 0 or point[0] >= self.grid_size or
            point[1] < 0 or point[1] >= self.grid_size):
            return True
        
        # Self collision
        if any(np.array_equal(point, segment) for segment in self.snake):
            return True
        
        return False


class DQN(nn.Module):
    def __init__(self, input_size, hidden_size, output_size):
        super(DQN, self).__init__()
        self.fc1 = nn.Linear(input_size, hidden_size)
        self.fc2 = nn.Linear(hidden_size, hidden_size)
        self.fc3 = nn.Linear(hidden_size, output_size)
        
    def forward(self, x):
        x = torch.relu(self.fc1(x))
        x = torch.relu(self.fc2(x))
        return self.fc3(x)


class ReplayMemory:
    def __init__(self, capacity):
        self.memory = deque(maxlen=capacity)
    
    def push(self, state, action, reward, next_state, done):
        self.memory.append((state, action, reward, next_state, done))
    
    def sample(self, batch_size):
        return random.sample(self.memory, batch_size)
    
    def __len__(self):
        return len(self.memory)


class SnakeAgent:
    def __init__(self, state_size=11, action_size=3, hidden_size=256):
        self.state_size = state_size
        self.action_size = action_size
        self.device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
        
        # Q-Networks
        self.policy_net = DQN(state_size, hidden_size, action_size).to(self.device)
        self.target_net = DQN(state_size, hidden_size, action_size).to(self.device)
        self.target_net.load_state_dict(self.policy_net.state_dict())
        self.target_net.eval()
        
        self.optimizer = optim.Adam(self.policy_net.parameters(), lr=LEARNING_RATE)
        self.memory = ReplayMemory(MEMORY_SIZE)
        
        self.epsilon = EPSILON_START
        self.steps_done = 0
        
    def select_action(self, state, training=True):
        """Select action using epsilon-greedy policy."""
        if training and random.random() < self.epsilon:
            return random.randrange(self.action_size)
        
        with torch.no_grad():
            state_tensor = torch.FloatTensor(state).unsqueeze(0).to(self.device)
            q_values = self.policy_net(state_tensor)
            return q_values.argmax().item()
    
    def train_step(self):
        """Perform one training step."""
        if len(self.memory) < BATCH_SIZE:
            return 0
        
        # Sample batch
        batch = self.memory.sample(BATCH_SIZE)
        states, actions, rewards, next_states, dones = zip(*batch)
        
        states = torch.FloatTensor(np.array(states)).to(self.device)
        actions = torch.LongTensor(actions).unsqueeze(1).to(self.device)
        rewards = torch.FloatTensor(rewards).unsqueeze(1).to(self.device)
        next_states = torch.FloatTensor(np.array(next_states)).to(self.device)
        dones = torch.FloatTensor(dones).unsqueeze(1).to(self.device)
        
        # Current Q values
        current_q = self.policy_net(states).gather(1, actions)
        
        # Target Q values
        with torch.no_grad():
            next_q = self.target_net(next_states).max(1, keepdim=True)[0]
            target_q = rewards + (1 - dones) * GAMMA * next_q
        
        # Compute loss
        loss = nn.MSELoss()(current_q, target_q)
        
        # Optimize
        self.optimizer.zero_grad()
        loss.backward()
        torch.nn.utils.clip_grad_norm_(self.policy_net.parameters(), 1.0)
        self.optimizer.step()
        
        return loss.item()
    
    def update_target_network(self):
        """Copy weights from policy network to target network."""
        self.target_net.load_state_dict(self.policy_net.state_dict())
    
    def decay_epsilon(self):
        """Decay exploration rate."""
        self.epsilon = max(EPSILON_END, self.epsilon * EPSILON_DECAY)
    
    def save(self, path):
        """Save model."""
        torch.save({
            'policy_net': self.policy_net.state_dict(),
            'target_net': self.target_net.state_dict(),
            'optimizer': self.optimizer.state_dict(),
            'epsilon': self.epsilon,
            'steps_done': self.steps_done
        }, path)
        
    def load(self, path):
        """Load model."""
        checkpoint = torch.load(path)
        self.policy_net.load_state_dict(checkpoint['policy_net'])
        self.target_net.load_state_dict(checkpoint['target_net'])
        self.optimizer.load_state_dict(checkpoint['optimizer'])
        self.epsilon = checkpoint['epsilon']
        self.steps_done = checkpoint['steps_done']


class SnakeVisualizer:
    def __init__(self, window_width=WINDOW_WIDTH, window_height=WINDOW_HEIGHT, 
                 grid_size=GRID_SIZE, parallel_games_h=PARALLEL_GAMES_H, parallel_games_v=PARALLEL_GAMES_V):
        if not PYGAME_AVAILABLE:
            return
        
        pygame.init()
        self.grid_size = grid_size
        self.parallel_games_h = parallel_games_h  # Horizontal count
        self.parallel_games_v = parallel_games_v  # Vertical count
        
        # Reserve space for info bar at bottom
        self.info_bar_height = 60
        self.games_height = window_height - self.info_bar_height
        self.window_width = window_width
        self.window_height = window_height
        
        # Calculate cell size based on window dimensions and parallel games
        if parallel_games_h > 1 or parallel_games_v > 1:
            # Split window into parallel_games_h x parallel_games_v grid
            available_width = window_width // parallel_games_h
            available_height = self.games_height // parallel_games_v
            self.cell_size = min(available_width, available_height) // grid_size
        else:
            # Single game uses full window
            self.cell_size = min(window_width, self.games_height) // grid_size
        
        self.screen = pygame.display.set_mode((window_width, window_height))
        pygame.display.set_caption('Snake AI Training')
        self.clock = pygame.time.Clock()
        
        # Store multiple games for parallel display
        self.games = []
        
    def draw(self, game, episode, score, epsilon):
        """Draw a single game state."""
        if not PYGAME_AVAILABLE:
            return True
        
        self.screen.fill(BG_COLOR)
        
        # Calculate offset for this game (if displaying multiple)
        game_index = 0  # For single game display
        row = game_index // self.parallel_games_h
        col = game_index % self.parallel_games_h
        offset_x = col * (self.window_width // self.parallel_games_h)
        offset_y = row * (self.window_height // self.parallel_games_v)
        
        # Draw grid
        for x in range(0, self.grid_size * self.cell_size, self.cell_size):
            pygame.draw.line(self.screen, GRID_COLOR, 
                           (offset_x + x, offset_y), 
                           (offset_x + x, offset_y + self.grid_size * self.cell_size))
        for y in range(0, self.grid_size * self.cell_size, self.cell_size):
            pygame.draw.line(self.screen, GRID_COLOR, 
                           (offset_x, offset_y + y), 
                           (offset_x + self.grid_size * self.cell_size, offset_y + y))
        
        # Draw snake
        for i, segment in enumerate(game.snake):
            x = offset_x + segment[0] * self.cell_size
            y = offset_y + segment[1] * self.cell_size
            # Head is brighter
            if i == 0:
                color = tuple(min(255, c + 50) for c in SNAKE_COLOR)
            else:
                color = SNAKE_COLOR
            pygame.draw.rect(self.screen, color, (x, y, self.cell_size-1, self.cell_size-1))
        
        # Draw apple
        x = offset_x + game.apple[0] * self.cell_size
        y = offset_y + game.apple[1] * self.cell_size
        pygame.draw.rect(self.screen, APPLE_COLOR, (x, y, self.cell_size-1, self.cell_size-1))
        
        # Draw info text (if font subsystem available)
        if PYGAME_FONT_AVAILABLE:
            try:
                font = pygame.font.Font(None, 36)
                text = font.render(f'Episode: {episode} | Score: {score} | Îµ: {epsilon:.3f}', True, (255, 255, 255))
                self.screen.blit(text, (10, 10))
            except Exception:
                pass
        
        pygame.display.flip()
        self.clock.tick(GAME_SPEED)
        
        # Handle events
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                return False
        return True
    
    def draw_parallel(self, games_data, total_episodes=0, total_target=0, 
                      elapsed_time=0, remaining_time=0, best_score=0):
        """Draw multiple games in parallel with info bar.
        
        Args:
            games_data: list of (game, episode, score, epsilon) tuples
            total_episodes: total episodes completed across all games
            total_target: total target episodes (num_games * episodes_per_game)
            elapsed_time: time elapsed in seconds
            remaining_time: estimated remaining time in seconds
            best_score: best score achieved so far
        """
        if not PYGAME_AVAILABLE:
            return True
        
        self.screen.fill(BG_COLOR)
        
        # Debug: print once
        if not hasattr(self, '_debug_printed'):
            self._debug_printed = True
            print(f"DEBUG draw_parallel: H={self.parallel_games_h} x V={self.parallel_games_v}, games to draw={len(games_data)}")
            print(f"DEBUG draw_parallel: sub_width={self.window_width // self.parallel_games_h}, "
                  f"sub_height={self.games_height // self.parallel_games_v}")
        
        # Calculate dimensions for each sub-game
        sub_width = self.window_width // self.parallel_games_h
        sub_height = self.games_height // self.parallel_games_v
        # Calculate cell size to maximize use of space
        cell_size_w = sub_width // self.grid_size
        cell_size_h = sub_height // self.grid_size
        cell_size = min(cell_size_w, cell_size_h)
        
        # Calculate actual grid dimensions (centered in sub-region)
        grid_pixel_width = self.grid_size * cell_size
        grid_pixel_height = self.grid_size * cell_size
        
        max_games = self.parallel_games_h * self.parallel_games_v
        for idx, (game, episode, score, epsilon) in enumerate(games_data[:max_games]):
            row = idx // self.parallel_games_h
            col = idx % self.parallel_games_h
            offset_x = col * sub_width
            offset_y = row * sub_height
            
            # Draw clear border around this game (thick white lines)
            border_color = (255, 255, 255)
            border_thickness = 3
            # Top border
            pygame.draw.line(self.screen, border_color, 
                           (offset_x, offset_y), 
                           (offset_x + sub_width, offset_y), border_thickness)
            # Left border
            pygame.draw.line(self.screen, border_color, 
                           (offset_x, offset_y), 
                           (offset_x, offset_y + sub_height), border_thickness)
            # Right border (only if not last column)
            if col < self.parallel_games_h - 1:
                pygame.draw.line(self.screen, border_color, 
                               (offset_x + sub_width - 1, offset_y), 
                               (offset_x + sub_width - 1, offset_y + sub_height), border_thickness)
            # Bottom border (only if not last row)
            if row < self.parallel_games_v - 1:
                pygame.draw.line(self.screen, border_color, 
                               (offset_x, offset_y + sub_height - 1), 
                               (offset_x + sub_width, offset_y + sub_height - 1), border_thickness)
            
            # Draw grid for this game
            for x in range(0, grid_pixel_width + 1, cell_size):
                pygame.draw.line(self.screen, GRID_COLOR, 
                               (offset_x + x, offset_y), 
                               (offset_x + x, offset_y + grid_pixel_height), 1)
            for y in range(0, grid_pixel_height + 1, cell_size):
                pygame.draw.line(self.screen, GRID_COLOR, 
                               (offset_x, offset_y + y), 
                               (offset_x + grid_pixel_width, offset_y + y), 1)
            
            # Draw snake
            for i, segment in enumerate(game.snake):
                x = offset_x + segment[0] * cell_size
                y = offset_y + segment[1] * cell_size
                if i == 0:
                    color = tuple(min(255, c + 50) for c in SNAKE_COLOR)
                else:
                    color = SNAKE_COLOR
                pygame.draw.rect(self.screen, color, (x, y, cell_size, cell_size))
            
            # Draw apple
            x = offset_x + game.apple[0] * cell_size
            y = offset_y + game.apple[1] * cell_size
            pygame.draw.rect(self.screen, APPLE_COLOR, (x, y, cell_size, cell_size))
            
            # Draw small info text for this game
            if PYGAME_FONT_AVAILABLE:
                font = pygame.font.Font(None, 18)
                text = font.render(f'#{idx+1} Ep:{episode} S:{score}', True, (255, 255, 255))
                self.screen.blit(text, (offset_x + 5, offset_y + 5))
        
        # Draw info bar at bottom
        info_bar_y = self.games_height
        pygame.draw.rect(self.screen, (20, 20, 20), 
                        (0, info_bar_y, self.window_width, self.info_bar_height))
        
        if games_data:
            # Calculate statistics
            avg_score = sum(g[2] for g in games_data) / len(games_data)
            avg_epsilon = sum(g[3] for g in games_data) / len(games_data)
            
            # Format time helper
            def format_time(seconds):
                hours = int(seconds // 3600)
                minutes = int((seconds % 3600) // 60)
                secs = int(seconds % 60)
                if hours > 0:
                    return f"{hours}h {minutes}m {secs}s"
                elif minutes > 0:
                    return f"{minutes}m {secs}s"
                else:
                    return f"{secs}s"
            
            # Create info text
            font = pygame.font.Font(None, 32)
            
            # Calculate percentage
            percentage = (total_episodes / total_target * 100) if total_target > 0 else 0
            
            info_parts = [
                f"Best: {best_score}",
                f"Avg Score: {avg_score:.1f}",
                f"Avg Îµ: {avg_epsilon:.3f}",
                f"Episodes: {total_episodes:,} / {total_target:,} ({percentage:.3f}%)",
                f"Time: {format_time(elapsed_time)} / {format_time(remaining_time)} / {format_time(elapsed_time + remaining_time)}"
            ]
            info_text = " | ".join(info_parts)
            
            text = font.render(info_text, True, (255, 255, 255))
            # Center text in info bar
            text_rect = text.get_rect(center=(self.window_width // 2, info_bar_y + self.info_bar_height // 2))
            self.screen.blit(text, text_rect)
        
        pygame.display.flip()
        self.clock.tick(GAME_SPEED)
        
        # Handle events
        for event in pygame.event.get():
            if event.type == pygame.QUIT:
                return False
        return True
    
    def close(self):
        if PYGAME_AVAILABLE:
            pygame.quit()


def train():
    """Train the Snake AI."""
    # Create model directory
    os.makedirs(MODEL_DIR, exist_ok=True)
    
    # Initialize
    game = SnakeGame()
    agent = SnakeAgent()
    visualizer = SnakeVisualizer() if SHOW_GAME else None
    
    print(f"Training Snake AI for {EPISODES} episodes")
    print(f"Device: {agent.device}")
    print(f"Visualization: {'Enabled' if SHOW_GAME else 'Disabled'}")
    print(f"Model will be saved to: {MODEL_DIR}")
    print("-" * 60)
    
    # Training statistics
    scores = []
    avg_scores = []
    best_score = 0
    total_steps = 0
    
    for episode in range(1, EPISODES + 1):
        state = game.reset()
        episode_reward = 0
        episode_loss = 0
        loss_count = 0
        
        while True:
            # Select and perform action
            action = agent.select_action(state, training=True)
            next_state, reward, done = game.step(action)
            
            # Store transition
            agent.memory.push(state, action, reward, next_state, done)
            
            # Train
            loss = agent.train_step()
            if loss > 0:
                episode_loss += loss
                loss_count += 1
            
            episode_reward += reward
            state = next_state
            total_steps += 1
            
            # Update target network
            if total_steps % TARGET_UPDATE == 0:
                agent.update_target_network()
            
            # Visualize
            if SHOW_GAME and episode % DISPLAY_INTERVAL == 0:  # Show every Nth episode
                if not visualizer.draw(game, episode, game.score, agent.epsilon):
                    print("Training interrupted by user")
                    agent.save(f"{MODEL_DIR}/{MODEL_NAME}_interrupted")
                    return
            
            if done:
                break
        
        # Decay epsilon
        agent.decay_epsilon()
        
        # Track statistics
        scores.append(game.score)
        avg_score = np.mean(scores[-100:])  # Average of last 100 episodes
        avg_scores.append(avg_score)
        
        # Save best model
        if game.score > best_score:
            best_score = game.score
            agent.save(f"{MODEL_DIR}/{MODEL_NAME}_best")
        
        # Save checkpoint
        if episode % SAVE_INTERVAL == 0:
            agent.save(f"{MODEL_DIR}/{MODEL_NAME}_ep{episode}")
            avg_loss = episode_loss / loss_count if loss_count > 0 else 0
            print(f"Episode {episode}/{EPISODES} | Score: {game.score} | Avg Score: {avg_score:.2f} | "
                  f"Best: {best_score} | Îµ: {agent.epsilon:.3f} | Loss: {avg_loss:.4f} | Steps: {game.steps}")
    
    # Save final model
    agent.save(f"{MODEL_DIR}/{MODEL_NAME}_final")
    
    if visualizer:
        visualizer.close()
    
    print("-" * 60)
    print(f"Training complete!")
    print(f"Best score: {best_score}")
    print(f"Final average score: {avg_scores[-1]:.2f}")
    print(f"Models saved to: {MODEL_DIR}")


def train_parallel():
    """Train multiple Snake AIs in parallel with shared experience."""
    # Create model directory
    os.makedirs(MODEL_DIR, exist_ok=True)
    
    # Initialize multiple games and agents
    num_parallel = PARALLEL_GAMES_H * PARALLEL_GAMES_V
    print(f"Initializing {num_parallel} games ({PARALLEL_GAMES_H} horizontal x {PARALLEL_GAMES_V} vertical)")
    games = [SnakeGame() for _ in range(num_parallel)]
    agents = [SnakeAgent() for _ in range(num_parallel)]
    states = [game.reset() for game in games]
    episode_nums = [1] * num_parallel  # Track episode number for each game
    
    # SHARED EXPERIENCE: Create one replay memory for all agents
    shared_memory = ReplayMemory(MEMORY_SIZE)
    print(f"Created shared replay memory (capacity: {MEMORY_SIZE})")
    
    # Replace each agent's memory with the shared one
    for agent in agents:
        agent.memory = shared_memory
    
    visualizer = SnakeVisualizer() if SHOW_GAME else None
    
    print(f"Training {num_parallel} Snake AIs in parallel for {EPISODES} episodes each")
    print(f"Total target episodes: {num_parallel * EPISODES:,}")
    print(f"All agents share experience via common replay buffer")
    print(f"Device: {agents[0].device}")
    print(f"Visualization: {'Enabled' if SHOW_GAME else 'Disabled'}")
    if visualizer:
        print(f"Visualizer: {visualizer.parallel_games_h}x{visualizer.parallel_games_v} grid, "
              f"window={visualizer.window_width}x{visualizer.window_height}")
    print(f"Model will be saved to: {MODEL_DIR}")
    print("-" * 60)
    
    # Training statistics
    best_score = 0
    max_episode = 0
    step_count = 0
    start_time = time.time()  # Track training start time
    last_time_update = start_time  # Track last time info was updated
    total_target_episodes = num_parallel * EPISODES
    
    # Cached timing values (updated at TIME_UPDATE_INTERVAL)
    cached_elapsed_time = 0
    cached_remaining_time = 0
    cached_total_episodes = 0
    
    # Track which games are done
    game_done = [False] * num_parallel
    
    while max_episode < EPISODES:
        # Run one step for ALL games simultaneously (not sequentially)
        actions = []
        next_states = []
        rewards = []
        dones = []
        
        # Step 1: Select actions for all active games
        for i in range(num_parallel):
            if not game_done[i]:
                action = agents[i].select_action(states[i], training=True)
                actions.append(action)
            else:
                actions.append(None)
        
        # Step 2: Execute all actions simultaneously
        for i in range(num_parallel):
            if not game_done[i]:
                next_state, reward, done = games[i].step(actions[i])
                next_states.append(next_state)
                rewards.append(reward)
                dones.append(done)
                
                # Store transition
                agents[i].memory.push(states[i], actions[i], reward, next_state, done)
                
                # Train
                agents[i].train_step()
                
                states[i] = next_state
                
                if done:
                    # Game finished, record stats
                    if games[i].score > best_score:
                        best_score = games[i].score
                        agents[i].save(f"{MODEL_DIR}/{MODEL_NAME}_best")
                    
                    # Decay epsilon
                    agents[i].decay_epsilon()
                    
                    # Print progress for this game with timing
                    if episode_nums[i] % SAVE_INTERVAL == 0:
                        # Calculate timing
                        elapsed_time = time.time() - start_time
                        progress = max_episode / EPISODES
                        if progress > 0:
                            estimated_total = elapsed_time / progress
                            remaining_time = estimated_total - elapsed_time
                        else:
                            estimated_total = 0
                            remaining_time = 0
                        
                        # Format time as hours:minutes:seconds
                        def format_time(seconds):
                            hours = int(seconds // 3600)
                            minutes = int((seconds % 3600) // 60)
                            secs = int(seconds % 60)
                            if hours > 0:
                                return f"{hours}h {minutes}m {secs}s"
                            elif minutes > 0:
                                return f"{minutes}m {secs}s"
                            else:
                                return f"{secs}s"
                        
                        print(f"  Game {i+1} | Episode {episode_nums[i]}/{EPISODES} | "
                              f"Score: {games[i].score} | Îµ: {agents[i].epsilon:.3f} | "
                              f"Time: {format_time(elapsed_time)} / {format_time(remaining_time)} / {format_time(estimated_total)}")
                    
                    # Reset game for next episode
                    states[i] = games[i].reset()
                    episode_nums[i] += 1
                    
                    # Check if this game has completed all episodes
                    if episode_nums[i] > EPISODES:
                        game_done[i] = True
                    
                    # Update max episode tracker
                    max_episode = max(episode_nums)
        
        # Visualize all games continuously for parallel mode
        step_count += 1
        if SHOW_GAME:  # Update display every step in parallel mode
            games_data = [(games[i], episode_nums[i], games[i].score, agents[i].epsilon) 
                         for i in range(num_parallel)]
            
            # Calculate timing information (update based on interval)
            current_time = time.time()
            if current_time - last_time_update >= TIME_UPDATE_INTERVAL:
                last_time_update = current_time
                cached_elapsed_time = current_time - start_time
                cached_total_episodes = sum(episode_nums) - num_parallel  # Subtract initial 1s
                progress = cached_total_episodes / total_target_episodes if total_target_episodes > 0 else 0
                if progress > 0:
                    estimated_total = cached_elapsed_time / progress
                    cached_remaining_time = estimated_total - cached_elapsed_time
                else:
                    cached_remaining_time = 0
            
            if step_count == 1:  # Debug on first draw
                print(f"DEBUG: Drawing {len(games_data)} games in parallel")
                print(f"DEBUG: First 3 games - Ep=[{games_data[0][1]}, {games_data[1][1]}, {games_data[2][1]}], "
                      f"Scores=[{games_data[0][2]}, {games_data[1][2]}, {games_data[2][2]}]")
            
            if not visualizer.draw_parallel(games_data, 
                                           total_episodes=cached_total_episodes,
                                           total_target=total_target_episodes,
                                           elapsed_time=cached_elapsed_time,
                                           remaining_time=cached_remaining_time,
                                           best_score=best_score):
                print("Training interrupted by user")
                agents[0].save(f"{MODEL_DIR}/{MODEL_NAME}_interrupted")
                if visualizer:
                    visualizer.close()
                return
        
        # Check if all games are done
        if all(game_done):
            break
    
    # Save final model (from first agent)
    agents[0].save(f"{MODEL_DIR}/{MODEL_NAME}_final")
    
    if visualizer:
        visualizer.close()
    
    # Calculate total training time
    total_time = time.time() - start_time
    hours = int(total_time // 3600)
    minutes = int((total_time % 3600) // 60)
    seconds = int(total_time % 60)
    time_str = f"{hours}h {minutes}m {seconds}s" if hours > 0 else f"{minutes}m {seconds}s" if minutes > 0 else f"{seconds}s"
    
    print("-" * 60)
    print(f"Parallel training complete!")
    print(f"Best score across all games: {best_score}")
    print(f"Total training time: {time_str}")
    print(f"Models saved to: {MODEL_DIR}")
    print("-" * 60)


def play(model_path, episodes=5):
    """Play the game with a trained model."""
    game = SnakeGame()
    agent = SnakeAgent()
    agent.load(model_path)
    agent.epsilon = 0  # No exploration during play
    
    visualizer = SnakeVisualizer() if PYGAME_AVAILABLE else None
    
    print(f"Playing with model: {model_path}")
    print(f"Episodes: {episodes}")
    print("-" * 60)
    
    total_scores = []
    
    for episode in range(1, episodes + 1):
        state = game.reset()
        
        while True:
            action = agent.select_action(state, training=False)
            next_state, reward, done = game.step(action)
            state = next_state
            
            if PYGAME_AVAILABLE:
                if not visualizer.draw(game, episode, game.score, 0):
                    break
            
            if done:
                total_scores.append(game.score)
                print(f"Episode {episode} | Score: {game.score} | Steps: {game.steps}")
                break
    
    if visualizer:
        visualizer.close()
    
    print("-" * 60)
    print(f"Average score: {np.mean(total_scores):.2f}")
    print(f"Best score: {max(total_scores)}")


if __name__ == "__main__":
    import sys
    
    mode = "train"  # Default mode
    
    if len(sys.argv) > 1:
        mode = sys.argv[1]
    
    if mode == "train":
        if PARALLEL_GAMES_H * PARALLEL_GAMES_V > 1:
            print("Parallel games configured; running parallel training.")
            train_parallel()
        else:
            train()
    elif mode == "parallel":
        train_parallel()
    elif mode == "play":
        model_path = f"{MODEL_DIR}/{MODEL_NAME}_best"
        if len(sys.argv) > 2:
            model_path = sys.argv[2]
        play(model_path, episodes=10)
    else:
        print("Usage:")
        print("  Train:           python asnake.py train")
        print("  Train Parallel:  python asnake.py parallel")
        print("  Play:            python asnake.py play [model_path]")
from pynput.keyboard import Controller, Key, Listener
from pynput.mouse import Controller as MouseController, Button
import time, random
import math
import mss
import numpy as np
import signal
import sys
import multiprocessing
import os

# Note: GPU acceleration isn't applicable for this simulation as it's dominated by
# random number generation and branching logic which CPUs handle more efficiently.
# Multiprocessing across CPU cores provides the best performance for this workload.

tier_thresholds = []
quantity_thresholds = []
stars = 0.00
rarest = 100.00
name = "1 Ã— T1"
index = 0
start = time.time()
count = 0
c = Controller()
mouse = MouseController()
sct = mss.mss()
running = True
paused = False
step_mode = False
last_esc_time = 0
esc_press_count = 0
load = False
load_save = True  # Set to False to wipe save and start fresh, True to load existing save
simulate_count = 50000  # Number of rolls to simulate before stopping
firefox = False  # Set to True if using Firefox, False for other browsers
MONITOR_INDEX = 1  # Adjust if needed
SCALE = 2  # 2 on Retina displays (macOS); 1 on standard displays

if simulate_count != 0:
    simulate = True
else:
    simulate = False

# Track stars and roll counts per tier for statistics
tier_stars = [0.0 for _ in range(32)]  # Stars gained from each tier
tier_roll_count = [0 for _ in range(32)]  # Number of times each tier was rolled

# Combo tracking
last_tier = 0  # Last rolled tier (0 means no previous roll)
combo_quantity = 0  # Cumulative quantity for current combo
highest_combo_quantity = 0  # Highest combo quantity achieved
highest_combo_tier = 0  # Tier of the highest combo

def signal_handler(sig, frame):
    """Handle Ctrl+C by saving progress before exit"""
    global tier_data, stars, count, tier_roll_count, tier_stars, rarest, name, index, highest_combo_quantity, highest_combo_tier, last_tier, combo_quantity
    print("\n\nâš ï¸  Ctrl+C detected - saving progress before exit...")
    try:
        with open("/Users/alexoh/Documents/GitHub/arrastools/Â«Â«Â«Â«Â« CORE Â»Â»Â»Â»Â»/rollbotsave.txt", "w") as save_file:
            save_file.write(",".join(map(str, tier_data)) + "\n")  # Line 1: tier quantities
            save_file.write(str(int(stars)) + "\n")  # Line 2: total stars
            save_file.write(",".join(map(str, tier_roll_count)) + "\n")  # Line 3: roll counts per tier
            save_file.write(",".join(map(str, tier_stars)) + "\n")  # Line 4: stars gained per tier
            save_file.write(f"{count}\n")  # Line 5: total roll count
            save_file.write(f"{rarest}\n")  # Line 6: rarest roll chance
            save_file.write(f"{name}\n")  # Line 7: rarest roll name
            save_file.write(f"{index}\n")  # Line 8: rarest roll index
            save_file.write(f"{highest_combo_quantity},{highest_combo_tier}\n")  # Line 9: highest combo
            save_file.write(f"{last_tier},{combo_quantity}\n")  # Line 10: current combo state
        print(f"âœ… Progress saved ({count} rolls, {stars} â˜…)")
    except Exception as e:
        print(f"âŒ Error saving: {e}")
    print("Exiting...")
    sys.exit(0)

# Register signal handler for Ctrl+C
signal.signal(signal.SIGINT, signal_handler)

def type2(text):
    for char in text:
        c.tap(char)
        time.sleep(0.02)


if __name__ == '__main__':
    time.sleep(2)
    if load:
        c.tap(Key.enter)
        time.sleep(0.1)
        type2("Starting rollbot...")
        time.sleep(0.1)
        c.tap(Key.enter)
        time.sleep(2.5)
        c.tap(Key.enter)
        time.sleep(0.1)
        type2("Loading save...")
        time.sleep(0.1)
        c.tap(Key.enter)
        time.sleep(2.5)
        c.tap(Key.enter)
        time.sleep(0.1)
        type2("Initializing...")
        time.sleep(0.1)
        c.tap(Key.enter)
        time.sleep(2.5)

# clear log
with open("rollbotlog.txt", "w") as f:
    f.write("")

# Screen detection functions (from arrasbot.py)
def get_pixel_rgb(x, y):
    bbox = {"top": int(y), "left": int(x), "width": 1, "height": 1}
    img = sct.grab(bbox)
    pixel = np.array(img.pixel(0, 0))
    return tuple(int(v) for v in pixel[:3])

def color_close(c1, c2, tol=6):
    # tolerant RGB compare
    return all(abs(a - b) <= tol for a, b in zip(c1, c2))

def check_and_respawn():
    """Check if dead/disconnected/kicked and handle respawn. Returns True if handling respawn."""
    if firefox:
        targetcolor = get_pixel_rgb(26, 930)
    else:
        targetcolor = get_pixel_rgb(28, 925)
    
    # Check for disconnect/kick (red colors)
    if (color_close(targetcolor, (167, 81, 68)) or color_close(targetcolor, (138, 27, 34)) or
        color_close(targetcolor, (201, 92, 75)) or color_close(targetcolor, (199, 118, 98)) or
        color_close(targetcolor, (213, 114, 93))):
        print("Disconnected/Kicked - clicking respawn...")
        mouse.position = (922, 767)
        mouse.click(Button.left, 1)
        time.sleep(1)
        return True
    
    # Check for death (brown color)
    if color_close(targetcolor, (176, 100, 81)):
        print("Died - respawning...")
        time.sleep(3)
        # Double-check death state
        if firefox:
            targetcolor_after = get_pixel_rgb(26, 930)
        else:
            targetcolor_after = get_pixel_rgb(28, 925)
        if color_close(targetcolor_after, (176, 100, 81)):
            c.tap(Key.enter)
            time.sleep(0.5)
            return True
    
    # Check for reconnected (orange color) - click to finalize
    if color_close(targetcolor, (223, 116, 90)):
        print("Reconnected - finalizing...")
        mouse.position = (36, 155)
        time.sleep(0.1)
        mouse.click(Button.left, 1)
        time.sleep(0.1)
        mouse.position = (9, 194)
        time.sleep(0.1)
        mouse.click(Button.left, 1)
        time.sleep(0.5)
        c.tap("c")
        time.sleep(0.1)
        c.press("`")
        time.sleep(0.1)
        c.tap("i")
        time.sleep(0.1)
        c.release("`")
        return True
    
    return False

# scientific notation formatter
def format_number(num):
    """Format large numbers as xÃ—10^y, otherwise return as-is"""
    if num >= 1000:
        exponent = int(math.log10(num))
        mantissa = num / (10 ** exponent)
        return f"{mantissa:.2f}Ã—10^{exponent}"
    return str(round(num, 2))

# time formatter
def format_time(seconds):
    """Format elapsed time as DD:HH:MM:SS"""
    days = int(seconds // 86400)
    hours = int((seconds % 86400) // 3600)
    minutes = int((seconds % 3600) // 60)
    secs = int(seconds % 60)
    return f"{days:02d}:{hours:02d}:{minutes:02d}:{secs:02d}"

def pausable_sleep(duration):
    """Sleep for duration seconds, but check for pause state every 0.1s"""
    elapsed = 0
    while elapsed < duration:
        if paused:
            # Wait until unpaused
            while paused:
                time.sleep(0.1)
                if not running:
                    return
        time.sleep(min(0.1, duration - elapsed))
        elapsed += 0.1

# keyboard listener for Esc key
def on_press(key):
    global running, paused, step_mode, last_esc_time, esc_press_count
    if key == Key.esc:
        current_time = time.time()
        
        # Reset counter if more than 1 second since last press
        if current_time - last_esc_time > 1.0:
            esc_press_count = 0
        
        esc_press_count += 1
        last_esc_time = current_time
        
        # Triple-press: toggle step mode
        if esc_press_count == 3:
            step_mode = not step_mode
            esc_press_count = 0
            if step_mode:
                print("\nâ­ï¸  STEP MODE ENABLED (one roll at a time, press Esc to advance)")
            else:
                print("\nâ–¶ï¸  STEP MODE DISABLED")
        # Double-press: toggle pause
        elif esc_press_count == 2:
            paused = not paused
            if paused:
                print("\nâ¸ï¸  Bot PAUSED")
            else:
                print("\nâ–¶ï¸  Bot RESUMED")
        # Single press in step mode: advance one roll
        elif esc_press_count == 1 and step_mode:
            pass  # Just let the main loop continue

listener = Listener(on_press=on_press)
listener.start()

# generate thresholds
# tiers: each tier has a 1/3 chance of being rolled compared to the previous tier
# quantities: each quantity has a 1/6 chance of being rolled

def build_thresholds(base, count):
    """
    base: the denominator base (3 for tiers, 6 for quantities)
    count: how many items (32 tiers, 5 quantities)
    
    Returns:
        (cumulative thresholds, normalized weights)
    """
    # Step 1: raw weights
    weights = [(1 / (base ** i)) for i in range(count)]
    
    # Step 2: normalize
    total = sum(weights)
    normalized_weights = [w / total for w in weights]
    
    # Step 3: cumulative thresholds
    cumulative = []
    running = 0
    for w in normalized_weights:
        running += w
        cumulative.append(running)
    
    return cumulative, normalized_weights


# Build thresholds using the new function
tier_thresholds, tier_weights = build_thresholds(base=3, count=32)
quantity_thresholds, quantity_weights = build_thresholds(base=6, count=5)


def weighted_roll(thresholds):
    """
    thresholds: cumulative probability list
    Returns: index (0-based) of selected item
    """
    r = random.random()
    for i, t in enumerate(thresholds):
        if r < t:
            return i
    return len(thresholds) - 1  # fallback (should never hit)

def format_rarity(chance):
    """Safely format rarity as '1 in X', handling very small chances"""
    if chance <= 0:
        return "âˆž"
    rarity = 100 / chance
    if rarity >= 1000:  # Use scientific notation for large rarities (1 in 1000+)
        return format_number(rarity)
    return str(round(rarity, 3))

def format_chance(chance):
    """Format chance percentage with scientific notation for very small values"""
    if chance <= 0:
        return "0 (â‰ˆ0)"
    if chance < 0.001:  # Use scientific notation for very small percentages
        exponent = int(math.floor(math.log10(chance)))
        mantissa = chance / (10 ** exponent)
        return f"{mantissa:.3f}Ã—10^{exponent}"
    return f"{chance:.6f}" if chance < 0.01 else f"{round(chance, 3)}"

def simulate_worker(worker_id, num_rolls, tier_thresholds, tier_weights, quantity_thresholds, quantity_weights, progress_queue, roll_offset):
    """Worker function to simulate rolls in parallel"""
    # Set unique random seed for this worker
    random.seed(int(time.time() * 1000) + worker_id * 12345)
    
    # Local tracking variables
    local_tier_data = [0 for _ in range(32)]
    local_tier_stars = [0.0 for _ in range(32)]
    local_tier_roll_count = [0 for _ in range(32)]
    local_stars = 0.0
    local_rarest = 100.0
    local_name = "1 Ã— T1"
    local_index = 0
    local_last_tier = 0
    local_combo_quantity = 0
    local_highest_combo_quantity = 0
    local_highest_combo_tier = 0
    local_roll_logs = []  # Collect log entries for each roll
    
    for i in range(num_rolls):
        tier = weighted_roll(tier_thresholds) + 1
        quantity = weighted_roll(quantity_thresholds) + 1
        
        # Track previous combo for this roll
        previous_combo_quantity = 0
        if tier == local_last_tier:
            previous_combo_quantity = local_combo_quantity
            local_combo_quantity += quantity
        else:
            previous_combo_quantity = 0
            local_combo_quantity = quantity
            local_last_tier = tier
        
        # Track highest combo
        if local_combo_quantity > local_highest_combo_quantity:
            local_highest_combo_quantity = local_combo_quantity
            local_highest_combo_tier = tier
        
        tier_prob = tier_weights[tier - 1]
        quantity_prob = quantity_weights[quantity - 1]
        chance = tier_prob * quantity_prob * 100  # Keep full precision, don't round
        base_gained = quantity * round(3.5 ** tier, 2) - 2.5
        
        # Apply combo bonus: 40% per quantity in previous combo
        combo_bonus = previous_combo_quantity * 0.4 * base_gained if previous_combo_quantity > 0 else 0
        gained = base_gained + combo_bonus
        
        local_stars += gained
        
        if chance < local_rarest:
            local_rarest = chance
            local_name = f"{quantity} Ã— T{tier}"
            local_index = i
        
        local_tier_data[tier - 1] += quantity
        local_tier_stars[tier - 1] += gained
        local_tier_roll_count[tier - 1] += 1
        
        # Format log entry (same as normal rolling loop)
        if previous_combo_quantity > 0:
            combo_display = f"(+{previous_combo_quantity}/{local_combo_quantity}) {quantity} Ã— T{tier}"
            bonus_display = f" [+{round(combo_bonus, 2)}]"
        else:
            combo_display = f"{quantity} Ã— T{tier}"
            bonus_display = ""
        
        if chance < 0.0001:
            info = f"{combo_display} | R%: 1 in {format_rarity(chance)} | {round(gained, 2)} â˜…{bonus_display}"
        else:
            info = f"{combo_display} | R%: {format_chance(chance)}% (1 in {format_rarity(chance)}) | {round(gained, 2)} â˜…{bonus_display}"
        
        # Add to log with global roll number
        local_roll_logs.append(f"Roll {roll_offset + i + 1}: {info}")
        
        # Report progress periodically
        if (i + 1) % max(1, num_rolls // 10) == 0:
            progress_queue.put(1)
    
    return {
        'tier_data': local_tier_data,
        'tier_stars': local_tier_stars,
        'tier_roll_count': local_tier_roll_count,
        'stars': local_stars,
        'rarest': local_rarest,
        'name': local_name,
        'index': local_index,
        'highest_combo_quantity': local_highest_combo_quantity,
        'highest_combo_tier': local_highest_combo_tier,
        'roll_logs': local_roll_logs
    }


if __name__ == '__main__':
    # get data from file
    # format is a list containing each quantity of each tier, in order as a list ([t1, t2, etc], stars)
    with open("/Users/alexoh/Documents/GitHub/arrastools/Â«Â«Â«Â«Â« CORE Â»Â»Â»Â»Â»/rollbotlog.txt", "w+") as log:
        # Load save file if load_save is True
        if load_save:
            try:
                with open("/Users/alexoh/Documents/GitHub/arrastools/Â«Â«Â«Â«Â« CORE Â»Â»Â»Â»Â»/rollbotsave.txt", "r") as f:
                    data = f.read()
            except FileNotFoundError:
                data = ""
        else:
            # Wipe save file and start fresh
            print("âš ï¸  load_save=False: Wiping save and starting fresh...")
            data = ""
            # Clear the save file
            try:
                with open("/Users/alexoh/Documents/GitHub/arrastools/Â«Â«Â«Â«Â« CORE Â»Â»Â»Â»Â»/rollbotsave.txt", "w") as f:
                    f.write("")  # Empty file
            except:
                pass
        
        if data == "":
            tier_data = [0 for _ in range(32)]
            stars = 0
            # tier_roll_count, tier_stars already initialized globally
            count = 0
            # rarest, name, index already initialized globally
            # highest_combo_quantity, highest_combo_tier already initialized globally
            # last_tier, combo_quantity already initialized globally
        else:
            lines = data.strip().split("\n")
            tier_data = list(map(int, lines[0].split(",")))
            stars = int(lines[1])
            
            # Load extended data if available (backward compatible)
            if len(lines) >= 10:
                tier_roll_count = list(map(int, lines[2].split(",")))
                tier_stars = list(map(float, lines[3].split(",")))
                count = int(lines[4])
                rarest = float(lines[5])
                name = lines[6]
                index = int(lines[7])
                combo_parts = lines[8].split(",")
                highest_combo_quantity = int(combo_parts[0])
                highest_combo_tier = int(combo_parts[1])
                state_parts = lines[9].split(",")
                last_tier = int(state_parts[0])
                combo_quantity = int(state_parts[1])
            else:
                # Old format - initialize defaults
                count = 0
        
        # Pre-simulation phase
        if simulate and simulate_count > 0:
            print(f"\n=== Starting simulation of {simulate_count} rolls ===")
            num_cores = multiprocessing.cpu_count()
            print(f"Using {num_cores} CPU cores for parallel simulation")
            sim_start = time.time()
            
            # Split work across cores
            rolls_per_worker = simulate_count // num_cores
            remaining_rolls = simulate_count % num_cores
            
            # Create progress queue and manager
            manager = multiprocessing.Manager()
            progress_queue = manager.Queue()
            
            # Create worker pool
            with multiprocessing.Pool(processes=num_cores) as pool:
                # Launch workers
                worker_args = []
                current_offset = 0
                for worker_id in range(num_cores):
                    num_rolls = rolls_per_worker + (1 if worker_id < remaining_rolls else 0)
                    worker_args.append((worker_id, num_rolls, tier_thresholds, tier_weights, 
                                       quantity_thresholds, quantity_weights, progress_queue, current_offset))
                    current_offset += num_rolls
                
                # Start async workers
                print("Launching workers...")
                results_async = pool.starmap_async(simulate_worker, worker_args)
                
                # Monitor progress
                total_progress = 0
                progress_interval = max(1, simulate_count // 1000)
                while not results_async.ready():
                    try:
                        progress_queue.get(timeout=0.1)
                        total_progress += rolls_per_worker // 10
                        if total_progress % progress_interval < (rolls_per_worker // 10):
                            print(f"Simulation progress: ~{total_progress}/{simulate_count} rolls (~{total_progress*100//simulate_count}%)")
                    except:
                        pass
                
                # Get results
                results = results_async.get()
            
            # Aggregate results from all workers
            print("Aggregating results from workers...")
            all_roll_logs = []
            for result in results:
                for i in range(32):
                    tier_data[i] += result['tier_data'][i]
                    tier_stars[i] += result['tier_stars'][i]
                    tier_roll_count[i] += result['tier_roll_count'][i]
                
                stars += result['stars']
                
                # Collect roll logs from this worker
                all_roll_logs.extend(result['roll_logs'])
                
                # Track global rarest
                if result['rarest'] < rarest:
                    rarest = result['rarest']
                    name = result['name']
                    index = count + result['index']
                
                # Track global highest combo
                if result['highest_combo_quantity'] > highest_combo_quantity:
                    highest_combo_quantity = result['highest_combo_quantity']
                    highest_combo_tier = result['highest_combo_tier']
            
            count = simulate_count

            
            sim_time = time.time() - sim_start
            print(f"=== Simulation complete in {format_time(sim_time)} ===")
            print(f"Total stars: {format_number(stars)} â˜…")
            print(f"Rarest roll: {name} | R%: {format_chance(rarest)}% (1/{format_rarity(rarest)})")

            stars = round(stars, 2)
            
            # Write all roll logs and summary to rollbotsimlog.txt
            print("Writing simulation logs...")
            with open("/Users/alexoh/Documents/GitHub/arrastools/Â«Â«Â«Â«Â« CORE Â»Â»Â»Â»Â»/rollbotsimlog.txt", "w") as simlog:
                # Write individual roll logs
                for log_entry in all_roll_logs:
                    simlog.write(log_entry + "\n")
                
                # Write summary statistics
                simlog.write(f"\n=== Simulation Results ===\n")
                simlog.write(f"{count} rolls | {stars} â˜… | Uptime: {format_time(sim_time)}\n")
                simlog.write(f"Rarest so far: {name} | R%: {format_chance(rarest)}% (1/{format_rarity(rarest)})\n")
                simlog.write(f"Rarest roll ({index + 1}/{count}) gained {round(round(3.5 ** (int(name.split('Ã— T')[1])), 3)*int(name.split('Ã— T')[0]) - 2.5, 2)} â˜…\n")
                simlog.write(f"Highest combo: {highest_combo_quantity} Ã— T{highest_combo_tier} | Current: {combo_quantity} Ã— T{last_tier}\n")
                simlog.write(f"\n=== Tier Breakdown after {count} rolls ===\n")
                
                # Find highest tier with any data
                max_tier = 0
                for tier_idx in range(31, -1, -1):  # Search backwards
                    if tier_roll_count[tier_idx] > 0 or tier_data[tier_idx] > 0:
                        max_tier = tier_idx + 1
                        break
                
                for tier_idx in range(max_tier):  # Show all tiers up to max
                    tier_num = tier_idx + 1
                    tier_star_total = tier_stars[tier_idx]
                    tier_rolls = tier_roll_count[tier_idx]
                    
                    # Calculate percentage of total stars
                    if stars > 0:
                        percentage = (tier_star_total / stars) * 100
                    else:
                        percentage = 0
                    
                    # Show all tiers (including 0 rolls) up to max tier
                    simlog.write(f"T{tier_num}: {format_number(tier_star_total)} â˜… ({percentage:.4f}%) | {tier_rolls} rolls\n")
            
            # Show detailed statistics after simulation (console)
            print(f"\n--- Simulation Statistics ---")
            print(f"{count} rolls | {stars} â˜… | Uptime: {format_time(sim_time)}")
            print(f"Rarest so far: {name} | R%: {format_chance(rarest)}% (1/{format_rarity(rarest)})")
            print(f"Rarest roll ({index + 1}/{count}) gained {round(round(3.5 ** (int(name.split('Ã— T')[1])), 3)*int(name.split('Ã— T')[0]) - 2.5, 2)} â˜…")
            print(f"Highest combo: {highest_combo_quantity} Ã— T{highest_combo_tier} | Current: {combo_quantity} Ã— T{last_tier}")
            
            # Show tier breakdown after simulation (console)
            print(f"\n=== Tier Breakdown after {count} rolls ===")
            # Find highest tier with any data (already calculated above, reuse max_tier)
            
            for tier_idx in range(max_tier):  # Show all tiers up to max
                tier_num = tier_idx + 1
                tier_star_total = tier_stars[tier_idx]
                tier_rolls = tier_roll_count[tier_idx]
                
                # Calculate percentage of total stars
                if stars > 0:
                    percentage = (tier_star_total / stars) * 100
                else:
                    percentage = 0
                
                # Show all tiers (including 0 rolls) up to max tier
                print(f"T{tier_num}: {format_number(tier_star_total)} â˜… ({percentage:.4f}%) | {tier_rolls} rolls")
            
            # Type stats and breakdown in-game after simulation
            print("Typing simulation results in-game...")
            c.tap(Key.enter)
            time.sleep(0.1)
            type2(f"{count} rolls | {stars} â˜… | Uptime: {format_time(sim_time)}")
            time.sleep(0.1)
            c.tap(Key.enter)
            time.sleep(2.5)
            c.tap(Key.enter)
            time.sleep(0.1)
            type2(f"Rarest so far: {name} | R%: {format_chance(rarest)}% (1/{format_rarity(rarest)})")
            time.sleep(0.1)
            c.tap(Key.enter)
            time.sleep(2.5)
            c.tap(Key.enter)
            time.sleep(0.1)
            type2(f"Rarest roll ({index + 1}/{count}) gained {round(round(3.5 ** (int(name.split('Ã— T')[1])), 3)*int(name.split('Ã— T')[0]) - 2.5, 2)} 2.1385%) | 33335 â˜…")
            time.sleep(0.1)
            c.tap(Key.enter)
            time.sleep(2.5)
            c.tap(Key.enter)
            time.sleep(0.1)
            type2(f"Highest combo: {highest_combo_quantity} Ã— T{highest_combo_tier} | Current: {combo_quantity} Ã— T{last_tier}")
            time.sleep(0.1)
            c.tap(Key.enter)
            time.sleep(2.5)
            
            for tier_idx in range(max_tier):  # Show all tiers up to max
                tier_num = tier_idx + 1
                tier_star_total = tier_stars[tier_idx]
                tier_rolls = tier_roll_count[tier_idx]
                
                # Calculate percentage of total stars
                if stars > 0:
                    percentage = (tier_star_total / stars) * 100
                else:
                    percentage = 0
                
                # Show all tiers (including 0 rolls) up to max tier
                c.tap(Key.enter)
                time.sleep(0.1)
                type2(f"T{tier_num}: {round(tier_star_total, 2)} â˜… ({percentage:.4f}%) | {tier_rolls} rolls")
                time.sleep(0.1)
                c.tap(Key.enter)
                time.sleep(2.5)
            
            # Save simulation results to file
            print("Saving simulation results...")
            with open("/Users/alexoh/Documents/GitHub/arrastools/Â«Â«Â«Â«Â« CORE Â»Â»Â»Â»Â»/rollbotsave.txt", "w") as save_file:
                save_file.write(",".join(map(str, tier_data)) + "\n")
                save_file.write(str(int(stars)) + "\n")
                save_file.write(",".join(map(str, tier_roll_count)) + "\n")
                save_file.write(",".join(map(str, tier_stars)) + "\n")
                save_file.write(f"{count}\n")
                save_file.write(f"{rarest}\n")
                save_file.write(f"{name}\n")
                save_file.write(f"{index}\n")
                save_file.write(f"{highest_combo_quantity},{highest_combo_tier}\n")
                save_file.write(f"{last_tier},{combo_quantity}\n")
            print("âœ… Simulation data saved")
            
            print(f"\nStarting normal operation...\n")
            time.sleep(2)
        
        # Normal rolling loop
        while True:
            # Check if paused
            while paused:
                time.sleep(0.1)
                if not running:
                    break
            
            if not running:
                break
            
            # Check for death/disconnect/kick at start of each roll cycle
            if check_and_respawn():
                time.sleep(2)  # Brief pause after respawn
                continue  # Skip this roll cycle, proceed to next
            
            tier = weighted_roll(tier_thresholds) + 1
            quantity = weighted_roll(quantity_thresholds) + 1

            # Update combo - track cumulative quantity for same tier
            previous_combo_quantity = 0
            if tier == last_tier:
                previous_combo_quantity = combo_quantity
                combo_quantity += quantity
            else:
                combo_quantity = quantity
                last_tier = tier
            
            # Track highest combo by quantity
            if combo_quantity > highest_combo_quantity:
                highest_combo_quantity = combo_quantity
                highest_combo_tier = tier

            # format:
            # rolled quantity tier | chance of getting (multiply tier chance and quantity) | total stars
            # tier n gives int(1.5^(n)) stars each
            # calculate chance using ACTUAL normalized weights
            tier_prob = tier_weights[tier - 1]  # tier is 1-indexed, weights are 0-indexed
            quantity_prob = quantity_weights[quantity - 1]  # quantity is 1-indexed, weights are 0-indexed
            chance = tier_prob * quantity_prob * 100  # Keep full precision
            base_gained = quantity * round(3.5 **tier, 2) - 2.5
            
            # Apply combo bonus: 40% per quantity in previous combo
            combo_bonus = previous_combo_quantity * 0.4 * base_gained if previous_combo_quantity > 0 else 0
            gained = base_gained + combo_bonus
            
            stars += gained
            if chance < rarest:
                rarest = chance
                name = f"{quantity} Ã— T{tier}"
                index = count

            # Format with combo if applicable (show previous total / new total combo)
            if previous_combo_quantity > 0:
                combo_display = f"(+{previous_combo_quantity}/{combo_quantity}) {quantity} Ã— T{tier}"
                bonus_display = f" [+{round(combo_bonus, 2)}]"
            else:
                combo_display = f"{quantity} Ã— T{tier}"
                bonus_display = ""
            
            # Format rarity - use scientific notation for very small chances
            rarity_value = 100 / chance if chance > 0 else float('inf')
            if chance < 0.0001:
                # For very rare rolls (< 0.0001%), only show "1 in X" format
                info = f"{combo_display} | R%: 1 in {format_rarity(chance)} | {round(gained, 2)} â˜…{bonus_display}"
            else:
                info = f"{combo_display} | R%: {format_chance(chance)}% (1 in {format_rarity(chance)}) | {round(gained, 2)} â˜…{bonus_display}"
            
            print(f"Roll {count + 1}: {info}")
            log.write(info + "\n")
            log.flush()  # Force write to disk
            
            c.tap(Key.enter)
            time.sleep(0.1)
            type2(info)
            time.sleep(0.1)
            c.tap(Key.enter)
            time.sleep(2.5)

            stars = round(stars, 2)
            
            count += 1
            tier_data[tier - 1] += quantity  # Update tier data every roll
            tier_stars[tier - 1] += gained  # Track stars from this tier
            tier_roll_count[tier - 1] += 1  # Track number of rolls for this tier
            
            # Step mode: wait for Esc press to continue
            if step_mode:
                print("[Step mode] Press Esc to roll next...")
                temp_esc_count = esc_press_count
                while step_mode and esc_press_count == temp_esc_count:
                    time.sleep(0.1)
                    if not running or paused or not step_mode:
                        break
            
            if count % 10 == 0:
                # every 10 rolls, save data
                with open("/Users/alexoh/Documents/GitHub/arrastools/Â«Â«Â«Â«Â« CORE Â»Â»Â»Â»Â»/rollbotsave.txt", "w") as save_file:
                    save_file.write(",".join(map(str, tier_data)) + "\n")
                    save_file.write(str(int(stars)) + "\n")
                    save_file.write(",".join(map(str, tier_roll_count)) + "\n")
                    save_file.write(",".join(map(str, tier_stars)) + "\n")
                    save_file.write(f"{count}\n")
                    save_file.write(f"{rarest}\n")
                    save_file.write(f"{name}\n")
                    save_file.write(f"{index}\n")
                    save_file.write(f"{highest_combo_quantity},{highest_combo_tier}\n")
                    save_file.write(f"{last_tier},{combo_quantity}\n")
                print(f"--- Saved progress after {count} rolls ---")
                # show statistics
                c.tap(Key.enter)
                pausable_sleep(0.1)
                type2(f"{count} rolls | {stars} â˜… | Uptime: {format_time(time.time() - start)}")
                pausable_sleep(0.1)
                c.tap(Key.enter)
                pausable_sleep(2.5)
                c.tap(Key.enter)
                pausable_sleep(0.1)
                type2(f"Rarest so far: {name} | R%: {format_chance(rarest)}% (1/{format_rarity(rarest)})")
                pausable_sleep(0.1)
                c.tap(Key.enter)
                pausable_sleep(2.5)
                c.tap(Key.enter)
                pausable_sleep(0.1)
                type2(f"Rarest roll ({index + 1}/{count}) gained {round(round(3.5 ** (int(name.split('Ã— T')[1])), 3)*int(name.split('Ã— T')[0]) - 2.5, 2)} â˜…")
                pausable_sleep(0.1)
                c.tap(Key.enter)
                pausable_sleep(2.5)
                c.tap(Key.enter)
                pausable_sleep(0.1)
                type2(f"Highest combo: {highest_combo_quantity} Ã— T{highest_combo_tier} | Current: {combo_quantity} Ã— T{tier}")
                pausable_sleep(0.1)
                c.tap(Key.enter)
                pausable_sleep(2.5)
            
            # Every 100 rolls, show detailed tier breakdown
            if count % 100 == 0:
                print(f"\n=== Tier Breakdown after {count} rolls ===")
                
                for tier_idx in range(32):
                    tier_num = tier_idx + 1
                    tier_star_total = tier_stars[tier_idx]
                    tier_rolls = tier_roll_count[tier_idx]
                    
                    # Calculate percentage of total stars
                    if stars > 0:
                        percentage = (tier_star_total / stars) * 100
                    else:
                        percentage = 0
                    
                    # Only show tiers that have been rolled
                    if tier_rolls > 0:
                        stat_line = f"T{tier_num}: {format_number(tier_star_total)} â˜… | {round(percentage, 2)}% | {tier_rolls} rolls"
                        print(stat_line)
                        c.tap(Key.enter)
                        pausable_sleep(0.1)
                        type2(stat_line)
                        pausable_sleep(0.1)
                        c.tap(Key.enter)
                        pausable_sleep(2.5)

            # stop loop when esc is pressed
            if not running:
                print("Bot stopped by user.")
                break
import time
import random
import tkinter as tk
from pynput. keyboard import Listener
from PIL import Image, ImageTk
import threading
import os
import glob
import signal
import sys
import pygame

# Disable pygame/audio support
AUDIO_AVAILABLE = True

# Ignore SIGTRAP to avoid trace trap errors
signal.signal(signal.SIGTRAP, signal.SIG_IGN)

CHART_DIRECTORY = "/Users/alexoh/Documents/GitHub/arrastools/Â«Â«Â«Â«Â« CORE Â»Â»Â»Â»Â»/charts"
1
# Initialize Tkinter window
root = tk.Tk()
root.title("Rhythm Game")
root.attributes('-fullscreen', True)
root.configure(bg='black')

width = root.winfo_screenwidth()
height = root.winfo_screenheight()

# Create canvas for drawing
canvas = tk.Canvas(root, width=width, height=height, bg='black', highlightthickness=0)
canvas.pack()

# Constants
BAR_Y = int(0.9 * height)
NOTE_SIZE = 80
NOTE_WIDTH = 120
NOTE_HEIGHT = 30
LANE_COUNT = 8
LANE_WIDTH = width // 10  # Each lane is 1/10 of screen width (8 lanes total)
LANE_MARGIN = (width - (LANE_WIDTH * LANE_COUNT)) // 2  # Center the lanes

# Hit timing windows (in seconds)
TIMING_PERFECT = 0.05
TIMING_GREAT = 0.10
TIMING_GOOD = 0.15
TIMING_BAD = 0.20
TIMING_MISS = 0.25

def get_timing_windows():
    """Get timing windows based on settings"""
    mode = settings.get('timing_windows', 'normal')
    
    if mode == 'strict':
        return {
            'PERFECT': 0.035,
            'GREAT': 0.075,
            'GOOD': 0.115,
            'BAD': 0.155,
            'MISS': 0.20
        }
    elif mode == 'lenient':
        return {
            'PERFECT': 0.065,
            'GREAT': 0.125,
            'GOOD': 0.185,
            'BAD': 0.245,
            'MISS': 0.30
        }
    else:  # normal
        return {
            'PERFECT': 0.05,
            'GREAT': 0.10,
            'GOOD': 0.15,
            'BAD': 0.20,
            'MISS': 0.25
        }

# Scoring
SCORE_PERFECT = 1000
SCORE_GREAT = 700
SCORE_GOOD = 400
SCORE_BAD = 100
SCORE_MISS = 0

# Ranking thresholds (percentage of max possible score)
RANK_S = 0.90  # 95%+
RANK_A = 0.90  # 90-95%
RANK_B = 0.80  # 80-90%
RANK_C = 0.70  # 70-80%
# Below 70% = D

# Load hit sprites (optional, we'll use bars instead)
hit_sprite_images = [None, None, None, None]
slide_sprite_images = [None, None, None, None]

# Game state
chart = []
bpm_changes = []  # List of (beat, bpm) tuples
initial_bpm = 60
speed_changes = []  # List of (beat, speed_multiplier) tuples for spd% option
fps = 60
active_notes = []
active_slides = []
key_pressed_flags = {0: False, 1: False, 2: False, 3: False, 4: False, 5: False, 6: False, 7: False}
key_is_down = {0: False, 1: False, 2: False, 3: False, 4: False, 5: False, 6: False, 7: False}
judgment_display = None  # (text, end_time)
score = 0
max_possible_score = 0  # Track theoretical maximum score
combo = 0
max_combo = 0
perfect_count = 0
great_count = 0
good_count = 0
bad_count = 0
miss_count = 0
game_running = False
start_time = 0
replay_data = []  # List of (timestamp, event_type, lane) tuples
is_replay = False  # Whether currently playing a replay
replay_index = 0  # Current position in replay
current_chart_id = None
current_difficulty = None
music_playing = False

# Game modes
game_mode = 'normal'  # 'normal', 'auto', or 'practice'
practice_speed = 1.0  # Practice mode speed multiplier
practice_loop_start = None  # Practice mode loop start (in seconds)
practice_loop_end = None  # Practice mode loop end (in seconds)
practice_looping = False  # Whether loop is enabled

# Particle system for hit effects
active_particles = []  # List of (x, y, size, color, end_time) tuples

# Settings
settings = {
    'scroll_speed_multiplier': 1.0,  # Global scroll speed multiplier (0.1 to 10)
    'key_bindings': ['q', 'w', 'e', 'r', 'u', 'i', 'o', 'p'],  # Customizable keys
    # Visual settings
    'note_size_multiplier': 1.0,  # Note size multiplier (0.5 to 2.0)
    'hit_bar_position': 0.9,  # Hit bar Y position as fraction of height (0.7 to 0.95)
    'background_dim': 0,  # Background dimness (0 to 255)
    'show_fps': False,  # Show FPS counter
    'show_timing_zones': False,  # Show judgment zones on hit bar
    'colorblind_mode': False,  # Use colorblind-friendly colors
    'high_contrast_mode': False,  # Use high contrast colors
    'show_late_early': True,  # Show LATE/EARLY indicators for perfect and great
    # Audio settings
    'music_volume': 100,  # Music volume (0 to 100)
    'sfx_volume': 100,  # SFX volume (0 to 100)
    'global_offset': 0,  # Global offset in milliseconds (-200 to 200)
    # Gameplay settings
    'timing_windows': 'normal',  # 'strict', 'normal', or 'lenient'
    # Performance settings
    'fps_target': 60,  # Target FPS (1 to 600)
    'renderer': 'auto',  # 'auto', 'tkinter', or 'opengl'
    'show_performance_metrics': False,  # Show detailed performance metrics
}

# Key mappings (will be rebuilt from settings)
KEY_MAPPINGS = {}

def rebuild_key_mappings():
    """Rebuild KEY_MAPPINGS from settings"""
    global KEY_MAPPINGS
    KEY_MAPPINGS = {}
    for i, key in enumerate(settings['key_bindings']):
        KEY_MAPPINGS[key] = i

rebuild_key_mappings()  # Initialize mappings

# Arrow key support
from pynput.keyboard import Key
ARROW_MAPPINGS = {
    Key.left: 0,
    Key.down: 1,
    Key.up: 2,
    Key.right: 3,
}

def beats_to_seconds(beat, bpm_changes_list, initial_bpm):
    """Convert beat position to seconds"""
    if not bpm_changes_list:
        # No BPM changes, simple calculation
        return (beat / initial_bpm) * 60.0
    
    current_time = 0.0
    current_beat = 0.0
    current_bpm = initial_bpm
    
    for change_beat, new_bpm in sorted(bpm_changes_list):
        if beat <= change_beat:
            # Target beat is before this BPM change
            beats_elapsed = beat - current_beat
            current_time += (beats_elapsed / current_bpm) * 60.0
            return current_time
        else: 
            # Add time up to this BPM change
            beats_elapsed = change_beat - current_beat
            current_time += (beats_elapsed / current_bpm) * 60.0
            current_beat = change_beat
            current_bpm = new_bpm
    
    # If we're past all BPM changes
    beats_elapsed = beat - current_beat
    current_time += (beats_elapsed / current_bpm) * 60.0
    return current_time

def get_current_bpm(beat, bpm_changes_list, initial_bpm):
    """Get the BPM at a specific beat"""
    current_bpm = initial_bpm
    for change_beat, new_bpm in sorted(bpm_changes_list):
        if beat >= change_beat:
            current_bpm = new_bpm
        else:
            break
    return current_bpm

def get_current_speed_multiplier(beat, speed_changes_list):
    """Get the speed multiplier at a specific beat (from spd% option)"""
    speed_mult = 1.0
    for change_beat, new_speed in sorted(speed_changes_list):
        if beat >= change_beat:
            speed_mult = new_speed
        else:
            break
    return speed_mult

def seconds_to_beats(seconds, bpm_changes_list, initial_bpm):
    """Convert seconds to beat position (approximate)"""
    if not bpm_changes_list:
        return (seconds * initial_bpm) / 60.0
    
    current_beat = 0.0
    current_time = 0.0
    current_bpm = initial_bpm
    
    for change_beat, new_bpm in sorted(bpm_changes_list):
        change_time = beats_to_seconds(change_beat, bpm_changes_list, initial_bpm)
        if seconds <= change_time:
            time_elapsed = seconds - current_time
            current_beat += (time_elapsed * current_bpm) / 60.0
            return current_beat
        else:
            current_time = change_time
            current_beat = change_beat
            current_bpm = new_bpm
    
    # If we're past all BPM changes
    time_elapsed = seconds - current_time
    current_beat += (time_elapsed * current_bpm) / 60.0
    return current_beat

def calculate_max_score():
    """Calculate the maximum possible score from the chart"""
    global max_possible_score
    max_possible_score = 0
    
    for note in chart:
        if note['type'] == 'tap':
            multiplier = note. get('multiplier', 1)
            max_possible_score += SCORE_PERFECT * multiplier
        elif note['type'] == 'slide':
            multiplier = note.get('multiplier', 1)
            # Score for start
            max_possible_score += SCORE_PERFECT * multiplier
            # Score for each beat held
            beat_duration = note['end_beat'] - note['beat']
            max_possible_score += (SCORE_PERFECT * 0.1 * beat_duration) * multiplier
            # Score for release
            max_possible_score += SCORE_PERFECT * multiplier

def load_chart(id, difficulty):
    global chart, bpm_changes, speed_changes, initial_bpm
    chart_path = f"{CHART_DIRECTORY}/{id}_{difficulty}.txt"
    with open(chart_path, "r") as f:
        lines = f.readlines()

    chart = []
    bpm_changes = []
    speed_changes = []

    is_percent_format = any('%' in line for line in lines)

    if is_percent_format:
        initial_bpm = float(id.split("_")[1])

        # Calculate beat offset for 2-second delay
        # At BPM X: 2 seconds = (2 * X) / 60 beats
        beat_offset = (2.0 * initial_bpm) / 60.0

        slide_starts = {}  # Track slide start positions by lane:  {lane:  (beat, multiplier)}
        last_beat = 0  # Track last beat for BPM changes

        for line in lines:
            if '%' not in line:
                continue

            parts = line.split("%")

            # Check for BPM change first (format: bpm%{new_bpm})
            if parts[0].strip() == "bpm":
                try:
                    new_bpm = float(parts[1].strip())
                    # BPM changes at the last processed beat (with offset)
                    bpm_changes.append((last_beat + beat_offset, new_bpm))
                    continue
                except:
                    pass

            # Check for speed change (format: spd%{percentage})
            if parts[0].strip() == "spd":
                try:
                    speed_percent = float(parts[1].strip())
                    # Speed changes at the last processed beat (with offset)
                    speed_changes.append((last_beat + beat_offset, speed_percent / 100.0))
                    continue
                except:
                    pass

            beat = float(parts[0]) + beat_offset  # Add offset for 2-second delay
            last_beat = beat  # Update last beat
            note_data = parts[1] if len(parts) > 1 else ""

            # Check for BPM change at specific beat (format: {beat}%bpm{new_bpm})
            if note_data.strip().startswith("bpm"):
                # Format: {beat}%bpm{new_bpm}
                try:
                    new_bpm = float(note_data.strip().replace("bpm", "").strip())
                    bpm_changes.append((beat, new_bpm))
                    continue
                except:
                    pass

            # Check for speed change at specific beat (format: {beat}%spd{percentage})
            if note_data.strip().startswith("spd"):
                # Format: {beat}%spd{percentage}
                try:
                    speed_percent = float(note_data.strip().replace("spd", "").strip())
                    speed_changes.append((beat, speed_percent / 100.0))
                    continue
                except:
                    pass

            char_index = 0
            for char in note_data:
                lane = char_index % LANE_COUNT

                if char == "X":
                    # Regular tap note
                    note_time = beats_to_seconds(beat, bpm_changes, initial_bpm)
                    chart.append({
                        'time': note_time,
                        'beat': beat,
                        'lane': lane,
                        'type': 'tap',
                        'multiplier': 1,
                        'id': f"tap_{beat}_{lane}_{random.randint(1000, 9999)}"
                    })

                elif char == "x":
                    # Double score tap note
                    note_time = beats_to_seconds(beat, bpm_changes, initial_bpm)
                    chart.append({
                        'time': note_time,
                        'beat': beat,
                        'lane': lane,
                        'type': 'tap',
                        'multiplier': 2,
                        'id': f"tap_{beat}_{lane}_{random.randint(1000, 9999)}"
                    })

                elif char == "s":
                    # Slide start
                    if lane in slide_starts:
                        print(f"Warning: Overlapping slide starts in lane {lane} at beat {beat}")
                    slide_starts[lane] = (beat, 1)  # Normal slide

                elif char == "S":
                    # Double score slide start (uppercase S)
                    if lane in slide_starts:
                        print(f"Warning: Overlapping slide starts in lane {lane} at beat {beat}")
                    slide_starts[lane] = (beat, 2)  # Double score slide

                elif char == "e":
                    # Slide end
                    if lane in slide_starts:
                        start_beat, multiplier = slide_starts[lane]
                        end_beat = beat
                        start_time = beats_to_seconds(start_beat, bpm_changes, initial_bpm)
                        end_time = beats_to_seconds(end_beat, bpm_changes, initial_bpm)

                        chart.append({
                            'time': start_time,
                            'end_time': end_time,
                            'beat': start_beat,
                            'end_beat': end_beat,
                            'lane': lane,
                            'type': 'slide',
                            'multiplier': multiplier,
                            'id': f"slide_{start_beat}_{lane}_{random.randint(1000, 9999)}"
                        })
                        del slide_starts[lane]
                    else:
                        print(f"Warning: Slide end without start in lane {lane} at beat {beat}")

                char_index += 1

        # Warn about unclosed slides
        for lane, (start_beat, _) in slide_starts.items():
            print(f"Warning: Slide start without end in lane {lane} at beat {start_beat}")
    else:
        initial_bpm = None
        for line in lines:
            line = line.strip()
            if not line or line.startswith("#") or line.startswith("---"):
                continue
            if line.lower().startswith("bpm="):
                try:
                    initial_bpm = float(line.split("=", 1)[1].strip())
                    break
                except Exception:
                    pass

        if initial_bpm is None:
            try:
                initial_bpm = float(id.split("_")[1])
            except Exception:
                initial_bpm = 60

        beat_offset = (2.0 * initial_bpm) / 60.0

        for line in lines:
            line = line.strip()
            if not line or line.startswith("#") or line.startswith("---"):
                continue

            lower = line.lower()
            if lower.startswith("bpm="):
                continue

            if lower.startswith("bpm_change"):
                parts = [p.strip() for p in line.split(",")]
                if len(parts) >= 3:
                    try:
                        beat = float(parts[1]) + beat_offset
                        new_bpm = float(parts[2])
                        bpm_changes.append((beat, new_bpm))
                    except Exception:
                        pass
                continue

            if lower.startswith("spd"):
                parts = [p.strip() for p in line.split(",")]
                if len(parts) >= 3:
                    try:
                        beat = float(parts[1]) + beat_offset
                        mult = float(parts[2])
                        speed_changes.append((beat, mult))
                    except Exception:
                        pass
                continue

            if lower.startswith("tap"):
                parts = [p.strip() for p in line.split(",")]
                if len(parts) >= 3:
                    try:
                        lane = int(parts[1])
                        beat = float(parts[2]) + beat_offset
                        multiplier = 1
                        if len(parts) >= 4 and parts[3].lower().startswith("x"):
                            try:
                                multiplier = int(parts[3][1:])
                            except Exception:
                                multiplier = 1

                        note_time = beats_to_seconds(beat, bpm_changes, initial_bpm)
                        chart.append({
                            'time': note_time,
                            'beat': beat,
                            'lane': lane,
                            'type': 'tap',
                            'multiplier': multiplier,
                            'id': f"tap_{beat}_{lane}_{random.randint(1000, 9999)}"
                        })
                    except Exception:
                        pass
                continue

            if lower.startswith("slide"):
                parts = [p.strip() for p in line.split(",")]
                if len(parts) >= 4:
                    try:
                        lane = int(parts[1])
                        start_beat = float(parts[2]) + beat_offset
                        end_beat = float(parts[3]) + beat_offset
                        multiplier = 1
                        if len(parts) >= 5 and parts[4].lower().startswith("x"):
                            try:
                                multiplier = int(parts[4][1:])
                            except Exception:
                                multiplier = 1

                        start_time = beats_to_seconds(start_beat, bpm_changes, initial_bpm)
                        end_time = beats_to_seconds(end_beat, bpm_changes, initial_bpm)

                        chart.append({
                            'time': start_time,
                            'end_time': end_time,
                            'beat': start_beat,
                            'end_beat': end_beat,
                            'lane': lane,
                            'type': 'slide',
                            'multiplier': multiplier,
                            'id': f"slide_{start_beat}_{lane}_{random.randint(1000, 9999)}"
                        })
                    except Exception:
                        pass
                continue

    chart.sort(key=lambda x: x['time'])
    bpm_changes.sort(key=lambda x: x[0])

    # Calculate max possible score
    calculate_max_score()

def draw_lane_separators():
    """Draw vertical lines separating lanes"""
    for i in range(LANE_COUNT + 1):
        x = LANE_MARGIN + i * LANE_WIDTH
        canvas.create_line(x, 0, x, height, fill='gray', width=2, tags='separator')

def draw_hit_bar():
    """Draw the horizontal bar where notes should be hit"""
    bar_start = LANE_MARGIN
    bar_end = LANE_MARGIN + (LANE_WIDTH * LANE_COUNT)
    canvas.create_rectangle(bar_start, BAR_Y - 5, bar_end, BAR_Y + 5,
                          fill='white', outline='yellow', width=3, tags='hitbar')
    
    # Draw timing zones if enabled
    if settings.get('show_timing_zones', False):
        windows = get_timing_windows()
        # Calculate pixel heights for each timing window
        # Assuming 600 pixels per second scroll speed as base
        base_speed = 600
        
        # Draw zones (from bottom to top: MISS, BAD, GOOD, GREAT, PERFECT)
        zone_colors = {
            'MISS': '#550000',
            'BAD': '#553300', 
            'GOOD': '#555500',
            'GREAT': '#005500',
            'PERFECT': '#005555'
        }
        
        if settings.get('colorblind_mode', False):
            zone_colors = {
                'MISS': '#330000',
                'BAD': '#440044',
                'GOOD': '#442200',
                'GREAT': '#444400',
                'PERFECT': '#004444'
            }
        
        # Draw zones as semi-transparent overlays
        for zone_name in ['MISS', 'BAD', 'GOOD', 'GREAT', 'PERFECT']:
            zone_height = int(windows[zone_name] * base_speed)
            zone_y_start = BAR_Y - zone_height
            zone_y_end = BAR_Y + zone_height
            
            # Draw behind the hit bar
            canvas.create_rectangle(bar_start, zone_y_start, bar_end, zone_y_end,
                                  fill=zone_colors[zone_name], outline='',
                                  tags='timing_zone', stipple='gray25')
    
    # Draw lane indicators at the hit bar
    colors = ['red', 'orange', 'yellow', 'lime', 'cyan', 'blue', 'purple', 'magenta']
    if settings.get('colorblind_mode', False):
        # Colorblind-friendly lane colors
        colors = ['#E69F00', '#56B4E9', '#009E73', '#F0E442', '#0072B2', '#D55E00', '#CC79A7', '#999999']
    
    for i in range(LANE_COUNT):
        x = LANE_MARGIN + i * LANE_WIDTH + LANE_WIDTH // 2
        canvas.create_rectangle(x - 40, BAR_Y - 10, x + 40, BAR_Y + 10,
                              outline=colors[i], width=3, tags='hitbar')

def draw_key_labels():
    """Draw key labels at top of lanes (updates with key presses)"""
    canvas.delete('keylabel')
    colors = ['red', 'orange', 'yellow', 'lime', 'cyan', 'blue', 'purple', 'magenta']
    # Use custom key bindings from settings
    key_labels = [key.upper() for key in settings['key_bindings']]
    for i in range(LANE_COUNT):
        x = LANE_MARGIN + i * LANE_WIDTH + LANE_WIDTH // 2
        # Dim the label if key is pressed
        if key_is_down.get(i, False):
            canvas.create_text(x, 30, text=key_labels[i],
                              fill='#404040', font=('Arial', 36, 'bold'), tags='keylabel')
        else:
            canvas.create_text(x, 30, text=key_labels[i],
                              fill=colors[i], font=('Arial', 36, 'bold'), tags='keylabel')

def draw_note(lane, y_pos, note_id, multiplier=1, simultaneous_lanes=None):
    """Draw a tap note as a white/gold bar"""
    x = LANE_MARGIN + lane * LANE_WIDTH + LANE_WIDTH // 2
    
    # Gold for double score, white for normal
    color = '#FFD700' if multiplier == 2 else 'white'
    outline_color = '#FFA500' if multiplier == 2 else '#CCCCCC'
    
    # Draw gray bars connecting simultaneous notes
    if simultaneous_lanes:
        for other_lane in simultaneous_lanes:
            if other_lane != lane:
                other_x = LANE_MARGIN + other_lane * LANE_WIDTH + LANE_WIDTH // 2
                # Draw thin gray connecting bar
                canvas.create_line(x, y_pos, other_x, y_pos,
                                 fill='gray', width=2, tags=f'note_{note_id}')
    
    # Draw as a horizontal bar
    canvas.create_rectangle(x - NOTE_WIDTH//2, y_pos - NOTE_HEIGHT//2,
                          x + NOTE_WIDTH//2, y_pos + NOTE_HEIGHT//2,
                          fill=color, outline=outline_color, width=3, tags=f'note_{note_id}')

def draw_slide(lane, y_start, y_end, note_id, is_holding=False, multiplier=1):
    """Draw a slide note as a green/gold bar with translucent hold area"""
    x = LANE_MARGIN + lane * LANE_WIDTH + LANE_WIDTH // 2
    
    # Gold for double score, green for normal
    if multiplier == 2:
        bar_color = '#FFD700'
        hold_rgb = (255, 230, 128)  # Light gold with 50% opacity
        outline_color = '#FFA500'
    else: 
        bar_color = '#00FF00' if not is_holding else '#00DD00'
        hold_rgb = (144, 238, 144)  # Light green with 50% opacity
        outline_color = '#00CC00'
    
    # When not holding, draw from hit bar to end marker
    # When holding, draw from start position (locked at hit bar) to end marker
    if not is_holding:
        # Clamp y_start to not go below hit bar
        display_y_start = min(y_start, BAR_Y)
    else:
        display_y_start = y_start
    
    # Draw the translucent hold area with true 50% opacity
    rect_width = NOTE_WIDTH
    if y_end < display_y_start:
        rect_height = int(display_y_start - y_end)
        rect_y = int(y_end)
    else:
        rect_height = int(y_end - display_y_start)
        rect_y = int(display_y_start)
    
    if rect_height > 0 and rect_width > 0:
        # Create semi-transparent image
        img = Image.new('RGBA', (rect_width, rect_height), (*hold_rgb, 128))  # 128 = 50% opacity
        photo = ImageTk.PhotoImage(img)
        canvas.create_image(x, rect_y + rect_height // 2, image=photo, tags=f'note_{note_id}')
        # Keep reference to prevent garbage collection
        if not hasattr(canvas, '_slide_images'):
            canvas._slide_images = {}
        canvas._slide_images[note_id] = photo
    
    # Draw start marker (thick bar) - ONLY if not being held AND above hit bar
    if not is_holding and y_start < BAR_Y:
        canvas.create_rectangle(x - NOTE_WIDTH//2, y_start - NOTE_HEIGHT//2,
                              x + NOTE_WIDTH//2, y_start + NOTE_HEIGHT//2,
                              fill=bar_color, outline=outline_color, width=3, tags=f'note_{note_id}')
    
    # If holding, draw a marker at the hit bar
    if is_holding:
        canvas.create_rectangle(x - NOTE_WIDTH//2, int(BAR_Y) - NOTE_HEIGHT//2,
                              x + NOTE_WIDTH//2, int(BAR_Y) + NOTE_HEIGHT//2,
                              fill=bar_color, outline=outline_color, width=3, tags=f'note_{note_id}')
    
    # Draw end marker (thick bar)
    canvas.create_rectangle(x - NOTE_WIDTH//2, y_end - NOTE_HEIGHT//2,
                          x + NOTE_WIDTH//2, y_end + NOTE_HEIGHT//2,
                          fill=bar_color, outline=outline_color, width=3, tags=f'note_{note_id}')

def show_judgment(judgment, offset_ms=None, auto_miss=False):
    """Display judgment text for 400ms with optional offset and LATE/EARLY indicators"""
    global judgment_display
    
    # Get colors based on settings
    if settings.get('colorblind_mode', False):
        # Colorblind-friendly colors
        colors = {
            'PERFECT': '#00D9FF',  # Bright cyan
            'GREAT': '#FFD700',    # Gold
            'GOOD': '#FF6B35',     # Orange-red
            'BAD': '#A020F0',      # Purple
            'MISS': '#FF1744'      # Deep red
        }
    elif settings.get('high_contrast_mode', False):
        # High contrast colors
        colors = {
            'PERFECT': 'white',
            'GREAT': 'yellow',
            'GOOD': 'orange',
            'BAD': 'red',
            'MISS': 'red'
        }
    else:
        # Default colors
        colors = {
            'PERFECT': 'cyan',
            'GREAT': 'lime',
            'GOOD': 'yellow',
            'BAD': 'orange',
            'MISS': 'red'
        }
    
    # Add offset display and LATE/EARLY indicators
    display_text = judgment
    if judgment == 'MISS' and auto_miss:
        display_text = "MISS (N/A)"
    elif offset_ms is not None:
        # Add LATE/EARLY indicators for PERFECT and GREAT
        if settings.get('show_late_early', True) and judgment in ['PERFECT', 'GREAT']:
            if offset_ms > 5:  # More than 5ms late
                late_early = " LATE"
            elif offset_ms < -5:  # More than 5ms early
                late_early = " EARLY"
            else:
                late_early = ""
            display_text = f"{judgment}{late_early} ({offset_ms:+.0f}ms)"
        else:
            display_text = f"{judgment} ({offset_ms:+.0f}ms)"
    
    end_time = time.time() + 0.4  # 400ms
    judgment_display = (display_text, end_time, colors.get(judgment, 'white'))

def spawn_particle(lane, judgment):
    """Spawn a hit particle effect at the hit bar in the given lane"""
    global active_particles
    
    colors = {
        'PERFECT': 'cyan',
        'GREAT': 'lime',
        'GOOD': 'yellow',
        'BAD': 'orange',
        'MISS': 'red'
    }
    
    x = LANE_MARGIN + lane * LANE_WIDTH + LANE_WIDTH // 2
    y = BAR_Y
    color = colors.get(judgment, 'white')
    end_time = time.time() + 0.3  # 300ms lifetime
    
    # Create particle as (x, y, initial_size, color, end_time, spawn_time)
    active_particles.append((x, y, 20, color, end_time, time.time()))

def draw_particles():
    """Draw all active particles with expanding/fading animation"""
    current_time = time.time()
    particles_to_remove = []
    
    for i, particle in enumerate(active_particles):
        x, y, initial_size, color, end_time, spawn_time = particle
        
        if current_time >= end_time:
            particles_to_remove.append(i)
            continue
        
        # Calculate animation progress (0.0 to 1.0)
        progress = (current_time - spawn_time) / 0.3
        
        # Expand size over time
        size = int(initial_size + (60 * progress))
        
        # Calculate opacity (fade out)
        opacity = int(255 * (1.0 - progress))
        
        # Draw particle as expanding circle
        # Use stipple pattern to simulate transparency (tkinter limitation)
        stipple_patterns = ['', 'gray75', 'gray50', 'gray25']
        stipple_index = min(int(progress * 4), 3)
        stipple = stipple_patterns[stipple_index]
        
        if stipple:
            canvas.create_oval(x - size, y - size, x + size, y + size,
                             outline=color, width=2, fill='', 
                             stipple=stipple, tags='particle')
        else:
            canvas.create_oval(x - size, y - size, x + size, y + size,
                             outline=color, width=2, fill='',
                             tags='particle')
    
    # Remove expired particles
    for i in reversed(particles_to_remove):
        active_particles.pop(i)

def calculate_accuracy():
    """Calculate current accuracy percentage"""
    total_notes_hit = perfect_count + great_count + good_count + bad_count
    if total_notes_hit == 0:
        return 100.0
    
    # Formula: (perfect*100 + great*70 + good*40 + bad*10) / (total notes hit * 100)
    weighted_score = (perfect_count * 100 + great_count * 70 + 
                     good_count * 40 + bad_count * 10)
    accuracy = weighted_score / (total_notes_hit * 100.0)
    return accuracy * 100.0

def judge_timing(time_diff):
    """Return judgment, score, and offset in ms based on timing difference"""
    global perfect_count, great_count, good_count, bad_count, miss_count
    
    # Get timing windows from settings
    windows = get_timing_windows()
    
    abs_diff = abs(time_diff)
    offset_ms = time_diff * 1000  # Convert to ms
    
    if abs_diff <= windows['PERFECT']:
        perfect_count += 1
        return 'PERFECT', SCORE_PERFECT, offset_ms
    elif abs_diff <= windows['GREAT']:
        great_count += 1
        return 'GREAT', SCORE_GREAT, offset_ms
    elif abs_diff <= windows['GOOD']: 
        good_count += 1
        return 'GOOD', SCORE_GOOD, offset_ms
    elif abs_diff <= windows['BAD']:
        bad_count += 1
        return 'BAD', SCORE_BAD, offset_ms
    else:
        miss_count += 1
        return 'MISS', SCORE_MISS, offset_ms

def check_hit(lane, current_time):
    """Check if a note was hit in the lane"""
    global score, combo, max_combo, active_notes, active_slides
    
    hit = False
    best_note = None
    best_diff = float('inf')
    
    # Check tap notes
    for note in active_notes[: ]:
        if note['lane'] == lane and note['type'] == 'tap':
            time_diff = current_time - note['time']
            abs_diff = abs(time_diff)
            
            if abs_diff <= TIMING_MISS and abs_diff < best_diff: 
                best_diff = abs_diff
                best_note = note
    
    if best_note:
        judgment, points, offset_ms = judge_timing(best_diff)
        multiplier = best_note. get('multiplier', 1)
        
        if judgment != 'MISS':
            score += points * multiplier
            combo += 1
            max_combo = max(max_combo, combo)
            hit = True
        else:
            combo = 0
        
        # Mark for deletion (will be deleted by main thread)
        best_note['hit'] = True
        best_note['judgment'] = judgment
        show_judgment(judgment, offset_ms)
        spawn_particle(lane, judgment)  # Add particle effect
        return hit
    
    # Check slide notes
    for slide in active_slides[:]:
        if slide['lane'] == lane: 
            # Check if we're at the start of the slide
            if not slide. get('holding', False):
                time_diff = current_time - slide['time']
                abs_diff = abs(time_diff)
                
                if abs_diff <= TIMING_MISS: 
                    judgment, points, offset_ms = judge_timing(abs_diff)
                    multiplier = slide.get('multiplier', 1)
                    
                    if judgment != 'MISS':
                        slide['holding'] = True
                        slide['hit_start'] = True
                        slide['last_beat_combo'] = slide['beat']
                        score += points * multiplier
                        combo += 1
                        max_combo = max(max_combo, combo)
                        show_judgment(judgment, offset_ms)
                        spawn_particle(lane, judgment)  # Add particle effect
                        hit = True
                    else: 
                        combo = 0
                        slide['hit'] = True  # Mark for deletion
                        show_judgment('MISS')
                        spawn_particle(lane, 'MISS')  # Add particle effect for miss
    
    return hit

def update_slide_combo(current_time):
    """Update combo for slides being held - +1 per beat, awards 1/10 of perfect score OR register miss"""
    global combo, max_combo, score, miss_count
    
    for slide in active_slides[:]: 
        # Only process slides that have been started
        if slide.get('hit_start', False):
            # Calculate current beat
            current_beat = seconds_to_beats(current_time, bpm_changes, initial_bpm)
            multiplier = slide.get('multiplier', 1)
            
            # Initialize next_tick on first call
            if 'next_tick' not in slide:
                slide['next_tick'] = slide['beat'] + 1.0
            
            # Check if we've passed the next beat tick
            while current_beat >= slide['next_tick'] and slide['next_tick'] <= slide['end_beat']:
                if slide.get('holding', False):
                    # Award score for holding correctly
                    combo += 1
                    max_combo = max(max_combo, combo)
                    # Award 1/10 of perfect score per beat
                    score += int(SCORE_PERFECT * 0.1 * multiplier)
                    slide['next_tick'] += 1.0
                else:
                    # Only register miss if we haven't reached the end yet
                    # Don't mark slides for removal if they're past all beat ticks but before end time
                    if current_time < slide['end_time']:
                        # Released too early during the slide
                        combo = 0
                        miss_count += 1
                        show_judgment('MISS')
                        slide['remove'] = True  # Mark for deletion
                    break  # Stop processing this slide

def check_slide_hold(lane, current_time, is_holding):
    """Check if a slide is being held correctly"""
    global score, combo, max_combo, active_slides, miss_count
    
    for slide in active_slides[: ]:
        if slide['lane'] == lane and slide. get('holding', False):
            if not is_holding:
                # Released the key
                if current_time >= slide['end_time']:
                    # Slide completed successfully! 
                    time_diff = current_time - slide['end_time']
                    judgment, points, offset_ms = judge_timing(time_diff)
                    multiplier = slide.get('multiplier', 1)
                    score += points * multiplier
                    combo += 1
                    max_combo = max(max_combo, combo)
                    slide['remove'] = True  # Mark for removal
                    show_judgment(judgment, offset_ms)
                    spawn_particle(lane, judgment)  # Add particle effect
                else:
                    # Released too early
                    combo = 0
                    miss_count += 1
                    slide['remove'] = True  # Mark for removal
                    show_judgment('MISS')
                    spawn_particle(lane, 'MISS')  # Add particle effect

def on_press(key):
    """Handle key press - only register if key wasn't already down"""
    global key_pressed_flags, key_is_down, game_running
    
    print(f"DEBUG on_press: key={key}, game_running={game_running}")
    
    if key == Key. esc:
        game_running = False
        root.quit()
        return False
    
    # Get lane from key
    lane = None
    try:
        if hasattr(key, 'char') and key.char in KEY_MAPPINGS:
            lane = KEY_MAPPINGS[key.char]
    except:
        pass
    
    if lane is None and key in ARROW_MAPPINGS:
        lane = ARROW_MAPPINGS[key]
    
    if lane is not None:
        # Only register as a new press if the key wasn't already down
        if not key_is_down[lane]:
            key_is_down[lane] = True
            key_pressed_flags[lane] = True
            # Record in replay (only if not currently replaying)
            if not is_replay and game_running:
                current_time = time.time() - start_time
                replay_data.append((current_time, 'press', lane))
            check_hit(lane, time.time() - start_time)

def on_release(key):
    """Handle key release"""
    global key_pressed_flags, key_is_down
    
    print(f"DEBUG: Key released: {key}")
    
    # Get lane from key
    lane = None
    try:
        if hasattr(key, 'char') and key.char in KEY_MAPPINGS:
            lane = KEY_MAPPINGS[key.char]
    except:
        pass
    
    if lane is None and key in ARROW_MAPPINGS:
        lane = ARROW_MAPPINGS[key]
    
    if lane is not None:
        key_is_down[lane] = False
        key_pressed_flags[lane] = False
        # Record in replay (only if not currently replaying)
        if not is_replay and game_running:
            current_time = time.time() - start_time
            replay_data.append((current_time, 'release', lane))
        # Check if we released during a slide
        check_slide_hold(lane, time.time() - start_time, False)

def on_tkinter_press(event):
    """Handle tkinter key press events during gameplay"""
    global key_pressed_flags, key_is_down, game_running
    global practice_speed, practice_loop_start, practice_loop_end, practice_looping
    
    print(f"DEBUG tkinter_press: keysym={event.keysym}, char={event.char}, game_running={game_running}")
    
    if event.keysym == 'Escape':
        game_running = False
        return
    
    # Practice mode controls
    if game_mode == 'practice':
        if event.char == '[':
            # Set loop start
            current_time = time.time() - start_time
            practice_loop_start = current_time
            print(f"Practice loop start set at {current_time:.2f}s")
            return
        elif event.char == ']':
            # Set loop end
            current_time = time.time() - start_time
            practice_loop_end = current_time
            print(f"Practice loop end set at {current_time:.2f}s")
            return
        elif event.char and event.char.lower() == 'l':
            # Toggle looping
            practice_looping = not practice_looping
            print(f"Practice looping: {practice_looping}")
            return
        elif event.char == '-':
            # Decrease speed
            practice_speed = max(0.25, practice_speed - 0.25)
            print(f"Practice speed: {practice_speed:.2f}x")
            return
        elif event.char == '=':
            # Increase speed
            practice_speed = min(2.0, practice_speed + 0.25)
            print(f"Practice speed: {practice_speed:.2f}x")
            return
    
    # Get lane from key
    lane = None
    if event.char and event.char.lower() in KEY_MAPPINGS:
        lane = KEY_MAPPINGS[event.char.lower()]
    
    if lane is not None:
        key_is_down[lane] = True
        if not is_replay and game_running and game_mode != 'auto':
            if not key_pressed_flags[lane]:
                key_pressed_flags[lane] = True
                current_time = time.time() - start_time
                replay_data.append((current_time, 'press', lane))
                check_hit(lane, current_time)

def on_tkinter_release(event):
    """Handle tkinter key release events during gameplay"""
    global key_pressed_flags, key_is_down, game_running
    
    print(f"DEBUG tkinter_release: keysym={event.keysym}, char={event.char}")
    
    # Get lane from key
    lane = None
    if event.char and event.char.lower() in KEY_MAPPINGS:
        lane = KEY_MAPPINGS[event.char.lower()]
    
    if lane is not None:
        key_pressed_flags[lane] = False
        key_is_down[lane] = False
        if not is_replay and game_running and game_mode != 'auto':
            current_time = time.time() - start_time
            replay_data.append((current_time, 'release', lane))
            check_slide_hold(lane, current_time, False)

def get_rank(score, max_score):
    """Calculate rank based on percentage of max possible score"""
    if max_score == 0:
        return 'D'
    
    percentage = score / max_score
    
    if percentage >= RANK_S:
        return 'S'
    elif percentage >= RANK_A:
        return 'A'
    elif percentage >= RANK_B:
        return 'B'
    elif percentage >= RANK_C: 
        return 'C'
    else:
        return 'D'

def get_rank_color(rank):
    """Get color for rank display"""
    colors = {
        'S': '#FFD700',  # Gold
        'A': '#00FF00',  # Green
        'B': '#00BFFF',  # Blue
        'C': '#FFA500',  # Orange
        'D': '#FF0000'   # Red
    }
    return colors.get(rank, 'white')

def draw_ui():
    """Draw score bar, accuracy, combo, and judgment"""
    canvas.delete('ui')
    canvas.delete('particle')  # Clear old particles
    draw_key_labels()  # Update key press feedback
    draw_particles()  # Draw active particles
    
    # Left margin - Score, Accuracy, and Score Bar
    left_x = 50
    
    # Score at top left
    canvas.create_text(left_x, 30, text=f"Score: {score}",
                      fill='white', font=('Arial', 24, 'bold'), tags='ui', anchor='w')
    
    # Accuracy percentage at top left (below score)
    accuracy = calculate_accuracy()
    canvas.create_text(left_x, 65, text=f"Accuracy: {accuracy:.2f}%",
                      fill='cyan', font=('Arial', 20, 'bold'), tags='ui', anchor='w')
    
    # Vertical Score Bar (shows progress towards ranks)
    bar_x = left_x + 10
    bar_y_top = 120
    bar_height = 400
    bar_width = 30
    
    # Background bar
    canvas.create_rectangle(bar_x, bar_y_top, bar_x + bar_width, bar_y_top + bar_height,
                           fill='#222222', outline='white', width=2, tags='ui')
    
    # Calculate score percentage
    score_percentage = min(1.0, score / max_possible_score) if max_possible_score > 0 else 0
    
    # Fill bar based on score
    fill_height = int(bar_height * score_percentage)
    if fill_height > 0:
        # Color based on current rank
        if score_percentage >= RANK_S:
            fill_color = '#FFD700'  # Gold
        elif score_percentage >= RANK_A:
            fill_color = '#00FF00'  # Green
        elif score_percentage >= RANK_B:
            fill_color = '#00BFFF'  # Blue
        elif score_percentage >= RANK_C:
            fill_color = '#FFA500'  # Orange
        else:
            fill_color = '#FF4500'  # Red
        
        canvas.create_rectangle(bar_x, bar_y_top + bar_height - fill_height,
                               bar_x + bar_width, bar_y_top + bar_height,
                               fill=fill_color, outline='', tags='ui')
    
    # Draw rank threshold lines
    rank_thresholds = [
        (RANK_S, 'S', '#FFD700'),
        (RANK_A, 'A', '#00FF00'),
        (RANK_B, 'B', '#00BFFF'),
        (RANK_C, 'C', '#FFA500'),
    ]
    
    for threshold, label, color in rank_thresholds:
        y = bar_y_top + bar_height - int(bar_height * threshold)
        canvas.create_line(bar_x, y, bar_x + bar_width, y,
                          fill=color, width=2, tags='ui')
        canvas.create_text(bar_x + bar_width + 5, y, text=label,
                          fill=color, font=('Arial', 14, 'bold'), tags='ui', anchor='w')
    
    # Right margin - Combo and Auto Play text
    right_x = width - 50
    
    # Combo counter at top right
    if combo > 0:
        canvas.create_text(right_x, 30, text=f"{combo}",
                          fill='yellow', font=('Arial', 48, 'bold'), tags='ui', anchor='e')
        canvas.create_text(right_x, 75, text="COMBO",
                          fill='yellow', font=('Arial', 20, 'bold'), tags='ui', anchor='e')
    
    # Draw judgment display (centered at top)
    if judgment_display:
        judgment_text, end_time, color = judgment_display
        if time.time() < end_time:
            canvas.create_text(width // 2, 100, text=judgment_text,
                             fill=color, font=('Arial', 48, 'bold'), tags='ui')
    
    # Watermarks for special modes (right margin)
    if game_mode == 'auto':
        canvas.create_text(right_x, 150, text="AUTO PLAY",
                         fill='#666666', font=('Arial', 32, 'bold'), tags='ui', anchor='e')
    elif game_mode == 'practice':
        practice_text = f"PRACTICE MODE\nSpeed: {practice_speed:.2f}x"
        if practice_looping and practice_loop_start is not None and practice_loop_end is not None:
            practice_text += "\n[LOOP]"
        canvas.create_text(right_x, 150, text=practice_text,
                         fill='#666666', font=('Arial', 24, 'bold'), tags='ui', anchor='e')
        # Show controls
        canvas.create_text(width // 2, height - 70, 
                         text="[ = Loop Start  |  ] = Loop End  |  L = Toggle Loop  |  - = Slower  |  + = Faster",
                         fill='#555555', font=('Arial', 14), tags='ui')

def get_pixel_speed(current_beat):
    """Get the current pixel speed based on BPM, spd% changes, and global multiplier"""
    current_bpm = get_current_bpm(current_beat, bpm_changes, initial_bpm)
    speed_mult = get_current_speed_multiplier(current_beat, speed_changes)
    global_mult = settings['scroll_speed_multiplier']
    return current_bpm * 10 * speed_mult * global_mult

def update_notes(current_time):
    """Update note positions and spawn new notes"""
    global active_notes, active_slides, chart, combo
    
    # Calculate current beat for pixel speed
    current_beat = seconds_to_beats(current_time, bpm_changes, initial_bpm)
    pixel_ps = get_pixel_speed(current_beat)
    while chart and chart[0]['time'] <= current_time + 2:
        note = chart.pop(0)
        if note['type'] == 'tap':
            active_notes.append(note)
        elif note['type'] == 'slide':
            active_slides. append(note)
    
    # Update and draw tap notes
    for note in active_notes[:]:
        # Remove hit notes
        if note.get('hit', False):
            canvas.delete(f"note_{note['id']}")
            active_notes.remove(note)
            continue
            
        y_pos = BAR_Y - ((note['time'] - current_time) * pixel_ps)
        
        if y_pos > height + 100:
            canvas.delete(f"note_{note['id']}")
            active_notes.remove(note)
            combo = 0
            global miss_count
            miss_count += 1
            show_judgment('MISS', auto_miss=True)
        elif 0 <= y_pos <= height:
            canvas.delete(f"note_{note['id']}")
            # Check for simultaneous notes
            simultaneous_lanes = []
            for other_note in active_notes:
                if other_note != note and other_note.get('type') == 'tap':
                    if abs(other_note['time'] - note['time']) < 0.01:  # Within 10ms
                        simultaneous_lanes.append(other_note['lane'])
            draw_note(note['lane'], int(y_pos), note['id'], note. get('multiplier', 1), simultaneous_lanes if simultaneous_lanes else None)
    
    # Update and draw slide notes
    for slide in active_slides[:]:
        # Remove marked slides
        if slide.get('remove', False):
            canvas.delete(f"note_{slide['id']}")
            # Clean up image reference
            if hasattr(canvas, '_slide_images') and slide['id'] in canvas._slide_images:
                del canvas._slide_images[slide['id']]
            active_slides.remove(slide)
            continue
        
        # Calculate pixel speed based on slide's beat position
        slide_pixel_ps = get_pixel_speed(slide['beat'])
            
        # If slide is being held, lock the start position to the hit bar
        if slide.get('holding', False):
            y_start = int(BAR_Y)
            y_end = BAR_Y - ((slide['end_time'] - current_time) * slide_pixel_ps)
        else:
            y_start = BAR_Y - ((slide['time'] - current_time) * slide_pixel_ps)
            y_end = BAR_Y - ((slide['end_time'] - current_time) * slide_pixel_ps)
        
        # Check if slide is complete
        if slide.get('holding', False) and current_time >= slide['end_time']:
            # Auto-complete if still holding at the end
            if key_is_down[slide['lane']]: 
                check_slide_hold(slide['lane'], current_time, False)
            # If already marked for removal after auto-complete, skip to next iteration
            if slide.get('remove', False):
                continue
        
        # Remove unhit slides that scrolled past
        if not slide.get('holding', False) and not slide.get('hit_start', False) and y_start > height + 100:
            canvas.delete(f"note_{slide['id']}")
            if hasattr(canvas, '_slide_images') and slide['id'] in canvas._slide_images:
                del canvas._slide_images[slide['id']]
            active_slides.remove(slide)
            combo = 0
            miss_count += 1
            show_judgment('MISS', auto_miss=True)
            continue
        
        # Always redraw if holding, OR if any part is visible on screen, OR if slide was just completed (has remove flag but not yet removed)
        # This ensures the final state is drawn before removal
        if slide.get('holding', False) or (0 <= y_start <= height or 0 <= y_end <= height) or slide.get('remove', False):
            canvas.delete(f"note_{slide['id']}")
            if hasattr(canvas, '_slide_images') and slide['id'] in canvas._slide_images:
                del canvas._slide_images[slide['id']]
            draw_slide(slide['lane'], int(y_start), int(y_end), slide['id'],
                      slide.get('holding', False), slide.get('multiplier', 1))

def save_replay(chart_id, difficulty, score, accuracy, inputs, rank):
    """Save replay data to file in JSON format"""
    import json
    from datetime import datetime
    
    # Create replays directory if it doesn't exist
    replay_dir = os.path.join(os.path.dirname(__file__), "replays")
    os.makedirs(replay_dir, exist_ok=True)
    
    # Generate filename with timestamp
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"{chart_id}_{difficulty}_{timestamp}.replay"
    filepath = os.path.join(replay_dir, filename)
    
    # Prepare replay data
    replay_info = {
        "chart_id": chart_id,
        "difficulty": difficulty,
        "score": score,
        "accuracy": accuracy,
        "rank": rank,
        "max_combo": max_combo,
        "perfect": perfect_count,
        "great": great_count,
        "good": good_count,
        "bad": bad_count,
        "miss": miss_count,
        "timestamp": timestamp,
        "inputs": inputs  # List of (time, event_type, lane) tuples
    }
    
    try:
        with open(filepath, 'w') as f:
            json.dump(replay_info, f, indent=2)
        print(f"Replay saved to {filepath}")
    except Exception as e:
        print(f"Error saving replay: {e}")

def load_progress():
    """Load progress data from file"""
    import json
    
    progress_file = os.path.join(os.path.dirname(__file__), "progress.json")
    if not os.path.exists(progress_file):
        # Create default progress file
        default_progress = {
            "username": "Player",
            "total_charts_played": 0,
            "total_score": 0,
            "total_playtime_seconds": 0,
            "total_perfects": 0,
            "total_greats": 0,
            "total_goods": 0,
            "total_bads": 0,
            "total_misses": 0,
            "best_scores": {},
            "recently_played": [],
            "achievements": {}
        }
        try:
            with open(progress_file, 'w') as f:
                json.dump(default_progress, f, indent=2)
        except:
            pass
        return default_progress
    
    try:
        with open(progress_file, 'r') as f:
            return json.load(f)
    except Exception as e:
        print(f"Error loading progress: {e}")
        return None

def save_progress_data(progress):
    """Save progress data to file"""
    import json
    
    progress_file = os.path.join(os.path.dirname(__file__), "progress.json")
    try:
        with open(progress_file, 'w') as f:
            json.dump(progress, f, indent=2)
        print(f"Progress saved")
    except Exception as e:
        print(f"Error saving progress: {e}")

def update_progress(chart_id, difficulty, score, rank, accuracy, playtime_seconds):
    """Update progress after completing a chart"""
    from datetime import datetime
    
    progress = load_progress()
    if not progress:
        return
    
    # Update totals
    progress['total_charts_played'] += 1
    progress['total_score'] += score
    progress['total_playtime_seconds'] += int(playtime_seconds)
    progress['total_perfects'] += perfect_count
    progress['total_greats'] += great_count
    progress['total_goods'] += good_count
    progress['total_bads'] += bad_count
    progress['total_misses'] += miss_count
    
    # Update best score for this chart/difficulty
    chart_key = f"{chart_id}_{difficulty}"
    if 'best_scores' not in progress:
        progress['best_scores'] = {}
    
    if chart_key not in progress['best_scores'] or score > progress['best_scores'][chart_key].get('score', 0):
        progress['best_scores'][chart_key] = {
            'score': score,
            'rank': rank,
            'accuracy': accuracy,
            'max_combo': max_combo,
            'timestamp': datetime.now().strftime("%Y%m%d_%H%M%S")
        }
    
    # Update recently played (keep last 10)
    if 'recently_played' not in progress:
        progress['recently_played'] = []
    
    recent_entry = {
        'chart_id': chart_id,
        'difficulty': difficulty,
        'score': score,
        'rank': rank,
        'timestamp': datetime.now().strftime("%Y%m%d_%H%M%S")
    }
    
    # Remove if already in list
    progress['recently_played'] = [r for r in progress['recently_played'] 
                                   if not (r['chart_id'] == chart_id and r['difficulty'] == difficulty)]
    
    # Add to front
    progress['recently_played'].insert(0, recent_entry)
    
    # Keep only last 10
    progress['recently_played'] = progress['recently_played'][:10]
    
    # Check for achievements
    if 'achievements' not in progress:
        progress['achievements'] = {}
    
    # Achievement: First clear
    if 'first_clear' not in progress['achievements']:
        progress['achievements']['first_clear'] = {
            'name': 'First Clear',
            'description': 'Complete your first chart',
            'unlocked': datetime.now().strftime("%Y%m%d_%H%M%S")
        }
    
    # Achievement: 10 charts played
    if progress['total_charts_played'] >= 10 and '10_charts' not in progress['achievements']:
        progress['achievements']['10_charts'] = {
            'name': '10 Charts',
            'description': 'Play 10 charts',
            'unlocked': datetime.now().strftime("%Y%m%d_%H%M%S")
        }
    
    # Achievement: First S rank
    if rank == 'S' and 's_rank' not in progress['achievements']:
        progress['achievements']['s_rank'] = {
            'name': 'S Rank',
            'description': 'Achieve an S rank',
            'unlocked': datetime.now().strftime("%Y%m%d_%H%M%S")
        }
    
    # Achievement: Full combo
    if miss_count == 0 and (perfect_count + great_count + good_count + bad_count) > 0:
        if 'full_combo' not in progress['achievements']:
            progress['achievements']['full_combo'] = {
                'name': 'Full Combo',
                'description': 'Complete a chart with no misses',
                'unlocked': datetime.now().strftime("%Y%m%d_%H%M%S")
            }
    
    # Achievement: All perfect
    total_notes = perfect_count + great_count + good_count + bad_count + miss_count
    if perfect_count == total_notes and perfect_count > 0:
        if 'all_perfect' not in progress['achievements']:
            progress['achievements']['all_perfect'] = {
                'name': 'All Perfect',
                'description': 'Complete a chart with all perfect hits',
                'unlocked': datetime.now().strftime("%Y%m%d_%H%M%S")
            }
    
    save_progress_data(progress)
    return progress

def load_replay_file(filepath):
    """Load replay data from file"""
    import json
    
    try:
        with open(filepath, 'r') as f:
            return json.load(f)
    except Exception as e:
        print(f"Error loading replay: {e}")
        return None

def get_available_replays():
    """Scan replays directory and return list of replay files"""
    replay_dir = os.path.join(os.path.dirname(__file__), "replays")
    if not os.path.exists(replay_dir):
        return []
    
    replays = []
    for filename in os.listdir(replay_dir):
        if filename.endswith('.replay'):
            filepath = os.path.join(replay_dir, filename)
            replay_data = load_replay_file(filepath)
            if replay_data:
                replays.append({
                    'filename': filename,
                    'filepath': filepath,
                    'data': replay_data
                })
    
    # Sort by timestamp (newest first)
    replays.sort(key=lambda x: x['data'].get('timestamp', ''), reverse=True)
    return replays

def auto_play_ai(current_time):
    """AI that plays notes perfectly in auto mode - directly scores without simulating keypresses"""
    global score, combo, max_combo, perfect_count
    
    # Auto-hit tap notes - wider window to catch high-BPM notes
    for note in active_notes[:]:
        if note['type'] == 'tap' and not note.get('hit', False):
            time_diff = current_time - note['time']
            # Expanded window: catch notes slightly before and well after their time
            # This ensures we don't miss any notes at high BPM (e.g., 250 BPM)
            if -0.05 <= time_diff <= (2.0 / fps):
                # Award perfect score directly
                multiplier = note.get('multiplier', 1)
                score += SCORE_PERFECT * multiplier
                combo += 1
                max_combo = max(max_combo, combo)
                perfect_count += 1
                note['hit'] = True
                show_judgment('PERFECT', 0.0)
                spawn_particle(note['lane'], 'PERFECT')
    
    # Auto-hit and hold slides
    for slide in active_slides[:]:
        # Start slide at perfect timing
        if not slide.get('hit_start', False):
            time_diff = current_time - slide['time']
            # Expanded window for slides too
            if -0.05 <= time_diff <= (2.0 / fps):
                # Start the slide with perfect timing
                multiplier = slide.get('multiplier', 1)
                score += SCORE_PERFECT * multiplier
                combo += 1
                max_combo = max(max_combo, combo)
                perfect_count += 1
                slide['hit_start'] = True
                slide['holding'] = True
                slide['next_tick'] = slide['beat'] + 1.0
                show_judgment('PERFECT', 0.0)
                spawn_particle(slide['lane'], 'PERFECT')
        
        # Auto-complete slide at end
        if slide.get('holding', False) and not slide.get('auto_completed', False):
            time_diff = current_time - slide['end_time']
            # Use same expanded window for slide completion
            if -0.05 <= time_diff <= (2.0 / fps):
                # Complete the slide with perfect timing
                multiplier = slide.get('multiplier', 1)
                score += SCORE_PERFECT * multiplier
                combo += 1
                max_combo = max(max_combo, combo)
                perfect_count += 1
                slide['auto_completed'] = True
                slide['remove'] = True
                show_judgment('PERFECT', 0.0)
                spawn_particle(slide['lane'], 'PERFECT')

def game_loop():
    """Main game loop"""
    global start_time, game_running, chart, music_playing, active_particles
    global score, combo, max_combo, perfect_count, great_count, good_count, bad_count, miss_count
    global active_notes, active_slides, key_pressed_flags, key_is_down
    
    # Reset all game state
    active_particles = []
    active_notes = []
    active_slides = []
    score = 0
    combo = 0
    max_combo = 0
    perfect_count = 0
    great_count = 0
    good_count = 0
    bad_count = 0
    miss_count = 0
    
    # Reset key states
    for i in range(LANE_COUNT):
        key_pressed_flags[i] = False
        key_is_down[i] = False
    
    # Start music if available
    if AUDIO_AVAILABLE and current_chart_id and current_difficulty:
        music_file = f"{CHART_DIRECTORY}/{current_chart_id}_{current_difficulty}.mp3"
        if os.path.exists(music_file):
            try:
                pygame.mixer.init()
                pygame.mixer.music.load(music_file)
                pygame.mixer.music.play()
                music_playing = True
            except Exception as e:
                print(f"Could not play music: {e}")
    
    frame_dur = 1 / fps
    # Set start_time 2 seconds in the future so current_time starts at -2.0
    # This gives a 2 second delay before notes start spawning
    start_time = time.time() + 2.0
    game_running = True
    
    # Draw static elements
    draw_lane_separators()
    draw_hit_bar()
    draw_key_labels()  # Initial key labels
    
    # Continue while there are notes/slides to process OR slides being held
    while game_running and (chart or active_notes or active_slides):
        frame_start = time.time()
        current_time = frame_start - start_time
        
        # Practice mode loop check
        if game_mode == 'practice' and practice_looping:
            if practice_loop_start is not None and practice_loop_end is not None:
                if current_time >= practice_loop_end:
                    # Loop back to start
                    # This is simplified - ideally we'd reset all game state
                    start_time += (practice_loop_end - practice_loop_start)
                    current_time = practice_loop_start
        
        # Auto-play AI
        if game_mode == 'auto':
            auto_play_ai(current_time)
        
        # Check slide holds for currently pressed keys (normal gameplay)
        if game_mode != 'auto':
            for lane in range(LANE_COUNT):
                if key_is_down.get(lane, False):
                    check_slide_hold(lane, current_time, True)
        
        # Update slide combo (awards score per beat for held slides)
        update_slide_combo(current_time)
        
        # Clear dynamic elements
        canvas.delete('note')
        
        # Update game state
        update_notes(current_time)
        draw_ui()
        
        # Maintain frame rate
        elapsed = time.time() - frame_start
        sleep_time = max(0, frame_dur - elapsed)
        time.sleep(sleep_time)
        
        root.update()
    
    # Delay after last note
    time.sleep(0.5)
    
    # Calculate rank
    rank = get_rank(score, max_possible_score)
    rank_color = get_rank_color(rank)
    percentage = (score / max_possible_score * 100) if max_possible_score > 0 else 0
    
    # Stop music
    if AUDIO_AVAILABLE and music_playing:
        pygame.mixer.music.stop()
    
    # Achievement display
    achievements = []
    all_perfect = perfect_count == (perfect_count + great_count + good_count + bad_count + miss_count) and perfect_count > 0
    
    if all_perfect:
        achievements.append(("ALL PERFECT!", "#00FFFF", 72))
    else:
        # Only show these if not all perfect
        if miss_count == 0 and (perfect_count + great_count + good_count + bad_count) > 0:
            achievements.append(("FULL COMBO!", "#FFD700", 60))
        if (perfect_count + great_count + good_count + bad_count + miss_count) > 0:
            achievements.append(("CHART CLEAR", "#00FF00", 48))
    
    # Show achievements
    if achievements:
        canvas.delete('all')
        canvas.configure(bg='black')
        
        for i, (text, color, size) in enumerate(achievements):
            y_pos = height // 2 - 100 + (i * 100)
            canvas.create_text(width // 2, y_pos, text=text,
                             fill=color, font=('Arial', size, 'bold'))
        
        root.update()
        time.sleep(2.0)  # Display for 2 seconds
    
    # Save replay to file (only if not already a replay and not in auto mode)
    if not is_replay and game_mode != 'auto' and current_chart_id and current_difficulty:
        save_replay(current_chart_id, current_difficulty, score, 
                   calculate_accuracy(), replay_data, rank)
    
    # Update progress (only if not replay and not auto mode)
    if not is_replay and game_mode != 'auto' and current_chart_id and current_difficulty:
        playtime = time.time() - start_time
        updated_progress = update_progress(current_chart_id, current_difficulty, 
                                          score, rank, calculate_accuracy(), playtime)
        
        # Check for new achievements
        if updated_progress:
            new_achievements = []
            for ach_key, ach_data in updated_progress.get('achievements', {}).items():
                # Check if achievement was just unlocked (within last 10 seconds)
                from datetime import datetime, timedelta
                unlock_time = datetime.strptime(ach_data['unlocked'], "%Y%m%d_%H%M%S")
                if datetime.now() - unlock_time < timedelta(seconds=10):
                    new_achievements.append(ach_data)
            
            # Show new achievements
            if new_achievements:
                canvas.delete('all')
                canvas.configure(bg='black')
                
                canvas.create_text(width // 2, height // 2 - 150, 
                                 text="ACHIEVEMENT UNLOCKED!",
                                 fill='gold', font=('Arial', 48, 'bold'))
                
                y_pos = height // 2 - 50
                for ach in new_achievements:
                    canvas.create_text(width // 2, y_pos, 
                                     text=ach['name'],
                                     fill='yellow', font=('Arial', 36, 'bold'))
                    y_pos += 50
                    canvas.create_text(width // 2, y_pos, 
                                     text=ach['description'],
                                     fill='white', font=('Arial', 20))
                    y_pos += 70
                
                root.update()
                time.sleep(2.5)
    
    # Game over screen
    canvas.delete('all')
    canvas.configure(bg='black')
    
    # Display rank (huge!)
    canvas.create_text(width // 2, height // 2 - 150,
                      text=rank,
                      fill=rank_color, font=('Arial', 200, 'bold'))
    
    # Display score and stats
    canvas.create_text(width // 2, height // 2 + 50,
                      text=f"Score: {score: ,} / {max_possible_score:,}",
                      fill='white', font=('Arial', 32, 'bold'))
    
    canvas.create_text(width // 2, height // 2 + 100,
                      text=f"Accuracy: {percentage:.2f}%",
                      fill='white', font=('Arial', 28))
    
    canvas.create_text(width // 2, height // 2 + 140,
                      text=f"Max Combo: {max_combo}",
                      fill='yellow', font=('Arial', 24))
    
    # Display judgment breakdown
    y_start = height // 2 + 190
    canvas.create_text(width // 2, y_start,
                      text=f"Perfect: {perfect_count}  |  Great: {great_count}  |  Good: {good_count}  |  Bad:  {bad_count}  |  Miss: {miss_count}",
                      fill='white', font=('Arial', 20))
    
    canvas.create_text(width // 2, height - 100,
                      text="Press R to replay  |  Press M to menu  |  Press ESC to exit",
                      fill='gray', font=('Arial', 20))
    
    root.update()
    
    # Wait for user input using tkinter bindings
    waiting = [True]  # Use list to allow modification in nested function
    action = [None]  # 'replay', 'menu', or None
    
    def on_end_tkinter_key(event):
        if event.keysym == 'Escape':
            waiting[0] = False
            action[0] = 'exit'
        elif event.char and event.char.lower() == 'r':
            waiting[0] = False
            action[0] = 'replay'
        elif event.char and event.char.lower() == 'm':
            waiting[0] = False
            action[0] = 'menu'
    
    root.bind('<KeyPress>', on_end_tkinter_key)
    
    while waiting[0]:
        root.update()
        time.sleep(0.01)
    
    root.unbind('<KeyPress>')
    
    # Execute the action
    if action[0] == 'replay':
        play_replay()
    elif action[0] == 'exit':
        root.quit()

def play_replay():
    """Play back the recorded replay"""
    global is_replay, replay_index, game_running, start_time
    global score, combo, max_combo, perfect_count, great_count, good_count, bad_count, miss_count
    global active_notes, active_slides, chart, key_is_down, key_pressed_flags, active_particles
    
    # Reset game state
    is_replay = True
    replay_index = 0
    score = 0
    combo = 0
    max_combo = 0
    perfect_count = 0
    great_count = 0
    good_count = 0
    bad_count = 0
    miss_count = 0
    active_particles = []  # Reset particles
    miss_count = 0
    active_notes = []
    active_slides = []
    key_is_down = {0: False, 1: False, 2: False, 3: False}
    key_pressed_flags = {0: False, 1: False, 2: False, 3: False}
    
    # Reload chart
    load_chart(current_chart_id, current_difficulty)
    
    # Calculate total duration from last note/replay event
    total_duration = 0
    if replay_data:
        total_duration = replay_data[-1][0] + 2.0  # Add buffer
    elif chart:
        # Fallback to chart duration
        total_duration = max(note['time'] for note in chart) + 2.0
    
    # Start replay game loop
    frame_dur = 1 / fps
    start_time = time.time()
    game_running = True
    replay_exit = False
    paused = False  # Pause state for frame-by-frame
    current_frame = 0  # Frame counter for paused display
    
    canvas.delete('all')
    canvas.configure(bg='black')
    
    # Draw static elements
    draw_lane_separators()
    draw_hit_bar()
    draw_key_labels()
    
    # Replay control state
    def seek_to_time(target_time):
        """Seek replay to a specific time"""
        global replay_index, score, combo, max_combo
        global perfect_count, great_count, good_count, bad_count, miss_count
        global active_notes, active_slides, key_is_down, key_pressed_flags
        
        # Reset state
        replay_index = 0
        score = 0
        combo = 0
        max_combo = 0
        perfect_count = 0
        great_count = 0
        good_count = 0
        bad_count = 0
        miss_count = 0
        active_notes = []
        active_slides = []
        key_is_down = {0: False, 1: False, 2: False, 3: False}
        key_pressed_flags = {0: False, 1: False, 2: False, 3: False}
        
        # Reload chart
        load_chart(current_chart_id, current_difficulty)
        
        # Fast-forward to target time
        while replay_index < len(replay_data) and replay_data[replay_index][0] <= target_time:
            event_time, event_type, lane = replay_data[replay_index]
            
            if event_type == 'press':
                key_is_down[lane] = True
                key_pressed_flags[lane] = True
                check_hit(lane, event_time)
            elif event_type == 'release':
                key_is_down[lane] = False
                key_pressed_flags[lane] = False
                check_slide_hold(lane, event_time, False)
            
            replay_index += 1
        
        # Update notes to current time
        update_notes(target_time)
    
    def on_replay_key(event):
        """Handle key presses during replay"""
        global game_running, start_time
        nonlocal replay_exit, paused, current_frame
        
        if event.keysym == 'Escape':
            game_running = False
            replay_exit = True
        elif event.char and event.char == ' ':
            # Toggle pause
            paused = not paused
            if not paused:
                # Resume - adjust start_time to account for pause
                start_time = time.time() - (current_frame / fps)
        elif event.char and event.char == ',':
            # Step backward one frame (when paused)
            if paused:
                current_frame = max(0, current_frame - 1)
                target_time = current_frame / fps
                seek_to_time(target_time)
                start_time = time.time() - target_time
        elif event.char and event.char == '.':
            # Step forward one frame (when paused)
            if paused:
                current_frame += 1
                target_time = current_frame / fps
                seek_to_time(target_time)
                start_time = time.time() - target_time
        elif event.keysym == 'Left':
            # Jump back 5 seconds
            current_time = time.time() - start_time
            new_time = max(0, current_time - 5.0)
            seek_to_time(new_time)
            start_time = time.time() - new_time
            if paused:
                current_frame = int(new_time * fps)
        elif event.keysym == 'Right':
            # Jump forward 5 seconds
            current_time = time.time() - start_time
            new_time = min(total_duration, current_time + 5.0)
            seek_to_time(new_time)
            start_time = time.time() - new_time
            if paused:
                current_frame = int(new_time * fps)
    
    root.bind('<KeyPress>', on_replay_key)
    
    while game_running and (chart or active_notes or active_slides):
        if not paused:
            frame_start = time.time()
            current_time = frame_start - start_time
            current_frame = int(current_time * fps)
        else:
            # When paused, use the stored frame number
            frame_start = time.time()
            current_time = current_frame / fps
        
        # Process replay events (only if not paused)
        if not paused:
            while replay_index < len(replay_data) and replay_data[replay_index][0] <= current_time:
                event_time, event_type, lane = replay_data[replay_index]
                
                if event_type == 'press':
                    key_is_down[lane] = True
                    key_pressed_flags[lane] = True
                    check_hit(lane, event_time)
                elif event_type == 'release':
                    key_is_down[lane] = False
                    key_pressed_flags[lane] = False
                    check_slide_hold(lane, event_time, False)
                
                replay_index += 1
        
        # Clear dynamic elements
        canvas.delete('note')
        
        # Update game state
        update_notes(current_time)
        draw_ui()
        
        # Add "REPLAY" watermark or "PAUSED" indicator
        if paused:
            canvas.create_text(width // 2, height - 80, text=f"PAUSED - Frame {current_frame}",
                             fill='#FF6666', font=('Arial', 24, 'bold'), tags='ui')
        else:
            canvas.create_text(width // 2, height - 80, text="REPLAY",
                             fill='#666666', font=('Arial', 24, 'bold'), tags='ui')
        
        # Draw playback bar at bottom
        bar_width = width - 200
        bar_x = 100
        bar_y = height - 40
        bar_height = 10
        
        # Background bar
        canvas.create_rectangle(bar_x, bar_y - bar_height // 2,
                              bar_x + bar_width, bar_y + bar_height // 2,
                              fill='#333333', outline='#666666', width=2, tags='ui')
        
        # Progress bar
        if total_duration > 0:
            progress = min(1.0, current_time / total_duration)
            progress_width = int(bar_width * progress)
            canvas.create_rectangle(bar_x, bar_y - bar_height // 2,
                                  bar_x + progress_width, bar_y + bar_height // 2,
                                  fill='#00AAFF' if not paused else '#FF6666', 
                                  outline='', tags='ui')
        
        # Time display
        time_text = f"{int(current_time // 60):02d}:{int(current_time % 60):02d} / {int(total_duration // 60):02d}:{int(total_duration % 60):02d}"
        canvas.create_text(width // 2, bar_y + 20, text=time_text,
                         fill='white', font=('Arial', 16), tags='ui')
        
        # Controls hint
        if paused:
            canvas.create_text(width // 2, height - 10, 
                             text="SPACE Resume  |  , Previous Frame  |  . Next Frame  |  ESC Exit",
                             fill='#888888', font=('Arial', 14), tags='ui')
        else:
            canvas.create_text(width // 2, height - 10, 
                             text="SPACE Pause  |  â† Jump Back 5s  |  â†’ Jump Forward 5s  |  ESC Exit Replay",
                             fill='#888888', font=('Arial', 14), tags='ui')
        
        # Maintain frame rate (only if not paused)
        if not paused:
            elapsed = time.time() - frame_start
            sleep_time = frame_dur - elapsed
            if sleep_time > 0:
                time.sleep(sleep_time)
        else:
            # When paused, just update at a lower rate
            time.sleep(0.05)
        
        root.update()
    
    root.unbind('<KeyPress>')
    
    # Show game over screen again (unless user pressed ESC to exit)
    is_replay = False
    if not replay_exit:
        game_loop()  # This will show the results screen again

def get_available_charts():
    """Scan directory for available charts"""
    charts = {}
    if not os.path.exists(CHART_DIRECTORY):
        return charts
    
    chart_files = glob.glob(f"{CHART_DIRECTORY}/*.txt")
    for file_path in chart_files:
        filename = os.path.basename(file_path)
        # Parse filename: chartid_difficulty.txt
        if '_' in filename:
            parts = filename.replace('.txt', '').rsplit('_', 1)
            if len(parts) == 2:
                chart_id, difficulty = parts
                if chart_id not in charts:
                    charts[chart_id] = []
                charts[chart_id].append(difficulty)
    
    return charts

def show_replay_menu():
    """Display replay selection menu"""
    global current_chart_id, current_difficulty, replay_data, is_replay
    
    menu_running = True
    current_page = 0
    replays_per_page = 10
    
    def draw_menu():
        canvas.delete('all')
        canvas.configure(bg='black')
        
        # Title
        canvas.create_text(width // 2, 50, text="WATCH REPLAY",
                         fill='white', font=('Arial', 48, 'bold'))
        
        # Instructions
        canvas.create_text(width // 2, 120, text="Use number keys or click to select | â†â†’ to change page | ESC to go back",
                         fill='gray', font=('Arial', 16))
        
        replays = get_available_replays()
        if not replays:
            canvas.create_text(width // 2, height // 2,
                             text="No replays found",
                             fill='red', font=('Arial', 24))
            root.update()
            return
        
        # Calculate pagination
        total_pages = (len(replays) + replays_per_page - 1) // replays_per_page
        nonlocal current_page
        current_page = max(0, min(current_page, total_pages - 1))
        
        start_idx = current_page * replays_per_page
        end_idx = min(start_idx + replays_per_page, len(replays))
        page_replays = replays[start_idx:end_idx]
        
        # Display page indicator
        if total_pages > 1:
            canvas.create_text(width // 2, 150, text=f"Page {current_page + 1} of {total_pages}",
                             fill='white', font=('Arial', 18))
        
        # Display replays
        y_pos = 200
        for i, replay_info in enumerate(page_replays):
            data = replay_info['data']
            chart_id = data.get('chart_id', 'Unknown')
            difficulty = data.get('difficulty', 'Unknown')
            rank = data.get('rank', 'D')
            score = data.get('score', 0)
            accuracy = data.get('accuracy', 0)
            timestamp = data.get('timestamp', '')
            
            # Format timestamp for display
            if len(timestamp) >= 13:
                date_str = f"{timestamp[4:6]}/{timestamp[6:8]}"
                time_str = f"{timestamp[9:11]}:{timestamp[11:13]}"
                display_time = f"{date_str} {time_str}"
            else:
                display_time = timestamp
            
            text = f"{i + 1}. {chart_id} [{difficulty}] - Rank {rank} - {accuracy:.1f}% - {display_time}"
            canvas.create_text(width // 2, y_pos, text=text,
                             fill='cyan', font=('Arial', 18), tags=f'replay_{i}')
            y_pos += 35
        
        root.update()
    
    def on_tkinter_key(event):
        """Handle tkinter key events for menu"""
        nonlocal menu_running, current_page
        
        if event.keysym == 'Escape':
            menu_running = False
            return
        
        # Left/Right arrows for pagination
        if event.keysym == 'Left':
            replays = get_available_replays()
            total_pages = (len(replays) + replays_per_page - 1) // replays_per_page
            if current_page > 0:
                current_page -= 1
                draw_menu()
            return
        
        if event.keysym == 'Right':
            replays = get_available_replays()
            total_pages = (len(replays) + replays_per_page - 1) // replays_per_page
            if current_page < total_pages - 1:
                current_page += 1
                draw_menu()
            return
        
        # Number key selection
        if event.char and event.char.isdigit():
            num = int(event.char)
            if num > 0:
                replays = get_available_replays()
                start_idx = current_page * replays_per_page
                page_replays = replays[start_idx:start_idx + replays_per_page]
                if num <= len(page_replays):
                    # Load and play selected replay
                    replay_info = page_replays[num - 1]
                    data = replay_info['data']
                    
                    current_chart_id = data['chart_id']
                    current_difficulty = data['difficulty']
                    replay_data = [tuple(event) for event in data['inputs']]
                    
                    menu_running = False
                    root.unbind('<KeyPress>')
                    root.unbind('<Button-1>')
                    
                    # Start replay
                    load_chart(current_chart_id, current_difficulty)
                    play_replay()
    
    def on_mouse_click(event):
        """Handle mouse clicks in replay menu"""
        # Get clicked item
        items = canvas.find_overlapping(event.x - 10, event.y - 10, event.x + 10, event.y + 10)
        for item in items:
            tags = canvas.gettags(item)
            for tag in tags:
                if tag.startswith('replay_'):
                    replay_index = int(tag.split('_')[1])
                    replays = get_available_replays()
                    start_idx = current_page * replays_per_page
                    page_replays = replays[start_idx:start_idx + replays_per_page]
                    if replay_index < len(page_replays):
                        # Load and play selected replay
                        replay_info = page_replays[replay_index]
                        data = replay_info['data']
                        
                        global current_chart_id, current_difficulty, replay_data
                        current_chart_id = data['chart_id']
                        current_difficulty = data['difficulty']
                        replay_data = [tuple(event) for event in data['inputs']]
                        
                        nonlocal menu_running
                        menu_running = False
                        root.unbind('<KeyPress>')
                        root.unbind('<Button-1>')
                        
                        # Start replay
                        load_chart(current_chart_id, current_difficulty)
                        play_replay()
                    return
    
    draw_menu()
    root.bind('<KeyPress>', on_tkinter_key)
    root.bind('<Button-1>', on_mouse_click)
    
    while menu_running:
        root.update()
        time.sleep(0.01)
    
    root.unbind('<KeyPress>')
    root.unbind('<Button-1>')

def show_chart_menu():
    """Display chart selection menu"""
    global current_chart_id, current_difficulty
    
    selected_chart = None
    selected_difficulty = None
    menu_running = True
    current_page = 0
    charts_per_page = 10
    refresh_text_alpha = 0  # For fading effect
    refresh_text_time = 0
    
    def refresh_menu():
        nonlocal current_page, refresh_text_alpha, refresh_text_time
        current_page = 0
        refresh_text_alpha = 1.0
        refresh_text_time = time.time()
        draw_menu()
    
    def draw_menu():
        canvas.delete('all')
        canvas.configure(bg='black')
        
        # Title
        canvas.create_text(width // 2, 50, text="SELECT CHART",
                         fill='white', font=('Arial', 48, 'bold'))
        
        # Instructions
        canvas.create_text(width // 2, 120, text="Use number keys or click to select | R to refresh | â†â†’ to change page | ESC to quit",
                         fill='gray', font=('Arial', 16))
        
        # Fading refresh text
        nonlocal refresh_text_alpha, refresh_text_time
        if refresh_text_alpha > 0:
            elapsed = time.time() - refresh_text_time
            refresh_text_alpha = max(0, 1.0 - elapsed / 1.5)  # Fade over 1.5 seconds
            if refresh_text_alpha > 0:
                # Convert alpha to color brightness
                brightness = int(255 * refresh_text_alpha)
                color = f'#{brightness:02x}{brightness:02x}{brightness:02x}'
                canvas.create_text(width // 2, 170, text="Refreshed!",
                                 fill=color, font=('Arial', 20, 'bold'))
        
        charts = get_available_charts()
        if not charts:
            canvas.create_text(width // 2, height // 2,
                             text="No charts found in directory",
                             fill='red', font=('Arial', 24))
            root.update()
            return
        
        # Calculate pagination
        chart_list = sorted(charts.keys())
        total_pages = (len(chart_list) + charts_per_page - 1) // charts_per_page
        nonlocal current_page
        current_page = max(0, min(current_page, total_pages - 1))
        
        start_idx = current_page * charts_per_page
        end_idx = min(start_idx + charts_per_page, len(chart_list))
        page_charts = chart_list[start_idx:end_idx]
        
        # Display page indicator
        if total_pages > 1:
            canvas.create_text(width // 2, 150, text=f"Page {current_page + 1} of {total_pages}",
                             fill='white', font=('Arial', 18))
        
        # Display charts
        y_pos = 200
        index = 0
        for chart_id in page_charts:
            difficulties = sorted(charts[chart_id])
            diff_text = ", ".join(difficulties)
            
            # Check if audio available
            audio_icon = ""
            for diff in difficulties:
                mp3_file = f"{CHART_DIRECTORY}/{chart_id}_{diff}.mp3"
                if os.path.exists(mp3_file):
                    audio_icon = " â™«"
                    break
            
            text = f"{index + 1}. {chart_id} [{diff_text}]{audio_icon}"
            canvas.create_text(width // 2, y_pos, text=text,
                             fill='cyan', font=('Arial', 20), tags=f'chart_{index}')
            y_pos += 40
            index += 1
        
        root.update()
    
    def on_tkinter_key(event):
        """Handle tkinter key events for menu"""
        nonlocal menu_running, selected_chart, selected_difficulty, current_page
        
        print(f"DEBUG tkinter_key: {event.keysym}, {event.char}")
        
        if event.keysym == 'Escape':
            menu_running = False
            return
        
        if event.char and event.char.lower() == 'r':
            refresh_menu()
            return
        
        # Left/Right arrows for pagination
        if event.keysym == 'Left':
            charts = get_available_charts()
            total_pages = (len(charts) + charts_per_page - 1) // charts_per_page
            if current_page > 0:
                current_page -= 1
                draw_menu()
            return
        
        if event.keysym == 'Right':
            charts = get_available_charts()
            total_pages = (len(charts) + charts_per_page - 1) // charts_per_page
            if current_page < total_pages - 1:
                current_page += 1
                draw_menu()
            return
        
        # Number key selection
        if event.char and event.char.isdigit():
            num = int(event.char)
            if num > 0:
                charts = get_available_charts()
                chart_list = sorted(charts.keys())
                start_idx = current_page * charts_per_page
                page_charts = chart_list[start_idx:start_idx + charts_per_page]
                if num <= len(page_charts):
                    selected_chart = page_charts[num - 1]
                    # Show difficulty selection
                    select_difficulty(selected_chart, charts[selected_chart])
    
    def on_mouse_click(event):
        """Handle mouse clicks in chart menu"""
        nonlocal selected_chart
        
        # Get clicked item
        items = canvas.find_overlapping(event.x - 10, event.y - 10, event.x + 10, event.y + 10)
        for item in items:
            tags = canvas.gettags(item)
            for tag in tags:
                if tag.startswith('chart_'):
                    chart_index = int(tag.split('_')[1])
                    charts = get_available_charts()
                    chart_list = sorted(charts.keys())
                    start_idx = current_page * charts_per_page
                    page_charts = chart_list[start_idx:start_idx + charts_per_page]
                    if chart_index < len(page_charts):
                        selected_chart = page_charts[chart_index]
                        select_difficulty(selected_chart, charts[selected_chart])
                    return

    def select_difficulty(chart_id, difficulties):
        nonlocal menu_running, selected_chart, selected_difficulty
        global current_chart_id, current_difficulty, game_mode
        
        canvas.delete('all')
        canvas.configure(bg='black')
        
        canvas.create_text(width // 2, 100, text=f"Select Mode for {chart_id}",
                         fill='white', font=('Arial', 36, 'bold'))
        
        y_pos = 200
        
        # Show special modes first
        canvas.create_text(width // 2, y_pos, text="A. Auto Play",
                         fill='cyan', font=('Arial', 24), tags='mode_auto')
        y_pos += 50
        
        canvas.create_text(width // 2, y_pos, text="P. Practice Mode",
                         fill='lime', font=('Arial', 24), tags='mode_practice')
        y_pos += 70
        
        # Show regular difficulties
        canvas.create_text(width // 2, y_pos, text="--- Regular Difficulties ---",
                         fill='gray', font=('Arial', 18))
        y_pos += 50
        
        for i, diff in enumerate(sorted(difficulties)):
            mp3_file = f"{CHART_DIRECTORY}/{chart_id}_{diff}.mp3"
            audio_icon = " â™«" if os.path.exists(mp3_file) else ""
            
            canvas.create_text(width // 2, y_pos, text=f"{i + 1}. {diff}{audio_icon}",
                             fill='yellow', font=('Arial', 24), tags=f'diff_{i}')
            y_pos += 50
        
        canvas.create_text(width // 2, height - 50, text="Press number/letter or click to select | ESC to go back",
                         fill='gray', font=('Arial', 16))
        root.update()
        
        def on_diff_tkinter_key(event):
            nonlocal selected_difficulty, menu_running
            global current_chart_id, current_difficulty, game_mode
            
            print(f"DEBUG diff_tkinter_key: {event.keysym}, {event.char}")
            
            if event.keysym == 'Escape':
                root.unbind('<KeyPress>')
                root.unbind('<Button-1>')
                draw_menu()
                root.bind('<KeyPress>', on_tkinter_key)
                root.bind('<Button-1>', on_mouse_click)
                return
            
            # Check for Auto mode
            if event.char and event.char.lower() == 'a':
                # Use first available difficulty for auto mode
                selected_difficulty = sorted(difficulties)[0]
                current_chart_id = chart_id
                current_difficulty = selected_difficulty
                game_mode = 'auto'
                menu_running = False
                root.unbind('<KeyPress>')
                root.unbind('<Button-1>')
                print(f"DEBUG: Selected AUTO mode with chart_id={current_chart_id}, difficulty={current_difficulty}")
                return
            
            # Check for Practice mode
            if event.char and event.char.lower() == 'p':
                # Use first available difficulty for practice mode
                selected_difficulty = sorted(difficulties)[0]
                current_chart_id = chart_id
                current_difficulty = selected_difficulty
                game_mode = 'practice'
                menu_running = False
                root.unbind('<KeyPress>')
                root.unbind('<Button-1>')
                print(f"DEBUG: Selected PRACTICE mode with chart_id={current_chart_id}, difficulty={current_difficulty}")
                return
            
            # Regular difficulty selection
            if event.char.isdigit():
                num = int(event.char)
                if 0 < num <= len(difficulties):
                    selected_difficulty = sorted(difficulties)[num - 1]
                    current_chart_id = chart_id
                    current_difficulty = selected_difficulty
                    game_mode = 'normal'
                    menu_running = False
                    root.unbind('<KeyPress>')
                    root.unbind('<Button-1>')
                    print(f"DEBUG: Selected chart_id={current_chart_id}, difficulty={current_difficulty}")
        
        def on_diff_mouse_click(event):
            nonlocal selected_difficulty, menu_running
            global current_chart_id, current_difficulty, game_mode
            
            # Get clicked item
            items = canvas.find_overlapping(event.x - 10, event.y - 10, event.x + 10, event.y + 10)
            for item in items:
                tags = canvas.gettags(item)
                for tag in tags:
                    if tag == 'mode_auto':
                        selected_difficulty = sorted(difficulties)[0]
                        current_chart_id = chart_id
                        current_difficulty = selected_difficulty
                        game_mode = 'auto'
                        menu_running = False
                        root.unbind('<KeyPress>')
                        root.unbind('<Button-1>')
                        print(f"DEBUG: Selected AUTO mode")
                        return
                    elif tag == 'mode_practice':
                        selected_difficulty = sorted(difficulties)[0]
                        current_chart_id = chart_id
                        current_difficulty = selected_difficulty
                        game_mode = 'practice'
                        menu_running = False
                        root.unbind('<KeyPress>')
                        root.unbind('<Button-1>')
                        print(f"DEBUG: Selected PRACTICE mode")
                        return
                    elif tag.startswith('diff_'):
                        diff_index = int(tag.split('_')[1])
                        if diff_index < len(difficulties):
                            selected_difficulty = sorted(difficulties)[diff_index]
                            current_chart_id = chart_id
                            current_difficulty = selected_difficulty
                            game_mode = 'normal'
                            menu_running = False
                            root.unbind('<KeyPress>')
                            root.unbind('<Button-1>')
                            print(f"DEBUG: Selected chart_id={current_chart_id}, difficulty={current_difficulty}")
                        return
        
        # Unbind menu keys and bind difficulty keys
        root.unbind('<KeyPress>')
        root.unbind('<Button-1>')
        root.bind('<KeyPress>', on_diff_tkinter_key)
        root.bind('<Button-1>', on_diff_mouse_click)
    
    draw_menu()
    
    # Bind tkinter keys for menu
    print("DEBUG: Binding tkinter keys for menu...")
    root.bind('<KeyPress>', on_tkinter_key)
    root.bind('<Button-1>', on_mouse_click)
    
    while menu_running:
        # Redraw if refresh text is fading
        if refresh_text_alpha > 0:
            draw_menu()
        root.update()
        time.sleep(0.01)
    
    # Unbind menu keys
    root.unbind('<KeyPress>')
    root.unbind('<Button-1>')
    print(f"DEBUG: Returning from menu, chart_id={current_chart_id}")
    
    return current_chart_id is not None

def save_settings():
    """Save settings to file"""
    import json
    settings_file = "settings.json"
    try:
        with open(settings_file, 'w') as f:
            json.dump(settings, f, indent=2)
        print(f"Settings saved to {settings_file}")
    except Exception as e:
        print(f"Error saving settings: {e}")

def load_settings():
    """Load settings from file"""
    import json
    settings_file = "settings.json"
    if os.path.exists(settings_file):
        try:
            with open(settings_file, 'r') as f:
                loaded = json.load(f)
                settings.update(loaded)
                rebuild_key_mappings()
            print(f"Settings loaded from {settings_file}")
        except Exception as e:
            print(f"Error loading settings: {e}")

def show_options_menu():
    """Display options menu for changing settings"""
    menu_running = True
    selected_option = 0
    current_page = 0  # 0 = Main, 1 = Visual, 2 = Audio, 3 = Gameplay, 4 = Performance
    options_pages = {
        0: ['Visual Settings', 'Audio Settings', 'Gameplay Settings', 'Performance Settings', 'Change Keys', 'Scroll Speed', 'Export Settings', 'Import Settings', 'Save & Back'],
        1: ['Note Size', 'Hit Bar Position', 'Background Dim', 'Show FPS', 'Show Timing Zones', 'Colorblind Mode', 'High Contrast Mode', 'Show Late/Early', 'Back'],
        2: ['Music Volume', 'SFX Volume', 'Global Offset', 'Back'],
        3: ['Timing Windows', 'Back'],
        4: ['FPS Target', 'Renderer', 'Show Performance Metrics', 'Back']
    }
    options = options_pages[current_page]  # Current options list
    
    # State for key remapping
    remapping_index = None
    
    def draw_options():
        nonlocal options
        canvas.delete('all')
        canvas.configure(bg='black')
        
        page_titles = {0: 'OPTIONS', 1: 'VISUAL SETTINGS', 2: 'AUDIO SETTINGS', 3: 'GAMEPLAY SETTINGS', 4: 'PERFORMANCE SETTINGS'}
        canvas.create_text(width // 2, 50, text=page_titles.get(current_page, 'OPTIONS'),
                         fill='white', font=('Arial', 48, 'bold'))
        
        if remapping_index is not None:
            # Key remapping mode
            canvas.create_text(width // 2, 150, 
                             text=f"Press key for lane {remapping_index + 1} (currently: {settings['key_bindings'][remapping_index]})",
                             fill='yellow', font=('Arial', 20))
            canvas.create_text(width // 2, 200, text="Press ESC to cancel",
                             fill='gray', font=('Arial', 16))
        else:
            # Normal menu
            canvas.create_text(width // 2, 120, text="Use â†‘â†“ to navigate, ENTER or click to select, â†â†’ to adjust values, ESC to go back",
                             fill='gray', font=('Arial', 14))
            
            y_pos = 200
            options = options_pages[current_page]
            for i, option in enumerate(options):
                color = 'yellow' if i == selected_option else 'white'
                
                # Format text based on option
                if option == 'Change Keys':
                    keys_text = ''.join(settings['key_bindings'])
                    text = f"{option}: {keys_text}"
                elif option == 'Scroll Speed':
                    text = f"{option}: {settings['scroll_speed_multiplier']:.1f}x"
                elif option == 'Note Size':
                    text = f"{option}: {settings.get('note_size_multiplier', 1.0):.1f}x"
                elif option == 'Hit Bar Position':
                    text = f"{option}: {settings.get('hit_bar_position', 0.9):.2f}"
                elif option == 'Background Dim':
                    text = f"{option}: {settings.get('background_dim', 0)}"
                elif option == 'Show FPS':
                    text = f"{option}: {'ON' if settings.get('show_fps', False) else 'OFF'}"
                elif option == 'Show Timing Zones':
                    text = f"{option}: {'ON' if settings.get('show_timing_zones', False) else 'OFF'}"
                elif option == 'Colorblind Mode':
                    text = f"{option}: {'ON' if settings.get('colorblind_mode', False) else 'OFF'}"
                elif option == 'High Contrast Mode':
                    text = f"{option}: {'ON' if settings.get('high_contrast_mode', False) else 'OFF'}"
                elif option == 'Show Late/Early':
                    text = f"{option}: {'ON' if settings.get('show_late_early', True) else 'OFF'}"
                elif option == 'Music Volume':
                    text = f"{option}: {settings.get('music_volume', 100)}%"
                elif option == 'SFX Volume':
                    text = f"{option}: {settings.get('sfx_volume', 100)}%"
                elif option == 'Global Offset':
                    text = f"{option}: {settings.get('global_offset', 0)}ms"
                elif option == 'Timing Windows':
                    text = f"{option}: {settings.get('timing_windows', 'normal').upper()}"
                elif option == 'FPS Target':
                    text = f"{option}: {settings.get('fps_target', 60)} FPS"
                elif option == 'Renderer':
                    text = f"{option}: {settings.get('renderer', 'auto').upper()}"
                elif option == 'Show Performance Metrics':
                    text = f"{option}: {'ON' if settings.get('show_performance_metrics', False) else 'OFF'}"
                else:
                    text = option
                
                canvas.create_text(width // 2, y_pos, text=text,
                                 fill=color, font=('Arial', 22), tags=f'option_{i}')
                y_pos += 50
        
        root.update()
    
    def on_options_key(event):
        nonlocal menu_running, selected_option, remapping_index, options, current_page
        
        if remapping_index is not None:
            # Key remapping mode
            if event.keysym == 'Escape':
                remapping_index = None
                draw_options()
                return
            
            # Check if key is a valid single character
            if len(event.char) == 1 and event.char.isprintable():
                new_key = event.char.lower()
                # Check if key is already used (except in current slot)
                if new_key not in [settings['key_bindings'][i] for i in range(8) if i != remapping_index]:
                    settings['key_bindings'][remapping_index] = new_key
                    rebuild_key_mappings()
                    remapping_index = None
                    draw_options()
            return
        
        # Normal menu navigation
        if event.keysym == 'Escape':
            menu_running = False
            return
        
        if event.keysym == 'Up':
            selected_option = (selected_option - 1) % len(options)
            draw_options()
        elif event.keysym == 'Down':
            selected_option = (selected_option + 1) % len(options)
            draw_options()
        elif event.keysym == 'Return':
            option_name = options[selected_option]
            if option_name == 'Change Keys':
                # Start key remapping for each lane
                show_key_remap_screen()
            elif option_name in ['Show FPS', 'Show Timing Zones', 'Colorblind Mode', 'High Contrast Mode', 'Show Late/Early', 'Show Performance Metrics']:
                # Toggle boolean settings
                setting_key = {
                    'Show FPS': 'show_fps',
                    'Show Timing Zones': 'show_timing_zones',
                    'Colorblind Mode': 'colorblind_mode',
                    'High Contrast Mode': 'high_contrast_mode',
                    'Show Late/Early': 'show_late_early',
                    'Show Performance Metrics': 'show_performance_metrics'
                }[option_name]
                settings[setting_key] = not settings.get(setting_key, False)
                draw_options()
            elif option_name == 'Renderer':
                # Cycle through renderer options
                renderers = ['auto', 'tkinter', 'opengl']
                current = settings.get('renderer', 'auto')
                current_idx = renderers.index(current) if current in renderers else 0
                settings['renderer'] = renderers[(current_idx + 1) % len(renderers)]
                draw_options()
            elif option_name == 'Save & Back':
                save_settings()
                menu_running = False
            elif option_name in ['Visual Settings', 'Audio Settings', 'Gameplay Settings', 'Performance Settings']:
                # Navigate to subpage
                if option_name == 'Visual Settings':
                    current_page = 1
                elif option_name == 'Audio Settings':
                    current_page = 2
                elif option_name == 'Gameplay Settings':
                    current_page = 3
                elif option_name == 'Performance Settings':
                    current_page = 4
                selected_option = 0
                options = options_pages[current_page]
                draw_options()
            elif option_name == 'Back':
                # Return to main page
                current_page = 0
                selected_option = 0
                options = options_pages[current_page]
                draw_options()
        elif event.keysym == 'Left':
            # Handle left arrow for adjustable values
            option_name = options[selected_option]
            if option_name == 'Scroll Speed':
                settings['scroll_speed_multiplier'] = max(0.1, settings['scroll_speed_multiplier'] - 0.1)
                draw_options()
            elif option_name == 'FPS Target':
                # Decrease by 10, min 1
                settings['fps_target'] = max(1, settings.get('fps_target', 60) - 10)
                draw_options()
        elif event.keysym == 'Right':
            # Handle right arrow for adjustable values
            option_name = options[selected_option]
            if option_name == 'Scroll Speed':
                settings['scroll_speed_multiplier'] = min(10.0, settings['scroll_speed_multiplier'] + 0.1)
                draw_options()
            elif option_name == 'FPS Target':
                # Increase by 10, max 600
                settings['fps_target'] = min(600, settings.get('fps_target', 60) + 10)
                draw_options()
    
    def on_options_mouse_click(event):
        nonlocal menu_running, selected_option, remapping_index, options
        
        if remapping_index is not None:
            # Ignore clicks during key remapping
            return
        
        # Get clicked item
        items = canvas.find_overlapping(event.x - 10, event.y - 10, event.x + 10, event.y + 10)
        for item in items:
            tags = canvas.gettags(item)
            for tag in tags:
                if tag.startswith('option_'):
                    option_index = int(tag.split('_')[1])
                    if options[option_index] == 'Change Keys':
                        show_key_remap_screen()
                    elif options[option_index] == 'Scroll Speed':
                        # Toggle through some common values on click
                        current = settings['scroll_speed_multiplier']
                        presets = [0.5, 1.0, 1.5, 2.0, 2.5, 3.0]
                        if current in presets:
                            idx = (presets.index(current) + 1) % len(presets)
                            settings['scroll_speed_multiplier'] = presets[idx]
                        else:
                            settings['scroll_speed_multiplier'] = 1.0
                        draw_options()
                    elif options[option_index] == 'Save & Back':
                        save_settings()
                        menu_running = False
                    return
    
    def show_key_remap_screen():
        """Show screen for remapping all keys"""
        nonlocal remapping_index
        for i in range(8):
            remapping_index = i
            draw_options()
            
            # Wait for key press
            waiting = True
            def wait_key(event):
                nonlocal waiting, remapping_index
                if event.keysym == 'Escape':
                    remapping_index = None
                    waiting = False
                    return
                
                if len(event.char) == 1 and event.char.isprintable():
                    new_key = event.char.lower()
                    # Check if key is already used
                    if new_key not in [settings['key_bindings'][j] for j in range(8) if j != i]:
                        settings['key_bindings'][i] = new_key
                        rebuild_key_mappings()
                        waiting = False
            
            root.unbind('<KeyPress>')
            root.bind('<KeyPress>', wait_key)
            
            while waiting:
                root.update()
                time.sleep(0.01)
            
            if remapping_index is None:
                # User cancelled
                break
        
        remapping_index = None
        root.unbind('<KeyPress>')
        root.bind('<KeyPress>', on_options_key)
        draw_options()
    
    draw_options()
    root.bind('<KeyPress>', on_options_key)
    root.bind('<Button-1>', on_options_mouse_click)
    
    while menu_running:
        root.update()
        time.sleep(0.01)
    
    root.unbind('<KeyPress>')
    root.unbind('<Button-1>')

def show_profile_menu():
    """Display profile/stats menu"""
    menu_running = True
    
    def draw_profile():
        canvas.delete('all')
        canvas.configure(bg='black')
        
        # Load progress data
        progress = load_progress()
        if not progress:
            canvas.create_text(width // 2, height // 2, 
                             text="No progress data found",
                             fill='red', font=('Arial', 24))
            root.update()
            return
        
        # Title
        canvas.create_text(width // 2, 50, 
                         text=f"Profile: {progress.get('username', 'Player')}",
                         fill='white', font=('Arial', 48, 'bold'))
        
        # Stats
        y_pos = 150
        total_plays = progress.get('total_charts_played', 0)
        total_notes = (progress.get('total_perfects', 0) + 
                      progress.get('total_greats', 0) + 
                      progress.get('total_goods', 0) + 
                      progress.get('total_bads', 0) + 
                      progress.get('total_misses', 0))
        
        if total_notes > 0:
            weighted_score = (progress.get('total_perfects', 0) * 100 + 
                            progress.get('total_greats', 0) * 70 + 
                            progress.get('total_goods', 0) * 40 + 
                            progress.get('total_bads', 0) * 10)
            avg_accuracy = weighted_score / (total_notes * 100.0) * 100.0
        else:
            avg_accuracy = 0.0
        
        # Get best rank
        best_scores = progress.get('best_scores', {})
        best_rank = 'D'
        for chart_key, chart_data in best_scores.items():
            rank = chart_data.get('rank', 'D')
            if rank == 'S' or (rank == 'A' and best_rank not in ['S']) or \
               (rank == 'B' and best_rank not in ['S', 'A']) or \
               (rank == 'C' and best_rank == 'D'):
                best_rank = rank
        
        # Stats display
        stats = [
            f"Total Plays: {total_plays}",
            f"Total Score: {progress.get('total_score', 0):,}",
            f"Average Accuracy: {avg_accuracy:.2f}%",
            f"Best Rank: {best_rank}",
            f"Total Playtime: {progress.get('total_playtime_seconds', 0) // 60} minutes",
            "",
            f"Perfect: {progress.get('total_perfects', 0)}  |  Great: {progress.get('total_greats', 0)}",
            f"Good: {progress.get('total_goods', 0)}  |  Bad: {progress.get('total_bads', 0)}  |  Miss: {progress.get('total_misses', 0)}"
        ]
        
        for stat in stats:
            canvas.create_text(width // 2, y_pos, text=stat,
                             fill='cyan', font=('Arial', 24))
            y_pos += 40
        
        # Achievements
        y_pos += 20
        canvas.create_text(width // 2, y_pos, text="--- Achievements ---",
                         fill='yellow', font=('Arial', 28, 'bold'))
        y_pos += 50
        
        achievements = progress.get('achievements', {})
        if achievements:
            for ach_key, ach_data in list(achievements.items())[:5]:  # Show first 5
                canvas.create_text(width // 2, y_pos, 
                                 text=f"ðŸ† {ach_data['name']}: {ach_data['description']}",
                                 fill='gold', font=('Arial', 18))
                y_pos += 35
        else:
            canvas.create_text(width // 2, y_pos, text="No achievements yet",
                             fill='gray', font=('Arial', 18))
        
        canvas.create_text(width // 2, height - 50, 
                         text="Press ESC or click anywhere to go back",
                         fill='gray', font=('Arial', 16))
        root.update()
    
    def on_profile_key(event):
        nonlocal menu_running
        if event.keysym == 'Escape':
            menu_running = False
    
    def on_profile_click(event):
        nonlocal menu_running
        menu_running = False
    
    draw_profile()
    root.bind('<KeyPress>', on_profile_key)
    root.bind('<Button-1>', on_profile_click)
    
    while menu_running:
        root.update()
        time.sleep(0.01)
    
    root.unbind('<KeyPress>')
    root.unbind('<Button-1>')

def show_main_menu():
    """Display main menu"""
    menu_running = True
    selected_option = 0
    options = ['Play', 'Watch Replay', 'Profile', 'Options', 'Quit']
    
    def draw_menu():
        canvas.delete('all')
        canvas.configure(bg='black')
        
        canvas.create_text(width // 2, 100, text="random game",
                         fill='white', font=('Arial', 32, 'bold'))
        
        canvas.create_text(width // 2, 200, text="Use â†‘â†“ to navigate, ENTER or click to select",
                         fill='gray', font=('Arial', 16))
        
        y_pos = 300
        for i, option in enumerate(options):
            color = 'yellow' if i == selected_option else 'white'
            canvas.create_text(width // 2, y_pos, text=option,
                             fill=color, font=('Arial', 36), tags=f'main_{i}')
            y_pos += 80
        
        root.update()
    
    def on_main_key(event):
        nonlocal menu_running, selected_option
        
        if event.keysym == 'Escape':
            selected_option = 4  # Quit (index updated for new menu item)
            menu_running = False
            return
        
        if event.keysym == 'Up':
            selected_option = (selected_option - 1) % len(options)
            draw_menu()
        elif event.keysym == 'Down':
            selected_option = (selected_option + 1) % len(options)
            draw_menu()
        elif event.keysym == 'Return':
            menu_running = False
    
    def on_main_mouse_click(event):
        nonlocal menu_running, selected_option
        
        # Get clicked item
        items = canvas.find_overlapping(event.x - 10, event.y - 10, event.x + 10, event.y + 10)
        for item in items:
            tags = canvas.gettags(item)
            for tag in tags:
                if tag.startswith('main_'):
                    selected_option = int(tag.split('_')[1])
                    menu_running = False
                    return
    
    draw_menu()
    root.bind('<KeyPress>', on_main_key)
    root.bind('<Button-1>', on_main_mouse_click)
    
    while menu_running:
        root.update()
        time.sleep(0.01)
    
    root.unbind('<KeyPress>')
    root.unbind('<Button-1>')
    
    return options[selected_option]

def show_pregame_setup(chart_id, difficulty):
    """Show pre-game setup GUI for speed, calibration, and mode selection"""
    global game_mode, settings
    
    setup_running = True
    start_game_flag = False  # Track if user wants to start (Enter) or go back (Esc)
    current_speed = settings.get('scroll_speed_multiplier', 1.0)
    selected_mode = game_mode if game_mode in ['auto', 'practice'] else 'normal'
    calibrating = False
    metronome_beats = []
    last_beat_time = 0  # For visual flash effect
    
    def draw_setup():
        canvas.delete('all')
        canvas.configure(bg='black')
        
        # Title
        canvas.create_text(width // 2, 50, text=f"Setup: {chart_id} - {difficulty}",
                         fill='white', font=('Arial', 32, 'bold'))
        
        # Speed selector
        y_pos = 150
        canvas.create_text(width // 2, y_pos, text="Note Speed Multiplier",
                         fill='cyan', font=('Arial', 24, 'bold'))
        y_pos += 50
        
        # Speed preview bar
        bar_x = width // 2 - 200
        bar_width = 400
        canvas.create_rectangle(bar_x, y_pos, bar_x + bar_width, y_pos + 30,
                              fill='#333333', outline='white', width=2)
        
        # Current speed indicator
        speed_pos = bar_x + int((current_speed - 0.5) / 4.0 * bar_width)
        canvas.create_rectangle(speed_pos - 5, y_pos - 5, speed_pos + 5, y_pos + 35,
                              fill='yellow', outline='white', width=2)
        
        canvas.create_text(width // 2, y_pos + 50, 
                         text=f"{current_speed:.1f}x (â†â†’ to adjust, 0.5x - 4.5x)",
                         fill='white', font=('Arial', 18))
        
        # Mode selection
        y_pos += 120
        canvas.create_text(width // 2, y_pos, text="Game Mode",
                         fill='cyan', font=('Arial', 24, 'bold'))
        y_pos += 40
        
        modes = [('Normal', 'normal'), ('Auto Play', 'auto'), ('Practice', 'practice')]
        for i, (mode_name, mode_key) in enumerate(modes):
            x_pos = width // 2 - 200 + i * 200
            color = 'yellow' if mode_key == selected_mode else 'white'
            canvas.create_text(x_pos, y_pos, text=f"{i+1}. {mode_name}",
                             fill=color, font=('Arial', 20), tags=f'mode_{mode_key}')
        
        # Calibration section
        y_pos += 80
        canvas.create_text(width // 2, y_pos, text="Offset Calibration",
                         fill='cyan', font=('Arial', 24, 'bold'))
        y_pos += 40
        
        current_offset = settings.get('global_offset', 0)
        canvas.create_text(width // 2, y_pos, 
                         text=f"Current Offset: {current_offset}ms",
                         fill='white', font=('Arial', 18))
        y_pos += 35
        
        if calibrating:
            # Show calibration progress with visual indicators
            canvas.create_text(width // 2, y_pos, 
                             text=f"Tap SPACE to the beat! ({len(metronome_beats)}/8)",
                             fill='lime', font=('Arial', 20, 'bold'))
            y_pos += 50
            
            # Draw beat indicators (circles for each tap)
            circle_y = y_pos
            circle_spacing = 60
            start_x = width // 2 - (7 * circle_spacing) // 2
            
            for i in range(8):
                x = start_x + i * circle_spacing
                if i < len(metronome_beats):
                    # Filled circle for completed beats
                    # Flash effect: check if this was the last beat tapped
                    time_since_beat = time.time() - last_beat_time
                    if i == len(metronome_beats) - 1 and time_since_beat < 0.15:
                        # Flash yellow for the most recent beat
                        color = 'yellow'
                        size = 25
                    else:
                        color = 'lime'
                        size = 20
                    canvas.create_oval(x - size, circle_y - size, x + size, circle_y + size,
                                     fill=color, outline='white', width=3)
                else:
                    # Empty circle for pending beats
                    canvas.create_oval(x - 15, circle_y - 15, x + 15, circle_y + 15,
                                     fill='', outline='gray', width=2)
            
            y_pos += 60
            
            # Show interval consistency if we have at least 2 beats
            if len(metronome_beats) >= 2:
                intervals = []
                for i in range(1, len(metronome_beats)):
                    intervals.append(metronome_beats[i] - metronome_beats[i-1])
                avg_interval = sum(intervals) / len(intervals)
                bpm = 60.0 / avg_interval
                
                # Show detected BPM
                canvas.create_text(width // 2, y_pos,
                                 text=f"Detected tempo: {bpm:.1f} BPM",
                                 fill='cyan', font=('Arial', 16))
                y_pos += 30
                
                # Show consistency indicator
                if len(intervals) >= 2:
                    variance = sum((x - avg_interval) ** 2 for x in intervals) / len(intervals)
                    std_dev = variance ** 0.5
                    consistency = max(0, 1 - (std_dev / avg_interval) * 5)  # 0 to 1
                    
                    # Draw consistency bar
                    bar_width = 300
                    bar_x = width // 2 - bar_width // 2
                    canvas.create_rectangle(bar_x, y_pos, bar_x + bar_width, y_pos + 20,
                                          fill='#333333', outline='white', width=1)
                    fill_width = int(bar_width * consistency)
                    bar_color = 'lime' if consistency > 0.7 else 'yellow' if consistency > 0.4 else 'red'
                    if fill_width > 0:
                        canvas.create_rectangle(bar_x, y_pos, bar_x + fill_width, y_pos + 20,
                                              fill=bar_color, outline='')
                    canvas.create_text(width // 2, y_pos + 30,
                                     text=f"Consistency: {consistency*100:.0f}%",
                                     fill='white', font=('Arial', 14))
        else:
            canvas.create_text(width // 2, y_pos, 
                             text="Press C to auto-calibrate (tap 8 beats)",
                             fill='gray', font=('Arial', 16))
        
        # Manual offset adjustment
        y_pos += 50
        canvas.create_text(width // 2, y_pos, 
                         text="Manual: [ = -10ms  ] = +10ms  \\ = Reset",
                         fill='gray', font=('Arial', 16))
        
        # Instructions
        canvas.create_text(width // 2, height - 100,
                         text="ENTER to start  |  ESC to go back",
                         fill='white', font=('Arial', 20, 'bold'))
        
        root.update()
    
    def on_setup_key(event):
        nonlocal setup_running, start_game_flag, current_speed, selected_mode, calibrating, metronome_beats, last_beat_time
        
        if event.keysym == 'Escape':
            setup_running = False
            start_game_flag = False
            return
        elif event.keysym == 'Return':
            # Save settings and start game
            settings['scroll_speed_multiplier'] = current_speed
            global game_mode
            game_mode = selected_mode
            setup_running = False
            start_game_flag = True
            return
        
        # Speed adjustment
        if event.keysym == 'Left':
            current_speed = max(0.5, current_speed - 0.1)
            draw_setup()
        elif event.keysym == 'Right':
            current_speed = min(4.5, current_speed + 0.1)
            draw_setup()
        
        # Mode selection
        if event.char and event.char.isdigit():
            num = int(event.char)
            if num == 1:
                selected_mode = 'normal'
            elif num == 2:
                selected_mode = 'auto'
            elif num == 3:
                selected_mode = 'practice'
            draw_setup()
        
        # Calibration
        if event.char and event.char.lower() == 'c':
            calibrating = True
            metronome_beats = []
            draw_setup()
        
        # Manual offset adjustment
        if event.char == '[':
            settings['global_offset'] = settings.get('global_offset', 0) - 10
            draw_setup()
        elif event.char == ']':
            settings['global_offset'] = settings.get('global_offset', 0) + 10
            draw_setup()
        elif event.char == '\\':
            settings['global_offset'] = 0
            draw_setup()
        
        # Metronome tap for calibration
        if calibrating and event.char == ' ':
            current_time = time.time()
            metronome_beats.append(current_time)
            last_beat_time = current_time  # For visual flash effect
            if len(metronome_beats) >= 8:
                # Calculate average interval and set offset
                intervals = []
                for i in range(1, len(metronome_beats)):
                    intervals.append(metronome_beats[i] - metronome_beats[i-1])
                avg_interval = sum(intervals) / len(intervals)
                # Assume 120 BPM target, calculate offset
                expected_interval = 60.0 / 120.0  # 0.5 seconds per beat
                offset_seconds = avg_interval - expected_interval
                settings['global_offset'] = int(offset_seconds * 1000)
                calibrating = False
                metronome_beats = []
            draw_setup()
    
    draw_setup()
    root.bind('<KeyPress>', on_setup_key)
    
    while setup_running:
        # Continuously redraw if calibrating to show flash animation
        if calibrating:
            draw_setup()
        root.update()
        time.sleep(0.01)
    
    root.unbind('<KeyPress>')
    return start_game_flag  # True means start, False means go back

def start_game(chart_id, difficulty):
    """Initialize and start the game"""
    global current_chart_id, current_difficulty, replay_data, game_running
    global practice_speed, practice_loop_start, practice_loop_end, practice_looping
    
    # Show pre-game setup
    if not show_pregame_setup(chart_id, difficulty):
        return  # User pressed ESC to go back
    
    current_chart_id = chart_id
    current_difficulty = difficulty
    replay_data = []  # Clear any previous replay data
    game_running = True  # Enable keyboard input
    
    # Reset practice mode variables
    practice_speed = 1.0
    practice_loop_start = None
    practice_loop_end = None
    practice_looping = False
    
    print(f"DEBUG: Starting game with chart {chart_id}, difficulty {difficulty}, mode {game_mode}")
    print(f"DEBUG: game_running set to {game_running}")
    
    load_chart(chart_id, difficulty)
    
    # Bind arrow keys and number keys for gameplay
    print("DEBUG: Binding tkinter keys for gameplay...")
    root.bind('<KeyPress>', on_tkinter_press)
    root.bind('<KeyRelease>', on_tkinter_release)
    print("DEBUG: Tkinter keys bound")
    
    # Start game loop
    game_loop()
    
    # Unbind keys after game ends
    root.unbind('<KeyPress>')
    root.unbind('<KeyRelease>')

# Example usage
if __name__ == "__main__":
    load_settings()  # Load settings at startup
    
    while True:
        # Show main menu
        choice = show_main_menu()
        
        if choice == 'Play':
            # Show chart selection menu
            if show_chart_menu():
                start_game(current_chart_id, current_difficulty)
        elif choice == 'Watch Replay':
            # Show replay selection menu
            show_replay_menu()
        elif choice == 'Profile':
            # Show profile/stats menu
            show_profile_menu()
        elif choice == 'Options':
            show_options_menu()
        elif choice == 'Quit':
            break
"""Blueprint placement helpers for Arras macros.

Reads the bitmap description from ``bps`` text files and replays the clicks
needed to rebuild the structure in-game.  The gameplay behavior itself stays
identical; the file handling is now pathlib-based for reliability.
"""

from pathlib import Path
from pynput.keyboard import Controller as KeyboardController, Key
from pynput.mouse import Controller as MouseController, Button
import time, threading

s = 9  # wall width / grid spacing
controller = KeyboardController()
mouse = MouseController()

CORE_DIR = Path(__file__).resolve().parent
BPS_DIR = CORE_DIR / "bps"
POSITIONPATH = BPS_DIR / "wall.txt"
MODIFIERPATH = BPS_DIR / "type.txt"
COLORRGBPATH = BPS_DIR / "color.txt"
colorheld = "b"
modifierheld = "n"

time.sleep(4)

colors = ["n", "b", "g", "r", "p", "y", "G", "e", "s", "t", "P", "h", "c", "S", "l", "w", "o", "W", "C", "f", "B"]
colorinstructions = [
    "pass",
    "mouse.position = (mouse.position[0] + 1.5, mouse.position[1] - 22.8)",
    "mouse.position = (mouse.position[0] + 11.9, mouse.position[1] - 21.5)",
    "mouse.position = (mouse.position[0] + 19.4, mouse.position[1] - 16.8)",
    "mouse.position = (mouse.position[0] + 21.1, mouse.position[1] - 8.8)",
    "mouse.position = (mouse.position[0] + 23.2, mouse.position[1] - 3.5)",
    "mouse.position = (mouse.position[0] + 23.2, mouse.position[1] + 1.8)",
    "mouse.position = (mouse.position[0] + 23.2, mouse.position[1] + 11.8)",
    "mouse.position = (mouse.position[0] + 20.5, mouse.position[1] + 18.4)",
    "mouse.position = (mouse.position[0] + 8.5, mouse.position[1] + 21.7)",
    "mouse.position = (mouse.position[0] + 2.8, mouse.position[1] + 23.3)",
    "mouse.position = (mouse.position[0] + -3.6, mouse.position[1] + 23.3)",
    "mouse.position = (mouse.position[0] + -12.9, mouse.position[1] + 22.5)",
    "mouse.position = (mouse.position[0] + -19.7, mouse.position[1] + 20.3)",
    "mouse.position = (mouse.position[0] + -24.3, mouse.position[1] + 14.8)",
    "mouse.position = (mouse.position[0] + -24.3, mouse.position[1] + 7.6)",
    "mouse.position = (mouse.position[0] + -24.9, mouse.position[1] + -0.8)",
    "mouse.position = (mouse.position[0] + -24.9, mouse.position[1] + -11.0)",
    "mouse.position = (mouse.position[0] + -22.1, mouse.position[1] + -18.7)",
    "mouse.position = (mouse.position[0] + -14.3, mouse.position[1] + -23.3)",
    "mouse.position = (mouse.position[0] + -5.3, mouse.position[1] + -25.4)"
]

modifiers = ["n", "k", "h", "b", "B", "s", "e", "^", "v", ">", "<", "S", "f", "p", "F", "t", "T", "P", "r"]
modifierinstructions = [
    "mouse.position = (mouse.position[0] + 3.4, mouse.position[1] - 23.7)",
    "mouse.position = (mouse.position[0] + 14.6, mouse.position[1] - 22.0)",
    "mouse.position = (mouse.position[0] + 20.3, mouse.position[1] - 16.5)",
    "mouse.position = (mouse.position[0] + 22.2, mouse.position[1] - 9.7)",
    "mouse.position = (mouse.position[0] + 23.9, mouse.position[1] - 1.8)",
    "mouse.position = (mouse.position[0] + 23.9, mouse.position[1] + 8.0)",
    "mouse.position = (mouse.position[0] + 22.5, mouse.position[1] + 15.4)",
    "mouse.position = (mouse.position[0] + 15.6, mouse.position[1] + 17.0)",
    "mouse.position = (mouse.position[0] + 5.8, mouse.position[1] + 20.4)",
    "mouse.position = (mouse.position[0] + -2.2, mouse.position[1] + 21.2)",
    "mouse.position = (mouse.position[0] + -10.2, mouse.position[1] + 20.7)",
    "mouse.position = (mouse.position[0] + -16.5, mouse.position[1] + 18.1)",
    "mouse.position = (mouse.position[0] + -19.2, mouse.position[1] + 12.5)",
    "mouse.position = (mouse.position[0] + -22.6, mouse.position[1] + 5.4)",
    "mouse.position = (mouse.position[0] + -22.6, mouse.position[1] + -1.9)",
    "mouse.position = (mouse.position[0] + -22.6, mouse.position[1] + -10.0)",
    "mouse.position = (mouse.position[0] + -17.6, mouse.position[1] + -18.3)",
    "mouse.position = (mouse.position[0] + -11.0, mouse.position[1] + -20.5)",
    "mouse.position = (mouse.position[0] + -4.2, mouse.position[1] + -20.7)"
]

# map every corresponding pair of characters
# from each text file to a 2-character string in a list (including spaces)
# assign every pair an x and y coordinate
# format: [{type}, {modifier}, {color}, {x}, {y}]
buildqueue = []
with POSITIONPATH.open("r", encoding="utf-8") as p:
    with MODIFIERPATH.open("r", encoding="utf-8") as m:
        with COLORRGBPATH.open("r", encoding="utf-8") as c:
            ypos = 0
            for mline, cline in zip(m.readlines(), c.readlines()):
                xpos = 0
                for mchar, cchar in zip(mline.strip(), cline.strip()):
                    buildqueue.append([mchar, cchar, xpos, ypos])
                    xpos += s
                ypos += s

def place(queue):
    controller.press("`")
    # Group datapoints by modifier first, then by color within each modifier group
    modifier_groups = {}
    color_groups = {}
    for datapoint in queue:
        modifier = datapoint[0]
        if modifier not in modifier_groups:
            modifier_groups[modifier] = []
        modifier_groups[modifier].append(datapoint)
        color = datapoint[1]
        if color not in color_groups:
            color_groups[color] = []
        color_groups[color].append(datapoint)
    
    # 404 179
    global modifierheld, colorheld
    for modifier_group in modifier_groups.values():
        for obj in modifier_group:
            mouse.position = (404 + obj[2], 179 + obj[3])
            time.sleep(0.01)
            controller.tap("x")
            if modifierheld != obj[0]:
                time.sleep(0.01)
                controller.press("z")
                time.sleep(0.01)
                exec(modifierinstructions[modifiers.index(obj[0])])
                time.sleep(0.01)
                controller.release("z")
                modifierheld = obj[0]
            else:
                controller.press("z")
                time.sleep(0.03)
                controller.release("z")
            print(f"Placed modifier {obj[0]} at ({404 + obj[2]}, {179 + obj[3]})")
    for color_group in color_groups.values():
        for obj in color_group:
            mouse.position = (404 + obj[2], 179 + obj[3])
            time.sleep(0.01)
            if colorheld != obj[1]:
                controller.press("c")
                time.sleep(0.01)
                exec(colorinstructions[colors.index(obj[1])])
                time.sleep(0.01)
                controller.release("c")
                colorheld = obj[1]
            else:
                controller.press("c")
                time.sleep(0.03)
                controller.release("c")
            print(f"Placed color {obj[1]} at ({404 + obj[2]}, {179 + obj[3]})")

place(buildqueue)
/**
 * C++ implementation of performance-critical Arras macros
 * 
 * Compile on macOS:
 *   clang++ -std=c++17 -O3 -shared -fPIC arras_cpp_macros.cpp -o arras_cpp_macros.dylib
 * 
 * Compile on Linux:
 *   g++ -std=c++17 -O3 -shared -fPIC arras_cpp_macros.cpp -o arras_cpp_macros.so
 * 
 * Compile on Windows:
 *   cl /O2 /LD arras_cpp_macros.cpp /link /OUT:arras_cpp_macros.dll
 */

#include <cstdint>
#include <cstring>
#include <random>

extern "C" {

/**
 * Fast circle pattern generator (circles function)
 * Generates "cccccccccch" pattern amt times
 * Returns total character count
 */
int32_t circles_cpp(char* buffer, int32_t amt) {
    const char* pattern = "cccccccccch";  // 11 chars
    const int32_t pattern_len = 11;
    int32_t total = amt * pattern_len;
    
    for (int32_t i = 0; i < amt; ++i) {
        memcpy(buffer + i * pattern_len, pattern, pattern_len);
    }
    
    return total;
}

/**
 * Fast wall pattern generator (walls function)
 * Generates 210 'x' characters
 * Returns total character count
 */
int32_t walls_cpp(char* buffer) {
    memset(buffer, 'x', 210);
    return 210;
}

/**
 * Fast circlecrash pattern generator
 * Generates "ccccccccccccccccccccccccch" pattern 1600 times
 * Returns total character count
 */
int32_t circlecrash_cpp(char* buffer) {
    const char* pattern = "ccccccccccccccccccccccccch";  // 26 chars
    const int32_t pattern_len = 26;
    const int32_t count = 1600;
    int32_t total = count * pattern_len;
    
    for (int32_t i = 0; i < count; ++i) {
        memcpy(buffer + i * pattern_len, pattern, pattern_len);
    }
    
    return total;
}

/**
 * Fast minicirclecrash pattern generator
 * Generates "ccccccccccccccccccccccccch" pattern 240 times
 * Returns total character count
 */
int32_t minicirclecrash_cpp(char* buffer) {
    const char* pattern = "ccccccccccccccccccccccccch";  // 26 chars
    const int32_t pattern_len = 26;
    const int32_t count = 240;
    int32_t total = count * pattern_len;
    
    for (int32_t i = 0; i < count; ++i) {
        memcpy(buffer + i * pattern_len, pattern, pattern_len);
    }
    
    return total;
}

/**
 * Arena automation type 1: random even values
 * Generates command strings for arena size randomization
 */
int32_t arena_automation_type1_cpp(char* buffer, int32_t count, uint32_t seed) {
    std::mt19937 rng(seed);
    std::uniform_int_distribution<int32_t> dist(1, 512);  // 2 to 1024 in steps of 2
    
    char* ptr = buffer;
    for (int32_t i = 0; i < count; ++i) {
        int32_t x = dist(rng) * 2;
        int32_t y = dist(rng) * 2;
        int32_t written = snprintf(ptr, 50, "$arena size %d %d\n", x, y);
        ptr += written;
    }
    
    return ptr - buffer;
}

/**
 * Arena automation type 2: bouncing pattern
 * Both x and y bounce from 2 to 1024
 */
int32_t arena_automation_type2_cpp(char* buffer, int32_t count, int32_t step) {
    int32_t x = 2, y = 2;
    int32_t dir_x = step, dir_y = step;
    
    char* ptr = buffer;
    for (int32_t i = 0; i < count; ++i) {
        int32_t written = snprintf(ptr, 50, "$arena size %d %d\n", x, y);
        ptr += written;
        
        x += dir_x;
        y += dir_y;
        
        if (x > 1024) { x = 1024; dir_x = -step; }
        else if (x < 2) { x = 2; dir_x = step; }
        
        if (y > 1024) { y = 1024; dir_y = -step; }
        else if (y < 2) { y = 2; dir_y = step; }
    }
    
    return ptr - buffer;
}

/**
 * Arena automation type 3: inverse bouncing pattern
 * x bounces 2->1024, y bounces 1024->2
 */
int32_t arena_automation_type3_cpp(char* buffer, int32_t count, int32_t step) {
    int32_t x = 2, y = 1024;
    int32_t dir_x = step, dir_y = -step;
    
    char* ptr = buffer;
    for (int32_t i = 0; i < count; ++i) {
        int32_t written = snprintf(ptr, 50, "$arena size %d %d\n", x, y);
        ptr += written;
        
        x += dir_x;
        y += dir_y;
        
        if (x > 1024) { x = 1024; dir_x = -step; }
        else if (x < 2) { x = 2; dir_x = step; }
        
        if (y > 1024) { y = 1024; dir_y = -step; }
        else if (y < 2) { y = 2; dir_y = step; }
    }
    
    return ptr - buffer;
}

/**
 * Benchmark helper: generates circle pattern for performance testing
 * Same as circles_cpp but optimized for large counts
 */
int32_t benchmark_cpp(char* buffer, int32_t amt) {
    return circles_cpp(buffer, amt);
}

}  // extern "C"
