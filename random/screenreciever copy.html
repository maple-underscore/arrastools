<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Screen Receiver</title>
  <style>
    body { margin: 0; background: #111; color: #ddd; font-family: sans-serif; }
    #toolbar { padding: 8px; background:#222; display:flex; gap:8px; align-items:center; }
    #viewer { display:flex; justify-content:center; align-items:center; height:calc(100vh - 48px); }
    img { max-width: 100%; max-height: 100%; image-rendering: optimizeSpeed; cursor: crosshair; display:none; }
    .token-wrapper { 
      position: relative; 
      display: flex; 
      align-items: center; 
    }
    .toggle-visibility {
      position: absolute;
      right: 8px;
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      padding: 2px 6px;
    }
    .toggle-visibility:hover {
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    Host: <input id="host" value="ws://YOUR_HOST:8765" style="width:260px" />
    Token: 
    <div class="token-wrapper">
      <input id="token" type="password" value="changeme" style="width:140px" />
      <button class="toggle-visibility" id="toggleToken">ðŸ”“</button>
    </div>
    <button id="connect">Connect</button>
    <span id="status"></span>
  </div>
  <div id="viewer"><img id="screen" alt="remote screen" /></div>

  <script>
    let ws = null;
    const img = document.getElementById("screen");
    const status = document.getElementById("status");
    let lastObjectUrl = null;
    let openedOnce = false;

    function setStatus(text) {
      status.textContent = text;
    }

    function connect() {
      const host = document.getElementById("host").value;
      const token = encodeURIComponent(document.getElementById("token").value || "");
      const url = host + "/?token=" + token;

      // close previous socket if present
      if (ws) {
        try { ws.close(); } catch(_) {}
        ws = null;
      }

      setStatus("Connecting...");
      img.style.display = "none";

      try {
        ws = new WebSocket(url);
      } catch (err) {
        setStatus("Disconnected - Lost broadcast");
        return;
      }

      ws.binaryType = "blob";

      ws.onopen = () => {
        setStatus("Connected");
        openedOnce = true;
      };

      ws.onmessage = async (evt) => {
        // binary frames (jpeg/webp)
        if (!(evt.data instanceof Blob)) return;
        if (lastObjectUrl) URL.revokeObjectURL(lastObjectUrl);
        lastObjectUrl = URL.createObjectURL(evt.data);
        img.src = lastObjectUrl;
        img.style.display = ""; // show viewer once frames arrive
      };

      ws.onerror = (e) => {
        // onerror can fire before onclose; mark as lost broadcast if no auth close
        // leave onclose to decide final message but provide immediate feedback
        if (!openedOnce) setStatus("Disconnected - Lost broadcast");
        console.debug("WebSocket error", e);
      };

      ws.onclose = (event) => {
        // if server closed with our auth code, show incorrect token
        if (event && event.code === 4003) {
          setStatus("Disconnected - Incorrect token");
        } else {
          setStatus("Disconnected - Lost broadcast");
        }
        img.style.display = "none";
      };

      // fallback timeout: if not connected within 5s -> consider lost
      const connectTimeout = setTimeout(() => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          try { if (ws) ws.close(); } catch(_) {}
          setStatus("Disconnected - Lost broadcast");
        }
      }, 5000);

      // clear timeout on successful open
      ws.addEventListener('open', () => clearTimeout(connectTimeout));
    }

    document.getElementById("connect").onclick = connect;

    // send normalized mouse coordinates and clicks
    function sendJSON(obj) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      ws.send(JSON.stringify(obj));
    }

    function getNormalizedCoords(e) {
      const rect = img.getBoundingClientRect();
      const x = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
      const y = Math.max(0, Math.min(1, (e.clientY - rect.top) / rect.height));
      return {nx: x, ny: y};
    }

    img.addEventListener("mousemove", (e) => {
      const c = getNormalizedCoords(e);
      sendJSON({type:"mouse", action:"move", nx: c.nx, ny: c.ny});
    });

    img.addEventListener("mousedown", (e) => {
      const c = getNormalizedCoords(e);
      const btn = (e.button === 0) ? "left" : "right";
      sendJSON({type:"mouse", action:"click", nx: c.nx, ny: c.ny, button: btn, count:1});
    });

    // wheel scroll
    img.addEventListener("wheel", (e) => {
      sendJSON({type:"mouse", action:"scroll", dx: 0, dy: Math.sign(e.deltaY) * 1});
      e.preventDefault();
    }, {passive:false});

    // keyboard - focused to window
    window.addEventListener("keydown", (e) => {
      if (e.key && e.key.length === 1) {
        sendJSON({type:"keyboard", action:"press", key: e.key});
      } else {
        sendJSON({type:"keyboard", action:"press", key: (e.key || "").toLowerCase()});
      }
      e.preventDefault();
    });

    const tokenInput = document.getElementById("token");
    const toggleToken = document.getElementById("toggleToken");

    toggleToken.addEventListener("click", () => {
      const type = tokenInput.type;
      tokenInput.type = type === "password" ? "text" : "password";
      toggleToken.textContent = type === "password" ? "ðŸ”“" : "ðŸ”’";
    });
  </script>
</body>
</html>